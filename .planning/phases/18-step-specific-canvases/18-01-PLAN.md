---
phase: 18-step-specific-canvases
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/canvas/step-canvas-config.ts
  - src/lib/canvas/quadrant-detection.ts
  - src/stores/canvas-store.ts
  - src/components/canvas/quadrant-overlay.tsx
autonomous: true

must_haves:
  truths:
    - "Step 2 canvas config defines Power x Interest quadrant with correct labels (Keep Satisfied, Manage Closely, Monitor, Keep Informed)"
    - "Step 4 canvas config defines empathy map quadrant with correct labels (Said, Thought, Felt, Experienced)"
    - "detectQuadrant returns correct quadrant based on center-point position relative to (0,0)"
    - "PostIt type includes optional quadrant field"
    - "QuadrantOverlay renders dashed cross-hair lines and quadrant labels that transform with viewport"
  artifacts:
    - path: "src/lib/canvas/step-canvas-config.ts"
      provides: "STEP_CANVAS_CONFIGS record and getStepCanvasConfig function"
      contains: "stakeholder-mapping"
    - path: "src/lib/canvas/quadrant-detection.ts"
      provides: "detectQuadrant function, Quadrant type, getQuadrantLabel function"
      exports: ["detectQuadrant", "getQuadrantLabel", "Quadrant", "QuadrantType"]
    - path: "src/stores/canvas-store.ts"
      provides: "Extended PostIt type with optional quadrant field"
      contains: "quadrant"
    - path: "src/components/canvas/quadrant-overlay.tsx"
      provides: "QuadrantOverlay SVG component for ReactFlow"
      exports: ["QuadrantOverlay"]
  key_links:
    - from: "src/lib/canvas/step-canvas-config.ts"
      to: "src/lib/canvas/quadrant-detection.ts"
      via: "imports QuadrantType"
      pattern: "import.*QuadrantType"
    - from: "src/components/canvas/quadrant-overlay.tsx"
      to: "@xyflow/react"
      via: "useReactFlow hook for viewport transformation"
      pattern: "useReactFlow"
---

<objective>
Create the foundational components for step-specific quadrant canvases: step configuration registry, quadrant detection logic, extended PostIt data model, and QuadrantOverlay SVG component.

Purpose: Establish the data-driven configuration and rendering primitives that Plan 02 will wire into the existing ReactFlowCanvas to enable quadrant layouts on Steps 2 and 4.

Output: Four new/modified files providing step config, detection logic, model extension, and overlay component.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-step-specific-canvases/18-RESEARCH.md

# Existing canvas infrastructure
@src/stores/canvas-store.ts
@src/components/canvas/react-flow-canvas.tsx
@src/lib/workshop/step-metadata.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create step canvas config and quadrant detection logic</name>
  <files>
    src/lib/canvas/step-canvas-config.ts
    src/lib/canvas/quadrant-detection.ts
  </files>
  <action>
Create two new files under `src/lib/canvas/`:

**1. `src/lib/canvas/quadrant-detection.ts`**

Export a `Quadrant` union type with 8 values:
- Power-Interest: `'high-power-high-interest' | 'high-power-low-interest' | 'low-power-high-interest' | 'low-power-low-interest'`
- Empathy Map: `'said' | 'thought' | 'felt' | 'experienced'`

Export a `QuadrantType` union: `'power-interest' | 'empathy-map'`

Export `detectQuadrant(position: { x: number; y: number }, width: number, height: number, type: QuadrantType): Quadrant` function:
- Calculate center point: `centerX = position.x + width / 2`, `centerY = position.y + height / 2`
- For `power-interest`: Y < 0 = High Power, X < 0 = Low Interest, X >= 0 = High Interest
  - Top-left (Y<0, X<0): `'high-power-low-interest'`
  - Top-right (Y<0, X>=0): `'high-power-high-interest'`
  - Bottom-left (Y>=0, X<0): `'low-power-low-interest'`
  - Bottom-right (Y>=0, X>=0): `'low-power-high-interest'`
- For `empathy-map`: Y < 0 = top, X < 0 = left
  - Top-left: `'thought'`
  - Top-right: `'felt'`
  - Bottom-left: `'said'`
  - Bottom-right: `'experienced'`

Export `getQuadrantLabel(quadrant: Quadrant): string` function returning human-readable labels:
- `'high-power-high-interest'` -> `'Manage Closely'`
- `'high-power-low-interest'` -> `'Keep Satisfied'`
- `'low-power-high-interest'` -> `'Keep Informed'`
- `'low-power-low-interest'` -> `'Monitor'`
- `'said'` -> `'What they said'`
- `'thought'` -> `'What they thought'`
- `'felt'` -> `'What they felt'`
- `'experienced'` -> `'What they experienced'`

**2. `src/lib/canvas/step-canvas-config.ts`**

Import `QuadrantType` from `./quadrant-detection`.

Define `QuadrantConfig` type:
```typescript
type QuadrantConfig = {
  type: QuadrantType;
  labels: {
    topLeft: string;
    topRight: string;
    bottomLeft: string;
    bottomRight: string;
  };
  axisLabels?: {
    horizontal: { left: string; right: string };
    vertical: { top: string; bottom: string };
  };
};
```

Define `StepCanvasConfig` type:
```typescript
type StepCanvasConfig = {
  hasQuadrants: boolean;
  quadrantType?: QuadrantType;
  quadrantConfig?: QuadrantConfig;
};
```

Export `STEP_CANVAS_CONFIGS: Record<string, StepCanvasConfig>` with entries for:
- `'stakeholder-mapping'`: hasQuadrants true, quadrantType 'power-interest', labels: topLeft='Keep Satisfied', topRight='Manage Closely', bottomLeft='Monitor', bottomRight='Keep Informed', axisLabels: horizontal left='Low Interest' / right='High Interest', vertical top='High Power' / bottom='Low Power'
- `'sense-making'`: hasQuadrants true, quadrantType 'empathy-map', labels: topLeft='Thought', topRight='Felt', bottomLeft='Said', bottomRight='Experienced' (no axisLabels)

Export `getStepCanvasConfig(stepId: string): StepCanvasConfig` that returns config or `{ hasQuadrants: false }` as default.

Also export `QuadrantConfig` type for use by QuadrantOverlay component.

IMPORTANT: Step IDs MUST match the semantic IDs in `src/lib/workshop/step-metadata.ts`: `'stakeholder-mapping'` (order 2) and `'sense-making'` (order 4).
  </action>
  <verify>
Run `npx tsc --noEmit` — no TypeScript errors. Grep for `detectQuadrant` and `STEP_CANVAS_CONFIGS` to confirm exports exist.
  </verify>
  <done>
Both files exist with correct exports. detectQuadrant returns correct quadrant for all 4 positions in both power-interest and empathy-map modes. STEP_CANVAS_CONFIGS contains entries for 'stakeholder-mapping' and 'sense-making' with matching step IDs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend PostIt type with quadrant field and create QuadrantOverlay component</name>
  <files>
    src/stores/canvas-store.ts
    src/components/canvas/quadrant-overlay.tsx
  </files>
  <action>
**1. Extend PostIt type in `src/stores/canvas-store.ts`:**

Add import for `Quadrant` type from `@/lib/canvas/quadrant-detection`.

Add optional `quadrant` field to PostIt type:
```typescript
export type PostIt = {
  // ... existing fields (id, text, position, width, height, color, parentId, type)
  quadrant?: Quadrant; // Quadrant position for steps with quadrant layout
};
```

No store action changes needed in this plan — quadrant assignment on drag will be wired in Plan 02.

**2. Create `src/components/canvas/quadrant-overlay.tsx`:**

This is a React component that renders inside ReactFlow as a child (alongside Background and Controls). It uses the `useReactFlow` hook to get viewport transformation and renders an SVG overlay.

```
'use client';
```

Import `useReactFlow` from `@xyflow/react`.
Import `useStore` from `zustand` (for reactive viewport updates).
Import `QuadrantConfig` from `@/lib/canvas/step-canvas-config`.
Import `useCallback, useEffect, useState` from `react`.

The component receives `config: QuadrantConfig` as props.

Implementation approach — use ReactFlow's `useStore` selector to subscribe to viewport changes reactively:

```typescript
import { useStore as useReactFlowStore, type ReactFlowState } from '@xyflow/react';

// Selector for viewport
const viewportSelector = (state: ReactFlowState) => ({
  x: state.transform[0],
  y: state.transform[1],
  zoom: state.transform[2],
});
```

Use this selector to get reactive `{ x, y, zoom }` values. Then calculate screen coordinates for the center crosshair:

```
const screenCenterX = 0 * zoom + x;  // canvas origin (0,0) -> screen coords
const screenCenterY = 0 * zoom + y;
```

Render an SVG with `pointer-events-none` and `z-10`:

- Two dashed lines (vertical and horizontal) through screenCenter using gray-400 (#9ca3af), strokeWidth 1.5, strokeDasharray "8 4"
- Four quadrant labels positioned inside each quadrant, offset ~80px from center (scaled by zoom would be too complex — use fixed pixel offset from screen center which moves with pan)
- Quadrant labels: 14px font, gray-500 (#6b7280), fontWeight 500, textAnchor appropriate for each corner
- If `config.axisLabels` present, render axis labels along the center lines: 12px, gray-400 (#9ca3af)

CRITICAL DETAILS:
- SVG must use `className="absolute inset-0 pointer-events-none z-10"` and `width="100%" height="100%"`
- Lines extend from edge to edge of the SVG container (x1=0, x2="100%" for horizontal; y1=0, y2="100%" for vertical)
- But the LINE POSITION tracks the viewport (screenCenterX for vertical line, screenCenterY for horizontal line)
- Quadrant labels should be positioned 80px from the center point in the appropriate direction
- Labels must NOT interfere with post-it interaction (pointer-events-none on entire SVG)

Export `QuadrantOverlay` as named export.
  </action>
  <verify>
Run `npx tsc --noEmit` — no TypeScript errors. Verify `QuadrantOverlay` export exists and `PostIt` type includes `quadrant` field.
  </verify>
  <done>
PostIt type has optional `quadrant?: Quadrant` field. QuadrantOverlay component renders viewport-aware SVG with crosshair lines and quadrant labels. Component accepts QuadrantConfig and transforms correctly with pan/zoom via useReactFlow viewport subscription.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `grep -r "detectQuadrant" src/lib/canvas/quadrant-detection.ts` returns the function
3. `grep -r "STEP_CANVAS_CONFIGS" src/lib/canvas/step-canvas-config.ts` returns the config
4. `grep -r "quadrant" src/stores/canvas-store.ts` returns the PostIt field
5. `grep -r "QuadrantOverlay" src/components/canvas/quadrant-overlay.tsx` returns the component
6. `grep -r "stakeholder-mapping" src/lib/canvas/step-canvas-config.ts` confirms correct step ID
7. `grep -r "sense-making" src/lib/canvas/step-canvas-config.ts` confirms correct step ID
</verification>

<success_criteria>
- Step canvas configuration registry exists with correct step IDs matching step-metadata.ts
- Quadrant detection function uses center-point calculation (not top-left corner)
- PostIt type extended with optional quadrant field (backward compatible)
- QuadrantOverlay component renders viewport-aware SVG lines and labels
- All files compile without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/18-step-specific-canvases/18-01-SUMMARY.md`
</output>
