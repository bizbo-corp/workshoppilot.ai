---
phase: 09-structured-outputs
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/lib/extraction/extract-artifact.ts
  - src/lib/extraction/index.ts
  - src/app/api/extract/route.ts
  - src/lib/context/save-artifact.ts
autonomous: true

must_haves:
  truths:
    - "System can extract a structured artifact from conversation history using AI"
    - "Extraction uses the correct Zod schema for the given step"
    - "Failed extractions retry up to 2 times with error context"
    - "After all retries fail, system returns a meaningful error (not crash)"
    - "Validated artifacts are saved to database with Zod validation"
  artifacts:
    - path: "src/lib/extraction/extract-artifact.ts"
      provides: "Core extraction logic with retry"
      exports: ["extractStepArtifact", "ExtractionError"]
    - path: "src/lib/extraction/index.ts"
      provides: "Re-exports extraction utilities"
      exports: ["extractStepArtifact"]
    - path: "src/app/api/extract/route.ts"
      provides: "POST endpoint for artifact extraction"
      exports: ["POST"]
    - path: "src/lib/context/save-artifact.ts"
      provides: "Updated save with Zod validation"
      contains: "schema.parse"
  key_links:
    - from: "src/app/api/extract/route.ts"
      to: "src/lib/extraction/extract-artifact.ts"
      via: "import extractStepArtifact"
      pattern: "extractStepArtifact"
    - from: "src/lib/extraction/extract-artifact.ts"
      to: "src/lib/schemas/index.ts"
      via: "import getSchemaForStep"
      pattern: "getSchemaForStep"
    - from: "src/app/api/extract/route.ts"
      to: "src/lib/context/save-artifact.ts"
      via: "save validated artifact"
      pattern: "saveStepArtifact"
---

<objective>
Build the extraction service that uses AI SDK 6's streamText with Output.object to extract structured artifacts from conversation history, with retry logic and Zod validation.

Purpose: OUT-02 requires extraction from conversation with retry logic and schema repair. This plan creates the server-side extraction pipeline: conversation -> AI extraction -> Zod validation -> retry on failure -> save to database.
Output: Extraction service, API endpoint, and updated save-artifact with Zod validation.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-structured-outputs/09-RESEARCH.md
@.planning/phases/09-structured-outputs/09-01-SUMMARY.md

@src/lib/ai/chat-config.ts
@src/lib/context/save-artifact.ts
@src/lib/context/assemble-context.ts
@src/app/api/chat/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create extraction service with retry logic</name>
  <files>src/lib/extraction/extract-artifact.ts, src/lib/extraction/index.ts</files>
  <action>
Create `src/lib/extraction/extract-artifact.ts` with the core extraction logic.

**ExtractionError class:**
- Custom error extending Error with `cause` property for the underlying error
- `name = 'ExtractionError'`

**extractStepArtifact function:**
```typescript
async function extractStepArtifact(
  stepId: string,
  conversationHistory: Array<{ role: string; content: string }>,
  maxRetries: number = 2
): Promise<{ artifact: Record<string, unknown>; stepId: string }>
```

Implementation:
1. Look up schema using `getSchemaForStep(stepId)` from `@/lib/schemas`. If no schema found, throw ExtractionError.

2. Loop for `maxRetries + 1` attempts (0, 1, 2 = 3 total attempts):
   - Build extraction system prompt:
     - Attempt 0: "Extract structured data from this design thinking conversation for the [stepName] step. Use the user's exact words where possible. Only include information explicitly discussed in the conversation."
     - Retry attempts: Append the previous Zod error message: "Previous extraction failed. Errors: [error.message]. Fix these specific issues and try again."
   - Call `streamText` from 'ai' with:
     - `model: google('gemini-2.0-flash')` (import google from @ai-sdk/google)
     - `system: extractionPrompt`
     - `messages: conversationHistory` (convert to proper format)
     - `output: Output.object({ schema })` (import Output from 'ai')
     - `temperature: 0.1` (low for extraction accuracy)
   - Await `result.object` to get the extracted data
   - Validate with `schema.parse(extracted)` (belt-and-suspenders check)
   - On success: return `{ artifact: validated, stepId }`
   - On error: capture error as lastError, log warning, continue to next attempt

3. After all retries exhausted: throw `new ExtractionError('Failed to extract valid artifact after N attempts', lastError)`

IMPORTANT: Import `Output` from 'ai' package. The streamText + Output.object pattern is the AI SDK 6 way (not the deprecated generateObject). Check the actual AI SDK 6 API -- if `Output` is not a named export from 'ai', look for the correct import path. The research document says `import { streamText, Output } from 'ai'` but verify by checking node_modules or docs.

NOTE: The `output` option on streamText makes it extract a structured object alongside the text response. The `.object` property on the result gives you the parsed object. The `.partialOutputStream` gives streaming partial objects (not needed here in the server-only extraction -- partial streaming is for UI which we'll handle in Plan 03).

Create `src/lib/extraction/index.ts` that re-exports extractStepArtifact and ExtractionError.
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors. Check that extractStepArtifact, ExtractionError, and Output import resolve correctly.
  </verify>
  <done>
extractStepArtifact function compiles and handles: schema lookup, AI extraction via streamText+Output.object, Zod validation, retry with error context (max 2 retries), and ExtractionError on final failure.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create extraction API endpoint and update save-artifact</name>
  <files>src/app/api/extract/route.ts, src/lib/context/save-artifact.ts</files>
  <action>
**Create `src/app/api/extract/route.ts`:**

POST endpoint that extracts and saves a step artifact.

Request body:
```json
{
  "workshopId": "wks_xxx",
  "stepId": "challenge",
  "sessionId": "ses_xxx"
}
```

Implementation:
1. Parse request body, validate required fields (workshopId, stepId, sessionId)
2. Assemble conversation history using `assembleStepContext(workshopId, stepId, sessionId)` -- use the `.messages` from the returned StepContext
3. If messages is empty or has fewer than 2 messages, return 400: "Not enough conversation to extract from"
4. Call `extractStepArtifact(stepId, messages)` from `@/lib/extraction`
5. Look up workshopStepId from database: query `workshopSteps` where workshopId and stepId match
6. If no workshopStep found, return 404
7. Call `saveStepArtifact(workshopStepId, stepId, result.artifact)` to persist
8. Return 200 with `{ artifact: result.artifact, stepId: result.stepId }`
9. Catch ExtractionError: return 422 with `{ error: 'extraction_failed', message: error.message }`
10. Catch all other errors: return 500 with `{ error: 'Internal server error' }`

Set `export const maxDuration = 60;` (extraction can take longer than chat).

**Update `src/lib/context/save-artifact.ts`:**

Add optional Zod validation before saving:
1. Import `getSchemaForStep` from `@/lib/schemas`
2. Add an optional `validate: boolean = false` parameter to saveStepArtifact
3. When `validate` is true AND a schema exists for the stepId:
   - Call `schema.parse(artifact)` before saving
   - If validation fails, throw the Zod error (let caller handle it)
4. When `validate` is false or no schema exists: save as-is (existing behavior preserved)
5. Keep the existing function signature backward-compatible (validate defaults to false)

This means the extract API endpoint will call `saveStepArtifact(workshopStepId, stepId, artifact)` without the validate flag (extraction already validated), but future code can opt into DB-save-time validation.
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors. Verify API route exists at `src/app/api/extract/route.ts` with POST export. Verify save-artifact.ts still has backward-compatible signature.
  </verify>
  <done>
POST /api/extract endpoint accepts workshopId, stepId, sessionId. Extracts artifact from conversation using AI, validates with Zod, saves to database. Returns 422 on extraction failure. save-artifact.ts has optional validation parameter while maintaining backward compatibility.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- `src/lib/extraction/extract-artifact.ts` exports extractStepArtifact with retry logic
- `src/app/api/extract/route.ts` exports POST handler
- `src/lib/context/save-artifact.ts` maintains backward compatibility
- Extraction uses streamText + Output.object (AI SDK 6 pattern, NOT deprecated generateObject)
- Temperature is set to 0.1 for extraction accuracy
</verification>

<success_criteria>
- OUT-02 complete: System extracts structured outputs from conversation with retry logic
- Extraction pipeline: conversation -> AI -> Zod validation -> retry on failure -> save
- API endpoint returns extracted artifact on success, meaningful error on failure
- Existing save-artifact callers are unaffected (backward-compatible)
</success_criteria>

<output>
After completion, create `.planning/phases/09-structured-outputs/09-02-SUMMARY.md`
</output>
