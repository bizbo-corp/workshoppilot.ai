---
phase: 09-structured-outputs
plan: 03
type: execute
wave: 3
depends_on: ["09-01", "09-02"]
files_modified:
  - src/components/workshop/output-panel.tsx
  - src/components/workshop/artifact-confirmation.tsx
  - src/components/workshop/step-container.tsx
  - src/components/workshop/step-navigation.tsx
autonomous: false

must_haves:
  truths:
    - "User sees extracted artifact rendered as formatted Markdown in the output panel"
    - "User sees Looks Good / Edit buttons after extraction completes"
    - "User can confirm artifact before step is marked complete"
    - "Extraction failures show a meaningful fallback (not a crash)"
    - "Next button is disabled until artifact is confirmed (or step has no artifact yet)"
  artifacts:
    - path: "src/components/workshop/output-panel.tsx"
      provides: "Real artifact display with Markdown rendering"
      contains: "ReactMarkdown"
    - path: "src/components/workshop/artifact-confirmation.tsx"
      provides: "Confirmation UI with Looks Good / Edit buttons"
      contains: "onConfirm"
    - path: "src/components/workshop/step-container.tsx"
      provides: "Wiring between chat, extraction, and output panel"
      contains: "extractArtifact"
    - path: "src/components/workshop/step-navigation.tsx"
      provides: "Navigation gated on artifact confirmation"
      contains: "artifactConfirmed"
  key_links:
    - from: "src/components/workshop/step-container.tsx"
      to: "/api/extract"
      via: "fetch call to extraction endpoint"
      pattern: "fetch.*api/extract"
    - from: "src/components/workshop/step-container.tsx"
      to: "src/components/workshop/output-panel.tsx"
      via: "artifact prop passed to output panel"
      pattern: "artifact.*OutputPanel"
    - from: "src/components/workshop/step-container.tsx"
      to: "src/components/workshop/step-navigation.tsx"
      via: "artifactConfirmed state prop"
      pattern: "artifactConfirmed"
    - from: "src/components/workshop/output-panel.tsx"
      to: "src/components/workshop/artifact-confirmation.tsx"
      via: "renders confirmation when artifact available"
      pattern: "ArtifactConfirmation"
---

<objective>
Build the user-facing extraction UI: replace mock output panel with real Markdown-rendered artifacts, add confirmation flow (Looks Good / Edit), and gate step navigation on artifact confirmation.

Purpose: OUT-03 requires user confirmation before step completion. OUT-04 requires Markdown rendering of structured outputs. This plan wires the extraction API to the UI and creates the confirmation gate.
Output: Updated output panel with real artifacts, confirmation component, and navigation gating.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-structured-outputs/09-RESEARCH.md
@.planning/phases/09-structured-outputs/09-01-SUMMARY.md
@.planning/phases/09-structured-outputs/09-02-SUMMARY.md

@src/components/workshop/output-panel.tsx
@src/components/workshop/step-container.tsx
@src/components/workshop/step-navigation.tsx
@src/components/workshop/chat-panel.tsx
@src/lib/workshop/step-metadata.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update output panel with Markdown artifact rendering</name>
  <files>src/components/workshop/output-panel.tsx</files>
  <action>
First, install react-markdown: `npm install react-markdown`

Rewrite `src/components/workshop/output-panel.tsx` to display real extracted artifacts instead of mock content.

**New props interface:**
```typescript
interface OutputPanelProps {
  stepOrder: number;
  artifact: Record<string, unknown> | null;  // Extracted artifact or null
  isExtracting: boolean;                     // Loading state during extraction
  extractionError: string | null;            // Error message if extraction failed
}
```

**Rendering states:**
1. **No artifact + not extracting** (default): Show current mock content as placeholder (preserve existing behavior with "Preview" badge and mockOutputContent from step-metadata)
2. **Extracting** (isExtracting=true): Show a loading spinner/skeleton with text "Extracting your output..."
3. **Extraction error** (extractionError set): Show error message with gentle copy: "I had trouble extracting your output. You can try again or edit manually." Include a "Try Again" button (calls onRetry callback) -- add `onRetry?: () => void` to props.
4. **Artifact available** (artifact is not null): Render the artifact as formatted Markdown using react-markdown.

**Markdown formatting function:**
Create a `formatArtifactAsMarkdown(artifact: Record<string, unknown>, stepOrder: number): string` function that:
- Gets step metadata from getStepByOrder
- Creates a Markdown string with:
  - Step name as heading
  - Each top-level field as a section (bold label, value below)
  - Arrays rendered as bullet lists
  - Nested objects rendered as indented key-value pairs
  - Handles all 10 step schema shapes gracefully (use a generic approach that iterates keys, not 10 separate formatters)

**ReactMarkdown usage:**
- Import ReactMarkdown from 'react-markdown'
- Render inside a `<div className="prose prose-sm dark:prose-invert max-w-none">` wrapper
- Use the existing Tailwind prose classes already in the component

Keep the header section (step output type label) but replace "Preview" badge with "Extracted" when artifact exists, and keep "Preview" when showing mock content.
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors. Verify react-markdown is in package.json dependencies. Verify OutputPanel accepts new props (artifact, isExtracting, extractionError).
  </verify>
  <done>
OutputPanel renders real artifacts as Markdown when available, shows mock content as placeholder, displays loading state during extraction, and shows error state with retry option. Uses react-markdown for formatted rendering (OUT-04).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create artifact confirmation component and wire extraction flow</name>
  <files>src/components/workshop/artifact-confirmation.tsx, src/components/workshop/step-container.tsx, src/components/workshop/step-navigation.tsx</files>
  <action>
**Create `src/components/workshop/artifact-confirmation.tsx`:**

A component that displays "Looks Good" and "Edit" buttons when an artifact is available.

Props:
```typescript
interface ArtifactConfirmationProps {
  onConfirm: () => void;           // User approves the artifact
  onEdit: () => void;              // User wants to refine via chat
  isConfirming: boolean;           // Loading state while confirming
  isConfirmed: boolean;            // Whether artifact has been confirmed
}
```

Rendering:
- When `isConfirmed`: Show a green checkmark with "Output confirmed" text and a subtle "Re-extract" link (calls onEdit)
- When not confirmed: Show two buttons side by side:
  - "Looks Good" (primary button, calls onConfirm, shows "Confirming..." when isConfirming)
  - "Let me refine" (secondary/ghost button, calls onEdit)
  - Brief instructional text above: "Review the extracted output above. Confirm when ready, or continue chatting to refine."

Use shadcn Button component and Tailwind classes consistent with existing UI.

**Update `src/components/workshop/step-container.tsx`:**

Add extraction state management and wire everything together.

New state:
```typescript
const [artifact, setArtifact] = useState<Record<string, unknown> | null>(null);
const [isExtracting, setIsExtracting] = useState(false);
const [extractionError, setExtractionError] = useState<string | null>(null);
const [artifactConfirmed, setArtifactConfirmed] = useState(false);
```

New props needed from parent: `workshopId: string` (add to StepContainerProps, pass from step page).

Add an `extractArtifact` function:
1. Set isExtracting true, clear error
2. `fetch('/api/extract', { method: 'POST', body: JSON.stringify({ workshopId, stepId: step.id, sessionId }) })`
3. On success (200): setArtifact(data.artifact)
4. On 422 (extraction_failed): setExtractionError(data.message)
5. On other errors: setExtractionError('An unexpected error occurred')
6. Set isExtracting false

Add a `handleConfirm` callback:
- setArtifactConfirmed(true)
- The artifact is already saved by the API endpoint, so confirmation is just UI state

Add a `handleEdit` callback:
- setArtifactConfirmed(false)
- Clear artifact so user can continue chatting and re-extract later
- Optionally: add a message to chat like "Let's refine the output..." (SKIP this for now, keep simple)

Wire to children:
- Pass artifact, isExtracting, extractionError, onRetry=extractArtifact to OutputPanel
- Render ArtifactConfirmation below OutputPanel (inside the output panel area) when artifact is not null
- Pass artifactConfirmed to StepNavigation

**Trigger extraction:**
- Add an "Extract Output" button in the output panel area that calls extractArtifact
- Show this button when there are enough messages (at least 2 user messages) AND no artifact yet AND not currently extracting
- This is a simple manual trigger for now (research noted: "Start with automatic during Synthesize phase, monitor user feedback"). Manual is safer for initial implementation.

**Update StepPage (src/app/workshop/[sessionId]/step/[stepId]/page.tsx):**
- Pass `workshopId={session.workshop.id}` to StepContainer (add to props)

**Update `src/components/workshop/step-navigation.tsx`:**

Add artifact confirmation gate:

New prop: `artifactConfirmed: boolean` (default false)

Modify handleNext:
- If `!artifactConfirmed`, disable the Next button and show tooltip or helper text: "Extract and confirm your output first"
- When artifactConfirmed is true, Next works as before (advance step)

BUT: For MVP flexibility, don't hard-block. Instead:
- If not confirmed: Show the Next button as enabled but with a warning style (outline variant instead of default) and text "Skip to Next"
- If confirmed: Show "Next" with the standard primary style and checkmark icon
- Both work -- skipping is allowed but discouraged. This prevents blocking users who just want to explore.

NOTE: The step page needs to pass workshopId into StepContainer. Update the StepContainer interface and the page component to thread this through.
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors. Verify artifact-confirmation.tsx exists with Looks Good button. Verify step-container.tsx has extractArtifact function. Verify step-navigation.tsx accepts artifactConfirmed prop. Run `npm run build` to confirm the full app builds.
  </verify>
  <done>
ArtifactConfirmation component shows Looks Good / Edit buttons (OUT-03). StepContainer manages extraction state and wires to OutputPanel. StepNavigation shows warning style when artifact not confirmed. Extract Output button triggers manual extraction. Full app builds without errors.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete structured output extraction flow: Zod schemas for all 10 steps, AI extraction with retry, Markdown rendering in output panel, user confirmation with Looks Good / Edit, and navigation gating.</what-built>
  <how-to-verify>
1. Start the dev server: `npm run dev`
2. Navigate to a workshop step (e.g., Step 1: Challenge)
3. Have a conversation with the AI -- discuss a problem, target user, and desired outcome
4. After several messages, look for the "Extract Output" button in the output panel
5. Click "Extract Output" -- verify:
   - Loading state appears ("Extracting your output...")
   - Extracted artifact renders as formatted Markdown (not raw JSON)
   - "Looks Good" and "Let me refine" buttons appear
6. Click "Looks Good" -- verify:
   - Confirmation checkmark appears
   - Next button changes to primary style
7. Click Next -- verify step advances normally
8. (Optional) Test error handling: try extracting on a step with very little conversation -- should show error message with retry option
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues</resume-signal>
</task>

</tasks>

<verification>
- `npm run build` passes without errors
- react-markdown installed and used in output panel
- Output panel shows: mock placeholder (default), loading state (extracting), Markdown artifact (success), error state (failure)
- Confirmation UI shows Looks Good / Edit buttons
- Step navigation shows warning style when artifact not confirmed
- Full extraction flow: chat -> Extract button -> AI extraction -> Markdown display -> Confirm -> Next
</verification>

<success_criteria>
- OUT-03 complete: User sees extracted output and confirms before step completion
- OUT-04 complete: Structured outputs render as formatted Markdown in the UI
- Extraction failures show graceful fallback with retry option
- Navigation gating encourages (but doesn't hard-block) artifact confirmation
- All 4 OUT requirements (OUT-01 through OUT-04) satisfied across Plans 01-03
</success_criteria>

<output>
After completion, create `.planning/phases/09-structured-outputs/09-03-SUMMARY.md`
</output>
