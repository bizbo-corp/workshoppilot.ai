---
phase: 48-stripe-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/lib/billing/stripe.ts
  - scripts/verify-env.ts
  - .env.local
autonomous: false
requirements: [BILL-01, BILL-02]
user_setup:
  - service: stripe
    why: "Payment processing — Stripe SDK needs API keys and Products/Prices created in the Dashboard"
    env_vars:
      - name: STRIPE_SECRET_KEY
        source: "Stripe Dashboard → Developers → API keys → Secret key (use test key sk_test_... for development)"
      - name: NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY
        source: "Stripe Dashboard → Developers → API keys → Publishable key (use test key pk_test_... for development)"
      - name: STRIPE_WEBHOOK_SECRET
        source: "Printed by `stripe listen` CLI command (whsec_... value)"
      - name: STRIPE_PRICE_SINGLE_FLIGHT
        source: "Stripe Dashboard → Products → Single Flight Workshop → Price ID (price_...)"
      - name: STRIPE_PRICE_SERIAL_ENTREPRENEUR
        source: "Stripe Dashboard → Products → Serial Entrepreneur Pack → Price ID (price_...)"
    dashboard_config:
      - task: "Create 'Single Flight Workshop' product"
        location: "Stripe Dashboard (test mode) → Products → + Add product → Name: 'Single Flight Workshop', One-time $79.00 USD, Description: '1 workshop credit. Unlock Steps 7-10 for one Build Pack.'"
      - task: "Create 'Serial Entrepreneur Pack' product"
        location: "Stripe Dashboard (test mode) → Products → + Add product → Name: 'Serial Entrepreneur Pack', One-time $149.00 USD, Description: '3 workshop credits. Run up to three Build Pack workshops.'"
      - task: "Install Stripe CLI"
        location: "Terminal: brew install stripe/stripe-cli/stripe && stripe login"
      - task: "Set Stripe env vars in Vercel"
        location: "Vercel Dashboard → Project Settings → Environment Variables → Add all 5 Stripe vars for Production, Preview, and Development"

must_haves:
  truths:
    - "stripe npm package is installed as a runtime dependency (not devDependency)"
    - "No client-side Stripe packages (@stripe/stripe-js, @stripe/react-stripe-js) are in package.json"
    - "Importing src/lib/billing/stripe.ts in a server context returns a working Stripe instance"
    - "Importing src/lib/billing/stripe.ts without STRIPE_SECRET_KEY throws a clear error at module load time"
    - "verify-env.ts checks all 5 Stripe env vars and rejects test keys in production"
    - "Two Stripe Products exist in the Dashboard with correct names, prices, and descriptions"
    - "STRIPE_PRICE_SINGLE_FLIGHT and STRIPE_PRICE_SERIAL_ENTREPRENEUR env vars contain valid price_ IDs"
  artifacts:
    - path: "src/lib/billing/stripe.ts"
      provides: "Server-only Stripe singleton with startup assertions"
      exports: ["stripe"]
    - path: "scripts/verify-env.ts"
      provides: "Pre-build env validation including Stripe vars"
      contains: "STRIPE_SECRET_KEY"
  key_links:
    - from: "src/lib/billing/stripe.ts"
      to: "process.env.STRIPE_SECRET_KEY"
      via: "new Stripe(process.env.STRIPE_SECRET_KEY, {...})"
      pattern: "new Stripe\\(process\\.env\\.STRIPE_SECRET_KEY"
    - from: "scripts/verify-env.ts"
      to: "process.env.STRIPE_SECRET_KEY"
      via: "requiredVars array inclusion and production key check"
      pattern: "STRIPE_SECRET_KEY"
---

<objective>
Install the Stripe SDK, create the server-only Stripe singleton with startup safety assertions, update the pre-build environment verification script, and guide the user through creating Products/Prices in the Stripe Dashboard and configuring all environment variables.

Purpose: Phase 49-51 (checkout, webhook, paywall) all depend on a working Stripe instance and valid Price IDs. This plan establishes that foundation with zero client-side Stripe code (redirect Checkout mode per locked decision).

Output: `stripe` npm dependency, `src/lib/billing/stripe.ts` singleton, updated `scripts/verify-env.ts`, 5 new env vars in `.env.local`, 2 Stripe Products in Dashboard.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/48-stripe-infrastructure/48-RESEARCH.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From src/db/client.ts (startup assertion pattern to follow):
```typescript
// Fail fast at module load
if (!process.env.DATABASE_URL) {
  throw new Error(
    'DATABASE_URL environment variable is not set. Please configure your Neon database connection string.'
  );
}
```

From scripts/verify-env.ts (env validation pattern to extend):
```typescript
const requiredVars = [
  'NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY',
  'CLERK_SECRET_KEY',
  'DATABASE_URL',
  'GOOGLE_GENERATIVE_AI_API_KEY',
];

// Production key check pattern:
if (isProduction) {
  if (publishableKey?.startsWith('pk_test_')) { /* error */ }
  if (secretKey?.startsWith('sk_test_')) { /* error */ }
}
```

From src/db/schema/users.ts (stripeCustomerId column exists — Phase 47 complete):
```typescript
stripeCustomerId: text('stripe_customer_id'),
```

From src/db/schema/credit-transactions.ts (stripeSessionId exists — Phase 47 complete):
```typescript
stripeSessionId: text('stripe_session_id').unique(),
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Stripe SDK and create server-only singleton</name>
  <files>
    package.json
    src/lib/billing/stripe.ts
  </files>
  <action>
1. Install the Stripe SDK:
   ```bash
   npm install stripe@^20.4.0
   ```
   This is a runtime server dependency, NOT devDependency. Do NOT install `@stripe/stripe-js` or `@stripe/react-stripe-js` — redirect Checkout mode requires zero client-side Stripe JS (locked decision in STATE.md).

2. Create `src/lib/billing/stripe.ts` with the following exact implementation:

```typescript
import 'server-only';
import Stripe from 'stripe';

// Fail fast: throw at module initialization if key is missing
// Same pattern as src/db/client.ts
if (!process.env.STRIPE_SECRET_KEY) {
  throw new Error(
    'STRIPE_SECRET_KEY environment variable is not set. Configure your Stripe API key.'
  );
}

// Production safety: prevent test keys from reaching production
if (
  process.env.VERCEL_ENV === 'production' &&
  process.env.STRIPE_SECRET_KEY.startsWith('sk_test_')
) {
  throw new Error(
    'STRIPE_SECRET_KEY is a test key (sk_test_*) but VERCEL_ENV is production. Use production Stripe keys.'
  );
}

export const stripe = new Stripe(process.env.STRIPE_SECRET_KEY, {
  apiVersion: '2026-02-25.clover', // Pinned to stripe@20.4.0 default
  typescript: true,
});
```

Key design choices:
- `import 'server-only'` causes a build error if this file is accidentally imported in a Client Component — hard enforcement that STRIPE_SECRET_KEY never reaches the browser.
- `apiVersion: '2026-02-25.clover'` — explicitly pinned to stripe@20.4.0 default so SDK upgrades don't silently change the API contract.
- No `let stripe: Stripe` singleton pattern needed — Next.js module caching makes the exported const naturally singleton per process.
- `typescript: true` enables full TypeScript type inference on API responses.

3. Verify `stripe` appears in `dependencies` (not `devDependencies`) in package.json after install.
4. Verify `@stripe/stripe-js` and `@stripe/react-stripe-js` do NOT appear anywhere in package.json.
  </action>
  <verify>
    <automated>cd /Users/michaelchristie/devProjects/workshoppilot.ai && node -e "const pkg = require('./package.json'); const hasDep = !!pkg.dependencies?.stripe; const noClient = !pkg.dependencies?.['@stripe/stripe-js'] && !pkg.dependencies?.['@stripe/react-stripe-js']; console.log('stripe in deps:', hasDep); console.log('no client pkgs:', noClient); if (!hasDep || !noClient) process.exit(1);" && test -f src/lib/billing/stripe.ts && grep -q "import 'server-only'" src/lib/billing/stripe.ts && grep -q "apiVersion" src/lib/billing/stripe.ts && echo "PASS" || echo "FAIL"</automated>
  </verify>
  <done>
    - `stripe@^20.4.0` is in package.json `dependencies`
    - `@stripe/stripe-js` and `@stripe/react-stripe-js` are NOT in package.json
    - `src/lib/billing/stripe.ts` exists with `import 'server-only'`, startup assertion for missing key, production test-key guard, and exported `stripe` instance with pinned apiVersion
  </done>
</task>

<task type="auto">
  <name>Task 2: Update verify-env.ts with Stripe environment variables</name>
  <files>
    scripts/verify-env.ts
  </files>
  <action>
Update `scripts/verify-env.ts` to validate all 5 Stripe environment variables and add a production key guard for `STRIPE_SECRET_KEY`.

1. Add these 5 vars to the `requiredVars` array:
   - `'STRIPE_SECRET_KEY'`
   - `'STRIPE_WEBHOOK_SECRET'`
   - `'NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY'`
   - `'STRIPE_PRICE_SINGLE_FLIGHT'`
   - `'STRIPE_PRICE_SERIAL_ENTREPRENEUR'`

2. Add a production key check for `STRIPE_SECRET_KEY` inside the existing `if (isProduction)` block, following the same pattern used for Clerk keys:

```typescript
const stripeSecretKey = process.env.STRIPE_SECRET_KEY;
if (stripeSecretKey?.startsWith('sk_test_')) {
  console.error('❌ STRIPE_SECRET_KEY is a test key (sk_test_*) but VERCEL_ENV is production');
  console.error('   Please use production Stripe keys for production deployments');
  hasErrors = true;
}
```

Do NOT modify existing Clerk or database env var checks. Only add — do not remove or rewrite.
  </action>
  <verify>
    <automated>cd /Users/michaelchristie/devProjects/workshoppilot.ai && grep -c "STRIPE" scripts/verify-env.ts | xargs -I{} test {} -ge 6 && echo "PASS: 6+ STRIPE references found" || echo "FAIL: insufficient STRIPE references"</automated>
  </verify>
  <done>
    - `scripts/verify-env.ts` `requiredVars` array includes all 5 Stripe env var names
    - Production guard rejects `sk_test_` prefixed `STRIPE_SECRET_KEY` when `VERCEL_ENV === 'production'`
    - All existing Clerk/DB/Google AI checks remain untouched
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 3: Create Stripe Products, configure env vars, and set up Stripe CLI</name>
  <action>Claude cannot create Stripe Dashboard products, obtain API keys, or run `stripe login` (requires browser OAuth). The user must perform these steps.</action>
  <instructions>
**Part A: Stripe Dashboard Setup (5 minutes)**

1. Go to https://dashboard.stripe.com (log in or create account)
2. Ensure you are in **Test mode** (toggle in top-right)
3. Navigate to **Developers → API keys**:
   - Copy the **Publishable key** (`pk_test_...`) — this is `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY`
   - Copy the **Secret key** (`sk_test_...`) — this is `STRIPE_SECRET_KEY`
4. Navigate to **Products → + Add product**:
   - **Product 1:** Name: "Single Flight Workshop", One-time pricing: $79.00 USD
     - Description: "1 workshop credit. Unlock Steps 7-10 for one Build Pack."
     - Click "Add product" → copy the **Price ID** (`price_...`) — this is `STRIPE_PRICE_SINGLE_FLIGHT`
   - **Product 2:** Name: "Serial Entrepreneur Pack", One-time pricing: $149.00 USD
     - Description: "3 workshop credits. Run up to three Build Pack workshops."
     - Click "Add product" → copy the **Price ID** (`price_...`) — this is `STRIPE_PRICE_SERIAL_ENTREPRENEUR`

**Part B: Local Environment Variables**

Add these 5 lines to `.env.local` (below the existing vars):

```
STRIPE_SECRET_KEY=sk_test_YOUR_KEY_HERE
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_YOUR_KEY_HERE
STRIPE_WEBHOOK_SECRET=whsec_PLACEHOLDER
STRIPE_PRICE_SINGLE_FLIGHT=price_YOUR_PRICE_ID_HERE
STRIPE_PRICE_SERIAL_ENTREPRENEUR=price_YOUR_PRICE_ID_HERE
```

Replace the placeholders with the actual values from Step A.

**Part C: Stripe CLI (3 minutes)**

1. Install: `brew install stripe/stripe-cli/stripe`
2. Authenticate: `stripe login` (opens browser)
3. Forward webhooks: `stripe listen --forward-to localhost:3000/api/webhooks/stripe`
4. The CLI prints a signing secret (`whsec_...`) — update `STRIPE_WEBHOOK_SECRET` in `.env.local` with this value

**Note:** The CLI `whsec_` is different from the Dashboard webhook secret. For local testing, always use the CLI-printed value. The Dashboard endpoint secret is for production/Vercel.

**Part D: Vercel Environment Variables**

In Vercel Dashboard → Project Settings → Environment Variables, add all 5 vars:
- `STRIPE_SECRET_KEY` — for Production: use live key (`sk_live_...`); for Preview: use test key (`sk_test_...`)
- `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY` — for Production: live key (`pk_live_...`); for Preview: test key (`pk_test_...`)
- `STRIPE_WEBHOOK_SECRET` — for Production: Dashboard endpoint secret; for Preview: create a separate webhook endpoint or use `VERCEL_AUTOMATION_BYPASS_SECRET` (see note below)
- `STRIPE_PRICE_SINGLE_FLIGHT` — same Price ID for both test and production (create separate products in live mode when ready)
- `STRIPE_PRICE_SERIAL_ENTREPRENEUR` — same as above

**Deployment Protection Note:** If Vercel Deployment Protection is enabled on preview environments, Stripe webhook delivery will get 401. Go to Vercel Dashboard → Project Settings → Deployment Protection → enable "Protection Bypass for Automation" and note the bypass secret for Phase 49 webhook setup.
  </instructions>
  <resume-signal>Type "done" when all env vars are set in .env.local and Stripe Products are created. Include the two Price IDs for verification if possible.</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Stripe SDK installed correctly:**
   ```bash
   node -e "const pkg = require('./package.json'); console.log('stripe:', pkg.dependencies.stripe); console.log('@stripe/stripe-js:', pkg.dependencies['@stripe/stripe-js'] || 'NOT INSTALLED'); console.log('@stripe/react-stripe-js:', pkg.dependencies['@stripe/react-stripe-js'] || 'NOT INSTALLED');"
   ```
   Expected: stripe version present, other two "NOT INSTALLED"

2. **Singleton loads without error (requires env vars set):**
   ```bash
   cd /Users/michaelchristie/devProjects/workshoppilot.ai && npx tsx -e "
     process.env.STRIPE_SECRET_KEY = process.env.STRIPE_SECRET_KEY || 'sk_test_placeholder';
     // Dynamic import to test module loading
     import('./src/lib/billing/stripe.ts').then(m => {
       console.log('Stripe singleton loaded:', typeof m.stripe === 'object' ? 'OK' : 'FAIL');
     }).catch(e => console.error('Load failed:', e.message));
   "
   ```

3. **verify-env.ts includes Stripe checks:**
   ```bash
   grep "STRIPE" scripts/verify-env.ts
   ```
   Expected: 6+ lines referencing STRIPE vars

4. **No client-side Stripe imports in codebase:**
   ```bash
   grep -r "@stripe/stripe-js\|@stripe/react-stripe-js" src/ --include="*.ts" --include="*.tsx" | head -5
   ```
   Expected: No results
</verification>

<success_criteria>
- `stripe@^20.4.0` in package.json dependencies, no client-side Stripe packages
- `src/lib/billing/stripe.ts` exports a `stripe` Stripe instance with `import 'server-only'`, missing-key assertion, and production test-key guard
- `scripts/verify-env.ts` validates all 5 Stripe env vars and rejects `sk_test_` in production
- `.env.local` contains all 5 Stripe env vars with real values from the Stripe Dashboard
- Two Products exist in Stripe Dashboard test mode: Single Flight ($79, 1 credit) and Serial Entrepreneur ($149, 3 credits)
- Stripe CLI is installed and `stripe listen --forward-to localhost:3000/api/webhooks/stripe` routes events (ready for Phase 49)
</success_criteria>

<output>
After completion, create `.planning/phases/48-stripe-infrastructure/48-01-SUMMARY.md`
</output>
