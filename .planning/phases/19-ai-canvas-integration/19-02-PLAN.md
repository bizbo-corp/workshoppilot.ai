---
phase: 19-ai-canvas-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/workshop/chat-panel.tsx
autonomous: true

must_haves:
  truths:
    - "AI suggestions in chat include 'Add to canvas' action button for [CANVAS_ITEM] markup"
    - "Clicking 'Add to canvas' creates a post-it from the AI suggestion text"
    - "[CANVAS_ITEM] markup is stripped from displayed message content (no raw tags visible)"
    - "Action buttons render below assistant message text, not inline"
    - "Non-canvas messages render identically to before (no regression)"
  artifacts:
    - path: "src/components/workshop/chat-panel.tsx"
      provides: "Canvas item parsing, action buttons, and add-to-canvas handler"
      contains: "parseCanvasItems"
  key_links:
    - from: "src/components/workshop/chat-panel.tsx"
      to: "src/providers/canvas-store-provider.tsx"
      via: "useCanvasStore hook for addPostIt"
      pattern: "useCanvasStore"
    - from: "src/components/workshop/chat-panel.tsx"
      to: "src/stores/canvas-store.ts"
      via: "addPostIt action called on button click"
      pattern: "addPostIt"
---

<objective>
Parse [CANVAS_ITEM] markup from AI messages and render "Add to canvas" action buttons that create post-its when clicked.

Purpose: Enable the "chat-to-canvas" flow where AI suggestions become canvas post-its with one click (requirements AICV-01, AICV-02). This is the client-side half of bidirectional AI-canvas integration.

Output: Modified ChatPanel that parses AI content for [CANVAS_ITEM] tags, strips them from display, renders action buttons below messages, and creates post-its in the canvas store when clicked.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-step-specific-canvases/18-02-SUMMARY.md

# Key source files
@src/components/workshop/chat-panel.tsx
@src/providers/canvas-store-provider.tsx
@src/stores/canvas-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add canvas item parsing and action button rendering to ChatPanel</name>
  <files>src/components/workshop/chat-panel.tsx</files>
  <action>
  Modify `src/components/workshop/chat-panel.tsx` to parse [CANVAS_ITEM] markup and render action buttons:

  1. **Add imports:**
     - Import `Plus` from `lucide-react` (alongside existing `Send`, `Loader2`)
     - Import `useCanvasStore` from `@/providers/canvas-store-provider`

  2. **Add `parseCanvasItems` function** (below existing `parseSuggestions` function):
     ```typescript
     /**
      * Parse [CANVAS_ITEM]...[/CANVAS_ITEM] markup from AI content.
      * Returns clean content (markup removed) and extracted canvas item strings.
      */
     function parseCanvasItems(content: string): { cleanContent: string; canvasItems: string[] } {
       const items: string[] = [];
       const regex = /\[CANVAS_ITEM\](.*?)\[\/CANVAS_ITEM\]/g;
       let match;

       while ((match = regex.exec(content)) !== null) {
         const text = match[1].trim();
         if (text.length > 0) {
           items.push(text);
         }
       }

       // Remove markup from content for clean markdown rendering
       const cleanContent = content.replace(/\s*\[CANVAS_ITEM\].*?\[\/CANVAS_ITEM\]\s*/g, ' ').trim();

       return { cleanContent, canvasItems: items };
     }
     ```

  3. **Access canvas store inside ChatPanel component:**
     At the top of the ChatPanel function body (after the `step` lookup, before the refs), add:
     ```typescript
     const addPostIt = useCanvasStore((state) => state.addPostIt);
     ```

  4. **Add handleAddToCanvas handler** (after the existing `handleKeyDown` function):
     ```typescript
     // Handle adding AI-suggested item to canvas as a post-it
     const handleAddToCanvas = React.useCallback((text: string) => {
       addPostIt({
         text,
         position: { x: 0, y: 0 },
         width: 120,
         height: 120,
         color: 'yellow',
       });
     }, [addPostIt]);
     ```

     Position (0,0) is the canvas origin (center of quadrant grids). User can drag to desired position. Default 120x120 matches the standard post-it size established in Phase 15.

  5. **Update assistant message rendering** to parse canvas items and show action buttons.

     In the message rendering section, for assistant messages (around line 249-262), change the rendering to first parse both suggestions AND canvas items from the content, then render the message and action buttons.

     Replace the existing assistant message rendering block:
     ```tsx
     // Assistant message — strip [SUGGESTIONS] block from display
     const { cleanContent } = parseSuggestions(content);
     return (
       <div key={...} className="flex items-start gap-3">
         <div className="flex size-8 ...">AI</div>
         <div className="flex-1">
           <div className="rounded-lg bg-muted p-3 text-sm prose prose-sm dark:prose-invert max-w-none">
             <ReactMarkdown>{cleanContent}</ReactMarkdown>
           </div>
         </div>
       </div>
     );
     ```

     With:
     ```tsx
     // Assistant message — strip [SUGGESTIONS] and [CANVAS_ITEM] markup
     const { cleanContent: noSuggestions } = parseSuggestions(content);
     const { cleanContent: finalContent, canvasItems } = parseCanvasItems(noSuggestions);
     return (
       <div key={`${message.id}-${index}`} className="flex items-start gap-3">
         <div className="flex size-8 shrink-0 items-center justify-center rounded-full bg-primary text-primary-foreground">
           AI
         </div>
         <div className="flex-1">
           <div className="rounded-lg bg-muted p-3 text-sm prose prose-sm dark:prose-invert max-w-none">
             <ReactMarkdown>{finalContent}</ReactMarkdown>
           </div>
           {canvasItems.length > 0 && (
             <div className="mt-2 flex flex-wrap gap-2">
               {canvasItems.map((item, i) => (
                 <button
                   key={i}
                   onClick={() => handleAddToCanvas(item)}
                   className="inline-flex items-center gap-1 rounded-md border border-primary/20 bg-primary/5 px-2.5 py-1.5 text-xs font-medium text-primary hover:bg-primary/10 transition-colors"
                 >
                   <Plus className="h-3 w-3" />
                   {item}
                 </button>
               ))}
             </div>
           )}
         </div>
       </div>
     );
     ```

     Key design decisions:
     - Parse suggestions FIRST, then canvas items from the cleaned result (avoids interaction between the two parsers)
     - Canvas item buttons show the item text alongside the Plus icon so the user knows WHAT they're adding
     - Buttons are below the message bubble in a flex-wrap row, visually distinct from suggestion pills (which appear in the input area)
     - Buttons use `bg-primary/5` with `border-primary/20` for a subtle, professional look
     - Buttons remain after clicking (no state tracking of "already added") — user can add the same item multiple times or undo with Ctrl+Z (per research recommendation: Option A, allow duplicates)

  Important: Do NOT modify the suggestion pills section at the bottom of the component — those remain as-is. The canvas item buttons are rendered inline with each assistant message, while suggestion pills are global at the bottom of the chat.
  </action>
  <verify>
  Run `npx tsc --noEmit` — no TypeScript errors.
  Run `npm run build` — build succeeds.
  Verify parsing function: `grep -n "parseCanvasItems" src/components/workshop/chat-panel.tsx` — function exists.
  Verify store access: `grep -n "useCanvasStore" src/components/workshop/chat-panel.tsx` — hook imported and used.
  Verify Plus icon: `grep -n "Plus" src/components/workshop/chat-panel.tsx` — imported from lucide-react and used in JSX.
  Verify handler: `grep -n "handleAddToCanvas" src/components/workshop/chat-panel.tsx` — callback function exists.
  Verify no raw tags: `grep -c "CANVAS_ITEM" src/components/workshop/chat-panel.tsx` should show the function definition but the regex ensures tags are stripped before ReactMarkdown rendering.
  </verify>
  <done>
  ChatPanel parses [CANVAS_ITEM] markup from AI messages, strips it from displayed content, renders "Add to canvas" buttons with item text below each assistant message, and creates post-its in the canvas store at (0,0) when buttons are clicked. Build succeeds with no errors.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — zero TypeScript errors
2. `npm run build` — build succeeds (SSR safety preserved, client component correctly accesses canvas store)
3. `grep -n "parseCanvasItems" src/components/workshop/chat-panel.tsx` — parser function exists
4. `grep -n "useCanvasStore" src/components/workshop/chat-panel.tsx` — canvas store accessed
5. `grep -n "handleAddToCanvas" src/components/workshop/chat-panel.tsx` — handler creates post-its
6. `grep -n "Plus" src/components/workshop/chat-panel.tsx` — Plus icon imported and rendered in action buttons
7. `grep -n "addPostIt" src/components/workshop/chat-panel.tsx` — store action called in handler
</verification>

<success_criteria>
- parseCanvasItems function extracts [CANVAS_ITEM] text and strips markup from content
- Action buttons render below assistant messages showing item text with Plus icon
- Clicking a button calls addPostIt with the item text, default position (0,0), and yellow color
- Messages without [CANVAS_ITEM] markup render identically to before (no regression)
- parseSuggestions and parseCanvasItems compose correctly (suggestions parsed first, then canvas items)
- TypeScript compiles and build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/19-ai-canvas-integration/19-02-SUMMARY.md`
</output>
