---
phase: 49-payment-api-layer
plan: 03
type: execute
wave: 2
depends_on: [49-02]
files_modified:
  - src/app/purchase/success/page.tsx
  - src/app/purchase/cancel/page.tsx
autonomous: true
requirements: [BILL-01, BILL-02, BILL-03]

must_haves:
  truths:
    - "After completing Stripe Checkout, the success page immediately shows the correct credit count without waiting for the webhook"
    - "If the webhook already fulfilled the purchase before the user returns, the success page still shows the correct credit count (already_fulfilled path)"
    - "The success page redirects to /dashboard if no session_id is present"
    - "The success page redirects to / if the user is unauthenticated"
    - "The cancel page shows a friendly message with a link back to the dashboard"
  artifacts:
    - path: "src/app/purchase/success/page.tsx"
      provides: "Server Component success page with dual-trigger credit fulfillment"
      exports: ["default"]
    - path: "src/app/purchase/cancel/page.tsx"
      provides: "Cancel page with return-to-dashboard link"
      exports: ["default"]
  key_links:
    - from: "src/app/purchase/success/page.tsx"
      to: "src/lib/billing/fulfill-credit-purchase.ts"
      via: "fulfillCreditPurchase(session_id) call on page load"
      pattern: "fulfillCreditPurchase"
    - from: "src/app/purchase/success/page.tsx"
      to: "src/db/schema/users.ts"
      via: "Fetch current creditBalance for already_fulfilled path"
      pattern: "creditBalance"
---

<objective>
Create the billing success and cancel pages that complete the Stripe Checkout redirect flow. The success page calls fulfillCreditPurchase() immediately on load (dual-trigger pattern), showing credits without waiting for the webhook.

Purpose: After a user completes Stripe Checkout, they land on the success page which immediately fulfills the purchase (or reads the current balance if the webhook already did it). This eliminates the "stale credit" UX problem where users return before the webhook fires.

Output: `src/app/purchase/success/page.tsx` (Server Component with dual-trigger fulfillment) and `src/app/purchase/cancel/page.tsx` (friendly cancel page with return link).
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/49-payment-api-layer/49-RESEARCH.md
@.planning/phases/49-payment-api-layer/49-02-PLAN.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase and Plan 49-02. -->

From src/lib/billing/fulfill-credit-purchase.ts (created in Plan 49-02):
```typescript
export type FulfillResult =
  | { status: 'fulfilled'; creditQty: number; newBalance: number }
  | { status: 'already_fulfilled' }
  | { status: 'payment_not_paid' }
  | { status: 'user_not_found' };

export async function fulfillCreditPurchase(sessionId: string): Promise<FulfillResult>;
```

From src/db/schema/users.ts:
```typescript
export const users = pgTable('users', {
  clerkUserId: text('clerk_user_id').notNull().unique(),
  creditBalance: integer('credit_balance').notNull().default(0),
});
```

From src/db/client.ts:
```typescript
export const db = drizzle(sql, { schema });
```

Auth pattern:
```typescript
import { auth } from '@clerk/nextjs/server';
const { userId } = await auth();
```

Next.js App Router searchParams pattern (Next.js 16.x):
```typescript
// searchParams is a Promise in async Server Components
interface PageProps {
  searchParams: Promise<{ session_id?: string }>;
}
export default async function Page({ searchParams }: PageProps) {
  const { session_id } = await searchParams;
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create billing success page with dual-trigger credit fulfillment</name>
  <files>src/app/purchase/success/page.tsx</files>
  <action>
Create a Next.js Server Component at `/purchase/success` that completes the dual-trigger fulfillment pattern. This page is loaded when Stripe redirects the user after a successful checkout, with `?session_id=cs_...` in the URL.

**Imports:**
```typescript
import { auth } from '@clerk/nextjs/server';
import { redirect } from 'next/navigation';
import { fulfillCreditPurchase } from '@/lib/billing/fulfill-credit-purchase';
import { db } from '@/db/client';
import { users } from '@/db/schema';
import { eq } from 'drizzle-orm';
import Link from 'next/link';
```

**Component interface:**
```typescript
interface PurchaseSuccessPageProps {
  searchParams: Promise<{ session_id?: string }>;
}
```

**Implementation steps:**

1. **Auth check:** `const { userId } = await auth(); if (!userId) redirect('/');`
2. **Extract session_id:** `const { session_id } = await searchParams; if (!session_id) redirect('/dashboard');` — searchParams is a Promise in Next.js 16.x App Router.
3. **Call fulfillCreditPurchase:** `const result = await fulfillCreditPurchase(session_id);`
4. **Determine credit count to display:**
   - If `result.status === 'fulfilled'`: use `result.newBalance` and `result.creditQty`
   - If `result.status === 'already_fulfilled'`: the webhook already processed it. Fetch current balance from DB: `const user = await db.query.users.findFirst({ where: eq(users.clerkUserId, userId), columns: { creditBalance: true } }); const currentBalance = user?.creditBalance ?? 0;`
   - If `result.status === 'payment_not_paid'`: show a "payment processing" message with a link to dashboard
   - If `result.status === 'user_not_found'`: show an error message (should not happen in practice)

5. **Render success UI:**
   Use the project's olive design system. The page should be a simple centered card layout:
   - A green checkmark icon or success indicator (use a simple SVG circle-check or text)
   - Heading: "Payment Successful!" (or "Purchase Complete!")
   - Subtext showing what was purchased: "You now have {newBalance} workshop credit(s)"
   - If `result.status === 'fulfilled'`: show "{creditQty} credit(s) added to your account"
   - If `result.status === 'already_fulfilled'`: show "Your credits are ready — {currentBalance} credit(s) available"
   - Primary CTA: Link to `/dashboard` — "Go to Dashboard"
   - Secondary link: "Start a new workshop" pointing to dashboard (since workshop creation starts there)

**Styling guidelines:**
- Use Tailwind classes consistent with the project (olive theme)
- Center the content vertically and horizontally on the page: `min-h-screen flex items-center justify-center`
- Card-style container with padding, rounded corners, subtle shadow
- Success color: use green/olive tones (not a jarring bright green)
- Keep it simple — this is a transient confirmation page, not a complex UI

**IMPORTANT:** Do NOT wrap `redirect()` calls in a try/catch — `redirect()` throws internally in Next.js. Place redirect calls before any try/catch blocks.

**IMPORTANT:** This is a Server Component. Do NOT use `'use client'`, useState, useEffect, or any client-side hooks. All data is fetched server-side during the request.
  </action>
  <verify>
    <automated>test -f src/app/purchase/success/page.tsx && grep -q "fulfillCreditPurchase" src/app/purchase/success/page.tsx && grep -q "await searchParams" src/app/purchase/success/page.tsx && grep -q "redirect" src/app/purchase/success/page.tsx && grep -q "session_id" src/app/purchase/success/page.tsx && grep -q "already_fulfilled" src/app/purchase/success/page.tsx && grep -q "/dashboard" src/app/purchase/success/page.tsx && echo "PASS" || echo "FAIL"</automated>
  </verify>
  <done>
    - `src/app/purchase/success/page.tsx` is a Server Component (no 'use client')
    - Reads session_id from searchParams (awaited Promise)
    - Redirects to / if unauthenticated
    - Redirects to /dashboard if no session_id
    - Calls fulfillCreditPurchase(session_id) — dual-trigger pattern
    - Shows credit count for both 'fulfilled' and 'already_fulfilled' paths
    - Handles 'payment_not_paid' with a processing message
    - Provides a "Go to Dashboard" link
  </done>
</task>

<task type="auto">
  <name>Task 2: Create billing cancel page with return-to-dashboard link</name>
  <files>src/app/purchase/cancel/page.tsx</files>
  <action>
Create a simple Next.js Server Component at `/purchase/cancel` that users see when they click "Back" or close the Stripe Checkout page without completing payment.

**Imports:**
```typescript
import Link from 'next/link';
```

**Implementation:**
This is a static page — no auth check needed (the user may or may not be signed in when they reach this page, depending on Stripe's redirect behavior). Keep it simple.

Render a centered card layout matching the success page structure:
- An informational icon or neutral indicator
- Heading: "Purchase Cancelled"
- Subtext: "No worries — you can purchase credits anytime from your dashboard or when you're ready to unlock Steps 7-10."
- Primary CTA: Link to `/dashboard` — "Return to Dashboard"
- Secondary text: "Your workshop progress is saved and waiting for you."

**Styling:**
- Same centered layout as success page: `min-h-screen flex items-center justify-center`
- Neutral tone (not error red) — cancelling is a valid user action
- Card-style container matching success page

**IMPORTANT:** This is a Server Component (default in App Router). No `'use client'` directive needed.
  </action>
  <verify>
    <automated>test -f src/app/purchase/cancel/page.tsx && grep -q "/dashboard" src/app/purchase/cancel/page.tsx && grep -q "Cancel" src/app/purchase/cancel/page.tsx && echo "PASS" || echo "FAIL"</automated>
  </verify>
  <done>
    - `src/app/purchase/cancel/page.tsx` exists as a Server Component
    - Shows a friendly cancel message (not an error)
    - Links to /dashboard
    - Reassures user that workshop progress is saved
  </done>
</task>

</tasks>

<verification>
1. `src/app/purchase/success/page.tsx` exists and is a Server Component
2. Success page reads `session_id` from `await searchParams` (Promise pattern)
3. Success page calls `fulfillCreditPurchase(session_id)` on load
4. Success page handles all four FulfillResult statuses: fulfilled, already_fulfilled, payment_not_paid, user_not_found
5. Success page shows correct credit count for both fulfilled and already_fulfilled paths
6. Success page redirects to `/` if unauthenticated and `/dashboard` if no session_id
7. `src/app/purchase/cancel/page.tsx` exists with a dashboard link and friendly messaging
8. Neither page uses `'use client'` — both are Server Components
</verification>

<success_criteria>
- After completing Stripe Checkout, the user lands on `/purchase/success?session_id=cs_...` and immediately sees their updated credit count — no waiting for webhook
- If the webhook already fired before the user returns, the success page still shows the correct credit count
- If the user cancels Stripe Checkout, they see a friendly message with a link back to the dashboard
- Both pages follow the project's olive design system
</success_criteria>

<output>
After completion, create `.planning/phases/49-payment-api-layer/49-03-SUMMARY.md`
</output>
