---
phase: 17-canvas-core-interactions
plan: 02
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - src/components/canvas/react-flow-canvas.tsx
  - src/components/canvas/canvas-toolbar.tsx
  - src/components/canvas/color-picker.tsx
autonomous: true

must_haves:
  truths:
    - "User can select multiple post-its via Shift+click or drag-select box"
    - "User can delete selected post-its with Backspace or Delete key"
    - "Delete key does NOT trigger during text editing in post-it textarea"
    - "User can pan canvas by dragging and zoom with scroll wheel"
    - "User can undo canvas actions with Ctrl+Z (or Cmd+Z on Mac)"
    - "User can redo canvas actions with Ctrl+Shift+Z (or Cmd+Shift+Z on Mac)"
    - "User can right-click a post-it to open color picker with 5 preset colors"
    - "Color picker closes when canvas is panned/zoomed"
    - "Undo/redo does NOT trigger auto-save (preserves isDirty state)"
  artifacts:
    - path: "src/components/canvas/react-flow-canvas.tsx"
      provides: "Multi-select, delete, pan/zoom, undo/redo, color picker integration"
      contains: "selectionKeyCode"
    - path: "src/components/canvas/color-picker.tsx"
      provides: "Right-click context menu with 5 color swatches"
      contains: "ColorPicker"
    - path: "src/components/canvas/canvas-toolbar.tsx"
      provides: "Updated toolbar with undo/redo buttons"
      contains: "onUndo"
  key_links:
    - from: "src/components/canvas/react-flow-canvas.tsx"
      to: "src/providers/canvas-store-provider.tsx"
      via: "useCanvasStoreApi() for temporal undo/redo access"
      pattern: "useCanvasStoreApi"
    - from: "src/components/canvas/react-flow-canvas.tsx"
      to: "react-hotkeys-hook"
      via: "useHotkeys for Ctrl+Z/Ctrl+Shift+Z keyboard shortcuts"
      pattern: "useHotkeys"
    - from: "src/components/canvas/react-flow-canvas.tsx"
      to: "src/components/canvas/color-picker.tsx"
      via: "onNodeContextMenu handler renders ColorPicker at click position"
      pattern: "onNodeContextMenu"
---

<objective>
Wire up all canvas interactions: multi-select with Shift+click and drag-select box, delete with Backspace/Delete keys, explicit pan/zoom configuration, undo/redo with Zundo temporal store and keyboard shortcuts, and color-coding via right-click context menu.

Purpose: Delivers the core interaction features (CANV-02 enhancements, CANV-03, CANV-05, CANV-06, CANV-07, CANV-08) that make the canvas a usable design thinking tool. Without these, post-its are static objects with no manipulation capability beyond drag.

Output: Fully interactive canvas with multi-select, delete, pan/zoom, undo/redo, and color-coding.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-canvas-core-interactions/17-RESEARCH.md
@.planning/phases/17-canvas-core-interactions/17-01-SUMMARY.md

Key existing files to read before modifying:
@src/components/canvas/react-flow-canvas.tsx
@src/components/canvas/canvas-toolbar.tsx
@src/providers/canvas-store-provider.tsx
@src/stores/canvas-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add multi-select, delete, pan/zoom, and undo/redo to ReactFlow canvas</name>
  <files>
    src/components/canvas/react-flow-canvas.tsx
    src/components/canvas/canvas-toolbar.tsx
  </files>
  <action>
    **Step 1: Add imports**
    Add to react-flow-canvas.tsx:
    ```typescript
    import { SelectionMode } from '@xyflow/react';
    import { Controls } from '@xyflow/react';
    import { useHotkeys } from 'react-hotkeys-hook';
    import { useCanvasStoreApi } from '@/providers/canvas-store-provider';
    ```

    **Step 2: Access temporal store**
    Inside ReactFlowCanvasInner, get the raw store API for undo/redo:
    ```typescript
    const storeApi = useCanvasStoreApi();
    const deletePostIt = useCanvasStore((s) => s.deletePostIt);
    const batchDeletePostIts = useCanvasStore((s) => s.batchDeletePostIts);
    ```

    **Step 3: Create undo/redo handlers**
    Implement custom undo/redo that preserve isDirty state to prevent undo/redo from triggering auto-save:
    ```typescript
    const handleUndo = useCallback(() => {
      const temporalStore = storeApi.temporal;
      const pastStates = temporalStore.getState().pastStates;
      if (pastStates.length > 0) {
        temporalStore.getState().undo();
      }
    }, [storeApi]);

    const handleRedo = useCallback(() => {
      const temporalStore = storeApi.temporal;
      const futureStates = temporalStore.getState().futureStates;
      if (futureStates.length > 0) {
        temporalStore.getState().redo();
      }
    }, [storeApi]);
    ```

    **Important Zundo API note:** With Zundo and `createStore` from zustand/vanilla, the temporal store is accessed via `storeApi.temporal`. The temporal store has its own `getState()` which returns `{ undo, redo, pastStates, futureStates, clear }`. Read the Plan 01 SUMMARY for exact API shape after Zundo integration.

    **Step 4: Wire undo/redo keyboard shortcuts**
    ```typescript
    useHotkeys('mod+z', (e) => {
      e.preventDefault();
      handleUndo();
    }, { enableOnFormTags: false });

    useHotkeys(['mod+shift+z', 'ctrl+y'], (e) => {
      e.preventDefault();
      handleRedo();
    }, { enableOnFormTags: false });
    ```

    Use `mod+z` (not `ctrl+z`) because react-hotkeys-hook's `mod` maps to Cmd on Mac and Ctrl on Windows/Linux.

    **Step 5: Handle node deletion via onNodesDelete**
    ```typescript
    const handleNodesDelete = useCallback(
      (deleted: Node[]) => {
        const ids = deleted.map(n => n.id);
        batchDeletePostIts(ids);
      },
      [batchDeletePostIts]
    );
    ```

    **Step 6: Update ReactFlow props**
    Update the `<ReactFlow>` component with these props:
    ```typescript
    <ReactFlow
      // ... existing props (nodes, edges, nodeTypes, onNodesChange, onNodeDoubleClick, onPaneClick)

      // Multi-select (CANV-06)
      selectionKeyCode="Shift"
      multiSelectionKeyCode={null}          // Disable Ctrl multi-select (conflicts with undo)
      selectionOnDrag={true}                // Enable drag-select box
      selectionMode={SelectionMode.Partial} // Select if any overlap

      // Delete (CANV-03)
      deleteKeyCode={editingNodeId ? null : ["Backspace", "Delete"]}
      onNodesDelete={handleNodesDelete}

      // Pan/Zoom (CANV-07) - most already set but make explicit
      panOnDrag={true}
      zoomOnScroll={true}
      zoomOnPinch={true}
      zoomOnDoubleClick={false}  // Already set - conflicts with post-it creation
      minZoom={0.3}              // Already set
      maxZoom={2}                // Already set
    >
      <Background ... />
      <Controls
        showInteractive={false}
        className="!shadow-md"
      />
    </ReactFlow>
    ```

    **Critical:** Remove `selectionKeyCode={null}` and `deleteKeyCode={null}` from current props (Phase 15 disabled them). Replace with the new values above.

    **Step 7: Pass color to node data**
    Update the `nodes` useMemo to include color from the PostIt:
    ```typescript
    data: {
      text: postIt.text,
      color: postIt.color || 'yellow',  // NEW: pass color to node
      isEditing: editingNodeId === postIt.id,
      onTextChange: handleTextChange,
      onEditComplete: handleEditComplete,
    } as PostItNodeData,
    ```

    **Step 8: Update canvas toolbar with undo/redo buttons**
    Update CanvasToolbar interface to accept undo/redo:
    ```typescript
    export interface CanvasToolbarProps {
      onAddPostIt: () => void;
      onUndo: () => void;
      onRedo: () => void;
      canUndo: boolean;
      canRedo: boolean;
    }
    ```

    Add undo/redo buttons to the toolbar:
    ```typescript
    <button onClick={onUndo} disabled={!canUndo} className="...">Undo</button>
    <button onClick={onRedo} disabled={!canRedo} className="...">Redo</button>
    ```

    Style: Same visual style as existing + button. Use opacity-50 + cursor-not-allowed when disabled.

    Pass canUndo/canRedo from ReactFlowCanvasInner. To get reactive canUndo/canRedo, subscribe to temporal state:
    ```typescript
    const [canUndo, setCanUndo] = useState(false);
    const [canRedo, setCanRedo] = useState(false);

    useEffect(() => {
      // Subscribe to temporal store changes
      const temporalStore = storeApi.temporal;
      const unsubscribe = temporalStore.subscribe((state) => {
        setCanUndo(state.pastStates.length > 0);
        setCanRedo(state.futureStates.length > 0);
      });
      return unsubscribe;
    }, [storeApi]);
    ```

    **Step 9: Pass undo/redo props to toolbar**
    ```typescript
    <CanvasToolbar
      onAddPostIt={handleToolbarAdd}
      onUndo={handleUndo}
      onRedo={handleRedo}
      canUndo={canUndo}
      canRedo={canRedo}
    />
    ```
  </action>
  <verify>
    ```bash
    # TypeScript compilation
    npx tsc --noEmit

    # Verify multi-select props
    grep "selectionKeyCode" src/components/canvas/react-flow-canvas.tsx
    grep "SelectionMode" src/components/canvas/react-flow-canvas.tsx

    # Verify delete handling
    grep "onNodesDelete" src/components/canvas/react-flow-canvas.tsx
    grep "deleteKeyCode" src/components/canvas/react-flow-canvas.tsx

    # Verify undo/redo keyboard shortcuts
    grep "useHotkeys" src/components/canvas/react-flow-canvas.tsx
    grep "mod+z" src/components/canvas/react-flow-canvas.tsx

    # Verify Controls component
    grep "Controls" src/components/canvas/react-flow-canvas.tsx

    # Verify toolbar undo/redo
    grep "onUndo" src/components/canvas/canvas-toolbar.tsx
    ```
  </verify>
  <done>
    ReactFlow canvas has multi-select (Shift+click, drag-select box), delete (Backspace/Delete with editing safety), explicit pan/zoom configuration, Controls component, and undo/redo via Zundo temporal store with mod+z / mod+shift+z keyboard shortcuts. Toolbar shows undo/redo buttons with disabled state. TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create color picker context menu and wire to post-it color changes</name>
  <files>
    src/components/canvas/color-picker.tsx
    src/components/canvas/react-flow-canvas.tsx
  </files>
  <action>
    **Step 1: Create ColorPicker component**
    Create `src/components/canvas/color-picker.tsx`:
    ```typescript
    'use client';

    import { memo } from 'react';
    import { cn } from '@/lib/utils';
    import type { PostItColor } from '@/stores/canvas-store';
    import { COLOR_CLASSES } from './post-it-node';

    interface ColorPickerProps {
      position: { x: number; y: number };
      currentColor: PostItColor;
      onColorSelect: (color: PostItColor) => void;
      onClose: () => void;
    }

    const COLORS: { value: PostItColor; label: string }[] = [
      { value: 'yellow', label: 'Yellow' },
      { value: 'pink', label: 'Pink' },
      { value: 'blue', label: 'Blue' },
      { value: 'green', label: 'Green' },
      { value: 'orange', label: 'Orange' },
    ];

    export const ColorPicker = memo(function ColorPicker({
      position, currentColor, onColorSelect, onClose,
    }: ColorPickerProps) {
      return (
        <>
          {/* Backdrop to close menu on click outside */}
          <div className="fixed inset-0 z-40" onClick={onClose} />

          {/* Color picker menu */}
          <div
            className="fixed z-50 bg-white rounded-lg shadow-lg border border-gray-200 p-2 flex gap-1.5"
            style={{ left: position.x, top: position.y }}
          >
            {COLORS.map(({ value, label }) => (
              <button
                key={value}
                onClick={() => onColorSelect(value)}
                title={label}
                className={cn(
                  'w-7 h-7 rounded-full border-2 transition-transform hover:scale-110',
                  COLOR_CLASSES[value],
                  currentColor === value
                    ? 'border-gray-800 ring-2 ring-offset-1 ring-gray-400'
                    : 'border-gray-300'
                )}
              />
            ))}
          </div>
        </>
      );
    });
    ```

    The ColorPicker uses fixed positioning at the right-click coordinates. A transparent backdrop catches clicks outside to close. Current color is highlighted with a darker border and ring.

    **Step 2: Add context menu state to ReactFlowCanvasInner**
    In react-flow-canvas.tsx, add state for the context menu:
    ```typescript
    const [contextMenu, setContextMenu] = useState<{
      nodeId: string;
      x: number;
      y: number;
      currentColor: PostItColor;
    } | null>(null);
    ```

    Import ColorPicker and PostItColor:
    ```typescript
    import { ColorPicker } from './color-picker';
    import type { PostItColor } from '@/stores/canvas-store';
    ```

    **Step 3: Handle right-click on nodes**
    ```typescript
    const handleNodeContextMenu = useCallback(
      (event: React.MouseEvent, node: Node) => {
        event.preventDefault();
        const postIt = postIts.find(p => p.id === node.id);
        setContextMenu({
          nodeId: node.id,
          x: event.clientX,
          y: event.clientY,
          currentColor: postIt?.color || 'yellow',
        });
      },
      [postIts]
    );
    ```

    Add `onNodeContextMenu={handleNodeContextMenu}` to ReactFlow props.

    **Step 4: Handle color selection**
    ```typescript
    const handleColorSelect = useCallback(
      (color: PostItColor) => {
        if (contextMenu) {
          updatePostIt(contextMenu.nodeId, { color });
          setContextMenu(null);
        }
      },
      [contextMenu, updatePostIt]
    );
    ```

    **Step 5: Close context menu on viewport change**
    Close the color picker when the user pans or zooms to prevent it from floating disconnected from its post-it:
    ```typescript
    const handleMoveStart = useCallback(() => {
      setContextMenu(null);
    }, []);
    ```

    Add `onMoveStart={handleMoveStart}` to ReactFlow props.

    Also close on pane click (already exists as handlePaneClick) -- add `setContextMenu(null)` at the beginning of the existing handlePaneClick handler.

    **Step 6: Render ColorPicker**
    After the CanvasToolbar and before the save status indicator, render:
    ```typescript
    {contextMenu && (
      <ColorPicker
        position={{ x: contextMenu.x, y: contextMenu.y }}
        currentColor={contextMenu.currentColor}
        onColorSelect={handleColorSelect}
        onClose={() => setContextMenu(null)}
      />
    )}
    ```

    **Important:** The ColorPicker renders OUTSIDE the ReactFlow component (in the same `div.relative` wrapper) so it uses screen coordinates, not flow coordinates.
  </action>
  <verify>
    ```bash
    # TypeScript compilation
    npx tsc --noEmit

    # Verify ColorPicker component exists
    ls src/components/canvas/color-picker.tsx

    # Verify context menu handler
    grep "onNodeContextMenu" src/components/canvas/react-flow-canvas.tsx

    # Verify color picker close on viewport change
    grep "onMoveStart" src/components/canvas/react-flow-canvas.tsx

    # Verify ColorPicker renders
    grep "ColorPicker" src/components/canvas/react-flow-canvas.tsx
    ```
  </verify>
  <done>
    Right-click context menu opens on post-it nodes showing 5 color swatches (yellow, pink, blue, green, orange). Selecting a color updates the post-it's color in the store. Color picker closes on: color selection, click outside, viewport pan/zoom, pane click. Current color highlighted in picker. TypeScript compiles without errors.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Shift+click adds post-its to selection (multi-select)
3. Drag on empty canvas creates selection box
4. Backspace/Delete removes selected post-its
5. Delete key does NOT fire when editing textarea (editingNodeId safety)
6. Ctrl+Z / Cmd+Z undoes last action
7. Ctrl+Shift+Z / Cmd+Shift+Z redoes action
8. Right-click post-it opens color picker
9. Selecting color changes post-it background
10. Color picker closes on pan/zoom
11. Controls component renders zoom in/out/fit buttons
12. Undo/redo buttons in toolbar show correct disabled state
</verification>

<success_criteria>
- Multi-select works via Shift+click and drag-select box
- Selected post-its deleted with Backspace or Delete key
- Delete key safely disabled during text editing
- Pan (drag) and zoom (scroll) work with min/max limits
- Controls component provides UI zoom buttons
- Undo/redo works via keyboard shortcuts and toolbar buttons
- Right-click opens color picker with 5 preset colors
- Color picker closes on viewport change
- All existing interactions (create, drag, edit) still work
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/17-canvas-core-interactions/17-02-SUMMARY.md`
</output>
