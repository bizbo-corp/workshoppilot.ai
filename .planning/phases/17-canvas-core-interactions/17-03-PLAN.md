---
phase: 17-canvas-core-interactions
plan: 03
type: execute
wave: 3
depends_on: ["17-02"]
files_modified:
  - src/components/canvas/group-node.tsx
  - src/stores/canvas-store.ts
  - src/components/canvas/react-flow-canvas.tsx
  - src/components/canvas/canvas-toolbar.tsx
autonomous: true

must_haves:
  truths:
    - "User can select 2+ post-its and click Group button to create a visual group"
    - "Grouped post-its move together when the group is dragged"
    - "User can ungroup a group to release individual post-its back to canvas"
    - "Ungrouped post-its retain their absolute canvas positions"
    - "Group node renders with subtle gray background and dashed border"
    - "Parent (group) nodes appear before children in the nodes array"
  artifacts:
    - path: "src/components/canvas/group-node.tsx"
      provides: "Group container node with gray background and dashed border"
      contains: "GroupNode"
    - path: "src/stores/canvas-store.ts"
      provides: "groupPostIts and ungroupPostIts store actions"
      contains: "groupPostIts"
    - path: "src/components/canvas/react-flow-canvas.tsx"
      provides: "Group node type registration, group button in toolbar, ungroup in context menu"
      contains: "groupNode"
  key_links:
    - from: "src/components/canvas/react-flow-canvas.tsx"
      to: "src/stores/canvas-store.ts"
      via: "groupPostIts and ungroupPostIts actions called from UI"
      pattern: "groupPostIts|ungroupPostIts"
    - from: "src/components/canvas/react-flow-canvas.tsx"
      to: "src/components/canvas/group-node.tsx"
      via: "nodeTypes registration for 'group' type"
      pattern: "group: GroupNode"
---

<objective>
Implement post-it grouping using ReactFlow's sub-flow (parent-child) system. Users select multiple post-its, click a Group button, and a visual group container wraps them. Ungrouping releases post-its back to their absolute positions.

Purpose: Enables spatial organization of related ideas (CANV-09), critical for design thinking workflows where clustering and categorization drive insight generation (e.g., affinity mapping in Steps 2 and 4).

Output: GroupNode component, store grouping actions, and UI controls for group/ungroup.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-canvas-core-interactions/17-RESEARCH.md
@.planning/phases/17-canvas-core-interactions/17-01-SUMMARY.md
@.planning/phases/17-canvas-core-interactions/17-02-SUMMARY.md

Key existing files to read before modifying:
@src/stores/canvas-store.ts
@src/components/canvas/react-flow-canvas.tsx
@src/components/canvas/canvas-toolbar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GroupNode component and add grouping/ungrouping store actions</name>
  <files>
    src/components/canvas/group-node.tsx
    src/stores/canvas-store.ts
  </files>
  <action>
    **Step 1: Create GroupNode component**
    Create `src/components/canvas/group-node.tsx`:
    ```typescript
    'use client';

    import { memo } from 'react';
    import { type NodeProps, type Node, NodeResizer } from '@xyflow/react';

    export type GroupNodeData = {
      label?: string;
    };

    export type GroupNode = Node<GroupNodeData, 'group'>;

    export const GroupNode = memo(({ selected }: NodeProps<GroupNode>) => {
      return (
        <div
          className={cn(
            'bg-gray-100/70 border-2 border-dashed border-gray-300 rounded-lg',
            'min-w-[160px] min-h-[160px] w-full h-full',
            selected && 'border-blue-400'
          )}
        >
          <NodeResizer
            isVisible={selected}
            minWidth={160}
            minHeight={160}
            handleClassName="!w-2 !h-2 !bg-blue-500 !border-blue-500"
          />
        </div>
      );
    });

    GroupNode.displayName = 'GroupNode';
    ```

    Import `cn` from `@/lib/utils`. The GroupNode is a simple container with:
    - Subtle gray background (`bg-gray-100/70` for translucency)
    - Dashed border (`border-dashed border-gray-300`)
    - Rounded corners (`rounded-lg`)
    - No text/label (keeps it clean, avoids overlap with post-it text)
    - Blue border highlight when selected
    - NodeResizer for manual size adjustment

    **Step 2: Add groupPostIts action to canvas store**
    In `src/stores/canvas-store.ts`, add:
    ```typescript
    groupPostIts: (postItIds: string[]) => void;
    ```

    Implementation:
    1. Generate a new group ID with `crypto.randomUUID()`
    2. Find all post-its matching the provided IDs
    3. Calculate bounding box of selected post-its:
       - minX = Math.min of all positions.x
       - minY = Math.min of all positions.y
       - maxX = Math.max of all (positions.x + width)
       - maxY = Math.max of all (positions.y + height)
    4. Create a group post-it:
       ```typescript
       {
         id: groupId,
         text: '',
         type: 'group',
         color: 'yellow', // Not visible on groups, but satisfies type
         position: { x: minX - 20, y: minY - 20 }, // 20px padding
         width: maxX - minX + 40,
         height: maxY - minY + 40,
       }
       ```
    5. Update each selected post-it's parentId and convert position to relative:
       ```typescript
       {
         parentId: groupId,
         position: {
           x: postIt.position.x - minX + 20, // Relative to group + padding
           y: postIt.position.y - minY + 20,
         }
       }
       ```
    6. Return new postIts array with group FIRST, then remaining post-its (parents must appear before children in ReactFlow)
    7. Set isDirty: true

    **Important ordering:** The group node MUST appear before its children in the postIts array. When building the new array:
    ```typescript
    const newPostIts = [
      ...state.postIts.filter(p => !postItIds.includes(p.id)), // Non-selected stay in place
      groupNode,                                                // Group node
      ...updatedChildren,                                       // Children after parent
    ];
    ```

    Actually, a better approach: put the group node at the BEGINNING of the array (before all other items) to ensure it's always rendered before children:
    ```typescript
    const otherPostIts = state.postIts.filter(p => !postItIds.includes(p.id));
    const newPostIts = [groupNode, ...otherPostIts, ...updatedChildren];
    ```

    **Step 3: Add ungroupPostIts action to canvas store**
    ```typescript
    ungroupPostIts: (groupId: string) => void;
    ```

    Implementation:
    1. Find the group post-it by ID
    2. Find all children (post-its with parentId === groupId)
    3. Convert each child's position back to absolute:
       ```typescript
       {
         parentId: undefined,
         position: {
           x: group.position.x + child.position.x,
           y: group.position.y + child.position.y,
         }
       }
       ```
    4. Remove the group post-it from the array
    5. Replace children with their absolute-position versions
    6. Set isDirty: true

    **Step 4: Export new action types**
    Update CanvasActions type to include:
    ```typescript
    groupPostIts: (postItIds: string[]) => void;
    ungroupPostIts: (groupId: string) => void;
    ```
  </action>
  <verify>
    ```bash
    # TypeScript compilation
    npx tsc --noEmit

    # Verify GroupNode component exists
    ls src/components/canvas/group-node.tsx
    grep "GroupNode" src/components/canvas/group-node.tsx

    # Verify store actions
    grep "groupPostIts" src/stores/canvas-store.ts
    grep "ungroupPostIts" src/stores/canvas-store.ts

    # Verify parent-before-children ordering logic
    grep "parentId" src/stores/canvas-store.ts
    ```
  </verify>
  <done>
    GroupNode component renders subtle gray dashed container with NodeResizer. Canvas store has groupPostIts action (calculates bounding box, creates parent, converts children to relative positions, ensures parent-before-children ordering) and ungroupPostIts action (converts children back to absolute positions, removes group). TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire grouping into canvas UI with Group button and ungroup context menu</name>
  <files>
    src/components/canvas/react-flow-canvas.tsx
    src/components/canvas/canvas-toolbar.tsx
  </files>
  <action>
    **Step 1: Register GroupNode as custom node type**
    In react-flow-canvas.tsx, update nodeTypes (defined OUTSIDE component):
    ```typescript
    import { GroupNode } from './group-node';

    const nodeTypes = {
      postIt: PostItNode,
      group: GroupNode,
    };
    ```

    **Step 2: Track selected nodes for Group button visibility**
    Add state to track how many non-group nodes are selected:
    ```typescript
    const [selectedNodeIds, setSelectedNodeIds] = useState<string[]>([]);
    ```

    Use ReactFlow's `onSelectionChange` callback:
    ```typescript
    const handleSelectionChange = useCallback(({ nodes }: { nodes: Node[] }) => {
      // Only count non-group nodes for grouping eligibility
      const nonGroupIds = nodes
        .filter(n => n.type !== 'group')
        .map(n => n.id);
      setSelectedNodeIds(nonGroupIds);
    }, []);
    ```

    Add `onSelectionChange={handleSelectionChange}` to ReactFlow props.

    **Step 3: Add Group button to toolbar**
    Update CanvasToolbar props:
    ```typescript
    export interface CanvasToolbarProps {
      onAddPostIt: () => void;
      onUndo: () => void;
      onRedo: () => void;
      canUndo: boolean;
      canRedo: boolean;
      onGroup: () => void;       // NEW
      canGroup: boolean;          // NEW: true when 2+ non-group nodes selected
    }
    ```

    Add Group button to toolbar (only visible when canGroup is true):
    ```typescript
    {canGroup && (
      <button onClick={onGroup} className="bg-white rounded-lg shadow-md hover:shadow-lg px-4 py-2 text-sm font-medium text-gray-700 transition-shadow duration-150">
        Group
      </button>
    )}
    ```

    **Step 4: Wire group action**
    In ReactFlowCanvasInner:
    ```typescript
    const groupPostIts = useCanvasStore((s) => s.groupPostIts);
    const ungroupPostIts = useCanvasStore((s) => s.ungroupPostIts);

    const handleGroup = useCallback(() => {
      if (selectedNodeIds.length >= 2) {
        groupPostIts(selectedNodeIds);
        setSelectedNodeIds([]); // Clear selection after grouping
      }
    }, [selectedNodeIds, groupPostIts]);
    ```

    Pass to toolbar:
    ```typescript
    <CanvasToolbar
      onAddPostIt={handleToolbarAdd}
      onUndo={handleUndo}
      onRedo={handleRedo}
      canUndo={canUndo}
      canRedo={canRedo}
      onGroup={handleGroup}
      canGroup={selectedNodeIds.length >= 2}
    />
    ```

    **Step 5: Add Ungroup option to context menu**
    Extend the existing context menu (from Plan 02's color picker) to also show an "Ungroup" option when right-clicking a group node.

    Update the contextMenu state type to include a `nodeType` field:
    ```typescript
    const [contextMenu, setContextMenu] = useState<{
      nodeId: string;
      x: number;
      y: number;
      currentColor: PostItColor;
      nodeType: string;  // NEW
    } | null>(null);
    ```

    In handleNodeContextMenu, pass the node type:
    ```typescript
    nodeType: node.type || 'postIt',
    ```

    In the context menu render section, show Ungroup button for group nodes instead of color picker:
    ```typescript
    {contextMenu && contextMenu.nodeType === 'group' ? (
      <div
        className="fixed z-50 bg-white rounded-lg shadow-lg border border-gray-200 p-1"
        style={{ left: contextMenu.x, top: contextMenu.y }}
      >
        <div className="fixed inset-0 z-40" onClick={() => setContextMenu(null)} />
        <button
          className="relative z-50 px-3 py-1.5 text-sm hover:bg-gray-100 rounded w-full text-left"
          onClick={() => {
            ungroupPostIts(contextMenu.nodeId);
            setContextMenu(null);
          }}
        >
          Ungroup
        </button>
      </div>
    ) : contextMenu ? (
      <ColorPicker ... />
    ) : null}
    ```

    **Step 6: Update nodes mapping for parentId and extent**
    In the `nodes` useMemo, add parentId and extent to support sub-flows:
    ```typescript
    const nodes = useMemo<Node[]>(() => {
      // Sort: groups first (parents before children for ReactFlow)
      const sorted = [...postIts].sort((a, b) => {
        if (a.type === 'group' && b.type !== 'group') return -1;
        if (a.type !== 'group' && b.type === 'group') return 1;
        return 0;
      });

      return sorted.map((postIt) => ({
        id: postIt.id,
        type: postIt.type || 'postIt',
        position: postIt.position,
        parentId: postIt.parentId,
        extent: postIt.parentId ? 'parent' as const : undefined,
        data: {
          text: postIt.text,
          color: postIt.color || 'yellow',
          isEditing: editingNodeId === postIt.id,
          onTextChange: handleTextChange,
          onEditComplete: handleEditComplete,
        } as PostItNodeData,
        style: postIt.type === 'group'
          ? { width: postIt.width, height: postIt.height }
          : { width: postIt.width, height: 'auto' },
      }));
    }, [postIts, editingNodeId, handleTextChange, handleEditComplete]);
    ```

    **Important:** The sort ensures parent (group) nodes always appear before children in the array, which ReactFlow requires. Groups use explicit width AND height (not 'auto') so the container is properly sized.

    **Step 7: Handle group node drag (children move with parent)**
    ReactFlow handles parent-child movement automatically when `parentId` is set. No additional code needed for this. However, update `handleNodesChange` to also handle position changes for group nodes:
    ```typescript
    changes.forEach((change) => {
      if (
        change.type === 'position' &&
        change.dragging === false &&
        change.position
      ) {
        const snappedPosition = snapToGrid(change.position);
        updatePostIt(change.id, { position: snappedPosition });
      }
    });
    ```
    This already handles group node drags since groups are in the postIts array.

    **Step 8: Prevent delete of group without ungrouping first**
    Update handleNodesDelete to also ungroup children when a group is deleted:
    ```typescript
    const handleNodesDelete = useCallback(
      (deleted: Node[]) => {
        deleted.forEach(node => {
          if (node.type === 'group') {
            // Ungroup children first, then remove group
            ungroupPostIts(node.id);
          }
        });
        // Delete non-group nodes
        const nonGroupIds = deleted
          .filter(n => n.type !== 'group')
          .map(n => n.id);
        if (nonGroupIds.length > 0) {
          batchDeletePostIts(nonGroupIds);
        }
      },
      [ungroupPostIts, batchDeletePostIts]
    );
    ```
  </action>
  <verify>
    ```bash
    # TypeScript compilation
    npx tsc --noEmit

    # Verify GroupNode registered in nodeTypes
    grep "group: GroupNode" src/components/canvas/react-flow-canvas.tsx

    # Verify Group button in toolbar
    grep "onGroup" src/components/canvas/canvas-toolbar.tsx
    grep "canGroup" src/components/canvas/canvas-toolbar.tsx

    # Verify ungroup in context menu
    grep "ungroupPostIts" src/components/canvas/react-flow-canvas.tsx
    grep "Ungroup" src/components/canvas/react-flow-canvas.tsx

    # Verify parentId in nodes mapping
    grep "parentId" src/components/canvas/react-flow-canvas.tsx

    # Verify onSelectionChange
    grep "onSelectionChange" src/components/canvas/react-flow-canvas.tsx
    ```
  </verify>
  <done>
    GroupNode registered as node type. Group button appears in toolbar when 2+ non-group post-its selected. Clicking Group creates a group container with children positioned relatively inside it. Right-click on group shows Ungroup option. Ungrouping converts children back to absolute positions and removes group. Nodes array sorts groups before children. Deleting a group auto-ungroups children. TypeScript compiles without errors.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Select 2+ post-its with Shift+click → Group button appears
3. Click Group → post-its wrapped in gray dashed container
4. Drag group → all children move together
5. Right-click group → Ungroup option appears
6. Click Ungroup → children released at correct absolute positions
7. Delete group → children ungrouped (not deleted)
8. Groups persist through auto-save and page reload
9. Undo grouping restores pre-group state
</verification>

<success_criteria>
- GroupNode renders with subtle gray-100 background and dashed gray-300 border
- Group button visible in toolbar when 2+ non-group nodes selected
- Grouping creates parent node with children positioned relatively inside
- Ungrouping converts children back to absolute positions
- Group drag moves all children automatically (ReactFlow parentId behavior)
- Deleting a group auto-ungroups children instead of deleting them
- Groups work with existing undo/redo (Zundo tracks postIts including parentId)
- Groups persist through auto-save (saved to stepArtifacts JSONB)
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/17-canvas-core-interactions/17-03-SUMMARY.md`
</output>
