---
phase: 17-canvas-core-interactions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/stores/canvas-store.ts
  - src/providers/canvas-store-provider.tsx
  - src/components/canvas/post-it-node.tsx
autonomous: true

must_haves:
  truths:
    - "PostIt type includes color field with 5 preset options (yellow, pink, blue, green, orange)"
    - "PostIt type includes parentId and type fields for grouping support"
    - "Canvas store wrapped with Zundo temporal middleware for undo/redo state history"
    - "PostItNode renders with correct background color based on post-it color field"
    - "PostItNode supports Escape key to cancel editing without saving"
    - "PostItNode textarea enforces maxLength of 200 characters"
    - "PostItNode shows visual ring feedback when in edit mode"
    - "Undo/redo history only tracks postIts (not isDirty or other transient state)"
  artifacts:
    - path: "src/stores/canvas-store.ts"
      provides: "Extended PostIt type with color/parentId/type, temporal() wrapper, 50-state history limit"
      contains: "temporal"
    - path: "src/components/canvas/post-it-node.tsx"
      provides: "Color-aware PostItNode with edit enhancements"
      contains: "COLOR_CLASSES"
    - path: "src/providers/canvas-store-provider.tsx"
      provides: "Provider exposing temporal store for undo/redo access"
      contains: "useCanvasStoreApi"
  key_links:
    - from: "src/stores/canvas-store.ts"
      to: "zundo"
      via: "temporal() middleware wrapping createStore"
      pattern: "temporal\\("
    - from: "src/components/canvas/post-it-node.tsx"
      to: "src/stores/canvas-store.ts"
      via: "PostItColor type import for color mapping"
      pattern: "PostItColor"
---

<objective>
Extend the canvas store with color, grouping fields, and Zundo undo/redo middleware. Enhance the PostItNode component with color rendering, edit mode improvements (Escape cancel, maxLength, visual feedback), and selection ring.

Purpose: Establishes the data model foundation and node rendering that all subsequent Phase 17 plans depend on. Without the extended type and temporal middleware, color-coding, undo/redo, and grouping cannot be implemented.

Output: Extended canvas store with Zundo temporal history, color-aware PostItNode with edit enhancements.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-canvas-core-interactions/17-RESEARCH.md
@.planning/phases/15-canvas-infrastructure-ssr-safety/15-01-SUMMARY.md
@.planning/phases/15-canvas-infrastructure-ssr-safety/15-02-SUMMARY.md

Key existing files to read before modifying:
@src/stores/canvas-store.ts
@src/providers/canvas-store-provider.tsx
@src/components/canvas/post-it-node.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Zundo and extend canvas store with color, grouping, and temporal middleware</name>
  <files>
    package.json
    src/stores/canvas-store.ts
    src/providers/canvas-store-provider.tsx
  </files>
  <action>
    **Step 1: Install Zundo**
    ```bash
    npm install zundo
    ```

    **Step 2: Extend PostIt type in canvas-store.ts**
    Add new type and fields:
    ```typescript
    export type PostItColor = 'yellow' | 'pink' | 'blue' | 'green' | 'orange';

    export type PostIt = {
      id: string;
      text: string;
      position: { x: number; y: number };
      width: number;
      height: number;
      color: PostItColor;       // NEW: defaults to 'yellow'
      parentId?: string;         // NEW: reference to parent group node
      type?: 'postIt' | 'group'; // NEW: node type discriminator
    };
    ```

    **Step 3: Add new store actions**
    Add `updatePostItColor` action:
    ```typescript
    updatePostItColor: (id: string, color: PostItColor) => void;
    ```
    Implementation: delegate to existing updatePostIt with `{ color }`.

    Add `batchDeletePostIts` action for multi-delete:
    ```typescript
    batchDeletePostIts: (ids: string[]) => void;
    ```
    Implementation: filter postIts where id not in ids array. Set isDirty: true.

    **Step 4: Wrap store with Zundo temporal middleware**
    Import `temporal` from 'zundo'. Wrap the existing store creation:
    ```typescript
    import { temporal } from 'zundo';

    return createStore<CanvasStore>()(
      temporal(
        (set) => ({
          // ... existing store implementation
        }),
        {
          partialize: (state) => ({
            postIts: state.postIts, // Only track postIts, NOT isDirty
          }),
          limit: 50,
          equality: (pastState, currentState) =>
            JSON.stringify(pastState) === JSON.stringify(currentState),
        }
      )
    );
    ```

    **Step 5: Update addPostIt to default color to 'yellow'**
    In the addPostIt action, ensure new post-its get `color: postIt.color || 'yellow'` and `type: postIt.type || 'postIt'`.

    **Step 6: Update canvas-store-provider.tsx**
    Export a `useCanvasStoreApi` hook that returns the raw store API (not just selected state). This is needed for Plan 02 to access `store.temporal.undo()` and `store.temporal.redo()`:
    ```typescript
    export function useCanvasStoreApi(): CanvasStoreApi {
      const store = useContext(CanvasStoreContext);
      if (!store) {
        throw new Error('useCanvasStoreApi must be used within CanvasStoreProvider');
      }
      return store;
    }
    ```

    **Important:** The existing `useCanvasStore` selector hook MUST continue working unchanged. The `useCanvasStoreApi` is an additional export, not a replacement.

    **Important:** Do NOT change the `setPostIts` behavior (it should still not mark dirty). The temporal middleware will still snapshot on setPostIts calls, but that's acceptable since setPostIts is only called on DB load.
  </action>
  <verify>
    ```bash
    # Verify zundo installed
    npm list zundo

    # TypeScript compilation
    npx tsc --noEmit

    # Verify temporal wrapping
    grep "temporal(" src/stores/canvas-store.ts

    # Verify PostItColor type exported
    grep "PostItColor" src/stores/canvas-store.ts

    # Verify useCanvasStoreApi exported
    grep "useCanvasStoreApi" src/providers/canvas-store-provider.tsx
    ```
  </verify>
  <done>
    Zundo installed. PostIt type extended with color (PostItColor), parentId, and type fields. Store wrapped with temporal() middleware (partialize: postIts only, limit: 50). Provider exports useCanvasStoreApi for temporal access. All existing store behavior preserved. TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance PostItNode with color rendering and edit improvements</name>
  <files>
    src/components/canvas/post-it-node.tsx
  </files>
  <action>
    **Step 1: Add color class mapping**
    Create a COLOR_CLASSES constant mapping PostItColor to Tailwind bg classes:
    ```typescript
    import type { PostItColor } from '@/stores/canvas-store';

    export const COLOR_CLASSES: Record<PostItColor, string> = {
      yellow: 'bg-amber-100',
      pink: 'bg-pink-100',
      blue: 'bg-blue-100',
      green: 'bg-green-100',
      orange: 'bg-orange-100',
    };
    ```
    Export COLOR_CLASSES so the color picker (Plan 02) can reuse it.

    **Step 2: Update PostItNodeData type**
    Add `color` field to PostItNodeData:
    ```typescript
    export type PostItNodeData = {
      text: string;
      color: PostItColor;    // NEW
      isEditing: boolean;
      onTextChange?: (id: string, text: string) => void;
      onEditComplete?: (id: string) => void;
    };
    ```

    **Step 3: Update PostItNode rendering**
    Replace hardcoded `bg-amber-100` with dynamic color lookup:
    ```typescript
    const bgColor = COLOR_CLASSES[data.color || 'yellow'];
    ```
    Use `bgColor` in the className.

    **Step 4: Add Escape key handler**
    Add `onKeyDown` handler to the textarea:
    ```typescript
    const handleKeyDown = useCallback((e: React.KeyboardEvent) => {
      if (e.key === 'Escape') {
        e.stopPropagation();
        data.onEditComplete?.(id);
      }
    }, [id, data]);
    ```
    Attach to textarea's `onKeyDown` prop.

    **Step 5: Add maxLength to textarea**
    Add `maxLength={200}` attribute to the textarea element.

    **Step 6: Add edit mode visual feedback**
    When `data.isEditing` is true, add `ring-2 ring-blue-400 ring-offset-1` to the outer div (in addition to selected ring). This provides clear visual feedback that the post-it is in edit mode.

    **Important:** Import `useCallback` from React (add to existing imports if not there). The `memo` wrapper MUST remain. The hidden Handles MUST remain for future edge support.
  </action>
  <verify>
    ```bash
    # TypeScript compilation
    npx tsc --noEmit

    # Verify COLOR_CLASSES exported
    grep "export const COLOR_CLASSES" src/components/canvas/post-it-node.tsx

    # Verify maxLength
    grep "maxLength" src/components/canvas/post-it-node.tsx

    # Verify Escape handler
    grep "Escape" src/components/canvas/post-it-node.tsx

    # Verify color in PostItNodeData
    grep "color:" src/components/canvas/post-it-node.tsx
    ```
  </verify>
  <done>
    PostItNode renders with dynamic background color from COLOR_CLASSES mapping. Textarea enforces maxLength={200}. Escape key exits edit mode via onEditComplete callback. Edit mode shows ring-2 ring-blue-400 visual feedback. COLOR_CLASSES exported for reuse. PostItNodeData includes color field. TypeScript compiles without errors.
  </done>
</task>

</tasks>

<verification>
1. `npm list zundo` shows zundo installed
2. `npx tsc --noEmit` passes with no errors
3. PostIt type includes color, parentId, and type fields
4. Canvas store wrapped with temporal() middleware
5. PostItNode renders dynamic colors (not hardcoded amber-100)
6. Escape key handler present on textarea
7. maxLength={200} on textarea
8. useCanvasStoreApi exported from provider
</verification>

<success_criteria>
- Zundo installed and canvas store wrapped with temporal middleware (50-state limit, postIts-only partialize)
- PostIt type extended with color (PostItColor), parentId (string?), type ('postIt' | 'group')
- PostItNode renders correct background color based on data.color
- Edit mode has Escape cancel, maxLength 200, visual ring feedback
- All existing canvas functionality (create, drag, edit, auto-save) still works unchanged
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/17-canvas-core-interactions/17-01-SUMMARY.md`
</output>
