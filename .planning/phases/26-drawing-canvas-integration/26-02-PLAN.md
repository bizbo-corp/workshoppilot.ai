---
phase: 26-drawing-canvas-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/canvas/drawing-image-node.tsx
  - src/stores/canvas-store.ts
  - src/components/canvas/react-flow-canvas.tsx
autonomous: true

must_haves:
  truths:
    - "DrawingImageNode renders PNG image via CSS background-image (no Konva imports)"
    - "DrawingImageNode fires onDoubleClick callback with drawingId for re-edit flow"
    - "drawingImage is registered in ReactFlow nodeTypes map"
    - "Canvas store has addDrawingNode and updateDrawingNode actions"
    - "Canvas store drawing nodes survive serialization round-trip (no functions in persisted state)"
  artifacts:
    - path: "src/components/canvas/drawing-image-node.tsx"
      provides: "Custom ReactFlow node displaying drawing PNGs"
      exports: ["DrawingImageNode", "DrawingImageNodeData"]
    - path: "src/stores/canvas-store.ts"
      provides: "Drawing node actions on canvas store"
      contains: "addDrawingNode"
    - path: "src/components/canvas/react-flow-canvas.tsx"
      provides: "nodeTypes registration including drawingImage"
      contains: "drawingImage"
  key_links:
    - from: "src/components/canvas/drawing-image-node.tsx"
      to: "src/components/canvas/react-flow-canvas.tsx"
      via: "nodeTypes registration"
      pattern: "drawingImage.*DrawingImageNode"
    - from: "src/stores/canvas-store.ts"
      to: "src/components/canvas/react-flow-canvas.tsx"
      via: "addDrawingNode consumed by canvas component"
      pattern: "addDrawingNode"
---

<objective>
Create DrawingImageNode custom ReactFlow node for displaying saved drawings as PNG images, add drawing-specific actions to canvas-store, and register the new node type.

Purpose: Provide the frontend display layer for drawings on the ReactFlow canvas, with double-click re-edit capability and proper node management in the store.

Output: DrawingImageNode component, updated canvas-store with drawing actions, updated react-flow-canvas with new nodeType.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-drawing-canvas-integration/26-RESEARCH.md

@src/components/canvas/post-it-node.tsx
@src/components/canvas/react-flow-canvas.tsx
@src/stores/canvas-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DrawingImageNode custom ReactFlow node</name>
  <files>
    src/components/canvas/drawing-image-node.tsx
  </files>
  <action>
Create `src/components/canvas/drawing-image-node.tsx` following the exact pattern from `post-it-node.tsx` (memo, Handle, NodeProps, Node type).

**CRITICAL: No Konva imports.** This is a pure React component displaying a PNG image via CSS background-image. This preserves the 600KB bundle budget (INTEG-05).

**Type definition:**
```typescript
export type DrawingImageNodeData = {
  imageUrl: string;      // Vercel Blob CDN URL for the PNG
  drawingId: string;     // ID in stepArtifacts.drawings array (for re-edit lookup)
  width: number;         // Drawing width in pixels
  height: number;        // Drawing height in pixels
};

export type DrawingImageNode = Node<DrawingImageNodeData, 'drawingImage'>;
```

**Component implementation:**
- Use `memo()` wrapper like PostItNode
- Accept `NodeProps<DrawingImageNode>` props (destructure `data`, `selected`, `id`)
- Render a `<div>` with:
  - `style.backgroundImage: url(${data.imageUrl})` for PNG display
  - `style.backgroundSize: 'contain'`
  - `style.backgroundRepeat: 'no-repeat'`
  - `style.backgroundPosition: 'center'`
  - `style.width: data.width` (capped at 400px: `Math.min(data.width, 400)`)
  - `style.height: data.height` (scaled proportionally if width was capped)
  - White background (`bg-white`) so transparent PNGs have a clean backdrop
  - `rounded-lg shadow-md` base styling
  - `hover:shadow-lg hover:ring-2 hover:ring-blue-400` on hover
  - `ring-2 ring-blue-500 ring-offset-1` when `selected`
  - `cursor-pointer` for affordance
  - `onDoubleClick` — this is handled at the ReactFlow level via `onNodeDoubleClick`, NOT in the component. Just add a visual affordance: a small pencil icon (SVG inline, 16x16) in the bottom-right corner, visible on hover.
- Hidden `<Handle>` elements (top target, bottom source) matching PostItNode pattern for future edge connections
- Set `displayName = 'DrawingImageNode'`

**Hover pencil icon:**
Add an absolutely positioned div in bottom-right with a simple pencil SVG (path only, no external deps). Use `opacity-0 group-hover:opacity-100` with `group` class on parent div for hover reveal.
  </action>
  <verify>
    - `npx tsc --noEmit` passes with no type errors
    - File contains no imports from 'konva' or 'react-konva'
    - Component uses memo() and has displayName
    - Hidden Handle elements present for target and source
  </verify>
  <done>
    DrawingImageNode renders PNG via CSS background-image, shows pencil icon on hover, has hidden connection handles, and contains zero Konva imports.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add drawing actions to canvas-store and register nodeType</name>
  <files>
    src/stores/canvas-store.ts
    src/components/canvas/react-flow-canvas.tsx
  </files>
  <action>
**Part A: Update canvas-store.ts**

Add a `DrawingNode` type alongside existing `PostIt` type:
```typescript
export type DrawingNode = {
  id: string;
  drawingId: string;   // ID in stepArtifacts.drawings array
  imageUrl: string;    // Vercel Blob CDN URL
  position: { x: number; y: number };
  width: number;
  height: number;
};
```

Add `drawingNodes: DrawingNode[]` to `CanvasState` (default: `[]`).

Add to `CanvasActions`:
- `addDrawingNode: (node: Omit<DrawingNode, 'id'>) => void` — generates UUID, appends to drawingNodes, sets isDirty
- `updateDrawingNode: (id: string, updates: Partial<DrawingNode>) => void` — updates matching node, sets isDirty
- `deleteDrawingNode: (id: string) => void` — filters out by id, sets isDirty
- `setDrawingNodes: (nodes: DrawingNode[]) => void` — for loading from DB (does NOT set isDirty, same pattern as setPostIts)

Update `createCanvasStore` initState to accept optional `drawingNodes: DrawingNode[]`.

Update `temporal.partialize` to include `drawingNodes` alongside postIts and gridColumns so undo/redo tracks drawing nodes.

**Part B: Update react-flow-canvas.tsx**

1. Import `DrawingImageNode` from `./drawing-image-node`:
   ```typescript
   import { DrawingImageNode } from './drawing-image-node';
   ```

2. Add to `nodeTypes` constant (outside component for stable reference):
   ```typescript
   const nodeTypes = {
     postIt: PostItNode,
     group: GroupNode,
     drawingImage: DrawingImageNode,
   };
   ```

3. In the `nodes` useMemo, after computing postIt nodes, also compute drawing nodes from `drawingNodes` store state:
   ```typescript
   const drawingNodes = useCanvasStore((s) => s.drawingNodes);
   ```
   Then in the useMemo, append drawing nodes to the sorted postIt nodes:
   ```typescript
   const drawingReactFlowNodes: Node[] = drawingNodes.map((dn) => ({
     id: dn.id,
     type: 'drawingImage' as const,
     position: dn.position,
     draggable: true,
     selectable: true,
     selected: selectedNodeIds.includes(dn.id),
     data: {
       imageUrl: dn.imageUrl,
       drawingId: dn.drawingId,
       width: dn.width,
       height: dn.height,
     },
     style: { width: Math.min(dn.width, 400), height: Math.min(dn.width, 400) * (dn.height / dn.width) },
   }));
   return [...postItReactFlowNodes, ...drawingReactFlowNodes];
   ```

4. Update `handleNodesChange` to also handle position changes for drawing nodes:
   When a position change applies to a node that's in `drawingNodes` (check by id), call `updateDrawingNode` instead of `updatePostIt`. Use the same snap-to-grid logic.

5. Update `handleNodesDelete` to also handle drawing node deletion:
   For each deleted node, if its id matches a drawingNode, call `deleteDrawingNode`. Only call deletePostIt/batchDeletePostIts for non-drawing nodes.

6. Import `DrawingNode` type from canvas-store.
  </action>
  <verify>
    - `npx tsc --noEmit` passes with no type errors
    - `nodeTypes` object contains `drawingImage` key
    - canvas-store exports DrawingNode type and all four drawing actions
    - Drawing nodes appear in the `nodes` useMemo alongside postIt nodes
  </verify>
  <done>
    Canvas store has full CRUD for drawing nodes (add, update, delete, set). DrawingImageNode is registered in nodeTypes. Drawing nodes render alongside postIts on the ReactFlow canvas with drag, select, and delete support.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- `drawing-image-node.tsx` has zero Konva imports
- `react-flow-canvas.tsx` nodeTypes includes drawingImage
- `canvas-store.ts` exports DrawingNode type and addDrawingNode, updateDrawingNode, deleteDrawingNode, setDrawingNodes
- Drawing nodes convert to ReactFlow nodes in useMemo
</verification>

<success_criteria>
DrawingImageNode component created and registered. Canvas store has complete drawing node CRUD. Drawing nodes render on canvas with drag/select/delete matching postIt behavior. No Konva imported in any file touched by this plan.
</success_criteria>

<output>
After completion, create `.planning/phases/26-drawing-canvas-integration/26-02-SUMMARY.md`
</output>
