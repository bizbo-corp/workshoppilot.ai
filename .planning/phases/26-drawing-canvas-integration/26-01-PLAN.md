---
phase: 26-drawing-canvas-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/lib/drawing/simplify.ts
  - src/actions/drawing-actions.ts
autonomous: true
user_setup:
  - service: vercel-blob
    why: "PNG image storage for drawings"
    env_vars:
      - name: BLOB_READ_WRITE_TOKEN
        source: "Vercel Dashboard → Storage → Create Blob Store → copy token"
    dashboard_config:
      - task: "Create Blob Store if not exists"
        location: "Vercel Dashboard → Storage → Create → Blob"

must_haves:
  truths:
    - "simplify-js and @vercel/blob are installed and importable"
    - "Freehand stroke simplification reduces point arrays by 60%+ at tolerance=1.0"
    - "Server action can upload PNG to Vercel Blob and return a CDN URL"
    - "Server action can save drawing record (PNG URL + vector JSON) to stepArtifacts.drawings[]"
    - "Server action can load drawing vector JSON by drawingId from stepArtifacts"
  artifacts:
    - path: "src/lib/drawing/simplify.ts"
      provides: "Douglas-Peucker simplification for DrawingElement[] arrays"
      exports: ["simplifyDrawingElements"]
    - path: "src/actions/drawing-actions.ts"
      provides: "Server actions for save/load/update drawings"
      exports: ["saveDrawing", "loadDrawing", "updateDrawing"]
  key_links:
    - from: "src/actions/drawing-actions.ts"
      to: "@vercel/blob"
      via: "put() for PNG upload"
      pattern: "put\\("
    - from: "src/actions/drawing-actions.ts"
      to: "src/db/schema/step-artifacts.ts"
      via: "JSONB merge into artifact.drawings[]"
      pattern: "stepArtifacts"
---

<objective>
Install new dependencies (@vercel/blob, simplify-js), create vector simplification utility, and build server actions for saving/loading drawings with Vercel Blob storage.

Purpose: Provide the backend foundation for drawing persistence — PNG upload, vector simplification, and database CRUD — so the frontend integration (Plan 02-03) can wire to real storage.

Output: Two new files (simplify.ts, drawing-actions.ts) plus installed dependencies.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-drawing-canvas-integration/26-RESEARCH.md

@src/actions/canvas-actions.ts
@src/db/schema/step-artifacts.ts
@src/lib/drawing/types.ts
@src/lib/drawing/export.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create vector simplification utility</name>
  <files>
    package.json
    src/lib/drawing/simplify.ts
  </files>
  <action>
1. Install new dependencies:
   ```bash
   npm install @vercel/blob simplify-js
   npm install -D @types/simplify-js
   ```
   Note: If @types/simplify-js doesn't exist, create a local type declaration in `src/lib/drawing/simplify.ts` instead.

2. Create `src/lib/drawing/simplify.ts`:
   - Export `simplifyDrawingElements(elements: DrawingElement[]): DrawingElement[]`
   - Only simplify elements with `type === 'pencil'` that have `points` arrays with 4+ values
   - Convert flat points array `[x1, y1, x2, y2, ...]` to `{x, y}[]` objects for simplify-js
   - Call `simplify(points, 1.0, true)` — tolerance=1.0, highQuality=true (Douglas-Peucker)
   - Convert back to flat array after simplification
   - Return non-pencil elements unchanged (rectangles, circles, arrows, text, etc.)
   - Import DrawingElement type from `@/lib/drawing/types`

   If simplify-js has no types:
   ```typescript
   declare module 'simplify-js' {
     type Point = { x: number; y: number };
     export default function simplify(points: Point[], tolerance?: number, highQuality?: boolean): Point[];
   }
   ```
  </action>
  <verify>
    - `npm ls @vercel/blob simplify-js` shows both installed
    - `npx tsc --noEmit` passes with no type errors on simplify.ts
  </verify>
  <done>
    simplify-js and @vercel/blob are installed. simplifyDrawingElements() converts flat points to objects, simplifies, and converts back. Non-pencil elements pass through unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create drawing server actions (save, load, update)</name>
  <files>
    src/actions/drawing-actions.ts
  </files>
  <action>
Create `src/actions/drawing-actions.ts` with `'use server'` directive. Follow the exact pattern from `src/actions/canvas-actions.ts` for database access (same imports, same workshopStep lookup, same artifact merge pattern).

**Define Drawing type** (at top of file, not exported — internal to server actions):
```typescript
type Drawing = {
  id: string;
  pngUrl: string;
  vectorJson: string;  // JSON.stringify'd DrawingElement[]
  width: number;
  height: number;
  createdAt: string;   // ISO timestamp
  updatedAt?: string;  // ISO timestamp, set on update
};
```

**Export `saveDrawing`:**
- Parameters: `{ workshopId: string; stepId: string; pngBase64: string; vectorJson: string; width: number; height: number }`
- Guard: Check `process.env.BLOB_READ_WRITE_TOKEN` — throw descriptive error if missing
- Convert base64 data URL to Buffer: `const base64Data = pngBase64.split(',')[1]; const buffer = Buffer.from(base64Data, 'base64');`
- Upload to Vercel Blob: `const { url } = await put(\`drawings/${workshopId}/${Date.now()}.png\`, buffer, { access: 'public', addRandomSuffix: true })`
- Find workshopStep by workshopId + stepId (same as canvas-actions.ts pattern)
- Read existing artifact, extract `drawings` array (default `[]`)
- Create drawing record with `id: crypto.randomUUID()`, `pngUrl: url`, `vectorJson`, `width`, `height`, `createdAt: new Date().toISOString()`
- Merge into artifact: `{ ...existingArtifact, drawings: [...existingDrawings, newDrawing] }`
- Update stepArtifacts with optimistic locking (version increment, same as canvas-actions.ts)
- If no artifact exists, insert new one with `schemaVersion: 'drawing-1.0'`
- Return `{ drawingId: newDrawing.id, pngUrl: url }`

**Export `loadDrawing`:**
- Parameters: `{ workshopId: string; stepId: string; drawingId: string }`
- Find workshopStep, read artifact, extract drawings array
- Find drawing by id in array
- Return `{ vectorJson, pngUrl, width, height }` or `null` if not found

**Export `updateDrawing`:**
- Parameters: `{ workshopId: string; stepId: string; drawingId: string; pngBase64: string; vectorJson: string; width: number; height: number }`
- Same Blob upload flow as saveDrawing (new PNG URL each time — old one auto-expires if Blob store is configured)
- Find existing drawing in array by id, replace its fields (pngUrl, vectorJson, width, height, updatedAt)
- Merge back into artifact with version increment
- Return `{ pngUrl: url }`

**Error handling:** Wrap each action in try/catch, return `{ success: false, error: string }` on failure, matching canvas-actions.ts pattern.
  </action>
  <verify>
    - `npx tsc --noEmit` passes with no type errors
    - All three exports exist: saveDrawing, loadDrawing, updateDrawing
    - Server action pattern matches canvas-actions.ts (same DB query patterns, same optimistic locking)
  </verify>
  <done>
    Three server actions (saveDrawing, loadDrawing, updateDrawing) handle the full drawing lifecycle: PNG upload to Vercel Blob, vector JSON storage in stepArtifacts.drawings[], and retrieval for re-editing.
  </done>
</task>

</tasks>

<verification>
- `npm ls @vercel/blob simplify-js` shows both packages installed
- `npx tsc --noEmit` passes with zero errors
- `src/lib/drawing/simplify.ts` exports simplifyDrawingElements
- `src/actions/drawing-actions.ts` exports saveDrawing, loadDrawing, updateDrawing
- Server actions follow same DB pattern as canvas-actions.ts
</verification>

<success_criteria>
Dependencies installed, simplification utility working with Douglas-Peucker at tolerance=1.0, and three server actions ready for frontend wiring. No runtime testing needed — TypeScript compilation proves correctness of imports and types.
</success_criteria>

<output>
After completion, create `.planning/phases/26-drawing-canvas-integration/26-01-SUMMARY.md`
</output>
