---
phase: 26-drawing-canvas-integration
plan: 04
type: execute
wave: 3
depends_on: ["26-03"]
files_modified:
  - src/components/canvas/canvas-toolbar.tsx
autonomous: false

must_haves:
  truths:
    - "Draw button visible in canvas toolbar for steps that support drawing"
    - "User verified the complete save + re-edit flow works end-to-end"
    - "Drawing PNG images display correctly on canvas at reasonable size"
    - "Double-click on drawing node opens EzyDraw with original drawing content"
    - "Existing postIt interactions work with no regressions"
  artifacts:
    - path: "src/components/canvas/canvas-toolbar.tsx"
      provides: "Draw button in toolbar for opening EzyDraw"
      contains: "onOpenDraw"
  key_links:
    - from: "src/components/canvas/canvas-toolbar.tsx"
      to: "src/components/canvas/react-flow-canvas.tsx"
      via: "onOpenDraw callback"
      pattern: "onOpenDraw"
---

<objective>
Add "Draw" button to the canvas toolbar and perform human verification of the complete drawing-canvas integration.

Purpose: Provide user-facing entry point for drawing and verify the full lifecycle works correctly before proceeding to Phase 27.

Output: Updated toolbar with draw button, verified integration.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-drawing-canvas-integration/26-RESEARCH.md
@.planning/phases/26-drawing-canvas-integration/26-03-SUMMARY.md

@src/components/canvas/canvas-toolbar.tsx
@src/components/canvas/react-flow-canvas.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Draw button to canvas toolbar</name>
  <files>
    src/components/canvas/canvas-toolbar.tsx
  </files>
  <action>
Read `src/components/canvas/canvas-toolbar.tsx` to understand the current toolbar layout and props.

Add a new prop `onOpenDraw?: () => void` to the toolbar component props.

Add a "Draw" button to the toolbar:
- Place it after the "+" (add postIt) button, separated by a thin divider
- Use a pencil/pen icon (simple inline SVG — a small drawing icon):
  ```
  <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
    <path d="M11.5 1.5l3 3-9 9H2.5v-3l9-9z" />
  </svg>
  ```
- Button styling matches existing toolbar buttons (same classes, same hover states)
- Tooltip: "Draw" (if toolbar uses tooltips) or aria-label: "Open drawing canvas"
- Only render the button if `onOpenDraw` is provided (some steps may not support drawing)
- On click: call `onOpenDraw()`

In `react-flow-canvas.tsx`, pass the `onOpenDraw` callback:
```typescript
<CanvasToolbar
  // ... existing props
  onOpenDraw={() => setEzyDrawState({ isOpen: true })}
/>
```
  </action>
  <verify>
    - `npx tsc --noEmit` passes with no type errors
    - Draw button appears in toolbar next to add button
    - Clicking Draw button opens EzyDraw modal
  </verify>
  <done>
    Draw button added to toolbar. Clicking it opens EzyDraw modal for creating a new drawing. Button only appears when onOpenDraw prop is provided.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify complete drawing-canvas integration</name>
  <files>src/components/canvas/react-flow-canvas.tsx</files>
  <action>
    Present the following verification checklist to the user. This is a human-verify checkpoint — no code changes needed.

    What was built:
    - EzyDraw drawings save as image nodes on ReactFlow canvas
    - Double-click drawing nodes to re-edit in EzyDraw
    - PNG images stored in Vercel Blob
    - Vector state stored in database for re-editing
    - Draw button in canvas toolbar

    Verification steps:
    1. Start dev server: `npm run dev`
    2. Navigate to any workshop step with canvas (e.g., Step 2 or Step 4)
    3. Test new drawing save flow:
       a. Click the "Draw" button in the canvas toolbar
       b. EzyDraw modal should open fullscreen
       c. Draw a simple sketch (freehand lines, a shape, some text)
       d. Click "Save" in the EzyDraw toolbar
       e. Modal should close
       f. A drawing image node should appear on the ReactFlow canvas at viewport center
       g. The drawing should display as a PNG image (not blank)
    4. Test re-edit flow:
       a. Double-click the drawing image node on canvas
       b. EzyDraw modal should open with the original drawing elements loaded
       c. Add something to the drawing (new shape or line)
       d. Click "Save"
       e. The drawing image on canvas should update with the new content
    5. Test persistence:
       a. Refresh the page
       b. The drawing image node should still appear on canvas (position preserved via autosave)
       c. Double-click it — original drawing elements should load for editing
    6. Test no regressions:
       a. Double-click on empty canvas area — should create a post-it (not open EzyDraw)
       b. Double-click on an existing post-it — should enter text editing mode
       c. Drag, select, delete post-its — all should work normally
    7. Check bundle size:
       a. Run `npm run build`
       b. Check that the main page bundle stays under 600KB (DrawingImageNode has no Konva imports)
  </action>
  <verify>User confirms all 7 verification steps pass</verify>
  <done>User types "approved" — all drawing-canvas integration flows verified working end-to-end</done>
</task>

</tasks>

<verification>
- Draw button visible in toolbar
- Full save flow: draw → save → image appears on canvas
- Full re-edit flow: double-click → edit → save → image updates
- Persistence: refresh preserves drawing nodes
- No regressions: post-it create, edit, drag, delete all work
- Bundle size: under 600KB (no Konva in DrawingImageNode)
</verification>

<success_criteria>
Human verifies that the complete drawing-canvas integration works end-to-end. All 6 success criteria from the phase are met:
1. Save drawing → appears as image node on canvas
2. Double-click drawing node → re-edit in EzyDraw
3. Vector state persists alongside PNG for re-editing
4. PNG stored in Vercel Blob (not base64 in database)
5. Drawings stored in stepArtifacts.drawings[] (separate from canvas nodes)
6. No database performance degradation
</success_criteria>

<output>
After completion, create `.planning/phases/26-drawing-canvas-integration/26-04-SUMMARY.md`
</output>
