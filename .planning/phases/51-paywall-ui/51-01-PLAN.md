---
phase: 51-paywall-ui
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/workshop/upgrade-dialog.tsx
  - src/components/workshop/step-navigation.tsx
  - src/components/layout/workshop-sidebar.tsx
  - src/components/layout/mobile-stepper.tsx
  - src/app/workshop/[sessionId]/layout.tsx
autonomous: true
requirements: [PAYW-02, PAYW-03]

must_haves:
  truths:
    - "Attempting to proceed past Step 6 with no credits opens an inline upgrade dialog (not a redirect)"
    - "Upgrade dialog shows outcome-framed headline 'Your Build Pack is 4 steps away' and progress context '6 of 10 steps complete'"
    - "Upgrade dialog has a 'Save and decide later' dismiss option that keeps user on Step 6"
    - "When user has credits, dialog shows 'Use 1 Credit to Unlock' CTA that calls consumeCredit() then advanceToNextStep() to reach Step 7"
    - "When user has no credits, dialog shows 'Get 1 Credit' CTA linking to pricing page with return_to=/workshop/{sessionId}/step/7 param"
    - "Steps 7-10 show a lock icon in both WorkshopSidebar and MobileStepper when workshop is not unlocked and not grandfathered"
  artifacts:
    - path: "src/components/workshop/upgrade-dialog.tsx"
      provides: "Controlled shadcn Dialog with outcome-framed paywall copy and dual CTAs"
      min_lines: 80
    - path: "src/components/workshop/step-navigation.tsx"
      provides: "paywallRequired handling in handleNext(), opens UpgradeDialog"
    - path: "src/components/layout/workshop-sidebar.tsx"
      provides: "Lock icon on Steps 7-10 when isPaywallLocked"
    - path: "src/components/layout/mobile-stepper.tsx"
      provides: "Lock icon on Steps 7-10 when isPaywallLocked"
    - path: "src/app/workshop/[sessionId]/layout.tsx"
      provides: "Computes isPaywallLocked from workshop data, passes to sidebar/stepper"
  key_links:
    - from: "src/components/workshop/step-navigation.tsx"
      to: "src/components/workshop/upgrade-dialog.tsx"
      via: "showUpgradeDialog state + UpgradeDialog component"
      pattern: "setShowUpgradeDialog\\(true\\)"
    - from: "src/components/workshop/upgrade-dialog.tsx"
      to: "src/actions/billing-actions.ts"
      via: "consumeCredit() import"
      pattern: "consumeCredit"
    - from: "src/app/workshop/[sessionId]/layout.tsx"
      to: "src/components/layout/workshop-sidebar.tsx"
      via: "isPaywallLocked prop"
      pattern: "isPaywallLocked"
---

<objective>
Build the inline upgrade dialog shown when a user attempts to proceed past Step 6 without credits, and add lock badges to Steps 7-10 in the sidebar and mobile stepper.

Purpose: This is the primary paywall UX — the moment a user hits the payment boundary. The dialog must be compelling (outcome-framed copy, progress context) and non-disruptive (inline dialog, not a page redirect). Lock badges in the stepper telegraph the gate before users reach it.

Output: `upgrade-dialog.tsx` component, modified `step-navigation.tsx` with paywallRequired handling, lock badges in both stepper components, `isPaywallLocked` computation in the workshop layout.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/51-paywall-ui/51-RESEARCH.md
@.planning/phases/50-credit-actions-server-enforcement/50-02-SUMMARY.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->
<!-- Executor should use these directly — no codebase exploration needed. -->

From src/actions/workshop-actions.ts:
```typescript
export async function advanceToNextStep(
  workshopId: string,
  currentStepId: string,
  nextStepId: string,
  sessionId: string
): Promise<{ nextStepOrder: number } | { paywallRequired: true; hasCredits: boolean; creditBalance: number }>
```

From src/actions/billing-actions.ts:
```typescript
export type ConsumeCreditResult =
  | { status: 'consumed'; newBalance: number }
  | { status: 'insufficient_credits' }
  | { status: 'already_unlocked' }
  | { status: 'grandfathered' }
  | { status: 'paywall_disabled' }
  | { status: 'error'; message: string };

export async function consumeCredit(workshopId: string): Promise<ConsumeCreditResult>;
export async function getCredits(): Promise<number>;
```

From src/lib/billing/paywall-config.ts:
```typescript
export const PAYWALL_CUTOFF_DATE: Date;
```

From src/components/workshop/step-navigation.tsx:
```typescript
interface StepNavigationProps {
  sessionId: string;
  workshopId: string;
  currentStepOrder: number;
  artifactConfirmed?: boolean;
  stepExplicitlyConfirmed?: boolean;
  stepStatus?: 'not_started' | 'in_progress' | 'complete' | 'needs_regeneration';
  isAdmin?: boolean;
  onReset?: () => void;
  onToggleGuideEditor?: () => void;
  isGuideEditing?: boolean;
  onAddGuide?: (position: { x: number; y: number }) => void;
  onSaveDefaultView?: () => void;
  onCompleteWorkshop?: () => void;
  isCompletingWorkshop?: boolean;
  workshopCompleted?: boolean;
  canCompleteWorkshop?: boolean;
}
```

From src/components/layout/workshop-sidebar.tsx:
```typescript
interface WorkshopSidebarProps {
  sessionId: string;
  workshopSteps: Array<{
    stepId: string;
    status: 'not_started' | 'in_progress' | 'complete' | 'needs_regeneration';
  }>;
}
```

From src/components/layout/mobile-stepper.tsx:
```typescript
interface MobileStepperProps {
  sessionId: string;
  workshopSteps: Array<{
    stepId: string;
    status: 'not_started' | 'in_progress' | 'complete' | 'needs_regeneration';
  }>;
}
```

From src/app/workshop/[sessionId]/layout.tsx:
```typescript
// session.workshop has all columns including creditConsumedAt and createdAt (Phase 47 schema)
// workshopSteps = session.workshop.steps.map(s => ({ stepId: s.stepId, status: s.status }))
// WorkshopSidebar and MobileStepper receive { sessionId, workshopSteps }
```

From src/lib/workshop/step-metadata.ts:
```typescript
export const STEPS: StepDefinition[];
// STEPS has 10 items with id, name, order, description
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create UpgradeDialog component and wire paywallRequired handling in StepNavigation</name>
  <files>
    src/components/workshop/upgrade-dialog.tsx
    src/components/workshop/step-navigation.tsx
  </files>
  <action>
**1. Create `src/components/workshop/upgrade-dialog.tsx`** — a 'use client' component:

Props interface:
```typescript
interface UpgradeDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  workshopId: string;
  sessionId: string;
  currentStepOrder: number;
  hasCredits: boolean;
  creditBalance: number;
}
```

Implementation:
- Use shadcn `Dialog` (controlled: `open` + `onOpenChange` props) from `@/components/ui/dialog`.
- Import `DialogContent`, `DialogHeader`, `DialogTitle`, `DialogDescription`, `DialogFooter` from shadcn dialog.
- Import `consumeCredit` from `@/actions/billing-actions` and `advanceToNextStep` from `@/actions/workshop-actions`.
- Import `STEPS` from `@/lib/workshop/step-metadata`.
- Import `Lock` from `lucide-react`.
- Import `toast` from `sonner`.
- Import `Button` from `@/components/ui/button`.
- Import `cn` from `@/lib/utils`.
- Import `Link` from `next/link`.

State: `const [isConsuming, setIsConsuming] = useState(false);`

**Dialog content (PAYW-03 outcome-framed copy):**
- Lock icon in olive circle at top (same style as PaywallOverlay: `h-14 w-14 rounded-full bg-olive-100 dark:bg-olive-900/50`)
- Headline: `"Your Build Pack is 4 steps away"` (h2, text-xl font-semibold)
- Sub-headline: `"You've completed 6 of 10 steps — you've done the hard part. Unlock the creation phase to turn your insights into a complete Build Pack."` (text-sm text-muted-foreground)
- Progress bar: simple 60% filled bar (6/10 steps) using div with olive bg. `<div className="w-full h-2 rounded-full bg-muted"><div className="h-2 rounded-full bg-olive-600 dark:bg-olive-500" style={{ width: '60%' }} /></div>`
- Label under progress bar: `"6 of 10 steps complete"` (text-xs text-muted-foreground text-center)

**CTAs (branched on `hasCredits`):**

When `hasCredits === true`:
- Credit balance note: `"You have {creditBalance} credit{s} available"` (text-sm, in a muted border box)
- Primary CTA (Button, size="lg", className="w-full"): `"Use 1 Credit to Unlock"` / `"Unlocking..."` when isConsuming
- Disable button when `isConsuming`

When `hasCredits === false`:
- Primary CTA (Button, size="lg", className="w-full"): `"Get 1 Credit — $79"` — wraps a Link to `/pricing?return_to=...` so the user returns to their workshop after purchase:
  ```tsx
  <Link
    href={`/pricing?return_to=${encodeURIComponent(`/workshop/${sessionId}/step/7`)}`}
    className={cn(buttonVariants({ size: 'lg' }), 'w-full text-center')}
  >
    Get 1 Credit — $79
  </Link>
  ```
  Import `buttonVariants` from `@/components/ui/button`.
- Secondary option text: `"Or save with the 3-credit pack — $149"` (text-xs text-muted-foreground text-center)

Always show dismiss: `<Button variant="ghost" onClick={() => onOpenChange(false)} className="w-full">Save and decide later</Button>`

**"Use 1 Credit" handler (`handleUseCredit`):**
```typescript
async function handleUseCredit() {
  setIsConsuming(true);
  try {
    const credit = await consumeCredit(workshopId);
    if (credit.status === 'consumed' || credit.status === 'already_unlocked' || credit.status === 'grandfathered' || credit.status === 'paywall_disabled') {
      // Credit consumed — re-call advanceToNextStep; gate now passes, redirect fires
      const currentStep = STEPS.find((s) => s.order === currentStepOrder);
      const nextStep = STEPS.find((s) => s.order === currentStepOrder + 1);
      if (currentStep && nextStep) {
        await advanceToNextStep(workshopId, currentStep.id, nextStep.id, sessionId);
      }
    } else if (credit.status === 'insufficient_credits') {
      toast.error('No credits available.');
    } else if (credit.status === 'error') {
      toast.error(credit.message ?? 'Something went wrong.');
    }
  } catch (error) {
    // Must rethrow NEXT_REDIRECT for navigation to work
    const digest = (error as Record<string, unknown>)?.digest;
    if (typeof digest === 'string' && digest.startsWith('NEXT_REDIRECT')) {
      throw error;
    }
    toast.error('Failed to unlock workshop. Please try again.');
  } finally {
    setIsConsuming(false);
  }
}
```

**CRITICAL:** The `advanceToNextStep()` second call will internally call `redirect()` which throws `NEXT_REDIRECT`. This is expected and must be rethrown. Do NOT wrap in a try/catch that swallows it.

Export the component as a named export: `export function UpgradeDialog(...)`.

**2. Modify `src/components/workshop/step-navigation.tsx`:**

Add new imports:
```typescript
import { UpgradeDialog } from '@/components/workshop/upgrade-dialog';
```

Add state variables inside `StepNavigation` function:
```typescript
const [showUpgradeDialog, setShowUpgradeDialog] = useState(false);
const [paywallState, setPaywallState] = useState<{ hasCredits: boolean; creditBalance: number } | null>(null);
```

Modify `handleNext()`: After `await advanceToNextStep(...)`, BEFORE the catch block, check the return value. The key insight: `advanceToNextStep()` either throws `NEXT_REDIRECT` (normal navigation) or returns a value (paywall). If execution reaches the line after `await`, it means the paywall path returned.

Replace the current handleNext body (lines 97-133) with:
```typescript
const handleNext = async () => {
  if (isNavigating || isLastStep) return;

  try {
    setIsNavigating(true);

    const currentStep = STEPS.find((s) => s.order === currentStepOrder);
    const nextStep = STEPS.find((s) => s.order === currentStepOrder + 1);

    if (!currentStep || !nextStep) {
      console.error('Step definitions not found');
      return;
    }

    const result = await advanceToNextStep(
      workshopId,
      currentStep.id,
      nextStep.id,
      sessionId
    );

    // If we reach here, redirect() did NOT fire — this is the paywall return
    if ('paywallRequired' in result && result.paywallRequired) {
      setPaywallState({ hasCredits: result.hasCredits, creditBalance: result.creditBalance });
      setShowUpgradeDialog(true);
      setIsNavigating(false);
      return;
    }
  } catch (error) {
    // redirect() throws NEXT_REDIRECT — must rethrow so Next.js handles navigation
    const digest = (error as Record<string, unknown>)?.digest;
    if (typeof digest === 'string' && digest.startsWith('NEXT_REDIRECT')) {
      throw error;
    }
    console.error('Failed to advance to next step:', error);
    toast.error('Failed to advance — please try again.');
    setIsNavigating(false);
  }
};
```

Add the `UpgradeDialog` component to the JSX return, OUTSIDE the existing div (as a sibling, wrapped in a fragment if needed):
```tsx
{showUpgradeDialog && paywallState && (
  <UpgradeDialog
    open={showUpgradeDialog}
    onOpenChange={setShowUpgradeDialog}
    workshopId={workshopId}
    sessionId={sessionId}
    currentStepOrder={currentStepOrder}
    hasCredits={paywallState.hasCredits}
    creditBalance={paywallState.creditBalance}
  />
)}
```

The return statement should wrap with `<>` fragment if needed to include both the existing `<div>` and the `UpgradeDialog`.
  </action>
  <verify>
    <automated>cd /Users/michaelchristie/devProjects/workshoppilot.ai && npx tsc --noEmit 2>&1 | head -30</automated>
  </verify>
  <done>
    - upgrade-dialog.tsx exists with UpgradeDialog named export
    - Dialog shows outcome-framed headline "Your Build Pack is 4 steps away", progress bar at 60%, "Save and decide later" dismiss
    - step-navigation.tsx handleNext() checks paywallRequired return and opens UpgradeDialog
    - When hasCredits=true, "Use 1 Credit to Unlock" CTA calls consumeCredit() then advanceToNextStep()
    - When hasCredits=false, "Get 1 Credit — $79" CTA links to /pricing?return_to=/workshop/{sessionId}/step/7
    - NEXT_REDIRECT is properly rethrown in both components
    - TypeScript compiles with zero errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Add lock badges to WorkshopSidebar and MobileStepper with isPaywallLocked from layout</name>
  <files>
    src/app/workshop/[sessionId]/layout.tsx
    src/components/layout/workshop-sidebar.tsx
    src/components/layout/mobile-stepper.tsx
  </files>
  <action>
**1. Modify `src/app/workshop/[sessionId]/layout.tsx`:**

Add import:
```typescript
import { PAYWALL_CUTOFF_DATE } from '@/lib/billing/paywall-config';
```

After the existing `workshopSteps` computation (line ~54-57), compute `isPaywallLocked`:
```typescript
// Paywall lock state for stepper badges
const PAYWALL_ENABLED = process.env.PAYWALL_ENABLED !== 'false';
const isUnlocked = session.workshop.creditConsumedAt !== null;
const isGrandfathered = !isUnlocked && session.workshop.createdAt < PAYWALL_CUTOFF_DATE;
const isPaywallLocked = PAYWALL_ENABLED && !isUnlocked && !isGrandfathered;
```

Note: `session.workshop.creditConsumedAt` and `session.workshop.createdAt` are already returned by the Drizzle `with:` query (no `columns:` restriction exists — all columns returned). No schema change or query change needed.

Pass `isPaywallLocked` to both sidebar/stepper components:
```tsx
<WorkshopSidebar sessionId={sessionId} workshopSteps={workshopSteps} isPaywallLocked={isPaywallLocked} />
```
```tsx
<MobileStepper sessionId={sessionId} workshopSteps={workshopSteps} isPaywallLocked={isPaywallLocked} />
```

**2. Modify `src/components/layout/workshop-sidebar.tsx`:**

Add `Lock` to the lucide-react import:
```typescript
import { Check, ChevronLeft, ChevronRight, Lock } from 'lucide-react';
```

Update `WorkshopSidebarProps` interface:
```typescript
interface WorkshopSidebarProps {
  sessionId: string;
  workshopSteps: Array<{
    stepId: string;
    status: 'not_started' | 'in_progress' | 'complete' | 'needs_regeneration';
  }>;
  isPaywallLocked?: boolean;
}
```

Update destructured props:
```typescript
export function WorkshopSidebar({ sessionId, workshopSteps, isPaywallLocked }: WorkshopSidebarProps) {
```

Inside the `STEPS.map()` callback (around line 191), add:
```typescript
const isLocked = isPaywallLocked && step.order >= 7;
```

Modify the step indicator div to show a Lock icon when locked. Replace the existing step indicator content (the `{isComplete ? <Check .../> : step.order}` block) with:
```tsx
{isLocked ? (
  <Lock className="h-3 w-3" />
) : isComplete ? (
  <Check className="h-3 w-3" />
) : (
  step.order
)}
```

Add locked styling to the step indicator div's className:
```typescript
isLocked && !isComplete && !isCurrent &&
  'border bg-background text-muted-foreground opacity-60',
```

This ensures locked steps (7-10) show with a lock icon and reduced opacity. Completed steps (if somehow complete) still show the check. Current step keeps its active styling.

IMPORTANT: Keep the existing `isAccessible` logic and Link/div branching unchanged. Locked steps that are accessible (e.g., `in_progress` status) remain navigable links — they navigate to the PaywallOverlay (Phase 50's direct URL handler). Steps that are `not_started` remain non-navigable as before.

**3. Modify `src/components/layout/mobile-stepper.tsx`:**

Add `Lock` to the lucide-react import:
```typescript
import { ChevronDown, Check, Lock } from 'lucide-react';
```

Update `MobileStepperProps` interface:
```typescript
interface MobileStepperProps {
  sessionId: string;
  workshopSteps: Array<{
    stepId: string;
    status: 'not_started' | 'in_progress' | 'complete' | 'needs_regeneration';
  }>;
  isPaywallLocked?: boolean;
}
```

Update destructured props:
```typescript
export function MobileStepper({ sessionId, workshopSteps, isPaywallLocked }: MobileStepperProps) {
```

Inside the `STEPS.map()` callback (around line 66), add:
```typescript
const isLocked = isPaywallLocked && step.order >= 7;
```

Apply the same lock icon replacement as WorkshopSidebar — replace the step indicator content:
```tsx
{isLocked ? (
  <Lock className="h-3 w-3" />
) : isComplete ? (
  <Check className="h-3 w-3" />
) : (
  step.order
)}
```

Add the same locked opacity styling to the step indicator div className in MobileStepper.

Keep `isAccessible` logic unchanged — same reasoning as WorkshopSidebar.
  </action>
  <verify>
    <automated>cd /Users/michaelchristie/devProjects/workshoppilot.ai && npx tsc --noEmit 2>&1 | head -30</automated>
  </verify>
  <done>
    - Workshop layout computes isPaywallLocked from creditConsumedAt, createdAt, and PAYWALL_CUTOFF_DATE
    - isPaywallLocked passed to both WorkshopSidebar and MobileStepper
    - Steps 7-10 show Lock icon when isPaywallLocked=true in both sidebar and mobile stepper
    - Completed steps still show Check icon (not lock)
    - Navigability unchanged (isAccessible logic preserved)
    - TypeScript compiles with zero errors
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npx next build` completes without errors
3. `upgrade-dialog.tsx` exports UpgradeDialog with all required props
4. `step-navigation.tsx` handles `paywallRequired` return from `advanceToNextStep()` and opens UpgradeDialog
5. Workshop layout computes `isPaywallLocked` and passes to sidebar/stepper
6. Both sidebar and mobile stepper render Lock icon for Steps 7-10 when locked
7. UpgradeDialog has "Save and decide later" dismiss option
8. UpgradeDialog uses outcome-framed copy per PAYW-03
</verification>

<success_criteria>
- Clicking "Next" on Step 6 with zero credits opens the upgrade dialog inline (no page redirect)
- Dialog headline reads "Your Build Pack is 4 steps away" with progress bar at 60%
- Dialog has "Save and decide later" ghost button that closes it
- When user has credits: "Use 1 Credit to Unlock" → consumeCredit() → advanceToNextStep() → Step 7
- When user has no credits: "Get 1 Credit — $79" links to /pricing?return_to=/workshop/{sessionId}/step/7
- Steps 7-10 show lock icon in sidebar when workshop is not unlocked
- Steps 7-10 show lock icon in mobile stepper when workshop is not unlocked
- All TypeScript types compile cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/51-paywall-ui/51-01-SUMMARY.md`
</output>
