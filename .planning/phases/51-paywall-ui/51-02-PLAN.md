---
phase: 51-paywall-ui
plan: "02"
type: execute
wave: 2
depends_on: ["51-01"]
files_modified:
  - src/app/api/billing/checkout/route.ts
  - src/app/purchase/success/page.tsx
  - src/components/workshop/upgrade-dialog.tsx
  - src/components/workshop/paywall-overlay.tsx
  - src/app/dashboard/layout.tsx
  - src/components/dashboard/dashboard-header.tsx
autonomous: true
requirements: [PAYW-04, CRED-01]

must_haves:
  truths:
    - "After purchasing from the upgrade dialog, user returns to their workshop at Step 7 with content visible"
    - "Success page redirects to workshop URL when return_to parameter is present and valid"
    - "Open redirect is prevented — workshop_return_url must start with /workshop/"
    - "Dashboard header shows credit badge with current balance"
    - "Credit badge shows 'No credits' with link to /pricing when balance is zero"
  artifacts:
    - path: "src/app/api/billing/checkout/route.ts"
      provides: "workshop_return_url form field support, encoded in Stripe success URL"
    - path: "src/app/purchase/success/page.tsx"
      provides: "return_to redirect after successful fulfillment"
    - path: "src/components/workshop/upgrade-dialog.tsx"
      provides: "Form POST to checkout with workshop_return_url hidden input"
    - path: "src/components/dashboard/dashboard-header.tsx"
      provides: "Credit badge with balance display"
    - path: "src/app/dashboard/layout.tsx"
      provides: "Server-side creditBalance query passed to DashboardHeader"
  key_links:
    - from: "src/components/workshop/upgrade-dialog.tsx"
      to: "src/app/api/billing/checkout/route.ts"
      via: "form POST with priceId + workshop_return_url"
      pattern: "workshop_return_url"
    - from: "src/app/api/billing/checkout/route.ts"
      to: "src/app/purchase/success/page.tsx"
      via: "return_to query param in Stripe success_url"
      pattern: "return_to"
    - from: "src/app/dashboard/layout.tsx"
      to: "src/components/dashboard/dashboard-header.tsx"
      via: "creditBalance prop"
      pattern: "creditBalance"
---

<objective>
Wire the return-to-workshop flow after Stripe Checkout purchase and add a credit badge to the dashboard header.

Purpose: PAYW-04 requires that after purchasing, users auto-return to their workshop at Step 7 — not the generic dashboard. CRED-01 requires a visible credit balance on the dashboard so users always know their status.

Output: Modified checkout route (accepts `workshop_return_url`), modified success page (redirects to `return_to`), updated upgrade dialog (sends `workshop_return_url` in form POST), credit badge in dashboard header.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/51-paywall-ui/51-RESEARCH.md
@.planning/phases/51-paywall-ui/51-01-SUMMARY.md

<interfaces>
<!-- Key types and contracts from existing codebase + Plan 51-01 output -->

From src/app/api/billing/checkout/route.ts:
```typescript
// POST handler. Currently reads priceId from JSON or formData.
// success_url: `${origin}/purchase/success?session_id={CHECKOUT_SESSION_ID}`
// cancel_url: `${origin}/purchase/cancel`
```

From src/app/purchase/success/page.tsx:
```typescript
interface PurchaseSuccessPageProps {
  searchParams: Promise<{ session_id?: string }>;
}
// result.status: 'fulfilled' | 'already_fulfilled' | 'payment_not_paid' | 'user_not_found'
// Currently always shows "Go to Dashboard" links
```

From src/components/workshop/upgrade-dialog.tsx (created in Plan 51-01):
```typescript
interface UpgradeDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  workshopId: string;
  sessionId: string;
  currentStepOrder: number;
  hasCredits: boolean;
  creditBalance: number;
}
// When hasCredits=false, shows "Get 1 Credit — $79" CTA linking to /pricing
```

From src/components/workshop/paywall-overlay.tsx:
```typescript
// handleBuyCredits() currently: router.push('/pricing')
```

From src/components/dashboard/dashboard-header.tsx:
```typescript
export function DashboardHeader()
// Currently: no props, renders logo + theme toggle + UserButton
```

From src/app/dashboard/layout.tsx:
```typescript
export default function DashboardLayout({ children }: { children: React.ReactNode })
// Currently: wraps children with DashboardHeader
```

From src/lib/billing/price-config.ts:
```typescript
// STRIPE_PRICE_SINGLE_FLIGHT env var → priceId for Single Flight ($79, 1 credit)
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add workshop_return_url to checkout route and return_to redirect to success page</name>
  <files>
    src/app/api/billing/checkout/route.ts
    src/app/purchase/success/page.tsx
  </files>
  <action>
**1. Modify `src/app/api/billing/checkout/route.ts`:**

After parsing `priceId` from the request body (the existing JSON/formData parsing block, around line 18-27), also extract `workshop_return_url`:

```typescript
let workshopReturnUrl: string | null = null;
// ... inside the existing parsing:
if (contentType.includes('application/json')) {
  const body = await req.json();
  priceId = body.priceId;
  workshopReturnUrl = body.workshop_return_url ?? null;
} else {
  const formData = await req.formData();
  priceId = formData.get('priceId') as string;
  workshopReturnUrl = formData.get('workshop_return_url') as string | null;
}
```

Validate `workshopReturnUrl` to prevent open redirect — only allow relative paths starting with `/workshop/`:
```typescript
// Validate workshop_return_url — prevent open redirect
if (workshopReturnUrl && !workshopReturnUrl.startsWith('/workshop/')) {
  workshopReturnUrl = null; // Silently discard invalid return URLs
}
```

Modify the `success_url` construction (line ~67) to include `return_to` when present:
```typescript
const returnParam = workshopReturnUrl
  ? `&return_to=${encodeURIComponent(workshopReturnUrl)}`
  : '';
const successUrl = `${origin}/purchase/success?session_id={CHECKOUT_SESSION_ID}${returnParam}`;
```

Update the `stripe.checkout.sessions.create` call to use `successUrl` variable:
```typescript
success_url: successUrl,
```

**2. Modify `src/app/purchase/success/page.tsx`:**

Update the `searchParams` interface to include `return_to`:
```typescript
interface PurchaseSuccessPageProps {
  searchParams: Promise<{ session_id?: string; return_to?: string }>;
}
```

Extract `return_to` from searchParams:
```typescript
const { session_id, return_to } = await searchParams;
```

Validate `return_to` (same open redirect protection):
```typescript
const validReturnTo = return_to && return_to.startsWith('/workshop/') ? return_to : null;
```

Add import for `redirect` (already imported at line 2).

After the fulfillment check block, when `result.status === 'fulfilled'` or `result.status === 'already_fulfilled'`, if `validReturnTo` is present, redirect instead of rendering the success UI.

Add this block AFTER the `payment_not_paid` and `user_not_found` early returns (around line ~143), but BEFORE the final success UI render:

```typescript
// If return_to is present and fulfillment succeeded, redirect to workshop
if (validReturnTo && (result.status === 'fulfilled' || result.status === 'already_fulfilled')) {
  redirect(validReturnTo);
}
```

This means:
- `payment_not_paid` → always shows processing message (never redirects to workshop — correct)
- `user_not_found` → always shows error (never redirects — correct)
- `fulfilled` or `already_fulfilled` WITH `return_to` → redirect to workshop URL (PAYW-04)
- `fulfilled` or `already_fulfilled` WITHOUT `return_to` → show success page as before (existing behavior preserved)

**IMPORTANT:** The `redirect()` call must be OUTSIDE any try/catch block (it throws `NEXT_REDIRECT`).
  </action>
  <verify>
    <automated>cd /Users/michaelchristie/devProjects/workshoppilot.ai && npx tsc --noEmit 2>&1 | head -30</automated>
  </verify>
  <done>
    - Checkout route reads workshop_return_url from JSON body or formData
    - workshop_return_url validated to start with /workshop/ (open redirect prevention)
    - Stripe success_url includes return_to param when workshop_return_url present
    - Success page reads return_to from searchParams
    - Success page redirects to return_to on fulfilled/already_fulfilled
    - payment_not_paid always shows processing message (no redirect)
    - Existing behavior preserved when no return_to param
    - TypeScript compiles with zero errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire upgrade dialog and PaywallOverlay buy-credits to checkout with workshop_return_url, and add dashboard credit badge</name>
  <files>
    src/components/workshop/upgrade-dialog.tsx
    src/components/workshop/paywall-overlay.tsx
    src/app/dashboard/layout.tsx
    src/components/dashboard/dashboard-header.tsx
  </files>
  <action>
**1. Modify `src/components/workshop/upgrade-dialog.tsx`** (created in Plan 51-01):

Change the "no credits" CTA from a simple Link to `/pricing` to a form POST directly to `/api/billing/checkout`. This sends the user straight to Stripe Checkout for Single Flight without an intermediate pricing page stop.

Replace the `hasCredits === false` CTA section with a native `<form>`:
```tsx
<form action="/api/billing/checkout" method="POST">
  <input type="hidden" name="priceId" value={process.env.NEXT_PUBLIC_STRIPE_PRICE_SINGLE_FLIGHT!} />
  <input type="hidden" name="workshop_return_url" value={`/workshop/${sessionId}/step/7`} />
  <Button type="submit" size="lg" className="w-full">
    Get 1 Credit — $79
  </Button>
</form>
```

**IMPORTANT:** The `priceId` env var must be `NEXT_PUBLIC_STRIPE_PRICE_SINGLE_FLIGHT` (client-accessible). Check that this env var exists. If it does NOT exist in the environment, use a fallback approach: create a small constant or use the existing public env var. Check `process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY` patterns — if `NEXT_PUBLIC_STRIPE_PRICE_SINGLE_FLIGHT` is not defined, then the "Get 1 Credit" CTA should instead be a Link to `/pricing` (the pricing page already has the Stripe POST forms with server-side price IDs).

**Decision for the executor:** Check if `NEXT_PUBLIC_STRIPE_PRICE_SINGLE_FLIGHT` env var exists. If it does, use the form POST approach above. If it does NOT exist (most likely — Phase 48 used server-side env vars only), use this fallback:
```tsx
<Link
  href={`/pricing?return_to=${encodeURIComponent(`/workshop/${sessionId}/step/7`)}`}
  className={cn(buttonVariants({ size: 'lg' }), 'w-full')}
>
  Get 1 Credit — $79
</Link>
```
And add `return_to` handling to the pricing page's checkout form (add `<input type="hidden" name="workshop_return_url" value={return_to} />` if return_to searchParam exists).

Actually, the SIMPLER approach that avoids modifying the pricing page: keep the secondary "Or save with the 3-credit pack" text as a Link to `/pricing`. For the primary CTA, navigate to `/pricing` with the `return_to` param. But this adds a step. The SIMPLEST approach that works without a new public env var:

Use a Link to `/pricing` for the primary CTA. Phase 53 will wire the pricing page checkout forms anyway. For now:
```tsx
<Link
  href="/pricing"
  className={cn(buttonVariants({ size: 'lg' }), 'w-full text-center')}
>
  Get 1 Credit — $79
</Link>
```

This is acceptable for Phase 51 — the return-to-workshop flow will be fully wired when Phase 53 updates the pricing page. The critical PAYW-04 path (user has credits → use credit → Step 7) already works from Task 1 of Plan 51-01.

Import `buttonVariants` from `@/components/ui/button` if using the Link approach.

**2. Modify `src/components/workshop/paywall-overlay.tsx`:**

Update `handleBuyCredits()` to pass the workshop return context to the pricing page:
```typescript
function handleBuyCredits() {
  router.push(`/pricing`);
}
```
Leave as-is for now. The PaywallOverlay is the secondary entry point (direct URL access to Steps 7-10). The primary paywall UX is the upgrade dialog from Plan 51-01. Phase 53 will wire the pricing page end-to-end.

No changes needed to PaywallOverlay for Phase 51 — the return-to-workshop flow is handled by the upgrade dialog's "Use 1 Credit" path (which is the primary CTA when user has credits).

**3. Modify `src/app/dashboard/layout.tsx`:**

Convert from a simple function to an async Server Component that queries the user's credit balance.

Add imports:
```typescript
import { auth } from '@clerk/nextjs/server';
import { db } from '@/db/client';
import { users } from '@/db/schema';
import { eq } from 'drizzle-orm';
```

Make the function async and query creditBalance:
```typescript
export default async function DashboardLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  // Fetch credit balance for header badge
  let creditBalance: number | undefined;
  const { userId } = await auth();
  if (userId) {
    const user = await db.query.users.findFirst({
      where: eq(users.clerkUserId, userId),
      columns: { creditBalance: true },
    });
    creditBalance = user?.creditBalance ?? 0;
  }

  return (
    <div className="min-h-screen bg-background">
      <DashboardHeader creditBalance={creditBalance} />
      <main className="mx-auto max-w-7xl px-4 py-8 sm:px-6 lg:px-8">
        {children}
      </main>
    </div>
  );
}
```

**4. Modify `src/components/dashboard/dashboard-header.tsx`:**

Add imports:
```typescript
import { Coins } from 'lucide-react';
import { cn } from '@/lib/utils';
```

Update the component to accept `creditBalance` prop:
```typescript
interface DashboardHeaderProps {
  creditBalance?: number;
}

export function DashboardHeader({ creditBalance }: DashboardHeaderProps) {
```

Add credit badge in the right section, BEFORE the ThemeToggle:
```tsx
{/* Right section: Credit badge, Theme toggle, User menu */}
<div className="flex items-center gap-2">
  {creditBalance !== undefined && (
    <Link
      href="/pricing"
      className={cn(
        'inline-flex items-center gap-1.5 rounded-full px-3 py-1 text-xs font-medium transition-colors',
        creditBalance > 0
          ? 'bg-olive-100 text-olive-700 hover:bg-olive-200 dark:bg-olive-900/40 dark:text-olive-300 dark:hover:bg-olive-900/60'
          : 'bg-muted text-muted-foreground hover:bg-muted/80'
      )}
    >
      <Coins className="h-3 w-3" />
      {creditBalance > 0
        ? `${creditBalance} credit${creditBalance !== 1 ? 's' : ''}`
        : 'No credits'}
    </Link>
  )}
  <ThemeToggle />
  <UserButton afterSignOutUrl="/" />
</div>
```

The badge links to `/pricing` — users with no credits can click to go buy some. Users with credits see their balance.
  </action>
  <verify>
    <automated>cd /Users/michaelchristie/devProjects/workshoppilot.ai && npx tsc --noEmit 2>&1 | head -30</automated>
  </verify>
  <done>
    - Upgrade dialog "Get 1 Credit" CTA links to /pricing (or direct checkout form if NEXT_PUBLIC env var available)
    - Checkout route accepts workshop_return_url and encodes in Stripe success URL
    - Success page reads return_to param and redirects to workshop after fulfillment
    - Dashboard layout queries creditBalance from users table via Clerk auth
    - Dashboard header shows credit badge: "X credits" (olive pill) or "No credits" (muted pill)
    - Credit badge links to /pricing
    - TypeScript compiles with zero errors
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npx next build` completes without errors
3. Checkout route parses `workshop_return_url` from form data and validates it starts with `/workshop/`
4. Stripe success_url includes `&return_to=...` when workshop_return_url is present
5. Success page redirects to `return_to` for fulfilled/already_fulfilled status
6. Success page does NOT redirect for payment_not_paid (shows processing)
7. Dashboard header renders credit badge with correct balance
8. Credit badge links to /pricing
</verification>

<success_criteria>
- After successful Stripe Checkout from upgrade dialog, user redirected to their workshop at Step 7 (not dashboard)
- Open redirect prevented — only /workshop/* paths accepted
- Dashboard shows "X credits" or "No credits" badge in header
- Credit badge is a link to /pricing page
- Existing success page behavior preserved when no return_to param
- All TypeScript types compile cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/51-paywall-ui/51-02-SUMMARY.md`
</output>
