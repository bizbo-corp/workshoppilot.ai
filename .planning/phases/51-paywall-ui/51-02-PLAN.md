---
phase: 51-paywall-ui
plan: "02"
type: execute
wave: 2
depends_on: ["51-01"]
files_modified:
  - src/app/api/billing/checkout/route.ts
  - src/app/purchase/success/page.tsx
  - src/app/pricing/page.tsx
  - src/components/workshop/paywall-overlay.tsx
  - src/app/dashboard/layout.tsx
  - src/components/dashboard/dashboard-header.tsx
autonomous: true
requirements: [PAYW-04, CRED-01]

must_haves:
  truths:
    - "After purchasing from the upgrade dialog (both has-credits and zero-credit paths), user returns to their workshop at Step 7 with content visible"
    - "Success page redirects to workshop URL when return_to parameter is present and valid"
    - "Open redirect is prevented — workshop_return_url must start with /workshop/"
    - "Pricing page reads return_to searchParam and includes it as workshop_return_url hidden input in checkout forms"
    - "Dashboard header shows credit badge with current balance"
    - "Credit badge shows 'No credits' with link to /pricing when balance is zero"
  artifacts:
    - path: "src/app/api/billing/checkout/route.ts"
      provides: "workshop_return_url form field support, encoded in Stripe success URL"
    - path: "src/app/purchase/success/page.tsx"
      provides: "return_to redirect after successful fulfillment"
    - path: "src/app/pricing/page.tsx"
      provides: "Reads return_to searchParam and forwards as workshop_return_url hidden input in checkout forms"
    - path: "src/components/dashboard/dashboard-header.tsx"
      provides: "Credit badge with balance display"
    - path: "src/app/dashboard/layout.tsx"
      provides: "Server-side creditBalance query passed to DashboardHeader"
  key_links:
    - from: "src/components/workshop/upgrade-dialog.tsx"
      to: "src/app/pricing/page.tsx"
      via: "Link href with return_to query param"
      pattern: "return_to"
    - from: "src/app/api/billing/checkout/route.ts"
      to: "src/app/purchase/success/page.tsx"
      via: "return_to query param in Stripe success_url"
      pattern: "return_to"
    - from: "src/app/pricing/page.tsx"
      to: "src/app/api/billing/checkout/route.ts"
      via: "workshop_return_url hidden input in checkout form"
      pattern: "workshop_return_url"
    - from: "src/app/dashboard/layout.tsx"
      to: "src/components/dashboard/dashboard-header.tsx"
      via: "creditBalance prop"
      pattern: "creditBalance"
---

<objective>
Wire the return-to-workshop flow after Stripe Checkout purchase and add a credit badge to the dashboard header.

Purpose: PAYW-04 requires that after purchasing, users auto-return to their workshop at Step 7 — not the generic dashboard. CRED-01 requires a visible credit balance on the dashboard so users always know their status.

Output: Modified checkout route (accepts `workshop_return_url`), modified success page (redirects to `return_to`), updated pricing page (reads `return_to` and forwards as `workshop_return_url` hidden input), updated PaywallOverlay (passes `return_to` to pricing), credit badge in dashboard header.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/51-paywall-ui/51-RESEARCH.md
@.planning/phases/51-paywall-ui/51-01-SUMMARY.md

<interfaces>
<!-- Key types and contracts from existing codebase + Plan 51-01 output -->

From src/app/api/billing/checkout/route.ts:
```typescript
// POST handler. Currently reads priceId from JSON or formData.
// success_url: `${origin}/purchase/success?session_id={CHECKOUT_SESSION_ID}`
// cancel_url: `${origin}/purchase/cancel`
```

From src/app/purchase/success/page.tsx:
```typescript
interface PurchaseSuccessPageProps {
  searchParams: Promise<{ session_id?: string }>;
}
// result.status: 'fulfilled' | 'already_fulfilled' | 'payment_not_paid' | 'user_not_found'
// Currently always shows "Go to Dashboard" links
```

From src/components/workshop/upgrade-dialog.tsx (created in Plan 51-01):
```typescript
interface UpgradeDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  workshopId: string;
  sessionId: string;
  currentStepOrder: number;
  hasCredits: boolean;
  creditBalance: number;
}
// When hasCredits=false, shows "Get 1 Credit — $79" CTA linking to /pricing?return_to=/workshop/{sessionId}/step/7
```

From src/components/workshop/paywall-overlay.tsx:
```typescript
// handleBuyCredits() currently: router.push('/pricing')
```

From src/components/dashboard/dashboard-header.tsx:
```typescript
export function DashboardHeader()
// Currently: no props, renders logo + theme toggle + UserButton
```

From src/app/dashboard/layout.tsx:
```typescript
export default function DashboardLayout({ children }: { children: React.ReactNode })
// Currently: wraps children with DashboardHeader
```

From src/app/pricing/page.tsx:
```typescript
// Server Component. Each tier has a <form method="POST" action="/api/billing/checkout">
// with <input type="hidden" name="priceId" value={tier.priceId} />.
// Currently does NOT accept or forward any return_to searchParam.
// searchParams available via: interface PricingPageProps { searchParams: Promise<{ return_to?: string }> }
```

From src/lib/billing/price-config.ts:
```typescript
// STRIPE_PRICE_SINGLE_FLIGHT env var → priceId for Single Flight ($79, 1 credit)
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add workshop_return_url to checkout route and return_to redirect to success page</name>
  <files>
    src/app/api/billing/checkout/route.ts
    src/app/purchase/success/page.tsx
  </files>
  <action>
**1. Modify `src/app/api/billing/checkout/route.ts`:**

After parsing `priceId` from the request body (the existing JSON/formData parsing block, around line 18-27), also extract `workshop_return_url`:

```typescript
let workshopReturnUrl: string | null = null;
// ... inside the existing parsing:
if (contentType.includes('application/json')) {
  const body = await req.json();
  priceId = body.priceId;
  workshopReturnUrl = body.workshop_return_url ?? null;
} else {
  const formData = await req.formData();
  priceId = formData.get('priceId') as string;
  workshopReturnUrl = formData.get('workshop_return_url') as string | null;
}
```

Validate `workshopReturnUrl` to prevent open redirect — only allow relative paths starting with `/workshop/`:
```typescript
// Validate workshop_return_url — prevent open redirect
if (workshopReturnUrl && !workshopReturnUrl.startsWith('/workshop/')) {
  workshopReturnUrl = null; // Silently discard invalid return URLs
}
```

Modify the `success_url` construction (line ~67) to include `return_to` when present:
```typescript
const returnParam = workshopReturnUrl
  ? `&return_to=${encodeURIComponent(workshopReturnUrl)}`
  : '';
const successUrl = `${origin}/purchase/success?session_id={CHECKOUT_SESSION_ID}${returnParam}`;
```

Update the `stripe.checkout.sessions.create` call to use `successUrl` variable:
```typescript
success_url: successUrl,
```

**2. Modify `src/app/purchase/success/page.tsx`:**

Update the `searchParams` interface to include `return_to`:
```typescript
interface PurchaseSuccessPageProps {
  searchParams: Promise<{ session_id?: string; return_to?: string }>;
}
```

Extract `return_to` from searchParams:
```typescript
const { session_id, return_to } = await searchParams;
```

Validate `return_to` (same open redirect protection):
```typescript
const validReturnTo = return_to && return_to.startsWith('/workshop/') ? return_to : null;
```

Add import for `redirect` (already imported at line 2).

After the fulfillment check block, when `result.status === 'fulfilled'` or `result.status === 'already_fulfilled'`, if `validReturnTo` is present, redirect instead of rendering the success UI.

Add this block AFTER the `payment_not_paid` and `user_not_found` early returns (around line ~143), but BEFORE the final success UI render:

```typescript
// If return_to is present and fulfillment succeeded, redirect to workshop
if (validReturnTo && (result.status === 'fulfilled' || result.status === 'already_fulfilled')) {
  redirect(validReturnTo);
}
```

This means:
- `payment_not_paid` → always shows processing message (never redirects to workshop — correct)
- `user_not_found` → always shows error (never redirects — correct)
- `fulfilled` or `already_fulfilled` WITH `return_to` → redirect to workshop URL (PAYW-04)
- `fulfilled` or `already_fulfilled` WITHOUT `return_to` → show success page as before (existing behavior preserved)

**IMPORTANT:** The `redirect()` call must be OUTSIDE any try/catch block (it throws `NEXT_REDIRECT`).
  </action>
  <verify>
    <automated>cd /Users/michaelchristie/devProjects/workshoppilot.ai && npx tsc --noEmit 2>&1 | head -30</automated>
    <automated>grep -c "validReturnTo" src/app/purchase/success/page.tsx</automated>
    <automated>cd /Users/michaelchristie/devProjects/workshoppilot.ai && grep -n "payment_not_paid\|validReturnTo.*redirect\|redirect.*validReturnTo" src/app/purchase/success/page.tsx</automated>
  </verify>
  <done>
    - redirect block with validReturnTo appears AFTER payment_not_paid early return (confirmed by line numbers in verify)
    - Checkout route reads workshop_return_url from JSON body or formData
    - workshop_return_url validated to start with /workshop/ (open redirect prevention)
    - Stripe success_url includes return_to param when workshop_return_url present
    - Success page reads return_to from searchParams
    - Success page redirects to return_to on fulfilled/already_fulfilled
    - payment_not_paid always shows processing message (no redirect)
    - Existing behavior preserved when no return_to param
    - TypeScript compiles with zero errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire pricing page return_to forwarding, PaywallOverlay return_to, and add dashboard credit badge</name>
  <files>
    src/app/pricing/page.tsx
    src/components/workshop/paywall-overlay.tsx
    src/app/dashboard/layout.tsx
    src/components/dashboard/dashboard-header.tsx
  </files>
  <action>
**1. Modify `src/app/pricing/page.tsx`** — wire `return_to` searchParam into checkout forms:

The upgrade dialog (Plan 51-01) links to `/pricing?return_to=/workshop/{sessionId}/step/7`. The pricing page must read this param and forward it as a `workshop_return_url` hidden input in all checkout forms, so Stripe Checkout → success page → workshop redirect works for the zero-credit purchase path.

Update the component to accept searchParams:
```typescript
interface PricingPageProps {
  searchParams: Promise<{ return_to?: string }>;
}

export default async function PricingPage({ searchParams }: PricingPageProps) {
  const { return_to } = await searchParams;

  // Validate return_to — prevent open redirect (same check as checkout route)
  const validReturnTo = return_to && return_to.startsWith('/workshop/') ? return_to : null;

  const tiers = getTiers();
  // ... rest of component
```

In the tier checkout form (around line 132), add the `workshop_return_url` hidden input when `validReturnTo` is present:
```tsx
<form method="POST" action="/api/billing/checkout">
  <input type="hidden" name="priceId" value={tier.priceId} />
  {validReturnTo && (
    <input type="hidden" name="workshop_return_url" value={validReturnTo} />
  )}
  <button type="submit" ...>{tier.cta}</button>
</form>
```

This completes the zero-credit PAYW-04 path: upgrade dialog → `/pricing?return_to=...` → checkout form with `workshop_return_url` → Stripe → success page with `return_to` → redirect to workshop.

**2. Modify `src/components/workshop/paywall-overlay.tsx`:**

Update `handleBuyCredits()` to include `return_to` in the pricing page URL. PaywallOverlay has access to `sessionId` (from props or route params). Pass it through:
```typescript
function handleBuyCredits() {
  router.push(`/pricing?return_to=${encodeURIComponent(`/workshop/${sessionId}/step/7`)}`);
}
```

If PaywallOverlay does not have `sessionId` in scope, extract it from the URL: `const sessionId = pathname.split('/')[2]` (from `usePathname()`). Check the component's existing props/hooks first.

This ensures users who hit the PaywallOverlay directly (via URL to Steps 7-10) also return to their workshop after purchasing.

**3. Modify `src/app/dashboard/layout.tsx`:**

Convert from a simple function to an async Server Component that queries the user's credit balance.

Add imports:
```typescript
import { auth } from '@clerk/nextjs/server';
import { db } from '@/db/client';
import { users } from '@/db/schema';
import { eq } from 'drizzle-orm';
```

Make the function async and query creditBalance:
```typescript
export default async function DashboardLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  // Fetch credit balance for header badge
  let creditBalance: number | undefined;
  const { userId } = await auth();
  if (userId) {
    const user = await db.query.users.findFirst({
      where: eq(users.clerkUserId, userId),
      columns: { creditBalance: true },
    });
    creditBalance = user?.creditBalance ?? 0;
  }

  return (
    <div className="min-h-screen bg-background">
      <DashboardHeader creditBalance={creditBalance} />
      <main className="mx-auto max-w-7xl px-4 py-8 sm:px-6 lg:px-8">
        {children}
      </main>
    </div>
  );
}
```

**4. Modify `src/components/dashboard/dashboard-header.tsx`:**

Add imports:
```typescript
import { Coins } from 'lucide-react';
import { cn } from '@/lib/utils';
```

Update the component to accept `creditBalance` prop:
```typescript
interface DashboardHeaderProps {
  creditBalance?: number;
}

export function DashboardHeader({ creditBalance }: DashboardHeaderProps) {
```

Add credit badge in the right section, BEFORE the ThemeToggle:
```tsx
{/* Right section: Credit badge, Theme toggle, User menu */}
<div className="flex items-center gap-2">
  {creditBalance !== undefined && (
    <Link
      href="/pricing"
      className={cn(
        'inline-flex items-center gap-1.5 rounded-full px-3 py-1 text-xs font-medium transition-colors',
        creditBalance > 0
          ? 'bg-olive-100 text-olive-700 hover:bg-olive-200 dark:bg-olive-900/40 dark:text-olive-300 dark:hover:bg-olive-900/60'
          : 'bg-muted text-muted-foreground hover:bg-muted/80'
      )}
    >
      <Coins className="h-3 w-3" />
      {creditBalance > 0
        ? `${creditBalance} credit${creditBalance !== 1 ? 's' : ''}`
        : 'No credits'}
    </Link>
  )}
  <ThemeToggle />
  <UserButton afterSignOutUrl="/" />
</div>
```

The badge links to `/pricing` — users with no credits can click to go buy some. Users with credits see their balance.
  </action>
  <verify>
    <automated>cd /Users/michaelchristie/devProjects/workshoppilot.ai && npx tsc --noEmit 2>&1 | head -30</automated>
    <automated>grep -c "workshop_return_url" src/app/pricing/page.tsx</automated>
  </verify>
  <done>
    - Pricing page reads return_to searchParam and validates it starts with /workshop/
    - Pricing page checkout forms include workshop_return_url hidden input when return_to is present
    - PaywallOverlay "Buy Credits" navigates to /pricing?return_to=/workshop/{sessionId}/step/7
    - Dashboard layout queries creditBalance from users table via Clerk auth
    - Dashboard header shows credit badge: "X credits" (olive pill) or "No credits" (muted pill)
    - Credit badge links to /pricing
    - Zero-credit purchase path verified end-to-end: upgrade dialog → pricing?return_to → checkout with workshop_return_url → success → workshop
    - TypeScript compiles with zero errors
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npx next build` completes without errors
3. Checkout route parses `workshop_return_url` from form data and validates it starts with `/workshop/`
4. Stripe success_url includes `&return_to=...` when workshop_return_url is present
5. Success page redirects to `return_to` for fulfilled/already_fulfilled status
6. Success page does NOT redirect for payment_not_paid (shows processing) — redirect block appears AFTER payment_not_paid early return
7. Pricing page reads `return_to` searchParam, validates it, and includes `workshop_return_url` hidden input in checkout forms
8. PaywallOverlay "Buy Credits" includes `return_to` param in pricing URL
9. Dashboard header renders credit badge with correct balance
10. Credit badge links to /pricing
</verification>

<success_criteria>
- After successful Stripe Checkout from upgrade dialog (zero-credit path via pricing page), user redirected to their workshop at Step 7 (not dashboard)
- After successful Stripe Checkout from PaywallOverlay (via pricing page), user redirected to their workshop at Step 7 (not dashboard)
- Open redirect prevented — only /workshop/* paths accepted (validated in checkout route, success page, AND pricing page)
- Dashboard shows "X credits" or "No credits" badge in header
- Credit badge is a link to /pricing page
- Existing success page behavior preserved when no return_to param
- All TypeScript types compile cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/51-paywall-ui/51-02-SUMMARY.md`
</output>
