---
phase: 25-ezydraw-foundation
plan: 04
type: execute
wave: 3
depends_on: ["25-02"]
files_modified:
  - src/components/ezydraw/tools/shapes-tool.tsx
  - src/components/ezydraw/ezydraw-stage.tsx
autonomous: true

must_haves:
  truths:
    - "User can place rectangles on the canvas by click-dragging"
    - "User can place circles/ellipses on the canvas by click-dragging"
    - "User can draw arrows between two points"
    - "User can draw straight lines between two points"
    - "User can place diamond shapes on the canvas by click-dragging"
    - "Shapes use current stroke color, fill color, and stroke width from toolbar"
  artifacts:
    - path: "src/components/ezydraw/tools/shapes-tool.tsx"
      provides: "Shape creation tool for rectangle, circle, arrow, line, diamond"
      contains: "ShapesTool"
  key_links:
    - from: "src/components/ezydraw/tools/shapes-tool.tsx"
      to: "src/stores/drawing-store.ts"
      via: "addElement to persist completed shape"
      pattern: "addElement"
    - from: "src/components/ezydraw/ezydraw-stage.tsx"
      to: "src/components/ezydraw/tools/shapes-tool.tsx"
      via: "renders ShapesTool and shape elements"
      pattern: "ShapesTool"
---

<objective>
Implement the shapes tool for placing rectangles, circles, arrows, lines, and diamonds on the canvas via click-drag interaction.

Purpose: Give users basic shape primitives for wireframing, diagramming, and annotating their concept sketches.

Output: ShapesTool component handling click-drag creation of 5 shape types, integrated into EzyDrawStage with proper element rendering.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/25-ezydraw-foundation/25-RESEARCH.md
@.planning/phases/25-ezydraw-foundation/25-02-SUMMARY.md
@src/components/ezydraw/ezydraw-stage.tsx
@src/stores/drawing-store.ts
@src/lib/drawing/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement ShapesTool with click-drag creation for 5 shape types</name>
  <files>
    src/components/ezydraw/tools/shapes-tool.tsx
  </files>
  <action>
    Create `src/components/ezydraw/tools/shapes-tool.tsx`:

    'use client' directive.

    **Imports:**
    - `Rect, Circle, Arrow, Line as KonvaLine, Group, Shape` from 'react-konva'
    - `KonvaEventObject` from 'konva/lib/Node'
    - `useDrawingStore` from drawing-store
    - Types from drawing/types

    **Shape creation pattern (click-drag):**
    All 5 shapes use the same interaction model:
    1. PointerDown: Record start point (startX, startY), set isDrawing = true
    2. PointerMove: Calculate current dimensions from start to current point, update preview
    3. PointerUp: Finalize shape, add to store

    **State (refs for performance):**
    - `isDrawingRef = useRef(false)`
    - `startPointRef = useRef<{x: number, y: number}>({x: 0, y: 0})`
    - `previewShapeRef = useRef<Partial<DrawingElement> | null>(null)`
    - `forceUpdate` state counter for preview rendering

    **Handler logic per shape type:**

    On PointerDown (when activeTool is rectangle/circle/diamond/arrow/line):
    - Record start position

    On PointerMove:
    - Calculate dimensions based on activeTool:
      - **rectangle**: width = |currentX - startX|, height = |currentY - startY|, x = min(startX, currentX), y = min(startY, currentY)
      - **circle**: radiusX = |currentX - startX| / 2, radiusY = |currentY - startY| / 2, center at midpoint
      - **diamond**: Same bounding box as rectangle (rendered via custom points path)
      - **arrow**: points = [startX, startY, currentX, currentY] (relative to element position)
      - **line**: points = [startX, startY, currentX, currentY] (relative to element position)
    - Update previewShapeRef and trigger forceUpdate

    On PointerUp:
    - Create the appropriate DrawingElement:
      - **RectangleElement**: `{ id, type: 'rectangle', x, y, rotation: 0, scaleX: 1, scaleY: 1, opacity: 1, width, height, fill: fillColor, stroke: strokeColor, strokeWidth }`
      - **CircleElement**: `{ id, type: 'circle', x: centerX, y: centerY, rotation: 0, scaleX: 1, scaleY: 1, opacity: 1, radiusX, radiusY, fill: fillColor, stroke: strokeColor, strokeWidth }`
      - **ArrowElement**: `{ id, type: 'arrow', x: 0, y: 0, rotation: 0, scaleX: 1, scaleY: 1, opacity: 1, points: [startX, startY, endX, endY], stroke: strokeColor, strokeWidth, pointerLength: 10, pointerWidth: 10 }`
      - **LineElement**: `{ id, type: 'line', x: 0, y: 0, rotation: 0, scaleX: 1, scaleY: 1, opacity: 1, points: [startX, startY, endX, endY], stroke: strokeColor, strokeWidth }`
      - **DiamondElement**: `{ id, type: 'diamond', x, y, rotation: 0, scaleX: 1, scaleY: 1, opacity: 1, width, height, fill: fillColor, stroke: strokeColor, strokeWidth }`
    - Skip creation if shape is too small (width < 3 && height < 3) to prevent accidental clicks
    - Call addElement() to persist
    - Reset refs

    **Preview rendering:**
    - Render the current preview shape while dragging (same Konva elements but with dashed stroke or slight opacity)
    - Preview uses `dash={[5, 5]}` and `opacity={0.6}` to distinguish from finalized shapes

    **Diamond rendering helper:**
    - Diamond is rendered as a `<Line>` with 4 points forming a diamond: top, right, bottom, left of bounding box
    - Points: `[width/2, 0, width, height/2, width/2, height, 0, height/2]` relative to x,y position
    - `closed={true}` to close the shape

    Export `ShapesTool` component with same handler pattern as PencilTool (handlers exposed for stage delegation).
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify compilation.
    Verify all 5 shape types: `grep -c "type:" src/components/ezydraw/tools/shapes-tool.tsx` should show multiple shape type references.
  </verify>
  <done>ShapesTool creates rectangles, circles, arrows, lines, and diamonds via click-drag, with preview during drag and persistence to drawing store on completion.</done>
</task>

<task type="auto">
  <name>Task 2: Add shape rendering to EzyDrawStage element renderer</name>
  <files>
    src/components/ezydraw/ezydraw-stage.tsx
  </files>
  <action>
    Update `src/components/ezydraw/ezydraw-stage.tsx` to:

    1. **Import ShapesTool** from ./tools/shapes-tool

    2. **Expand element renderer** to handle all shape types:
       - RectangleElement: `<Rect x={el.x} y={el.y} width={el.width} height={el.height} fill={el.fill} stroke={el.stroke} strokeWidth={el.strokeWidth} rotation={el.rotation} scaleX={el.scaleX} scaleY={el.scaleY} opacity={el.opacity} />`
       - CircleElement: `<Ellipse x={el.x} y={el.y} radiusX={el.radiusX} radiusY={el.radiusY} fill={el.fill} stroke={el.stroke} strokeWidth={el.strokeWidth} rotation={el.rotation} scaleX={el.scaleX} scaleY={el.scaleY} opacity={el.opacity} />`
       - Note: Use Konva `Ellipse` (not `Circle`) since we store radiusX/radiusY for ellipses
       - ArrowElement: `<Arrow x={el.x} y={el.y} points={el.points} stroke={el.stroke} strokeWidth={el.strokeWidth} pointerLength={el.pointerLength} pointerWidth={el.pointerWidth} rotation={el.rotation} scaleX={el.scaleX} scaleY={el.scaleY} opacity={el.opacity} />`
       - LineElement: `<Line x={el.x} y={el.y} points={el.points} stroke={el.stroke} strokeWidth={el.strokeWidth} rotation={el.rotation} scaleX={el.scaleX} scaleY={el.scaleY} opacity={el.opacity} />`
       - DiamondElement: `<Line x={el.x} y={el.y} points={[el.width/2, 0, el.width, el.height/2, el.width/2, el.height, 0, el.height/2]} closed={true} fill={el.fill} stroke={el.stroke} strokeWidth={el.strokeWidth} rotation={el.rotation} scaleX={el.scaleX} scaleY={el.scaleY} opacity={el.opacity} />`

    3. **Update event delegation** on the interaction rect:
       - When activeTool is one of ['rectangle', 'circle', 'arrow', 'line', 'diamond'], delegate pointer events to ShapesTool handlers
       - When activeTool is 'pencil', delegate to PencilTool handlers (already done)

    4. **Add Ellipse and Arrow imports** from react-konva (they weren't imported in plan 03):
       `import { Stage, Layer, Rect, Line, Ellipse, Arrow, Text, Group } from 'react-konva'`

    5. **Key prop on elements:** Each rendered element needs `key={el.id}` for React reconciliation.

    6. **Render ShapesTool** in the drawing layer alongside PencilTool for shape preview rendering.
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify compilation.
    Run `npm run build` to verify no SSR errors.
    Verify all shape renderers: `grep -c "Ellipse\|Arrow\|Rect\|Line" src/components/ezydraw/ezydraw-stage.tsx`
  </verify>
  <done>EzyDrawStage renders all shape types (rectangle, circle, arrow, line, diamond) from the store and delegates shape tool events to ShapesTool. Users can create all 5 shape types via click-drag.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds
3. ShapesTool handles 5 shape types via click-drag
4. Shapes use current color and stroke width from store
5. Preview shows during drag with dashed stroke
6. Small accidental clicks (< 3px) are ignored
7. All shape types render correctly from store
</verification>

<success_criteria>
- User can draw rectangles, circles, arrows, lines, and diamonds
- Shapes are created via click-drag interaction
- Preview visible during drag operation
- Shapes use toolbar's stroke color, fill color, and width
- All shapes persist in drawing store and render on canvas
</success_criteria>

<output>
After completion, create `.planning/phases/25-ezydraw-foundation/25-04-SUMMARY.md`
</output>
