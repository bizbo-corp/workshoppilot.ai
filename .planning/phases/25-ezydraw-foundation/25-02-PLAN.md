---
phase: 25-ezydraw-foundation
plan: 02
type: execute
wave: 2
depends_on: ["25-01"]
files_modified:
  - src/components/ezydraw/ezydraw-modal.tsx
  - src/components/ezydraw/ezydraw-stage.tsx
  - src/components/ezydraw/toolbar.tsx
  - src/components/ezydraw/ezydraw-loader.tsx
autonomous: true

must_haves:
  truths:
    - "EzyDraw opens as fullscreen modal overlay covering entire viewport"
    - "Modal has save and cancel buttons in a top toolbar"
    - "Konva Stage renders at full viewport dimensions inside the modal"
    - "Modal lazy-loads with next/dynamic ssr:false to avoid SSR errors"
    - "Touch scrolling is prevented inside the modal (touch-action: none)"
  artifacts:
    - path: "src/components/ezydraw/ezydraw-modal.tsx"
      provides: "Fullscreen modal wrapper with save/cancel controls"
      contains: "EzyDrawModal"
    - path: "src/components/ezydraw/ezydraw-stage.tsx"
      provides: "Konva Stage + Layer setup with refs"
      contains: "EzyDrawStage"
    - path: "src/components/ezydraw/toolbar.tsx"
      provides: "Tool selection bar with tool buttons, color picker, undo/redo"
      contains: "EzyDrawToolbar"
    - path: "src/components/ezydraw/ezydraw-loader.tsx"
      provides: "Lazy-load wrapper using next/dynamic with ssr:false"
      contains: "EzyDrawLoader"
  key_links:
    - from: "src/components/ezydraw/ezydraw-modal.tsx"
      to: "src/stores/drawing-store.ts"
      via: "DrawingStoreProvider wraps modal content"
      pattern: "DrawingStoreProvider"
    - from: "src/components/ezydraw/ezydraw-stage.tsx"
      to: "src/stores/drawing-store.ts"
      via: "useDrawingStore hook for elements and tools"
      pattern: "useDrawingStore"
    - from: "src/components/ezydraw/ezydraw-loader.tsx"
      to: "src/components/ezydraw/ezydraw-modal.tsx"
      via: "dynamic import with ssr:false"
      pattern: "dynamic.*import.*ezydraw-modal"
---

<objective>
Build the EzyDraw fullscreen modal with Konva Stage, toolbar with tool buttons, and lazy-load wrapper. This creates the visual shell that all drawing tools plug into.

Purpose: Establish the container UI — the modal that opens, the canvas that renders inside it, the toolbar users interact with, and the SSR-safe loading mechanism.

Output: Four components: EzyDrawModal (fullscreen overlay), EzyDrawStage (Konva canvas), EzyDrawToolbar (tool buttons), EzyDrawLoader (lazy import).
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/25-ezydraw-foundation/25-RESEARCH.md
@.planning/phases/25-ezydraw-foundation/25-01-SUMMARY.md
@src/components/canvas/canvas-wrapper.tsx (reference for lazy-load pattern)
@src/components/ui/dialog.tsx (reference for dialog pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create EzyDraw toolbar and Stage components</name>
  <files>
    src/components/ezydraw/toolbar.tsx
    src/components/ezydraw/ezydraw-stage.tsx
  </files>
  <action>
    1. Create `src/components/ezydraw/toolbar.tsx`:
       - 'use client' directive
       - Import useDrawingStore from drawing-store
       - Import lucide-react icons: Pencil, Square, Circle, Type, MousePointer2, Eraser, ArrowRight, Minus, Diamond, Undo2, Redo2, Trash2, Save, X
       - Top-positioned horizontal toolbar bar: fixed to top of modal, z-10, bg-white/95 backdrop-blur border-b, h-12, flex items-center px-3 gap-1
       - **Left section (tools):** Tool buttons for each DrawingTool — pencil, select, rectangle, circle, diamond, arrow, line, text, eraser. Each is a small icon button (32x32px), active tool highlighted with bg-blue-100 text-blue-700 ring-1 ring-blue-300. Use `setActiveTool` from store on click.
       - **Center section (options):** Stroke color (small color swatch button showing current strokeColor — clicking opens native `<input type="color">` hidden behind it), stroke width selector (small dropdown or 3 preset buttons: thin=1, medium=2, thick=4), fill color (same pattern as stroke).
       - **Right section (actions):** Undo button (disabled when !canUndo), Redo button (disabled when !canRedo), divider, Clear All button (Trash2 icon), divider, Cancel button (X icon, ghost variant), Save button (Save icon, primary blue bg).
       - Export `EzyDrawToolbar` component, accepting `onSave: () => void` and `onCancel: () => void` props.
       - **Keyboard shortcuts:** Use react-hotkeys-hook (already installed):
         - `mod+z` → undo
         - `mod+shift+z` → redo
         - `v` → select tool
         - `p` → pencil tool
         - `r` → rectangle
         - `c` → circle
         - `a` → arrow
         - `l` → line
         - `t` → text
         - `e` → eraser
         - `d` → diamond
       - Shortcuts only active when toolbar is mounted (cleanup automatic with useHotkeys)

    2. Create `src/components/ezydraw/ezydraw-stage.tsx`:
       - 'use client' directive
       - Import Stage, Layer from react-konva
       - Import Konva types from konva
       - Import useDrawingStore
       - Accept no props (reads from store)
       - Maintain refs: `stageRef: Konva.Stage`, `drawingLayerRef: Konva.Layer`, `uiLayerRef: Konva.Layer`
       - Stage dimensions: Use `window.innerWidth` x `(window.innerHeight - 48)` (48px for toolbar), update on window resize via useEffect + resize listener
       - Stage background: white (#ffffff)
       - Two layers:
         - Drawing Layer (ref=drawingLayerRef): Where all elements render. For now, render placeholder text "Draw here" centered. Elements will be rendered by tool components added in plans 03-05.
         - UI Layer (ref=uiLayerRef): For selection transformer, added in plan 05.
       - **Memory cleanup:** useEffect cleanup calls `stageRef.current?.destroy()` on unmount (CRITICAL per research — Safari iOS canvas memory)
       - **Touch prevention:** Wrapper div has `style={{ touchAction: 'none' }}` and `onTouchMove={(e) => e.preventDefault()}`
       - Export `EzyDrawStage` component
       - Also export `stageRef` via React.forwardRef or useImperativeHandle so parent modal can access `stage.toDataURL()` for PNG export in plan 06.
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm components compile.
    Verify toolbar has tool buttons: `grep -c "setActiveTool" src/components/ezydraw/toolbar.tsx` should be >= 9
  </verify>
  <done>Toolbar renders all 9 tool buttons with active state highlighting, color/width controls, undo/redo/clear/save/cancel actions, and keyboard shortcuts. Stage renders Konva canvas at viewport dimensions with two layers and proper memory cleanup.</done>
</task>

<task type="auto">
  <name>Task 2: Create EzyDraw modal and lazy-load wrapper</name>
  <files>
    src/components/ezydraw/ezydraw-modal.tsx
    src/components/ezydraw/ezydraw-loader.tsx
  </files>
  <action>
    1. Create `src/components/ezydraw/ezydraw-modal.tsx`:
       - 'use client' directive
       - Import Dialog, DialogContent, DialogTitle from @/components/ui/dialog (use existing shadcn dialog)
       - Import DrawingStoreProvider from drawing-store
       - Import EzyDrawToolbar and EzyDrawStage
       - Props: `isOpen: boolean`, `onClose: () => void`, `onSave: (dataURL: string) => void`, `initialElements?: DrawingElement[]`
       - Render Dialog with `open={isOpen}` and `onOpenChange` handler
       - DialogContent: `className="max-w-[100vw] max-h-[100vh] w-screen h-screen p-0 rounded-none border-0 gap-0"` to go truly fullscreen
       - Add a hidden DialogTitle for accessibility: `<DialogTitle className="sr-only">EzyDraw - Drawing Canvas</DialogTitle>`
       - Suppress the default close button on DialogContent (check if it has a prop like `showCloseButton={false}` or handle via className)
       - Inside DialogContent: wrap with DrawingStoreProvider
       - Layout: flex flex-col h-full
         - EzyDrawToolbar (at top, h-12)
         - EzyDrawStage (flex-1, fills remaining space)
       - **onSave handler:** Get stage ref, call stage.toDataURL({ pixelRatio: 2 }), pass dataURL to onSave prop, then call onClose
       - **onCancel handler:** Call onClose directly (no save)
       - **Clear confirmation:** When clear is triggered from toolbar, show window.confirm("Clear entire drawing? This cannot be undone.") — if confirmed, call store.clearAll()
       - Export `EzyDrawModal`

    2. Create `src/components/ezydraw/ezydraw-loader.tsx`:
       - 'use client' directive
       - Use `next/dynamic` with `ssr: false` to lazy-import EzyDrawModal (same pattern as canvas-wrapper.tsx)
       - Loading fallback: centered spinner or "Loading drawing tools..." text in a fullscreen overlay
       - Props: Same as EzyDrawModal (isOpen, onClose, onSave, initialElements?)
       - Export `EzyDrawLoader` — this is what consumers import, NOT EzyDrawModal directly
       - This ensures konva + react-konva + perfect-freehand only load when user opens EzyDraw

    **Dialog close button:** Read the dialog.tsx source to determine how to hide the close button. The shadcn dialog likely has an X button in DialogContent. Options:
    - If there's a `showCloseButton` or similar prop, use it
    - If not, use CSS to hide it: `[&>button]:hidden` or similar
    - The toolbar already has Cancel button, so the dialog's close button is redundant
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm modal and loader compile.
    Verify lazy loading: `grep "ssr: false" src/components/ezydraw/ezydraw-loader.tsx`
    Verify dialog usage: `grep "Dialog" src/components/ezydraw/ezydraw-modal.tsx`
  </verify>
  <done>EzyDrawModal renders as fullscreen dialog overlay with toolbar and stage. EzyDrawLoader provides SSR-safe lazy loading via next/dynamic. Opening EzyDraw loads ~470KB of drawing libraries on demand, keeping initial page bundle clean.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. EzyDrawLoader uses next/dynamic with ssr:false
3. EzyDrawModal wraps content in DrawingStoreProvider
4. Toolbar has 9 tool buttons + undo/redo/clear/save/cancel
5. Stage creates 2 Konva layers with refs
6. Stage cleanup calls destroy() on unmount
7. touch-action:none prevents scroll interference
</verification>

<success_criteria>
- Fullscreen modal opens and closes via isOpen prop
- Konva Stage renders at viewport dimensions inside modal
- Toolbar shows all drawing tool buttons with active state
- Keyboard shortcuts work for tool switching and undo/redo
- Modal lazy-loads (no SSR errors on build)
- Canvas memory properly cleaned up on unmount
</success_criteria>

<output>
After completion, create `.planning/phases/25-ezydraw-foundation/25-02-SUMMARY.md`
</output>
