---
phase: 25-ezydraw-foundation
plan: 05
type: execute
wave: 4
depends_on: ["25-03", "25-04"]
files_modified:
  - src/components/ezydraw/tools/select-tool.tsx
  - src/components/ezydraw/tools/text-tool.tsx
  - src/components/ezydraw/tools/eraser-tool.tsx
  - src/components/ezydraw/ezydraw-stage.tsx
autonomous: true

must_haves:
  truths:
    - "User can select any element by clicking on it"
    - "Selected element shows resize handles and can be moved and resized"
    - "User can add text labels by clicking with text tool and typing"
    - "User can erase elements by clicking on them with eraser tool"
    - "User can clear entire canvas with confirmation dialog"
  artifacts:
    - path: "src/components/ezydraw/tools/select-tool.tsx"
      provides: "Selection with Konva.Transformer for move/resize"
      contains: "SelectTool"
    - path: "src/components/ezydraw/tools/text-tool.tsx"
      provides: "Text label placement and inline editing"
      contains: "TextTool"
    - path: "src/components/ezydraw/tools/eraser-tool.tsx"
      provides: "Element deletion on click"
      contains: "EraserTool"
  key_links:
    - from: "src/components/ezydraw/tools/select-tool.tsx"
      to: "react-konva"
      via: "Konva.Transformer for resize handles"
      pattern: "Transformer"
    - from: "src/components/ezydraw/tools/select-tool.tsx"
      to: "src/stores/drawing-store.ts"
      via: "updateElement for position/size changes after drag/resize"
      pattern: "updateElement"
    - from: "src/components/ezydraw/tools/eraser-tool.tsx"
      to: "src/stores/drawing-store.ts"
      via: "deleteElement to remove clicked element"
      pattern: "deleteElement"
---

<objective>
Implement select/move/resize, text labels, and eraser tools. These complete the tool palette for basic drawing operations.

Purpose: Users need to rearrange elements (select), annotate drawings (text), and correct mistakes (eraser/clear). These tools make the drawing experience complete.

Output: Three tool components (SelectTool, TextTool, EraserTool) integrated into EzyDrawStage.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/25-ezydraw-foundation/25-RESEARCH.md
@.planning/phases/25-ezydraw-foundation/25-03-SUMMARY.md
@.planning/phases/25-ezydraw-foundation/25-04-SUMMARY.md
@src/components/ezydraw/ezydraw-stage.tsx
@src/stores/drawing-store.ts
@src/lib/drawing/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement SelectTool with Konva.Transformer for move/resize</name>
  <files>
    src/components/ezydraw/tools/select-tool.tsx
  </files>
  <action>
    Create `src/components/ezydraw/tools/select-tool.tsx`:

    'use client' directive.

    **Imports:**
    - `Transformer` from 'react-konva'
    - `Konva` from 'konva'
    - `useDrawingStore` from drawing-store

    **Selection logic:**
    - Read `selectedElementId` and `selectElement` from store
    - Maintain `transformerRef = useRef<Konva.Transformer>(null)`

    **How selection works:**
    This component does NOT handle click events directly. Instead, the stage's element renderer makes each element clickable when activeTool === 'select':
    - Each rendered element gets `onClick` handler that calls `selectElement(el.id)`
    - Each rendered element gets `draggable={activeTool === 'select'}` prop

    The SelectTool component renders the Transformer and handles its lifecycle:

    1. **Transformer setup:** When `selectedElementId` changes:
       - Find the Konva node on the stage by ID (using `stageRef.current.findOne('#' + selectedElementId)`)
       - If found, attach transformer: `transformerRef.current.nodes([node])` and `transformerRef.current.getLayer()?.batchDraw()`
       - If null, detach: `transformerRef.current.nodes([])`

    2. **Transformer config:**
       - `boundBoxFunc`: Prevent resize below 5x5px
       - `rotateEnabled={true}` — allow rotation
       - `keepRatio={false}` — allow free resize
       - `anchorSize={8}` — visible resize handles
       - `borderStroke="#0ea5e9"` — sky-500 blue border
       - `anchorStroke="#0ea5e9"` — matching anchor color
       - `anchorFill="#ffffff"` — white fill for handles
       - `anchorCornerRadius={2}` — slightly rounded handles

    3. **Drag end handler:** When an element is dragged (dragEnd event on the element):
       - Read new x, y from the element's absolute position
       - Call `updateElement(el.id, { x: node.x(), y: node.y() })`

    4. **Transform end handler:** When resize/rotate completes:
       - Read new scaleX, scaleY, rotation, x, y from the node
       - For shapes (rect, circle, diamond): multiply dimensions by scale and reset scale to 1 for cleaner state
       - For strokes: keep scaleX/scaleY (too complex to recalculate points)
       - Call `updateElement(el.id, { ... })`

    5. **Deselect:** Click on empty canvas (the interaction rect) when in select mode should call `selectElement(null)`

    Export `SelectTool` component. It renders inside the UI Layer (not drawing layer) since the Transformer is a UI control.
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify compilation.
    Verify Transformer usage: `grep "Transformer" src/components/ezydraw/tools/select-tool.tsx`
  </verify>
  <done>SelectTool renders Konva.Transformer around selected element, handles drag-end and transform-end to persist position/size changes to store, with blue handles and min-size constraints.</done>
</task>

<task type="auto">
  <name>Task 2: Implement TextTool, EraserTool, and integrate all tools into stage</name>
  <files>
    src/components/ezydraw/tools/text-tool.tsx
    src/components/ezydraw/tools/eraser-tool.tsx
    src/components/ezydraw/ezydraw-stage.tsx
  </files>
  <action>
    1. Create `src/components/ezydraw/tools/text-tool.tsx`:
       - 'use client' directive
       - **Text placement:** When activeTool === 'text' and user clicks on canvas:
         - Create a TextElement at click position with default text "Text"
         - `{ id, type: 'text', x: clickX, y: clickY, rotation: 0, scaleX: 1, scaleY: 1, opacity: 1, text: 'Text', fontSize: store.fontSize, fill: store.strokeColor, width: 200, fontFamily: 'sans-serif' }`
         - Call addElement() to persist
         - Immediately select the new text element and trigger edit mode
       - **Inline editing:** When a text element is double-clicked (in select mode OR text mode):
         - Create an HTML textarea positioned exactly over the Konva text node using absolute positioning
         - The textarea overlays the canvas (using a portal or DOM manipulation)
         - On blur or Enter: update the text content via updateElement(id, { text: newText })
         - Remove the textarea overlay
       - **Implementation approach:** Use Konva's built-in approach — on dblclick of a Text node, hide the Konva text, show an HTML textarea at the same position, and on blur, update and show the Konva text again. This is the documented Konva pattern for text editing.
       - Export `TextTool` — this mostly provides event handlers, minimal rendering

    2. Create `src/components/ezydraw/tools/eraser-tool.tsx`:
       - 'use client' directive
       - **Simple approach:** When activeTool === 'eraser' and user clicks on an element:
         - Identify the clicked element from the Konva event target
         - Match it to a DrawingElement by id (each Konva node has `id={el.id}`)
         - Call `deleteElement(el.id)` from store
       - **Visual feedback:** Change cursor to crosshair when eraser is active
       - **Hover effect:** Elements highlight (opacity or outline change) when hovered with eraser tool active. Use `onMouseEnter`/`onMouseLeave` to add/remove highlight.
       - Export `EraserTool` — provides event handlers for eraser interaction

    3. Update `src/components/ezydraw/ezydraw-stage.tsx`:
       - **Import all three new tools:** SelectTool, TextTool, EraserTool
       - **Make elements interactive:** When rendering each DrawingElement:
         - Add `id={el.id}` to each Konva node (for findOne lookup by SelectTool)
         - When activeTool === 'select': add `draggable={true}`, onClick handler for selection
         - When activeTool === 'eraser': add onClick handler for deletion
         - When activeTool === 'text' and it's a text element: add onDblClick for inline editing
         - When drawing tools active (pencil, shapes): set `listening={false}` for performance
       - **Cursor management:** Set cursor on stage container based on activeTool:
         - select: 'default'
         - pencil: 'crosshair'
         - rectangle/circle/diamond/arrow/line: 'crosshair'
         - text: 'text'
         - eraser: `url(eraser-cursor.svg) 12 12, crosshair` or just 'crosshair' with a visual indicator
       - **Render SelectTool** in the UI Layer (second layer)
       - **Event delegation update:** Add handlers for text and eraser tools:
         - text tool: click on interaction rect = create new text at position
         - eraser tool: click on element = delete it
         - select tool: click on interaction rect = deselect; click on element = select
       - **Text rendering:** Add TextElement to the element renderer:
         - `<Text id={el.id} x={el.x} y={el.y} text={el.text} fontSize={el.fontSize} fill={el.fill} width={el.width} fontFamily={el.fontFamily} rotation={el.rotation} scaleX={el.scaleX} scaleY={el.scaleY} opacity={el.opacity} />`
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify compilation.
    Run `npm run build` to verify no SSR errors.
    Verify all tools imported: `grep -c "Tool" src/components/ezydraw/ezydraw-stage.tsx` should be >= 4
  </verify>
  <done>SelectTool provides move/resize via Transformer, TextTool creates and edits text labels inline, EraserTool deletes clicked elements. All tools integrated into stage with proper event delegation and cursor management.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds
3. SelectTool uses Konva.Transformer with resize handles
4. Dragged/resized elements persist new position to store
5. TextTool creates text at click position
6. Text inline editing works via HTML textarea overlay
7. EraserTool deletes clicked element from store
8. Cursor changes based on active tool
</verification>

<success_criteria>
- User can select elements, move them, and resize them with handles
- User can click with text tool to place editable text labels
- User can double-click text to edit it inline
- User can click elements with eraser to delete them
- All tool interactions persist to drawing store
- Cursor provides visual feedback for active tool
</success_criteria>

<output>
After completion, create `.planning/phases/25-ezydraw-foundation/25-05-SUMMARY.md`
</output>
