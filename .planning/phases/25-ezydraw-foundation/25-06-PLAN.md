---
phase: 25-ezydraw-foundation
plan: 06
type: execute
wave: 5
depends_on: ["25-05"]
files_modified:
  - src/lib/drawing/export.ts
  - src/components/ezydraw/ezydraw-modal.tsx
  - src/components/ezydraw/ezydraw-stage.tsx
  - src/components/ezydraw/toolbar.tsx
autonomous: false

must_haves:
  truths:
    - "User can undo the last drawing action with Cmd+Z"
    - "User can redo an undone action with Cmd+Shift+Z"
    - "Undo/redo buttons in toolbar reflect available history (disabled when empty)"
    - "User can export drawing as PNG by clicking save"
    - "Exported PNG has 2x pixel ratio for retina quality"
    - "User can clear entire canvas after confirming dialog"
    - "All tools work together: draw, place shapes, add text, select, erase, undo, redo, save"
  artifacts:
    - path: "src/lib/drawing/export.ts"
      provides: "PNG export utility using Konva stage.toDataURL"
      contains: "exportToPNG"
  key_links:
    - from: "src/lib/drawing/export.ts"
      to: "konva"
      via: "stage.toDataURL for PNG generation"
      pattern: "toDataURL"
    - from: "src/components/ezydraw/ezydraw-modal.tsx"
      to: "src/lib/drawing/export.ts"
      via: "calls exportToPNG on save button click"
      pattern: "exportToPNG"
    - from: "src/components/ezydraw/toolbar.tsx"
      to: "src/stores/drawing-store.ts"
      via: "undo/redo actions and canUndo/canRedo state"
      pattern: "undo|redo|canUndo|canRedo"
---

<objective>
Wire up undo/redo to toolbar and keyboard shortcuts, implement PNG export on save, and add clear-canvas confirmation. This plan completes the EzyDraw feature set and includes a visual verification checkpoint.

Purpose: Complete the drawing loop — users can create, undo mistakes, and save their work as PNG images. This finishes Phase 25's feature requirements.

Output: Working export utility, wired undo/redo, clear confirmation, and verified end-to-end drawing experience.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/25-ezydraw-foundation/25-RESEARCH.md
@.planning/phases/25-ezydraw-foundation/25-05-SUMMARY.md
@src/components/ezydraw/ezydraw-modal.tsx
@src/components/ezydraw/ezydraw-stage.tsx
@src/components/ezydraw/toolbar.tsx
@src/stores/drawing-store.ts
@src/lib/drawing/history.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PNG export utility and wire save/clear/undo/redo into modal</name>
  <files>
    src/lib/drawing/export.ts
    src/components/ezydraw/ezydraw-modal.tsx
    src/components/ezydraw/ezydraw-stage.tsx
    src/components/ezydraw/toolbar.tsx
  </files>
  <action>
    1. Create `src/lib/drawing/export.ts`:
       - Import Konva type from 'konva'
       - Export `exportToPNG(stage: Konva.Stage): string` function:
         - Hide UI layer (transformer, selection indicators) before export by setting visible=false on UI layer
         - Call `stage.toDataURL({ mimeType: 'image/png', pixelRatio: 2 })` for retina quality
         - Re-show UI layer after export
         - Return the base64 data URL string
       - Export `exportToBlob(stage: Konva.Stage): Promise<Blob>` function:
         - Use same hide/show pattern
         - Convert dataURL to Blob: `fetch(dataURL).then(r => r.blob())`
         - Return Blob (for future Vercel Blob upload in Phase 26)

    2. Update `src/components/ezydraw/ezydraw-stage.tsx`:
       - Expose stage ref to parent via forwardRef or callback ref pattern
       - The modal needs access to `stageRef.current` to call exportToPNG
       - **Recommended:** Use useImperativeHandle to expose `{ getStage: () => stageRef.current }` or simply pass stageRef up via a callback prop: `onStageReady: (stage: Konva.Stage) => void`
       - When Stage mounts, call `onStageReady(stageRef.current)` so the modal stores the reference

    3. Update `src/components/ezydraw/ezydraw-modal.tsx`:
       - **Save handler:** When save button clicked:
         - Get stage reference from the callback
         - If no stage, return early
         - Call `exportToPNG(stage)` to get data URL
         - Call `onSave(dataURL)` prop to pass PNG to consumer
         - Call `onClose()` to dismiss modal
       - **Clear handler:** Wire the clear button:
         - Show `window.confirm('Clear entire drawing? This cannot be undone.')` dialog
         - If confirmed, call `store.clearAll()` (this pushes empty state to history, so it's undoable — actually per the requirement "with confirmation dialog" the confirm IS the safeguard, so clearAll should truly clear, not be undoable. Reset history too.)
         - If cancelled, do nothing
       - Pass `onClear` callback to toolbar

    4. Update `src/components/ezydraw/toolbar.tsx`:
       - **Undo/redo buttons:** Wire to store's `undo()` and `redo()` actions
       - Read `canUndo` and `canRedo` from store
       - Disable undo button when `!canUndo`, disable redo when `!canRedo`
       - Visual: disabled buttons get `opacity-40 cursor-not-allowed`
       - **Clear button:** Accept `onClear` prop, call it on click
       - **Verify keyboard shortcuts are wired** (should already be from plan 02):
         - mod+z → undo()
         - mod+shift+z → redo()
       - **Undo/redo counter display (optional UX):** Show small badge or text "3/50" showing current position in history stack. If too complex, skip.

    5. **Integration verification:** Ensure all pieces connect:
       - Toolbar undo → store.undo() → DrawingHistory.undo() → elements restored
       - Toolbar redo → store.redo() → DrawingHistory.redo() → elements restored
       - Toolbar clear → confirm dialog → store.clearAll() → empty canvas
       - Save button → exportToPNG(stage) → data URL → onSave callback → modal closes
       - Keyboard Cmd+Z → store.undo() (same path)
       - Keyboard Cmd+Shift+Z → store.redo() (same path)
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify compilation.
    Run `npm run build` to verify no SSR errors.
    Verify export function: `grep "toDataURL" src/lib/drawing/export.ts`
    Verify undo/redo wiring: `grep "canUndo\|canRedo" src/components/ezydraw/toolbar.tsx`
  </verify>
  <done>PNG export generates 2x retina data URL, undo/redo wired to toolbar buttons and keyboard shortcuts with disabled states, clear canvas shows confirmation dialog. Save button exports and passes PNG to parent.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify complete EzyDraw drawing experience</name>
  <files>N/A - verification only</files>
  <action>
    Human verification of the complete EzyDraw drawing modal. What was built:
    - Freehand pencil with velocity-based strokes
    - 5 shape types (rectangle, circle, arrow, line, diamond)
    - Text labels with inline editing
    - Select/move/resize with handles
    - Eraser tool
    - Undo/redo (Cmd+Z / Cmd+Shift+Z)
    - PNG export on save
    - Clear canvas with confirmation
    - Fullscreen modal with toolbar

    Steps to verify:
    1. Start the dev server: `npm run dev`
    2. To test EzyDraw, add a temporary test button that opens EzyDrawLoader, or import it into an existing page
    3. Open the EzyDraw modal — should be fullscreen with white canvas and toolbar at top
    4. Test freehand drawing (pencil tool) — strokes should have variable width, no lag
    5. Test shapes — switch to rectangle (R), circle (C), arrow (A), line (L), diamond (D) — each via click-drag
    6. Test text (T) — click to place, double-click to edit inline
    7. Test select (V) — click element for resize handles, drag to move, drag handles to resize
    8. Test eraser (E) — click element to delete
    9. Test undo/redo — Cmd+Z undoes, Cmd+Shift+Z redoes, buttons disable when empty
    10. Test clear — trash icon, confirmation dialog, canvas empties
    11. Test save — draw something, click save, PNG data URL generated
    12. Test cancel — draw something, click cancel, modal closes
  </action>
  <verify>All 12 verification steps pass with expected behavior. No visual glitches, no console errors, responsive interactions.</verify>
  <done>Human has verified complete EzyDraw drawing experience works correctly across all tools, undo/redo, export, and clear functionality.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds (no SSR errors)
3. PNG export produces valid data URL with 2x pixel ratio
4. Undo/redo works across all tool types
5. Clear canvas shows confirmation before clearing
6. Keyboard shortcuts work (Cmd+Z, Cmd+Shift+Z, tool shortcuts)
7. All 9 tools work: pencil, rectangle, circle, arrow, line, diamond, text, select, eraser
8. EzyDraw modal lazy-loads via next/dynamic with ssr:false
9. Canvas memory cleaned up on modal close (destroy called)
</verification>

<success_criteria>
- Complete end-to-end drawing flow: open modal → draw → undo/redo → save as PNG
- All 9 drawing tools functional
- Keyboard shortcuts responsive
- No SSR build errors
- Human verification of visual quality and interaction feel
</success_criteria>

<output>
After completion, create `.planning/phases/25-ezydraw-foundation/25-06-SUMMARY.md`
</output>
