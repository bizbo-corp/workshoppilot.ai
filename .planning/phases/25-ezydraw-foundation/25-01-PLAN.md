---
phase: 25-ezydraw-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/lib/drawing/types.ts
  - src/stores/drawing-store.ts
  - src/lib/drawing/history.ts
autonomous: true

must_haves:
  truths:
    - "konva, react-konva, and perfect-freehand are installed and importable"
    - "Drawing element types are defined with proper TypeScript discriminated unions"
    - "Drawing store manages elements array, active tool, stroke color/width, and selected element"
    - "History manager tracks undo/redo state with 50-step limit"
  artifacts:
    - path: "src/lib/drawing/types.ts"
      provides: "TypeScript types for all drawing elements (stroke, rectangle, circle, arrow, line, diamond, text)"
      contains: "DrawingElement"
    - path: "src/stores/drawing-store.ts"
      provides: "Zustand store for drawing state management"
      contains: "createDrawingStore"
    - path: "src/lib/drawing/history.ts"
      provides: "Undo/redo history manager with ref-based state snapshots"
      contains: "pushHistory"
  key_links:
    - from: "src/stores/drawing-store.ts"
      to: "src/lib/drawing/types.ts"
      via: "imports DrawingElement type"
      pattern: "import.*DrawingElement.*from.*types"
    - from: "src/stores/drawing-store.ts"
      to: "src/lib/drawing/history.ts"
      via: "imports history manager"
      pattern: "import.*history"
---

<objective>
Install Konva.js + react-konva + perfect-freehand, create TypeScript types for all drawing elements, build Zustand drawing store, and implement undo/redo history manager.

Purpose: Establish the data layer foundation that all EzyDraw tools will consume. Types define the shape of every drawing element, the store manages state, and history enables undo/redo.

Output: npm packages installed, types.ts with DrawingElement discriminated union, drawing-store.ts with Zustand factory pattern, history.ts with ref-based state snapshots.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-ezydraw-foundation/25-RESEARCH.md
@src/stores/canvas-store.ts (reference for Zustand factory pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install drawing packages and create TypeScript types</name>
  <files>
    package.json
    src/lib/drawing/types.ts
  </files>
  <action>
    1. Install packages: `npm install konva react-konva perfect-freehand`
    2. Create `src/lib/drawing/types.ts` with these types:

    **DrawingTool union:** `'pencil' | 'rectangle' | 'circle' | 'arrow' | 'line' | 'diamond' | 'text' | 'select' | 'eraser'`

    **Base element type:** `{ id: string; type: DrawingTool; x: number; y: number; rotation: number; scaleX: number; scaleY: number; opacity: number; }`

    **Discriminated union DrawingElement with these variants:**
    - `StrokeElement`: type='pencil', points: number[] (flat array from perfect-freehand), stroke: string, strokeWidth: number, fill: string (for filled path from getStroke)
    - `RectangleElement`: type='rectangle', width: number, height: number, fill: string, stroke: string, strokeWidth: number
    - `CircleElement`: type='circle', radiusX: number, radiusY: number, fill: string, stroke: string, strokeWidth: number
    - `ArrowElement`: type='arrow', points: number[] (start/end as [x1,y1,x2,y2]), stroke: string, strokeWidth: number, pointerLength: number, pointerWidth: number
    - `LineElement`: type='line', points: number[], stroke: string, strokeWidth: number
    - `DiamondElement`: type='diamond', width: number, height: number, fill: string, stroke: string, strokeWidth: number
    - `TextElement`: type='text', text: string, fontSize: number, fill: string, width: number, fontFamily: string

    **DrawingState type:** `{ elements: DrawingElement[]; selectedElementId: string | null; activeTool: DrawingTool; strokeColor: string; fillColor: string; strokeWidth: number; fontSize: number; }`

    **Helper:** `createElementId(): string` using `crypto.randomUUID()`

    Use `as const` satisfies patterns where appropriate. Export all types.
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm types compile without errors.
    Check packages installed: `npm ls konva react-konva perfect-freehand`
  </verify>
  <done>konva, react-konva, and perfect-freehand appear in package.json dependencies. TypeScript types file compiles and exports DrawingElement discriminated union with all 7 element variants.</done>
</task>

<task type="auto">
  <name>Task 2: Create Zustand drawing store and history manager</name>
  <files>
    src/stores/drawing-store.ts (existing file, but drawing store is NEW â€” create alongside, or create as separate drawing-store)
    src/lib/drawing/history.ts
  </files>
  <action>
    **IMPORTANT:** The existing `src/stores/canvas-store.ts` is for the ReactFlow canvas (post-its). Create a SEPARATE `src/stores/drawing-store.ts` for EzyDraw. Follow the same Zustand factory pattern from canvas-store.ts.

    1. Create `src/lib/drawing/history.ts`:
       - Export class `DrawingHistory` with:
         - Private `history: DrawingElement[][]` array (snapshots of full elements array)
         - Private `currentStep: number` index
         - Private `maxSteps = 50`
         - `push(elements: DrawingElement[])`: Deep clone elements, truncate future if mid-history, append, enforce maxSteps limit
         - `undo(): DrawingElement[] | null`: Decrement step, return snapshot or null if at start
         - `redo(): DrawingElement[] | null`: Increment step, return snapshot or null if at end
         - `canUndo: boolean` getter
         - `canRedo: boolean` getter
         - `clear()`: Reset history and step
       - Deep clone using `structuredClone()` (available in all modern browsers)

    2. Create `src/stores/drawing-store.ts`:
       - Import from zustand/vanilla (factory pattern matching canvas-store.ts)
       - Import DrawingElement, DrawingTool, DrawingState, createElementId from types.ts
       - Import DrawingHistory from history.ts
       - **State:** elements: DrawingElement[], selectedElementId: string | null, activeTool: DrawingTool (default 'pencil'), strokeColor: string (default '#000000'), fillColor: string (default 'transparent'), strokeWidth: number (default 2), fontSize: number (default 16), canUndo: boolean, canRedo: boolean
       - **Actions:** addElement(element), updateElement(id, updates), deleteElement(id), setElements(elements), setActiveTool(tool), setStrokeColor(color), setFillColor(color), setStrokeWidth(width), setFontSize(size), selectElement(id | null), undo(), redo(), clearAll(), getSnapshot(): DrawingElement[]
       - History integration: addElement/updateElement/deleteElement push to history. undo/redo restore from history and update canUndo/canRedo. clearAll pushes empty snapshot.
       - Export `createDrawingStore()` factory function (NOT a singleton)
       - Export `type DrawingStore = ReturnType<typeof createDrawingStore>`
       - Export a React context + provider pattern: `DrawingStoreProvider` and `useDrawingStore` hook (same pattern as canvas-store-provider.tsx)
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm store and history compile.
    Verify exports: `grep -n "export" src/stores/drawing-store.ts`
    Verify history: `grep -n "export" src/lib/drawing/history.ts`
  </verify>
  <done>Drawing store factory creates isolated Zustand store with full element CRUD, tool selection, color/width settings, and integrated undo/redo via DrawingHistory class. Provider and hook exported for React consumption.</done>
</task>

</tasks>

<verification>
1. `npm ls konva react-konva perfect-freehand` shows all three installed
2. `npx tsc --noEmit` passes with zero errors
3. `src/lib/drawing/types.ts` exports DrawingElement with 7 variants
4. `src/stores/drawing-store.ts` exports createDrawingStore factory
5. `src/lib/drawing/history.ts` exports DrawingHistory class with undo/redo
</verification>

<success_criteria>
- Three npm packages installed and importable
- TypeScript types define all drawing element variants
- Zustand drawing store follows factory pattern from canvas-store.ts
- History manager enforces 50-step limit with deep cloning
- All files compile without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/25-ezydraw-foundation/25-01-SUMMARY.md`
</output>
