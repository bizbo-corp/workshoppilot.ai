---
phase: 35-e2e-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - playwright.config.ts
  - package.json
  - src/proxy.ts
  - e2e/helpers/auth-bypass.ts
  - e2e/helpers/workshop-factory.ts
autonomous: true

must_haves:
  truths:
    - "Playwright is installed and configured with a working test runner"
    - "E2E tests can access the app without Clerk authentication blocking"
    - "A workshop factory helper can create a fresh workshop via UI interaction"
  artifacts:
    - path: "playwright.config.ts"
      provides: "Playwright configuration with desktop-only viewport and local dev server"
      contains: "baseURL"
    - path: "e2e/helpers/auth-bypass.ts"
      provides: "Test setup that bypasses Clerk middleware via environment variable"
      contains: "E2E"
    - path: "e2e/helpers/workshop-factory.ts"
      provides: "Helper to create a new workshop and return session URL"
      contains: "createWorkshop"
    - path: "package.json"
      provides: "test:e2e npm script for running Playwright"
      contains: "playwright"
  key_links:
    - from: "playwright.config.ts"
      to: "e2e/"
      via: "testDir configuration"
      pattern: "testDir.*e2e"
    - from: "src/proxy.ts"
      to: "E2E_TESTING env var"
      via: "conditional middleware bypass"
      pattern: "E2E_TESTING|BYPASS_AUTH"
---

<objective>
Install Playwright, configure it for desktop-only E2E testing against the local dev server, and set up auth bypass so tests can access protected routes (steps 4-10) without Clerk authentication.

Purpose: Foundation for E2E test suite -- without Playwright installed and auth bypassed, no automated tests can run.
Output: Working Playwright config, auth bypass mechanism, workshop factory helper, npm script.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/proxy.ts
@package.json
@src/actions/workshop-actions.ts
@src/lib/workshop/step-metadata.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Playwright and configure for local E2E testing</name>
  <files>
    playwright.config.ts
    package.json
    e2e/helpers/auth-bypass.ts
  </files>
  <action>
    1. Install Playwright as a dev dependency:
       ```
       npm install --save-dev @playwright/test
       npx playwright install chromium
       ```
       Only install Chromium browser (not all browsers) since we only need desktop Chrome for this phase.

    2. Create `playwright.config.ts` at project root:
       - `testDir: './e2e'`
       - `baseURL: 'http://localhost:3000'`
       - `timeout: 120_000` (2 min per test — AI responses are slow with real Gemini)
       - `expect.timeout: 30_000` (30s for assertions — streaming responses take time)
       - Single project: `{ name: 'chromium', use: { ...devices['Desktop Chrome'] } }`
       - `webServer` block: `command: 'npm run dev'`, `url: 'http://localhost:3000'`, `reuseExistingServer: true`
       - `use.trace: 'on-first-retry'` for debugging failed tests
       - NO `fullyParallel` — tests must run sequentially since they share a real database

    3. Create `e2e/helpers/auth-bypass.ts`:
       - Export a constant `E2E_AUTH_BYPASS = true` as a marker
       - This file documents the approach: When `BYPASS_AUTH=true` env var is set, the Clerk middleware in `src/proxy.ts` will skip auth checks, allowing Playwright to access all routes including protected steps 4-10 and the dashboard.

    4. Add npm scripts to `package.json`:
       - `"test:e2e": "BYPASS_AUTH=true playwright test"`
       - `"test:e2e:headed": "BYPASS_AUTH=true playwright test --headed"`
       - `"test:e2e:debug": "BYPASS_AUTH=true playwright test --debug"`

    5. Add to `.gitignore` if not present:
       - `test-results/`
       - `playwright-report/`
       - `blob-report/`
  </action>
  <verify>
    - `npx playwright --version` outputs a version number
    - `cat playwright.config.ts` exists with correct testDir and baseURL
    - `grep "test:e2e" package.json` shows the new script
  </verify>
  <done>Playwright installed, configured for desktop Chromium against localhost:3000 with 2-min test timeout, npm scripts added</done>
</task>

<task type="auto">
  <name>Task 2: Implement Clerk auth bypass and workshop factory helper</name>
  <files>
    src/proxy.ts
    e2e/helpers/workshop-factory.ts
  </files>
  <action>
    1. Modify `src/proxy.ts` to conditionally bypass Clerk middleware when `BYPASS_AUTH` env var is set:
       - At the top of the file, check `process.env.BYPASS_AUTH === 'true'`
       - If true, export a simple passthrough middleware that calls `NextResponse.next()` for all routes, instead of the `clerkMiddleware` wrapper
       - Keep the same `config.matcher` export regardless of bypass mode
       - This approach completely skips Clerk's auth() calls, so no Clerk API keys are needed during E2E testing
       - The `createWorkshopSession` server action calls `auth()` which returns `{ userId: null }` when Clerk is bypassed — this is fine because it falls through to `clerkUserId = 'anonymous'`

    2. Create `e2e/helpers/workshop-factory.ts`:
       - Export an async function `createWorkshopViaUI(page: Page)` that:
         a. Navigates to `'/'` (landing page)
         b. Clicks the "Start Workshop" CTA button (look for text or a link/button containing "Start" or "New Workshop")
         c. Waits for navigation to `/workshop/{sessionId}/step/1`
         d. Extracts and returns `{ sessionId, workshopUrl }` from the current URL
       - This helper abstracts workshop creation so each test file can get a fresh workshop
       - Include a `waitForAIGreeting(page: Page)` helper that waits for the first AI message to appear in the chat panel (look for a message bubble or element with role from the AI, timeout 60s since first AI response may be slow due to cold start)
       - Include a `sendMessage(page: Page, text: string)` helper that types into the chat input textarea, presses Enter, and waits for the AI response to appear (new message bubble from assistant)
       - Include a `waitForAIResponse(page: Page, existingCount: number)` helper that waits until the number of assistant messages exceeds `existingCount`
       - Include a `clickNextStep(page: Page)` helper that clicks the "Next" navigation button and waits for URL to change to the next step number

    Selectors guidance (inspect the actual components):
    - Chat input: Look for `textarea` in the chat panel area
    - AI messages: Look for elements that represent assistant messages (check chat-panel.tsx for class names or structure)
    - Next button: Look for the StepNavigation "Next" button (contains ChevronRight icon)
    - Start Workshop: Look for the CTA button on the landing or dashboard page
  </action>
  <verify>
    - `BYPASS_AUTH=true npm run dev` starts without Clerk errors and allows accessing /dashboard and /workshop routes
    - `cat e2e/helpers/workshop-factory.ts` exists with createWorkshopViaUI, sendMessage, waitForAIResponse, clickNextStep exports
    - `grep "BYPASS_AUTH" src/proxy.ts` confirms the conditional bypass
  </verify>
  <done>Clerk middleware conditionally bypassed via BYPASS_AUTH env var, workshop factory helper with UI interaction methods ready for test consumption</done>
</task>

</tasks>

<verification>
1. `npx playwright --version` returns a version
2. `BYPASS_AUTH=true npm run dev` starts the dev server without auth errors
3. Manually visiting `http://localhost:3000/dashboard` in the browser while BYPASS_AUTH=true does NOT redirect to sign-in
4. `ls e2e/helpers/` shows auth-bypass.ts and workshop-factory.ts
5. `npm run test:e2e -- --list` lists available test files (none yet, but no errors)
</verification>

<success_criteria>
Playwright is installed and configured, auth is bypassable for E2E tests, and workshop factory helpers are ready for the test files in Plan 02 to consume.
</success_criteria>

<output>
After completion, create `.planning/phases/35-e2e-testing/35-01-SUMMARY.md`
</output>
