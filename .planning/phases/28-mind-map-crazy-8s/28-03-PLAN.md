---
phase: 28-mind-map-crazy-8s
plan: 03
type: execute
wave: 3
depends_on: ["28-02"]
files_modified:
  - src/app/api/ai/suggest-themes/route.ts
  - src/components/workshop/mind-map-canvas.tsx
autonomous: true

must_haves:
  truths:
    - "AI generates 3-5 diverse theme branch suggestions based on HMW statement and workshop context"
    - "User clicks Suggest Themes button and theme nodes appear as children of root"
    - "Suggested themes auto-assign theme colors and trigger dagre relayout"
    - "AI suggestion works even when mind map already has some manual nodes"
    - "Loading state shown while AI generates suggestions"
  artifacts:
    - path: "src/app/api/ai/suggest-themes/route.ts"
      provides: "API endpoint for AI theme branch generation"
      exports: ["POST"]
    - path: "src/components/workshop/mind-map-canvas.tsx"
      provides: "Suggest Themes button and AI integration in mind map"
      contains: "handleSuggestThemes"
  key_links:
    - from: "src/components/workshop/mind-map-canvas.tsx"
      to: "src/app/api/ai/suggest-themes/route.ts"
      via: "fetch POST to /api/ai/suggest-themes"
      pattern: "fetch.*suggest-themes"
    - from: "src/app/api/ai/suggest-themes/route.ts"
      to: "Gemini AI via Vercel AI SDK"
      via: "generateText or generateObject"
      pattern: "generateObject|generateText"
---

<objective>
Add AI-powered theme suggestion to the mind map canvas so users can overcome blank-canvas paralysis.

Purpose: When users see an empty mind map with just the HMW statement, they may not know where to start. The AI analyzes earlier workshop context (HMW statement, persona, research insights) and suggests 3-5 diverse theme branches as starting points. Users can then build on these themes or add their own.

Output: API endpoint for theme generation and UI button integration in the mind map canvas.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-mind-map-crazy-8s/28-RESEARCH.md
@.planning/phases/28-mind-map-crazy-8s/28-02-SUMMARY.md

# Reference: existing AI integration patterns
@src/app/api/chat/route.ts
@src/app/api/extract/route.ts
@src/lib/ai/prompts/step-prompts.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AI theme suggestion API endpoint</name>
  <files>
    src/app/api/ai/suggest-themes/route.ts
  </files>
  <action>
Create POST endpoint at `/api/ai/suggest-themes` that generates theme branch suggestions for mind map.

**Request body:**
```typescript
{
  workshopId: string;
  hmwStatement: string;
  existingThemes?: string[];  // Already-added theme labels (to avoid duplicates)
}
```

**Implementation:**
1. Validate request body (workshopId, hmwStatement required)
2. Load workshop context from database:
   - Fetch stepArtifacts for earlier steps (challenge step, persona step, sense-making step) to gather context
   - Extract: HMW statement, persona name + description, key insights/pains/gains
   - Use same DB pattern as `/api/extract/route.ts`
3. Build AI prompt:

```
You are facilitating Step 8 (Ideation) of a design thinking workshop.

**Context:**
- HMW Statement: {hmwStatement}
- Persona: {personaName} - {personaDescription}
- Key Pains: {pains}
- Key Gains: {gains}
- Key Insights: {insights}

{existingThemes?.length ? `**Already explored themes (avoid duplicating):** ${existingThemes.join(', ')}` : ''}

**Task:**
Generate 3-5 high-level theme branches for a mind map exploring solutions to the HMW statement.

**Requirements:**
- Each theme should be broad enough to spawn multiple sub-ideas (2-4 words)
- Themes should be diverse and not overlap with each other
- Themes should connect to persona needs and research insights
- Do NOT duplicate any already-explored themes

Output as JSON array of strings. Example: ["Mobile-First Experience", "Community Features", "Gamification Elements"]
```

4. Call Gemini via Vercel AI SDK `generateObject` with z.object({ themes: z.array(z.string()) }) schema
5. Use same model configuration as existing AI routes (Gemini 2.0 Flash)
6. Return `{ themes: string[] }` on success
7. Return appropriate error responses (400 for missing params, 500 for AI failure)

**Error handling:**
- Wrap in try/catch, return 500 with error message on failure
- If workshop not found, return 404
- If AI returns empty/invalid, return fallback generic themes: ["Technology Solutions", "Process Improvements", "User Experience", "Community & Social"]
  </action>
  <verify>
Run `npx tsc --noEmit` — zero errors.
Grep `src/app/api/ai/suggest-themes/route.ts` for: POST, generateObject, hmwStatement, themes, Gemini.
  </verify>
  <done>
API endpoint accepts workshopId + HMW statement, loads workshop context, generates 3-5 theme suggestions via Gemini, returns JSON array.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Suggest Themes button to MindMapCanvas</name>
  <files>
    src/components/workshop/mind-map-canvas.tsx
  </files>
  <action>
Add AI theme suggestion UI to the MindMapCanvas component:

**New props:** Add `workshopId: string` to existing props (already has workshopId but ensure it's accessible).

**New state:**
- `isSuggesting: boolean` — loading state for AI request
- `suggestionError: string | null` — error message if suggestion fails

**Suggest Themes button:**
Position a floating panel in the top-right corner of the ReactFlow canvas:
```tsx
<Panel position="top-right" className="!m-3">
  <div className="bg-background border rounded-lg shadow-sm p-3 space-y-2">
    <Button
      onClick={handleSuggestThemes}
      disabled={isSuggesting}
      size="sm"
      variant="outline"
      className="gap-2"
    >
      {isSuggesting ? (
        <Loader2 className="h-4 w-4 animate-spin" />
      ) : (
        <Sparkles className="h-4 w-4" />
      )}
      {isSuggesting ? 'Generating...' : 'Suggest Themes'}
    </Button>
    {suggestionError && (
      <p className="text-xs text-destructive">{suggestionError}</p>
    )}
  </div>
</Panel>
```

Import `Panel` from `@xyflow/react`, `Button` from ui, `Sparkles` and `Loader2` from lucide-react.

**handleSuggestThemes callback:**
1. Set `isSuggesting = true`, clear error
2. Collect existing theme labels from level-1 nodes: `mindMapNodes.filter(n => n.level === 1).map(n => n.label)`
3. Fetch POST `/api/ai/suggest-themes` with `{ workshopId, hmwStatement: rootNode.label, existingThemes }`
4. Parse response JSON: `{ themes: string[] }`
5. For each theme:
   - Determine theme color: THEME_COLORS index based on total level-1 children count (existing + new)
   - Create MindMapNodeState: unique ID, theme label, level 1, parentId: 'root', color from palette
   - Create MindMapEdgeState: source 'root', target newNodeId
   - Call `addMindMapNode(newNode, newEdge)` for each
6. Set `isSuggesting = false`
7. On error: set `suggestionError` with user-friendly message, set `isSuggesting = false`

**UX considerations:**
- Button only visible when mind map has fewer than 6 level-1 branches (after that, user has plenty of themes)
- Each suggestion adds to existing mind map (doesn't replace)
- After adding themes, fitView is called to show all new nodes
  </action>
  <verify>
Run `npx tsc --noEmit` — zero errors.
Run `npm run build` — production build succeeds.
Grep `src/components/workshop/mind-map-canvas.tsx` for: handleSuggestThemes, suggest-themes, Sparkles, isSuggesting, Panel.
  </verify>
  <done>
Suggest Themes button in MindMapCanvas calls AI endpoint, generates 3-5 theme branches, adds them as level-1 children of root with auto-assigned colors, triggers dagre relayout.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm run build` succeeds
3. API endpoint `/api/ai/suggest-themes` exists and handles POST
4. AI prompt includes workshop context (HMW, persona, insights)
5. Existing themes passed to AI to avoid duplicates
6. New theme nodes auto-assign colors from THEME_COLORS palette
7. Button shows loading spinner during generation
8. Button hidden when 6+ themes already exist
</verification>

<success_criteria>
- AI generates 3-5 diverse theme suggestions grounded in workshop context
- Themes appear as color-coded children of root node with dagre layout
- Loading state and error handling provide smooth UX
- Existing manual themes preserved when AI suggestions added
- Full TypeScript compilation and build pass
</success_criteria>

<output>
After completion, create `.planning/phases/28-mind-map-crazy-8s/28-03-SUMMARY.md`
</output>
