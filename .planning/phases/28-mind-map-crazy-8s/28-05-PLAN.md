---
phase: 28-mind-map-crazy-8s
plan: 05
type: execute
wave: 2
depends_on: ["28-04"]
files_modified:
  - src/components/workshop/crazy-8s-canvas.tsx
  - src/app/api/ai/suggest-sketch-prompts/route.ts
  - src/hooks/use-canvas-autosave.ts
  - src/actions/canvas-actions.ts
autonomous: true

must_haves:
  truths:
    - "Tapping an empty slot opens EzyDraw modal with 800x800 square canvas"
    - "Saving a drawing from EzyDraw stores PNG to Vercel Blob and updates slot"
    - "Tapping a filled slot re-opens EzyDraw with saved vector elements for editing"
    - "Updated sketch replaces the previous image in the slot"
    - "AI can suggest sketch prompts that appear in empty slots"
    - "Crazy 8s slots persist across page refresh via autosave"
  artifacts:
    - path: "src/components/workshop/crazy-8s-canvas.tsx"
      provides: "Crazy 8s container with EzyDraw integration"
      exports: ["Crazy8sCanvas"]
    - path: "src/app/api/ai/suggest-sketch-prompts/route.ts"
      provides: "AI endpoint for sketch prompt suggestions"
      exports: ["POST"]
    - path: "src/hooks/use-canvas-autosave.ts"
      provides: "Autosave includes crazy8sSlots and mindMapNodes"
      contains: "crazy8sSlots"
    - path: "src/actions/canvas-actions.ts"
      provides: "Canvas load/save includes crazy8sSlots and mindMapNodes"
      contains: "crazy8sSlots"
  key_links:
    - from: "src/components/workshop/crazy-8s-canvas.tsx"
      to: "src/actions/drawing-actions.ts"
      via: "saveDrawing/loadDrawing/updateDrawing server actions"
      pattern: "saveDrawing|loadDrawing|updateDrawing"
    - from: "src/components/workshop/crazy-8s-canvas.tsx"
      to: "src/components/workshop/crazy-8s-grid.tsx"
      via: "Grid component rendering"
      pattern: "Crazy8sGrid"
    - from: "src/hooks/use-canvas-autosave.ts"
      to: "src/stores/canvas-store.ts"
      via: "Subscribe to crazy8sSlots changes"
      pattern: "crazy8sSlots"
---

<objective>
Wire EzyDraw modal into Crazy 8s grid for the complete sketch-to-slot workflow: tap slot, draw, save, display. Add AI sketch prompt suggestions and persist slots via autosave.

Purpose: This completes the Crazy 8s drawing experience. Users can sketch in each of the 8 slots using the EzyDraw modal (built in Phase 25-27) with an 800x800 square canvas. Sketches save as PNG to Vercel Blob and display in the grid. AI suggests prompts to help overcome blank-canvas paralysis.

Output: Crazy 8s container component, AI prompt endpoint, and autosave integration.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-mind-map-crazy-8s/28-RESEARCH.md
@.planning/phases/28-mind-map-crazy-8s/28-04-SUMMARY.md

# Reference: EzyDraw integration patterns from Phase 26
@.planning/phases/26-drawing-canvas-integration/26-03-SUMMARY.md

# Reference: existing drawing server actions and autosave
@src/actions/drawing-actions.ts
@src/hooks/use-canvas-autosave.ts
@src/actions/canvas-actions.ts
@src/components/ezydraw/ezydraw-modal.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build Crazy8sCanvas container with EzyDraw integration</name>
  <files>
    src/components/workshop/crazy-8s-canvas.tsx
  </files>
  <action>
Create the Crazy8sCanvas wrapper component that connects Crazy8sGrid with EzyDraw modal for the draw-save-display flow:

**Props:**
```typescript
interface Crazy8sCanvasProps {
  workshopId: string;
  stepId: string;
}
```

**Imports:**
- Crazy8sGrid from `./crazy-8s-grid`
- EzyDrawLoader from `@/components/ezydraw/ezydraw-loader` (lazy-loaded wrapper from Phase 25)
- saveDrawing, loadDrawing, updateDrawing from `@/actions/drawing-actions`
- simplifyDrawingElements from `@/lib/drawing/simplify`
- EMPTY_CRAZY_8S_SLOTS, CRAZY_8S_CANVAS_SIZE from `@/lib/canvas/crazy-8s-types`
- useCanvasStore from store provider
- DrawingElement type from `@/lib/drawing/types`

**Store selectors:**
- crazy8sSlots, updateCrazy8sSlot, setCrazy8sSlots

**Initialization:**
- useEffect on mount: if `crazy8sSlots.length === 0`, call `setCrazy8sSlots(EMPTY_CRAZY_8S_SLOTS)` to initialize 8 empty slots

**EzyDraw modal state:**
```typescript
const [ezyDrawState, setEzyDrawState] = useState<{
  isOpen: boolean;
  slotId: string;
  drawingId?: string;           // Existing drawing ID for re-edit
  initialElements?: DrawingElement[];  // Existing vector data for re-edit
} | null>(null);
```

**handleSlotClick(slotId: string):**
1. Find slot in crazy8sSlots by slotId
2. If slot has drawingId (filled slot → re-edit):
   - Call `loadDrawing({ workshopId, stepId, drawingId: slot.drawingId })`
   - If drawing found, parse vectorJson to DrawingElement[]
   - Open EzyDraw with `{ isOpen: true, slotId, drawingId: slot.drawingId, initialElements: elements }`
   - If drawing not found (deleted?), open empty: `{ isOpen: true, slotId }`
3. If slot has no drawingId (empty slot → new drawing):
   - Open EzyDraw with `{ isOpen: true, slotId }`

**handleDrawingSave(result: { pngDataUrl: string; elements: DrawingElement[] }):**
Following Phase 26-03 pattern exactly:
1. Simplify elements: `const simplified = simplifyDrawingElements(result.elements)`
2. Convert to JSON: `const vectorJson = JSON.stringify(simplified)`
3. If re-editing (ezyDrawState.drawingId exists):
   - Call `updateDrawing({ workshopId, stepId, drawingId: ezyDrawState.drawingId, pngBase64: result.pngDataUrl, vectorJson, width: 800, height: 800 })`
   - On success: `updateCrazy8sSlot(ezyDrawState.slotId, { imageUrl: response.pngUrl })`
4. If new drawing:
   - Call `saveDrawing({ workshopId, stepId, pngBase64: result.pngDataUrl, vectorJson, width: 800, height: 800 })`
   - On success: `updateCrazy8sSlot(ezyDrawState.slotId, { drawingId: response.drawingId, imageUrl: response.pngUrl })`
5. Close modal: `setEzyDrawState(null)`

**handleTitleChange(slotId: string, title: string):**
- Call `updateCrazy8sSlot(slotId, { title })`

**AI prompt state (feature hook for Task 2):**
- `aiPrompts: string[]` state, initially empty
- Pass to Crazy8sGrid as prop

**Render:**
```tsx
<div className="h-full overflow-auto p-6">
  <Crazy8sGrid
    slots={crazy8sSlots}
    onSlotClick={handleSlotClick}
    onTitleChange={handleTitleChange}
    aiPrompts={aiPrompts}
  />

  {ezyDrawState?.isOpen && (
    <EzyDrawLoader
      isOpen={true}
      onClose={() => setEzyDrawState(null)}
      onSave={handleDrawingSave}
      initialElements={ezyDrawState.initialElements}
      canvasSize={CRAZY_8S_CANVAS_SIZE}  // 800x800 square
    />
  )}
</div>
```

Note: EzyDrawLoader may need `canvasSize` prop support. If not already supported, pass it and the EzyDraw modal should use it to set Stage width/height. Check existing EzyDraw modal implementation — if canvasSize prop is not supported, add it as an optional prop that defaults to 1920x1080 and update the Stage dimensions accordingly. This is a minimal change: the Stage width/height should read from `canvasSize?.width ?? 1920` and `canvasSize?.height ?? 1080`.
  </action>
  <verify>
Run `npx tsc --noEmit` — zero errors.
Grep `src/components/workshop/crazy-8s-canvas.tsx` for: Crazy8sCanvas, EzyDrawLoader, handleSlotClick, handleDrawingSave, saveDrawing, loadDrawing, updateDrawing, simplifyDrawingElements, CRAZY_8S_CANVAS_SIZE.
  </verify>
  <done>
Crazy8sCanvas wires EzyDraw modal to grid slots: empty slot opens blank 800x800 canvas, filled slot opens with saved vector data, save writes PNG + vector JSON, slot updates with image URL and drawing reference.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add AI sketch prompts and autosave integration</name>
  <files>
    src/app/api/ai/suggest-sketch-prompts/route.ts
    src/hooks/use-canvas-autosave.ts
    src/actions/canvas-actions.ts
    src/components/workshop/crazy-8s-canvas.tsx
  </files>
  <action>
**suggest-sketch-prompts/route.ts:**
Create POST endpoint for AI sketch prompt suggestions:

Request body: `{ workshopId: string; themes?: string[] }` (themes from mind map if available)

Implementation:
1. Load workshop context (HMW statement, persona from earlier steps)
2. Build prompt:
```
You are facilitating Step 8b (Crazy 8s) of a design thinking workshop.

Context:
- HMW: {hmwStatement}
- Persona: {personaName}
- Mind Map Themes: {themes.join(', ')}

Generate exactly 8 short sketch prompts (1 sentence each) to help the user sketch 8 different ideas.
Each prompt should suggest a specific, sketchable concept.

Output as JSON array of 8 strings. Keep each under 80 characters.
Example: ["Sketch a mobile app home screen with...", "Draw a notification that..."]
```
3. Call Gemini via `generateObject` with `z.object({ prompts: z.array(z.string()).length(8) })`
4. Return `{ prompts: string[] }`
5. Fallback on error: return 8 generic prompts like "Sketch your best idea", "Try a mobile-first approach", etc.

**use-canvas-autosave.ts:**
Update autosave hook to include mind map and crazy 8s state:

Add store selectors:
- `mindMapNodes`, `mindMapEdges`, `crazy8sSlots`

Include in autosave payload alongside existing postIts, drawingNodes, gridColumns:
- `mindMapNodes: mindMapNodes` (serialized to _canvas object)
- `mindMapEdges: mindMapEdges` (serialized to _canvas object)
- `crazy8sSlots: crazy8sSlots` (serialized to _canvas object)

Add these to the dependency array that triggers save (alongside existing postIts and gridColumns checks).

**canvas-actions.ts:**
Update save/load types to include mind map and crazy 8s data:

In `saveCanvasState`:
- Accept optional `mindMapNodes`, `mindMapEdges`, `crazy8sSlots` in params
- Store in `_canvas` object alongside existing postIts, drawingNodes, gridColumns

In `loadCanvasState`:
- Return `mindMapNodes`, `mindMapEdges`, `crazy8sSlots` from `_canvas` object if present

**crazy-8s-canvas.tsx (update):**
Add "Suggest Prompts" button:
- Position above the grid: `<div className="flex justify-end mb-4">`
- Button with Sparkles icon, disabled during loading
- Calls `/api/ai/suggest-sketch-prompts` with workshopId
- Sets `aiPrompts` state with response
- Button only shows when all slots are empty (once user starts drawing, prompts are less useful)
  </action>
  <verify>
Run `npx tsc --noEmit` — zero errors.
Run `npm run build` — production build succeeds.
Grep `src/app/api/ai/suggest-sketch-prompts/route.ts` for: POST, prompts, Gemini.
Grep `src/hooks/use-canvas-autosave.ts` for: mindMapNodes, mindMapEdges, crazy8sSlots.
Grep `src/actions/canvas-actions.ts` for: mindMapNodes, mindMapEdges, crazy8sSlots.
  </verify>
  <done>
AI sketch prompts endpoint generates 8 contextual prompts. Autosave persists mind map nodes/edges and Crazy 8s slots. Canvas load/save includes all Phase 28 state. Suggest Prompts button visible when all slots empty.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm run build` succeeds
3. Empty slot click opens EzyDraw with 800x800 canvas
4. Drawing save stores PNG to Vercel Blob and updates slot
5. Filled slot click loads vector JSON and opens EzyDraw for re-edit
6. AI sketch prompts endpoint returns 8 prompts
7. Autosave includes mindMapNodes, mindMapEdges, crazy8sSlots
8. Canvas load restores mind map and crazy 8s state
</verification>

<success_criteria>
- Complete draw-save-display cycle works for all 8 slots
- Re-edit preserves vector data (not just PNG)
- 800x800 square canvas prevents aspect ratio distortion
- AI prompts appear in empty slots when generated
- All state persists across page refresh via autosave
- No regressions to existing canvas autosave (postIts, drawingNodes, gridColumns)
</success_criteria>

<output>
After completion, create `.planning/phases/28-mind-map-crazy-8s/28-05-SUMMARY.md`
</output>
