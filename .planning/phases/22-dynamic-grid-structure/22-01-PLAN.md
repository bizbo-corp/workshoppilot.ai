---
phase: 22-dynamic-grid-structure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/canvas/step-canvas-config.ts
  - src/stores/canvas-store.ts
  - src/providers/canvas-store-provider.tsx
  - src/components/canvas/post-it-node.tsx
  - src/components/canvas/react-flow-canvas.tsx
autonomous: true

must_haves:
  truths:
    - "Grid cells are large enough to comfortably fit post-its with generous margins (240px wide, 150px tall)"
    - "Post-it cards grow vertically to show all text without scrolling"
    - "Dragging a post-it shows pointer cursor on hover and grabbing cursor during drag with reduced opacity"
    - "Canvas store holds dynamic gridColumns state with add/update/remove actions"
    - "Column operations participate in undo/redo via existing zundo temporal middleware"
  artifacts:
    - path: "src/lib/canvas/step-canvas-config.ts"
      provides: "Larger grid cell dimensions (240px columns, 150px rows, 15px padding)"
      contains: "width: 240"
    - path: "src/stores/canvas-store.ts"
      provides: "GridColumn type, gridColumns state, addGridColumn/updateGridColumn/removeGridColumn actions"
      exports: ["GridColumn", "CanvasState", "CanvasActions"]
    - path: "src/components/canvas/post-it-node.tsx"
      provides: "Auto-sizing textarea via react-textarea-autosize, cursor-pointer class"
      contains: "TextareaAutosize"
    - path: "src/components/canvas/react-flow-canvas.tsx"
      provides: "Drag opacity feedback via onNodeDragStart/onNodeDragStop handlers"
      contains: "draggingNodeId"
  key_links:
    - from: "src/stores/canvas-store.ts"
      to: "zundo temporal middleware"
      via: "gridColumns in partialize"
      pattern: "gridColumns"
    - from: "src/components/canvas/post-it-node.tsx"
      to: "react-textarea-autosize"
      via: "TextareaAutosize import"
      pattern: "import TextareaAutosize"
    - from: "src/components/canvas/react-flow-canvas.tsx"
      to: "src/stores/canvas-store.ts"
      via: "gridColumns selector for passing dynamic columns"
      pattern: "useCanvasStore.*gridColumns"
---

<objective>
Establish Phase 22 foundation: enlarge grid cells for comfortable post-it spacing, extend canvas store with dynamic column state and actions, and polish post-it UX with auto-sizing text and drag feedback.

Purpose: These are the building blocks for column management UI (Plan 02). The store must hold dynamic gridColumns before any UI can add/remove/edit columns. The UX polish items (auto-size, drag cursor) are independent improvements requested by the user that touch the same files.

Output: Larger grid cells visible in journey mapping, canvas store ready with column CRUD actions, post-its auto-size and show drag feedback.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-dynamic-grid-structure/22-RESEARCH.md
@src/stores/canvas-store.ts
@src/providers/canvas-store-provider.tsx
@src/lib/canvas/step-canvas-config.ts
@src/lib/canvas/grid-layout.ts
@src/components/canvas/post-it-node.tsx
@src/components/canvas/react-flow-canvas.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enlarge grid cells and extend canvas store with dynamic column state</name>
  <files>
    src/lib/canvas/step-canvas-config.ts
    src/stores/canvas-store.ts
    src/providers/canvas-store-provider.tsx
  </files>
  <action>
**step-canvas-config.ts** - Update journey-mapping gridConfig dimensions:
- All row heights to 150px (except 'emotions' which goes to 120px)
- All column widths to 240px
- origin.y to 60 (from 50) for header breathing room
- cellPadding to 15 (from 10)

**canvas-store.ts** - Extend with dynamic column management:

1. Add `GridColumn` type export:
```typescript
export type GridColumn = {
  id: string;
  label: string;
  width: number;
};
```

2. Add `gridColumns` to `CanvasState`:
```typescript
export type CanvasState = {
  postIts: PostIt[];
  isDirty: boolean;
  gridColumns: GridColumn[]; // Dynamic columns, initialized from step config
};
```

3. Add column actions to `CanvasActions`:
```typescript
addGridColumn: (label: string) => void;
updateGridColumn: (id: string, updates: Partial<GridColumn>) => void;
removeGridColumn: (id: string, gridConfig: GridConfig) => void;
```

4. Implement `addGridColumn`: Generate UUID id, use default width 240, append to gridColumns array, set isDirty.

5. Implement `updateGridColumn`: Map over gridColumns, merge updates for matching id, set isDirty. Do NOT recalculate post-it positions here (label edits don't affect positions; width changes deferred to future phase).

6. Implement `removeGridColumn`: Find column index. Determine adjacent target column (prefer left, fall back to right). For each postIt with cellAssignment.col matching deleted column id:
   - If target column exists: update cellAssignment.col to target column id, recalculate position using getCellBounds with the FILTERED columns array (import getCellBounds from grid-layout.ts). The getCellBounds call needs a CellCoordinate — find the target column's NEW index in the filtered array, and find the row index from the gridConfig.rows array using postIt.cellAssignment.row.
   - If no target column (deleting last column): clear cellAssignment to undefined.
   - Filter out deleted column from gridColumns, set isDirty.

7. Update `partialize` in temporal config to include `gridColumns`:
```typescript
partialize: (state) => ({
  postIts: state.postIts,
  gridColumns: state.gridColumns,
}),
```

8. Update DEFAULT_STATE to include `gridColumns: initState?.gridColumns || []`.

9. Update `createCanvasStore` signature to accept optional gridColumns in initState:
```typescript
export const createCanvasStore = (initState?: { postIts: PostIt[]; gridColumns?: GridColumn[] }) => {
```

10. Add `setGridColumns` action (for loading from DB, like setPostIts — does NOT set isDirty):
```typescript
setGridColumns: (gridColumns: GridColumn[]) => set(() => ({ gridColumns })),
```

**canvas-store-provider.tsx** - Update to pass initialGridColumns:
- Add `initialGridColumns?: GridColumn[]` to CanvasStoreProviderProps
- Pass to createCanvasStore: `createCanvasStore({ postIts: initialPostIts || [], gridColumns: initialGridColumns || [] })`

NOTE: Import `GridConfig` from `@/lib/canvas/grid-layout` in canvas-store.ts for the removeGridColumn action. Import `getCellBounds` too. The gridConfig parameter in removeGridColumn provides the rows array needed to find row indices.
  </action>
  <verify>
Run `npx tsc --noEmit` — zero TypeScript errors. Verify GridColumn type is exported. Verify gridColumns appears in CanvasState. Verify addGridColumn, updateGridColumn, removeGridColumn exist in CanvasActions.
  </verify>
  <done>
step-canvas-config.ts has 240px column widths, 150px row heights (120px for emotions), 15px cellPadding, 60px origin.y. canvas-store.ts exports GridColumn type, CanvasState includes gridColumns, three column actions implemented, partialize includes gridColumns. canvas-store-provider.tsx accepts initialGridColumns prop.
  </done>
</task>

<task type="auto">
  <name>Task 2: Auto-size post-it cards and add drag cursor/opacity feedback</name>
  <files>
    src/components/canvas/post-it-node.tsx
    src/components/canvas/react-flow-canvas.tsx
  </files>
  <action>
**post-it-node.tsx** — Replace textarea with TextareaAutosize and add cursor:

1. Add import: `import TextareaAutosize from 'react-textarea-autosize';`

2. Add `cursor-pointer` to the outer div className (after the existing transition classes).

3. Add a `dragging` prop to PostItNodeData:
```typescript
export type PostItNodeData = {
  text: string;
  color: PostItColor;
  isEditing: boolean;
  dragging?: boolean; // NEW: true during drag for opacity feedback
  onTextChange?: (id: string, text: string) => void;
  onEditComplete?: (id: string) => void;
};
```

4. In the outer div style, add conditional opacity:
```typescript
style={{
  width: '120px',
  minHeight: '120px',
  touchAction: 'none',
  opacity: data.dragging ? 0.6 : 1,
  transition: 'opacity 150ms ease',
}}
```

5. Replace the `<textarea>` with `<TextareaAutosize>`:
```tsx
<TextareaAutosize
  autoFocus
  maxLength={200}
  minRows={3}
  maxRows={10}
  className="nodrag nopan bg-transparent border-none outline-none resize-none w-full"
  defaultValue={data.text}
  onBlur={() => data.onEditComplete?.(id)}
  onChange={(e) => data.onTextChange?.(id, e.target.value)}
  onKeyDown={handleKeyDown}
  placeholder="Type here..."
  style={{ overflow: 'hidden' }}
/>
```

6. The non-editing text display `<p>` is already fine with `break-words whitespace-pre-wrap`. Keep it.

**react-flow-canvas.tsx** — Add drag feedback state and pass to nodes:

1. Add state: `const [draggingNodeId, setDraggingNodeId] = useState<string | null>(null);`

2. Add `onNodeDragStart` handler:
```typescript
const handleNodeDragStart = useCallback(
  (_event: React.MouseEvent, node: Node) => {
    setDraggingNodeId(node.id);
  },
  []
);
```

3. Modify existing `handleNodeDrag` — no changes needed, it already handles cell highlighting.

4. Update the drag-stop logic in `handleNodesChange` (the `if (change.dragging === false)` block): After updating the post-it position, also call `setDraggingNodeId(null)`.

5. In the `nodes` useMemo, pass `dragging` in the data:
```typescript
data: {
  text: postIt.text,
  color: postIt.color || 'yellow',
  isEditing: editingNodeId === postIt.id,
  dragging: draggingNodeId === postIt.id, // NEW
  onTextChange: handleTextChange,
  onEditComplete: handleEditComplete,
} as PostItNodeData,
```

6. Add `draggingNodeId` to the useMemo dependency array.

7. Wire `onNodeDragStart={handleNodeDragStart}` on the `<ReactFlow>` component.

8. Also add a global CSS class for the grabbing cursor. In the `<ReactFlow>` component, add `className` prop:
```tsx
<ReactFlow
  className={draggingNodeId ? 'cursor-grabbing' : ''}
  // ... existing props
>
```
  </action>
  <verify>
Run `npx tsc --noEmit` — zero TypeScript errors. Run `npm run build` — build succeeds. Verify TextareaAutosize import in post-it-node.tsx. Verify draggingNodeId state in react-flow-canvas.tsx. Verify onNodeDragStart handler wired to ReactFlow.
  </verify>
  <done>
Post-it cards use TextareaAutosize with minRows=3, maxRows=10, overflow hidden (no scroll). Post-it outer div has cursor-pointer class and conditional opacity 0.6 during drag. ReactFlowCanvas tracks draggingNodeId state, sets it on drag start, clears on drag stop, passes dragging boolean to PostItNode data.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- `npm run build` succeeds (SSR safety, no client-only imports in server code)
- Journey mapping grid config shows 240px columns, 150px rows, 15px padding
- Canvas store exports GridColumn type and column actions
- PostItNode imports TextareaAutosize from react-textarea-autosize
- Dragging state tracked and passed as data.dragging to PostItNode
</verification>

<success_criteria>
1. Grid cells in step-canvas-config.ts are enlarged (240px wide, 150px/120px tall, 15px padding)
2. Canvas store has gridColumns state with add/update/remove actions participating in undo/redo
3. Post-it textarea auto-sizes with no scrollbar, grows to fit content
4. Dragging a post-it reduces opacity to 0.6, hovering shows pointer cursor
5. TypeScript compilation and production build both pass
</success_criteria>

<output>
After completion, create `.planning/phases/22-dynamic-grid-structure/22-01-SUMMARY.md`
</output>
