---
phase: 03-application-shell
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/actions/workshop-actions.ts
  - src/app/page.tsx
  - src/app/workshop/loading.tsx
  - src/components/layout/landing-header.tsx
  - src/components/workshop/start-workshop-button.tsx
autonomous: true

must_haves:
  truths:
    - "Clicking 'Start Workshop' creates a workshop + session in the database"
    - "User is redirected to /workshop/[sessionId]/step/1 after session creation"
    - "Landing page shows clear 'Start Workshop' CTA with loading state"
    - "Anonymous users can start workshops (no auth required)"
    - "Brief loading screen appears during session creation"
  artifacts:
    - path: "src/actions/workshop-actions.ts"
      provides: "Server Action to create workshop + session in DB"
      exports: ["createWorkshopSession"]
    - path: "src/app/page.tsx"
      provides: "Updated landing page with Start Workshop button"
    - path: "src/components/layout/landing-header.tsx"
      provides: "Separate header for landing page"
    - path: "src/components/workshop/start-workshop-button.tsx"
      provides: "Client component with loading state for starting workshops"
  key_links:
    - from: "src/components/workshop/start-workshop-button.tsx"
      to: "src/actions/workshop-actions.ts"
      via: "Server Action invocation"
      pattern: "createWorkshopSession"
    - from: "src/actions/workshop-actions.ts"
      to: "src/db/client.ts"
      via: "database insert"
      pattern: "db\\.insert"
---

<objective>
Create the workshop session creation flow: Server Action that creates workshop + session in DB, landing page with "Start Workshop" CTA, and loading screen during creation.

Purpose: This is the primary user entry point. Clicking "Start Workshop" should immediately create a DB record and redirect to Step 1. Anonymous users can start without auth.
Output: Server Action for session creation, updated landing page, landing header component, loading screen.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-application-shell/03-CONTEXT.md
@.planning/phases/03-application-shell/03-RESEARCH.md
@src/db/schema/workshops.ts
@src/db/schema/sessions.ts
@src/db/schema/steps.ts
@src/db/client.ts
@src/lib/ids.ts
@src/app/page.tsx
@src/components/Logo.tsx
@.planning/phases/03-application-shell/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create workshop session Server Action</name>
  <files>src/actions/workshop-actions.ts</files>
  <action>
Create `src/actions/workshop-actions.ts` with `'use server'` directive.

Implement `createWorkshopSession()`:

1. Get the current user from Clerk's `auth()`. If no user (anonymous), use `null` for clerkUserId.
2. Create a workshop record:
   - `id`: generated with `createPrefixedId('ws')`
   - `clerkUserId`: userId from auth or a placeholder string like `'anonymous'` (the workshops table has `clerkUserId` as notNull, so we need a value -- use `'anonymous'` for unauthenticated users)
   - `title`: `'New Workshop'` (per user decision: "Before AI naming, workshop appears as 'New Workshop'")
   - `originalIdea`: empty string (will be populated later when AI processes first message)
   - `status`: `'active'`
3. Create a session record:
   - `id`: generated with `createPrefixedId('ses')`
   - `workshopId`: the workshop ID from step 2
4. Initialize all 10 workshop_steps records as `'not_started'`:
   - CRITICAL: Use the CORRECT WorkshopPilot step definition IDs that match the seed script:
     'challenge', 'stakeholder-mapping', 'user-research', 'sense-making', 'persona', 'journey-mapping', 'reframe', 'ideation', 'concept', 'validate'
   - Do NOT use the old wrong IDs (empathize, define, ideate, prototype, test, etc.)
   - For each of these 10 step definition IDs, create a workshopSteps record
   - Set step 1 ('challenge') to `'in_progress'` since user starts there
   - Import STEPS from `src/lib/workshop/step-metadata.ts` and use `STEPS.map(s => s.id)` to get the step definition IDs, ensuring they stay in sync with the metadata module
5. Call `redirect(`/workshop/${sessionId}/step/1`)` to send user to Step 1.

Handle errors: wrap in try/catch, log errors, throw a user-friendly error if DB insert fails.

Note on the workshops schema: `clerkUserId` is notNull. For anonymous users, store a recognizable placeholder like `'anonymous'`. When the user signs up and migration happens (Phase 2 already built this), these records get updated.
  </action>
  <verify>
Run `npm run build` to confirm no TypeScript errors.
Verify the server action file has `'use server'` at the top.
Verify the function performs: workshop insert, session insert, workshopSteps inserts (10 records), and redirect.
Verify the step IDs used are: challenge, stakeholder-mapping, user-research, sense-making, persona, journey-mapping, reframe, ideation, concept, validate.
  </verify>
  <done>Server Action `createWorkshopSession` creates workshop + session + 10 workshop_steps in DB using CORRECT step definition IDs (challenge, stakeholder-mapping, user-research, etc.), then redirects to `/workshop/[sessionId]/step/1`. Works for both authenticated and anonymous users.</done>
</task>

<task type="auto">
  <name>Task 2: Update landing page with Start Workshop CTA and landing header</name>
  <files>src/app/page.tsx, src/components/layout/landing-header.tsx, src/components/workshop/start-workshop-button.tsx, src/app/workshop/loading.tsx</files>
  <action>
**Create `src/components/layout/landing-header.tsx`:**

Per user decision: "Separate header components for landing page vs workshop."

Build a landing-specific header:
- Left: Logo (Link to `/`)
- Right: Sign in button (for signed-out users via Clerk `SignedOut`), UserButton + "Dashboard" link (for signed-in users via `SignedIn`)
- The header should NOT be sticky/fixed -- per user decision: "Header scrolls away with content"
- Style: Linear-like clean design, subtle border-bottom, muted colors
- Support dark mode with `dark:` Tailwind variants
- Import and reuse the sign-in/sign-up modal system from Phase 2

**Create `src/components/workshop/start-workshop-button.tsx`:**

Client component (`'use client'`) that:
- Uses `useTransition` to manage loading state
- Calls the `createWorkshopSession` server action on click
- Shows loading state: "Setting up your workshop..." with a spinner animation (per user decision: "Brief loading screen with animation 1-2 seconds")
- Uses shadcn Button component for consistent styling
- Large, prominent button style (this is the primary CTA)

**Update `src/app/page.tsx`:**

Redesign the landing page:
- Import and render `LandingHeader` at top
- Keep the Logo and tagline centered
- Add the `StartWorkshopButton` component as primary CTA below the tagline
- For signed-in users, also show a "Continue Workshop" secondary CTA that links to `/dashboard` (per user decision: "Dashboard primary CTA: Continue most recent workshop -- Start New is secondary")
- Clean, minimal design (Linear-like per user decision)
- Dark mode support

**Create `src/app/workshop/loading.tsx`:**

Next.js loading file that shows during workshop route transitions:
- "Setting up your workshop..." with a spinner/animation
- Per user decision: "Brief loading screen with animation (1-2 seconds)"
- Also used for "Resuming your workshop..." when coming from dashboard
- Clean, centered, minimal design
  </action>
  <verify>
Run `npm run build` to confirm no TypeScript errors.
Run `npm run dev` and verify:
1. Landing page renders with landing header, logo, tagline, and Start Workshop button
2. Landing header has sign-in button for unauthenticated users
3. Clicking "Start Workshop" shows loading state
4. Workshop loading screen appears during transition
  </verify>
  <done>Landing page displays with clear "Start Workshop" CTA. Clicking it creates a session in DB and redirects to step 1. Landing-specific header shows auth controls. Loading screen appears during session creation. Works for both anonymous and authenticated users.</done>
</task>

</tasks>

<verification>
- `npm run build` passes
- Landing page has "Start Workshop" button
- Server action creates workshop + session + 10 steps in DB using correct step IDs (challenge, stakeholder-mapping, etc.)
- Redirect to `/workshop/[sessionId]/step/1` works
- Loading screen shows during creation
- Anonymous users can start workshops
- Landing header is separate from workshop header
</verification>

<success_criteria>
Users can click "Start Workshop" on the landing page, which creates a workshop session in the database and redirects them to Step 1. The flow works for both anonymous and authenticated users. A brief loading screen appears during creation. Workshop steps are created with the correct WorkshopPilot step definition IDs.
</success_criteria>

<output>
After completion, create `.planning/phases/03-application-shell/03-03-SUMMARY.md`
</output>
