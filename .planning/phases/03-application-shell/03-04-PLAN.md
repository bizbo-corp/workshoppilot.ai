---
phase: 03-application-shell
plan: 04
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - src/app/workshop/[sessionId]/layout.tsx
  - src/components/layout/workshop-header.tsx
  - src/components/layout/workshop-sidebar.tsx
  - src/components/layout/mobile-stepper.tsx
  - src/components/dialogs/exit-workshop-dialog.tsx
  - src/hooks/use-local-storage.ts
autonomous: true

must_haves:
  truths:
    - "Workshop pages render with sidebar (step list), header (logo, workshop name, exit button, user menu), and main content area"
    - "Sidebar is collapsible via toggle button and Cmd+B keyboard shortcut"
    - "Sidebar collapse state persists in localStorage across sessions"
    - "Exit Workshop button shows confirmation dialog with reassuring message"
    - "On mobile, a top stepper bar replaces the sidebar"
    - "Header scrolls away with content (not sticky)"
  artifacts:
    - path: "src/app/workshop/[sessionId]/layout.tsx"
      provides: "Workshop shell layout with sidebar + header + content area"
    - path: "src/components/layout/workshop-header.tsx"
      provides: "Workshop header with logo, name, step indicator, exit button, user menu"
    - path: "src/components/layout/workshop-sidebar.tsx"
      provides: "Collapsible sidebar with 10 step links"
    - path: "src/components/layout/mobile-stepper.tsx"
      provides: "Horizontal progress indicator for mobile"
    - path: "src/components/dialogs/exit-workshop-dialog.tsx"
      provides: "Confirmation dialog for exiting workshop"
    - path: "src/hooks/use-local-storage.ts"
      provides: "Hydration-safe localStorage hook"
  key_links:
    - from: "src/app/workshop/[sessionId]/layout.tsx"
      to: "src/components/layout/workshop-sidebar.tsx"
      via: "component composition"
      pattern: "WorkshopSidebar"
    - from: "src/components/layout/workshop-sidebar.tsx"
      to: "src/lib/workshop/step-metadata.ts"
      via: "step data import"
      pattern: "STEPS|getStepByOrder"
    - from: "src/components/layout/workshop-sidebar.tsx"
      to: "src/hooks/use-local-storage.ts"
      via: "persist collapse state"
      pattern: "useLocalStorage"
---

<objective>
Build the workshop shell layout: collapsible sidebar with step list, workshop header with exit button, mobile stepper, and the confirmation dialog for exiting.

Purpose: This is the persistent wrapper for all workshop step pages. The layout stays mounted while users navigate between steps, keeping sidebar state and header consistent.
Output: Workshop layout.tsx, sidebar, header, mobile stepper, exit dialog, localStorage hook.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-application-shell/03-CONTEXT.md
@.planning/phases/03-application-shell/03-RESEARCH.md
@src/lib/workshop/step-metadata.ts
@src/components/ui/sidebar.tsx
@src/components/ui/dialog.tsx
@src/components/ui/sheet.tsx
@src/components/ui/button.tsx
@.planning/phases/03-application-shell/03-01-SUMMARY.md
@.planning/phases/03-application-shell/03-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create hooks and utility components</name>
  <files>src/hooks/use-local-storage.ts, src/components/dialogs/exit-workshop-dialog.tsx, src/components/layout/mobile-stepper.tsx</files>
  <action>
**Create `src/hooks/use-local-storage.ts`:**

Hydration-safe localStorage hook per research Pattern 2. The hook must:
- Accept a key string and default value of generic type T
- Use `useState` initialized with the default value (NOT localStorage -- that causes hydration errors)
- Use `useEffect` to read localStorage after hydration and update state
- Return `[value, setValue, isLoading]` tuple
- `setValue` both updates React state AND writes to localStorage
- `isLoading` is true until the first useEffect runs (for showing skeletons)
- Handle JSON serialization/deserialization
- Handle missing/corrupt data gracefully (fall back to default)

**Create `src/components/dialogs/exit-workshop-dialog.tsx`:**

Per user decision: "Exit workshop shows confirmation dialog: 'Are you sure? Your progress is saved.'"

Per research Pitfall 4, make the dialog REASSURING, not scary:
- Title: "Return to Dashboard" (not "Are you sure?")
- Description: "Your progress is saved automatically. You can continue this workshop anytime."
- Primary button: "Return to Dashboard" (default variant, not destructive)
- Secondary button: "Stay in Workshop" (ghost variant)
- Use shadcn Dialog component
- On confirm: navigate to `/dashboard` using `useRouter().push('/dashboard')`
- Accept `open` and `onOpenChange` props for controlled dialog state

**Create `src/components/layout/mobile-stepper.tsx`:**

Per user decision: "On mobile: top stepper bar -- compact horizontal progress indicator, tap to expand full step list."

Build a horizontal stepper bar:
- Shows compact step indicators (numbered circles or dots) in a horizontal row
- Current step is highlighted, completed steps have checkmark, future steps are muted
- Tapping the stepper bar expands to a full step list (use shadcn Sheet component sliding from top per research suggestion)
- The expanded sheet shows all 10 steps with names, allowing navigation
- Import STEPS from step-metadata.ts
- Accept `currentStep` and `sessionId` props
- Each step links to `/workshop/[sessionId]/step/[stepNumber]`
- For this phase, all steps are accessible (sequential enforcement comes in Phase 4)
  </action>
  <verify>
Run `npm run build` to confirm no TypeScript errors.
Verify all three files export their components correctly.
  </verify>
  <done>useLocalStorage hook handles hydration safely. Exit dialog shows reassuring message and navigates to dashboard. Mobile stepper shows compact horizontal indicators with expandable step list.</done>
</task>

<task type="auto">
  <name>Task 2: Build workshop sidebar, header, and layout</name>
  <files>src/components/layout/workshop-sidebar.tsx, src/components/layout/workshop-header.tsx, src/app/workshop/[sessionId]/layout.tsx</files>
  <action>
**Create `src/components/layout/workshop-sidebar.tsx`:**

Per user decisions:
- Sidebar is collapsible with toggle button + keyboard shortcut (Cmd+B)
- Shows step number + name only (no descriptions), status shown by color/icon
- Flat list of all 10 steps (no grouping)
- Collapsed state persists in localStorage
- When collapsed, header step indicator is sufficient -- no icon rail needed

Implementation:
- Use shadcn/ui Sidebar component (SidebarProvider, Sidebar, SidebarContent, SidebarMenu, SidebarMenuItem, SidebarMenuButton)
- Import `useHotkeys` from `react-hotkeys-hook` for Cmd+B toggle
- Import `useLocalStorage` for persisting collapse state with key `'workshoppilot-sidebar-collapsed'`
- Show loading skeleton during hydration (while `isLoading` from useLocalStorage)
- Each step item: step number + step name, links to `/workshop/[sessionId]/step/[stepNumber]`
- Current step highlighted (compare with URL param)
- Step status indicators: muted text for not_started, accent/bold for current, checkmark for complete (for now, just highlight current -- Phase 4 adds real status)
- Use `usePathname()` to determine current step from URL
- Sidebar width: ~260px (Claude's discretion, between narrow 240px and medium 320px)
- Visual style: Linear-like, clean borders, muted colors, dark mode support
- Toggle button at the bottom of sidebar

**Create `src/components/layout/workshop-header.tsx`:**

Per user decisions:
- Header scrolls away with content (not sticky/fixed)
- Contains: logo + workshop name + step indicator + user menu
- Separate from landing header
- Explicit 'Exit Workshop' button (not logo click)
- When sidebar collapsed, header step indicator is sufficient

Implementation:
- Client component (`'use client'`)
- Left section: Logo (small variant), workshop name (editable -- shows "New Workshop" initially, clicking allows inline rename per user decision), current step indicator ("Step 3: Ideate")
- Right section: Theme toggle button (sun/moon icon using `useTheme` from next-themes), Exit Workshop button (triggers exit dialog), UserButton from Clerk (for signed-in) or Sign In button (for signed-out)
- NOT sticky -- just a normal block element that scrolls with content
- Accept `sessionId` prop to construct navigation links
- Workshop name: for now, display "New Workshop" (renaming functionality wired in Plan 06)
- Accept `workshopName` prop (default "New Workshop")
- Step indicator reads current step from URL params

**Create `src/app/workshop/[sessionId]/layout.tsx`:**

Per research Pattern 1 (layout nesting):
- This layout wraps all step pages within a workshop session
- Server component that fetches session data from DB to verify session exists
- If session not found, redirect to dashboard
- Renders the workshop shell:
  - SidebarProvider wrapping everything (from shadcn)
  - Workshop sidebar on the left
  - Main content column: workshop header on top, then `{children}` below
- Content area uses `flex-1` and `overflow-hidden` for the main area
- Full-width content per user decision: "Main content area is full width (no max-width cap)"
- The layout should handle the overall structure. On mobile (below md breakpoint), hide sidebar entirely and show MobileStepper at the top instead.

IMPORTANT: Next.js 16 `params` are async (Promise). Use `const { sessionId } = await params;` pattern.
  </action>
  <verify>
Run `npm run build` to confirm no TypeScript errors.
Run `npm run dev` and navigate to `/workshop/test123/step/1` (will 404 on step page but layout should render):
1. Sidebar visible with 10 steps listed
2. Workshop header visible with logo, "New Workshop" name, step indicator
3. Cmd+B toggles sidebar collapse
4. Exit Workshop button opens confirmation dialog
5. Sidebar collapse state persists on page refresh
  </verify>
  <done>Workshop layout renders with collapsible sidebar (10 steps, keyboard shortcut, localStorage persistence), workshop header (logo, name, step indicator, exit button, user menu), and mobile stepper. Layout persists across step navigation.</done>
</task>

</tasks>

<verification>
- `npm run build` passes
- Workshop layout renders sidebar + header + content area
- Sidebar shows all 10 steps with number and name
- Sidebar collapses/expands with toggle button and Cmd+B
- Sidebar state persists in localStorage
- Exit Workshop opens reassuring confirmation dialog
- Mobile stepper shows on small screens
- Header scrolls with content (not sticky)
- Dark mode classes applied throughout
</verification>

<success_criteria>
Workshop shell layout is the persistent wrapper for all step pages. Sidebar, header, and mobile stepper are functional. The layout does not re-render when navigating between steps. All user decisions about sidebar behavior, header content, and mobile patterns are implemented.
</success_criteria>

<output>
After completion, create `.planning/phases/03-application-shell/03-04-SUMMARY.md`
</output>
