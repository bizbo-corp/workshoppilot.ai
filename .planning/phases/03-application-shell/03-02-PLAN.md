---
phase: 03-application-shell
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/seed-steps.ts
  - src/lib/workshop/step-metadata.ts
  - src/middleware.ts
autonomous: true

must_haves:
  truths:
    - "Step metadata is available with names, descriptions, greetings, and mock output types for all 10 steps"
    - "Database step_definitions contain the correct 10 WorkshopPilot steps (challenge, stakeholder-mapping, etc.)"
    - "Workshop routes for steps 1-3 are public, steps 4-10 are protected by middleware"
  artifacts:
    - path: "scripts/seed-steps.ts"
      provides: "Correct 10 WorkshopPilot step definitions for database seeding"
      contains: "challenge"
    - path: "src/lib/workshop/step-metadata.ts"
      provides: "Hardcoded step data (names, descriptions, greetings, mock outputs) for all 10 steps"
      exports: ["STEPS", "getStepByOrder", "getStepBySlug"]
    - path: "src/middleware.ts"
      provides: "Updated route matchers for workshop step protection"
      contains: "workshop"
  key_links:
    - from: "src/lib/workshop/step-metadata.ts"
      to: "step pages"
      via: "imported by step page components"
      pattern: "getStepByOrder|STEPS"
    - from: "scripts/seed-steps.ts"
      to: "src/db/schema/steps.ts"
      via: "stepDefinitions table insert"
      pattern: "stepDefinitions"
---

<objective>
Fix the seed script to use WorkshopPilot's correct 10 steps, create the step metadata module with all 10 design thinking step definitions (hardcoded, not from DB per user decision), and update middleware to protect workshop routes per Phase 2 handoff.

Purpose: The seed script currently contains generic design thinking steps (empathize, define, ideate...) instead of WorkshopPilot's actual 10 steps (challenge, stakeholder-mapping, user-research...). This must be corrected BEFORE any plan creates workshop_steps records, otherwise foreign key references will fail. Step metadata is consumed by sidebar, step pages, and mobile stepper. Middleware update fulfills the Phase 2 handoff for workshop route protection (steps 1-3 public, 4-10 protected).
Output: Corrected seed script with correct step IDs. Step metadata module with exports. Updated middleware with workshop route matchers.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-application-shell/03-CONTEXT.md
@src/middleware.ts
@src/db/schema/steps.ts
@scripts/seed-steps.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix seed script with correct WorkshopPilot step definitions</name>
  <files>scripts/seed-steps.ts</files>
  <action>
Update `scripts/seed-steps.ts` to replace the WRONG generic design thinking steps with WorkshopPilot's CORRECT 10 steps. The current script has placeholder steps (empathize, define, ideate, prototype, test, prioritize, architect, spec, story, pack) which do NOT match the product.

Replace the STEP_DEFINITIONS array with the correct 10 WorkshopPilot steps (from PROJECT.md):

```typescript
const STEP_DEFINITIONS = [
  {
    id: 'challenge' as const,
    name: 'Challenge',
    description: 'Extract the core problem and draft a How Might We statement',
    order: 1,
    promptTemplate: null,
  },
  {
    id: 'stakeholder-mapping' as const,
    name: 'Stakeholder Mapping',
    description: 'Identify and prioritize the people and groups involved',
    order: 2,
    promptTemplate: null,
  },
  {
    id: 'user-research' as const,
    name: 'User Research',
    description: 'Gather insights through synthetic interviews and research',
    order: 3,
    promptTemplate: null,
  },
  {
    id: 'sense-making' as const,
    name: 'Research Sense Making',
    description: 'Synthesize research into themes, pains (5), and gains (5)',
    order: 4,
    promptTemplate: null,
  },
  {
    id: 'persona' as const,
    name: 'Persona Development',
    description: 'Create a research-grounded user persona',
    order: 5,
    promptTemplate: null,
  },
  {
    id: 'journey-mapping' as const,
    name: 'Journey Mapping',
    description: 'Map the current user experience and find the critical dip',
    order: 6,
    promptTemplate: null,
  },
  {
    id: 'reframe' as const,
    name: 'Reframing Challenge',
    description: 'Craft a focused How Might We statement based on insights',
    order: 7,
    promptTemplate: null,
  },
  {
    id: 'ideation' as const,
    name: 'Ideation',
    description: 'Generate ideas using Mind Mapping, Crazy 8s, Brain Writing, and Billboard Hero',
    order: 8,
    promptTemplate: null,
  },
  {
    id: 'concept' as const,
    name: 'Concept Development',
    description: 'Develop concept sheets with SWOT analysis, feasibility, and elevator pitch',
    order: 9,
    promptTemplate: null,
  },
  {
    id: 'validate' as const,
    name: 'Validate',
    description: 'Create flow diagrams, prototyping, PRD generation, and Build Pack export',
    order: 10,
    promptTemplate: null,
  },
];
```

The script structure (import, onConflictDoUpdate logic, console output) stays the same -- only the data changes.

After updating the file, re-run the seed script to update the database:
```bash
npx tsx scripts/seed-steps.ts
```

IMPORTANT: The old step IDs (empathize, define, etc.) may have workshop_steps records referencing them if anyone ran the app. The onConflictDoUpdate will update existing rows BUT won't handle renamed IDs (it's insert-on-conflict-update, not a rename). Since this is pre-launch development, the old IDs can be manually deleted first if needed, or the seed can insert new rows alongside. The safest approach: delete all old step_definition rows first, then insert the new ones. Add a `DELETE FROM step_definitions` before the inserts (and cascade will clean workshop_steps).

Update the seed script to add a cleanup step before seeding:
```typescript
// Clean up old step definitions (development only - safe pre-launch)
await db.delete(stepDefinitions);
console.log('Cleaned up old step definitions');
```
  </action>
  <verify>
Run `npx tsx scripts/seed-steps.ts` and verify output shows all 10 correct steps seeded:
- challenge, stakeholder-mapping, user-research, sense-making, persona, journey-mapping, reframe, ideation, concept, validate
Run `npm run build` to confirm no TypeScript errors.
  </verify>
  <done>Seed script contains the correct 10 WorkshopPilot step definitions with proper IDs (challenge, stakeholder-mapping, user-research, sense-making, persona, journey-mapping, reframe, ideation, concept, validate). Database is re-seeded with correct data.</done>
</task>

<task type="auto">
  <name>Task 2: Create step metadata module with correct WorkshopPilot steps</name>
  <files>src/lib/workshop/step-metadata.ts</files>
  <action>
Create `src/lib/workshop/step-metadata.ts` with hardcoded data for all 10 design thinking steps. Per user decision: "Step descriptions are hardcoded in component (not fetched from DB step_definitions)."

CRITICAL: The step IDs (slugs) in this file MUST match the database step_definition IDs from the seed script. This alignment is essential because workshop_steps records reference step_definition IDs.

Define a TypeScript interface `StepDefinition`:
```typescript
interface StepDefinition {
  order: number;          // 1-10
  id: string;             // Database step_definition ID: 'challenge', 'stakeholder-mapping', etc.
  slug: string;           // URL-friendly (same as id): 'challenge', 'stakeholder-mapping', etc.
  name: string;           // Display name: 'Challenge', 'Stakeholder Mapping', etc.
  description: string;    // Brief description of what this step does
  greeting: string;       // AI greeting message per user decision
  mockOutputType: string; // Type label for output panel
  mockOutputContent: string; // Structured placeholder content for the output panel
}
```

The 10 steps with CORRECT IDs, names, descriptions, and step-specific mock output content:

1. `id: 'challenge'`, name: "Challenge", description: "Extract the core problem and draft a How Might We statement"
   - greeting: "Welcome! Let's start by understanding the problem you're trying to solve. Tell me about your idea -- what challenge or opportunity are you exploring?"
   - mockOutputType: "Problem Statement & HMW"
   - mockOutputContent: "Problem Statement:\n[Description of the core problem your users face]\n\nHow Might We:\nHow might we [problem area] for [target user] so that [desired outcome]?"

2. `id: 'stakeholder-mapping'`, name: "Stakeholder Mapping", description: "Identify and prioritize the people and groups involved"
   - greeting: "Now let's map out who's involved. Who are the key people and groups that will be affected by or influence your solution?"
   - mockOutputType: "Stakeholder Grid"
   - mockOutputContent: "Stakeholder Grid (Power vs Interest):\n\nHigh Power, High Interest:\n- [Key stakeholder 1]\n- [Key stakeholder 2]\n\nHigh Power, Low Interest:\n- [Stakeholder to keep satisfied]\n\nLow Power, High Interest:\n- [Stakeholder to keep informed]\n\nLow Power, Low Interest:\n- [Monitor only]"

3. `id: 'user-research'`, name: "User Research", description: "Gather insights through synthetic interviews and research"
   - greeting: "Time to understand your users deeply. I'll help you conduct synthetic user interviews to uncover needs, behaviors, and pain points."
   - mockOutputType: "Interview Questions & Synthesis"
   - mockOutputContent: "Interview Questions:\n1. [Question about user context]\n2. [Question about current behavior]\n3. [Question about pain points]\n4. [Question about desired outcomes]\n\nSynthesis Notes:\n- Key insight 1: [Finding from research]\n- Key insight 2: [Finding from research]\n- Key insight 3: [Finding from research]"

4. `id: 'sense-making'`, name: "Research Sense Making", description: "Synthesize research into themes, pains, and gains"
   - greeting: "Let's make sense of what we've learned. I'll help you organize your research findings into clear themes, pain points, and gains."
   - mockOutputType: "Affinity Map & Pains/Gains"
   - mockOutputContent: "Themes:\n1. [Theme 1]: [Supporting evidence]\n2. [Theme 2]: [Supporting evidence]\n3. [Theme 3]: [Supporting evidence]\n\nTop 5 Pains:\n1. [Pain point]\n2. [Pain point]\n3. [Pain point]\n4. [Pain point]\n5. [Pain point]\n\nTop 5 Gains:\n1. [Desired gain]\n2. [Desired gain]\n3. [Desired gain]\n4. [Desired gain]\n5. [Desired gain]"

5. `id: 'persona'`, name: "Persona Development", description: "Create a research-grounded user persona"
   - greeting: "Time to bring your users to life! Based on our research, I'll help you create a detailed persona that represents your target user."
   - mockOutputType: "User Persona Card"
   - mockOutputContent: "Name: [Persona Name]\nAge: [Age]\nRole: [Role / Occupation]\nLocation: [Location]\n\nBio:\n[Brief background story]\n\nGoals:\n- [Primary goal]\n- [Secondary goal]\n\nPain Points:\n- [Key frustration 1]\n- [Key frustration 2]\n\nBehaviors:\n- [Relevant behavior pattern]\n- [Technology usage pattern]\n\nQuote:\n\"[A quote that captures their perspective]\""

6. `id: 'journey-mapping'`, name: "Journey Mapping", description: "Map the current user experience and find the critical dip"
   - greeting: "Let's walk through your user's current experience step by step. We'll map their journey and find where things break down -- the critical 'dip'."
   - mockOutputType: "Journey Map"
   - mockOutputContent: "Journey Map: [Persona Name]'s Experience\n\nStage 1: [Awareness]\n- Actions: [What they do]\n- Thoughts: [What they think]\n- Emotions: [How they feel] (positive)\n\nStage 2: [Consideration]\n- Actions: [What they do]\n- Thoughts: [What they think]\n- Emotions: [How they feel] (neutral)\n\nStage 3: [The Dip]\n- Actions: [What they struggle with]\n- Thoughts: [Frustrations]\n- Emotions: [How they feel] (negative)\n- PAIN POINT: [Critical breakdown]\n\nStage 4: [Resolution]\n- Actions: [Current workaround]\n- Opportunity: [Where we can help]"

7. `id: 'reframe'`, name: "Reframing Challenge", description: "Craft a focused How Might We statement based on insights"
   - greeting: "With all our research insights, let's reframe the challenge. We'll craft a focused 'How Might We' statement that captures the real opportunity."
   - mockOutputType: "Refined HMW Statement"
   - mockOutputContent: "Original HMW:\nHow might we [initial problem framing]?\n\nResearch Insights Applied:\n- [Key insight that shifts perspective]\n- [Pain point from journey map dip]\n- [Persona need]\n\nRefined HMW:\nHow might we [reframed problem] for [specific persona] when [specific context] so that [measurable outcome]?"

8. `id: 'ideation'`, name: "Ideation", description: "Generate ideas using Mind Mapping, Crazy 8s, Brain Writing, and Billboard Hero"
   - greeting: "Time to get creative! We'll use multiple ideation techniques -- Mind Mapping, Crazy 8s, Brain Writing, and Billboard Hero -- to generate a wide range of solutions."
   - mockOutputType: "Mind Map & Idea Cards"
   - mockOutputContent: "Mind Map:\n[Central HMW Statement]\n├── Branch 1: [Category]\n│   ├── [Idea 1.1]\n│   └── [Idea 1.2]\n├── Branch 2: [Category]\n│   ├── [Idea 2.1]\n│   └── [Idea 2.2]\n└── Branch 3: [Category]\n    ├── [Idea 3.1]\n    └── [Idea 3.2]\n\nTop Ideas:\n1. [Idea title] -- [Brief description]\n2. [Idea title] -- [Brief description]\n3. [Idea title] -- [Brief description]"

9. `id: 'concept'`, name: "Concept Development", description: "Develop concept sheets with SWOT analysis, feasibility, and elevator pitch"
   - greeting: "Let's develop your best ideas into solid concepts. For each one, we'll create a concept sheet with SWOT analysis, feasibility assessment, and elevator pitch."
   - mockOutputType: "Concept Sheet"
   - mockOutputContent: "Concept: [Concept Name]\n\nElevator Pitch:\n[One-sentence description of the concept]\n\nSWOT Analysis:\nStrengths:\n- [Internal advantage]\nWeaknesses:\n- [Internal limitation]\nOpportunities:\n- [External possibility]\nThreats:\n- [External risk]\n\nFeasibility:\n- Technical: [High/Medium/Low]\n- Business: [High/Medium/Low]\n- User Desirability: [High/Medium/Low]\n\nNext Steps:\n- [Action item 1]\n- [Action item 2]"

10. `id: 'validate'`, name: "Validate", description: "Create flow diagrams, prototyping, PRD generation, and Build Pack export"
    - greeting: "Final step! Let's validate your concept with flow diagrams, a prototype outline, and generate your PRD. This becomes your Build Pack -- everything a developer needs to start building."
    - mockOutputType: "Flow Diagram & PRD Outline"
    - mockOutputContent: "User Flow:\n[Start] → [Step 1] → [Decision Point]\n  ├── Yes → [Step 2a] → [Step 3]\n  └── No → [Step 2b] → [Step 3]\n[Step 3] → [End]\n\nPRD Outline:\n1. Overview & Objectives\n2. Target Users & Personas\n3. Core Features (MVP)\n4. User Stories\n5. Technical Requirements\n6. Success Metrics\n\nBuild Pack Status:\n- [ ] PRD Document\n- [ ] User Stories\n- [ ] Technical Spec\n- [ ] Flow Diagrams"

Export:
- `STEPS: StepDefinition[]` - All 10 steps in order
- `getStepByOrder(order: number): StepDefinition | undefined` - Lookup by step number
- `getStepBySlug(slug: string): StepDefinition | undefined` - Lookup by URL slug (same as id)
- `getStepById(id: string): StepDefinition | undefined` - Lookup by database ID (same as slug)
- `TOTAL_STEPS: number` - Constant 10
  </action>
  <verify>
Create a quick test: import the module and verify `STEPS.length === 10`, each step has all fields populated, `getStepByOrder(1)?.name === 'Challenge'`, `getStepByOrder(10)?.name === 'Validate'`, `getStepBySlug('stakeholder-mapping')?.order === 2`, `getStepById('sense-making')?.name === 'Research Sense Making'`.
Run `npm run build` to confirm TypeScript types are correct.
  </verify>
  <done>Step metadata module exports STEPS array with all 10 correct WorkshopPilot steps. Each step has order, id, slug, name, description, greeting, mockOutputType, and mockOutputContent with step-specific content. IDs match database step_definitions. Lookup functions work correctly.</done>
</task>

<task type="auto">
  <name>Task 3: Update middleware for workshop route protection</name>
  <files>src/middleware.ts</files>
  <action>
Update `src/middleware.ts` per the Phase 2 handoff comment block already in the file. The comment says:

```
// PHASE 3 HANDOFF: WORKSHOP STEP ROUTE PROTECTION
// PUBLIC (add to isPublicRoute): steps 1-3
// PROTECTED (add to isProtectedRoute): steps 4-10
// User decision (LOCKED): steps 1-3 public, steps 4-10 protected
```

Changes:
1. Add workshop step routes 1-3 to `isPublicRoute`:
   - `'/workshop/:path*/step/1'`
   - `'/workshop/:path*/step/2'`
   - `'/workshop/:path*/step/3'`

2. Add workshop step routes 4-10 to `isProtectedRoute`:
   - `'/workshop/:path*/step/4'` through `'/workshop/:path*/step/10'`
   - Also add the workshop base route: `'/workshop(.*)'` as a catch-all for any workshop URLs not matching specific steps

3. Add a workshop creation API route to protected: `'/api/workshops/create'`

4. Remove the handoff comment block (it's now implemented).

5. Keep the existing logic for admin routes, protected route redirects, and landing page redirect for authenticated users.

6. IMPORTANT: The middleware should allow anonymous access to steps 1-3 and the workshop base URL. Steps 4-10 require auth. If an unauthenticated user tries to access step 4+, redirect to landing page (the auth wall modal from Phase 2 will be triggered by the step page itself in Phase 4).

Note about routing: The URL pattern is `/workshop/[sessionId]/step/[stepId]` where stepId is a number 1-10. The middleware route matchers should handle this.
  </action>
  <verify>
Run `npm run build` to confirm no TypeScript errors in middleware.
Manually verify route matchers cover:
- `/workshop/ses_abc123/step/1` -> public
- `/workshop/ses_abc123/step/3` -> public
- `/workshop/ses_abc123/step/4` -> protected
- `/workshop/ses_abc123/step/10` -> protected
- `/dashboard` -> protected (unchanged)
- `/admin` -> admin-only (unchanged)
  </verify>
  <done>Middleware updated with workshop route protection. Steps 1-3 are public. Steps 4-10 are protected. Phase 2 handoff comment removed. Existing admin and protected route logic preserved.</done>
</task>

</tasks>

<verification>
- `npm run build` passes
- Seed script contains correct 10 WorkshopPilot step IDs (challenge, stakeholder-mapping, user-research, sense-making, persona, journey-mapping, reframe, ideation, concept, validate)
- Database re-seeded with correct step definitions
- `src/lib/workshop/step-metadata.ts` exports STEPS with 10 entries using matching IDs
- `src/middleware.ts` has workshop route matchers for public (1-3) and protected (4-10) steps
- Phase 2 handoff comment block removed from middleware
</verification>

<success_criteria>
Database step_definitions and hardcoded step metadata are aligned with WorkshopPilot's actual 10-step flow. Step IDs match between seed script, metadata module, and all downstream consumers. Step metadata module is the single source of truth for step information used across all UI components. Middleware correctly gates workshop steps per the locked user decision (1-3 public, 4-10 protected).
</success_criteria>

<output>
After completion, create `.planning/phases/03-application-shell/03-02-SUMMARY.md`
</output>
