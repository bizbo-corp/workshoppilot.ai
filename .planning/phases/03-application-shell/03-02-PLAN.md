---
phase: 03-application-shell
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/workshop/step-metadata.ts
  - src/middleware.ts
autonomous: true

must_haves:
  truths:
    - "Step metadata is available with names, descriptions, greetings, and mock output types for all 10 steps"
    - "Workshop routes for steps 1-3 are public, steps 4-10 are protected by middleware"
  artifacts:
    - path: "src/lib/workshop/step-metadata.ts"
      provides: "Hardcoded step data (names, descriptions, greetings, mock outputs) for all 10 steps"
      exports: ["STEPS", "getStepByOrder", "getStepBySlug"]
    - path: "src/middleware.ts"
      provides: "Updated route matchers for workshop step protection"
      contains: "workshop"
  key_links:
    - from: "src/lib/workshop/step-metadata.ts"
      to: "step pages"
      via: "imported by step page components"
      pattern: "getStepByOrder|STEPS"
---

<objective>
Create the step metadata module with all 10 design thinking step definitions (hardcoded, not from DB per user decision) and update middleware to protect workshop routes per Phase 2 handoff.

Purpose: Step metadata is consumed by sidebar, step pages, and mobile stepper. Middleware update fulfills the Phase 2 handoff for workshop route protection (steps 1-3 public, 4-10 protected).
Output: Step metadata module with exports. Updated middleware with workshop route matchers.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-application-shell/03-CONTEXT.md
@src/middleware.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create step metadata module</name>
  <files>src/lib/workshop/step-metadata.ts</files>
  <action>
Create `src/lib/workshop/step-metadata.ts` with hardcoded data for all 10 design thinking steps. Per user decision: "Step descriptions are hardcoded in component (not fetched from DB step_definitions)."

Define a TypeScript interface `StepDefinition`:
```typescript
interface StepDefinition {
  order: number;          // 1-10
  slug: string;           // URL-friendly: 'empathize', 'define', etc.
  name: string;           // Display name: 'Challenge', 'Stakeholder Mapping', etc.
  description: string;    // Brief description of what this step does
  greeting: string;       // AI greeting message per user decision
  mockOutputType: string; // Type label for output panel: 'Persona', 'Problem Statement', etc.
  mockOutputContent: string; // Structured placeholder content for the output panel
}
```

The 10 steps (from PROJECT.md):
1. Challenge - Extract the core problem, draft HMW statement
2. Stakeholder Mapping - Identify and prioritize stakeholders
3. User Research - Gather insights via synthetic interviews
4. Research Sense Making - Synthesize into themes, pains, gains
5. Persona Development - Create research-grounded user persona
6. Journey Mapping - Map current experience, find the "dip"
7. Reframing Challenge - Craft focused "How Might We" statement
8. Ideation - Mind Mapping, Crazy 8s, brainstorming
9. Concept Development - Concept sheets with SWOT, feasibility
10. Validate - Flow diagrams, prototyping, PRD generation

For each step's `greeting`, write a welcoming message specific to that step per user decision: "AI greeting per step -- pre-populated welcome message specific to each step." Examples:
- Step 1: "Welcome! Let's start by understanding the problem you're trying to solve. Tell me about your idea -- what challenge or opportunity are you exploring?"
- Step 5: "Time to bring your users to life! Based on our research, I'll help you create a detailed persona that represents your target user."

For each step's `mockOutputContent`, create structured placeholder text showing what the output will look like per user decision: "Output panel shows step-specific mock content -- each step previews its output type." Examples:
- Step 1 (HMW Statement): "How might we [problem area] for [target user] so that [desired outcome]?"
- Step 5 (Persona): "Name: [Persona Name]\nAge: [Age]\nRole: [Role]\nGoals: [Key goals]\nPain Points: [Key frustrations]"
- Step 8 (Ideas List): "1. [Idea title]\n   Description: [Brief description]\n2. [Idea title]\n   Description: [Brief description]"

Export:
- `STEPS: StepDefinition[]` - All 10 steps in order
- `getStepByOrder(order: number): StepDefinition | undefined` - Lookup by step number
- `getStepBySlug(slug: string): StepDefinition | undefined` - Lookup by URL slug
- `TOTAL_STEPS: number` - Constant 10
  </action>
  <verify>
Create a quick test: import the module and verify `STEPS.length === 10`, each step has all fields populated, `getStepByOrder(1)?.name === 'Challenge'`, `getStepByOrder(10)?.name === 'Validate'`.
Run `npm run build` to confirm TypeScript types are correct.
  </verify>
  <done>Step metadata module exports STEPS array with all 10 steps. Each step has order, slug, name, description, greeting, mockOutputType, and mockOutputContent. Lookup functions work correctly.</done>
</task>

<task type="auto">
  <name>Task 2: Update middleware for workshop route protection</name>
  <files>src/middleware.ts</files>
  <action>
Update `src/middleware.ts` per the Phase 2 handoff comment block already in the file. The comment says:

```
// PHASE 3 HANDOFF: WORKSHOP STEP ROUTE PROTECTION
// PUBLIC (add to isPublicRoute): steps 1-3
// PROTECTED (add to isProtectedRoute): steps 4-10
// User decision (LOCKED): steps 1-3 public, steps 4-10 protected
```

Changes:
1. Add workshop step routes 1-3 to `isPublicRoute`:
   - `'/workshop/:path*/step/1'`
   - `'/workshop/:path*/step/2'`
   - `'/workshop/:path*/step/3'`

2. Add workshop step routes 4-10 to `isProtectedRoute`:
   - `'/workshop/:path*/step/4'` through `'/workshop/:path*/step/10'`
   - Also add the workshop base route: `'/workshop(.*)'` as a catch-all for any workshop URLs not matching specific steps

3. Add a workshop creation API route to protected: `'/api/workshops/create'`

4. Remove the handoff comment block (it's now implemented).

5. Keep the existing logic for admin routes, protected route redirects, and landing page redirect for authenticated users.

6. IMPORTANT: The middleware should allow anonymous access to steps 1-3 and the workshop base URL. Steps 4-10 require auth. If an unauthenticated user tries to access step 4+, redirect to landing page (the auth wall modal from Phase 2 will be triggered by the step page itself in Phase 4).

Note about routing: The URL pattern is `/workshop/[sessionId]/step/[stepId]` where stepId is a number 1-10. The middleware route matchers should handle this.
  </action>
  <verify>
Run `npm run build` to confirm no TypeScript errors in middleware.
Manually verify route matchers cover:
- `/workshop/ses_abc123/step/1` -> public
- `/workshop/ses_abc123/step/3` -> public
- `/workshop/ses_abc123/step/4` -> protected
- `/workshop/ses_abc123/step/10` -> protected
- `/dashboard` -> protected (unchanged)
- `/admin` -> admin-only (unchanged)
  </verify>
  <done>Middleware updated with workshop route protection. Steps 1-3 are public. Steps 4-10 are protected. Phase 2 handoff comment removed. Existing admin and protected route logic preserved.</done>
</task>

</tasks>

<verification>
- `npm run build` passes
- `src/lib/workshop/step-metadata.ts` exports STEPS with 10 entries
- `src/middleware.ts` has workshop route matchers for public (1-3) and protected (4-10) steps
- Phase 2 handoff comment block removed from middleware
</verification>

<success_criteria>
Step metadata module is the single source of truth for step information used across all UI components. Middleware correctly gates workshop steps per the locked user decision (1-3 public, 4-10 protected).
</success_criteria>

<output>
After completion, create `.planning/phases/03-application-shell/03-02-SUMMARY.md`
</output>
