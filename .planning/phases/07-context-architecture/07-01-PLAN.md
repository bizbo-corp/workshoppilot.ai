---
phase: 07-context-architecture
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/db/schema/step-artifacts.ts
  - src/db/schema/step-summaries.ts
  - src/db/schema/index.ts
  - src/db/schema/relations.ts
  - src/lib/context/types.ts
autonomous: true

must_haves:
  truths:
    - "step_artifacts table exists in database with JSONB artifact column"
    - "step_summaries table exists in database with text summary column"
    - "Both tables have optimistic locking via version column"
    - "Drizzle relations connect new tables to workshopSteps"
  artifacts:
    - path: "src/db/schema/step-artifacts.ts"
      provides: "stepArtifacts table definition"
      contains: "pgTable"
    - path: "src/db/schema/step-summaries.ts"
      provides: "stepSummaries table definition"
      contains: "pgTable"
    - path: "src/lib/context/types.ts"
      provides: "TypeScript types for context tiers and artifacts"
      contains: "StepContext"
  key_links:
    - from: "src/db/schema/step-artifacts.ts"
      to: "src/db/schema/steps.ts"
      via: "foreign key reference workshopSteps.id"
      pattern: "references.*workshopSteps"
    - from: "src/db/schema/step-summaries.ts"
      to: "src/db/schema/steps.ts"
      via: "foreign key reference workshopSteps.id"
      pattern: "references.*workshopSteps"
    - from: "src/db/schema/index.ts"
      to: "src/db/schema/step-artifacts.ts"
      via: "re-export"
      pattern: "export.*step-artifacts"
---

<objective>
Create the database schema for step artifacts and step summaries, the two new tables required for the dual-layer context architecture.

Purpose: These tables are the persistence layer for the three-tier context system. step_artifacts stores structured JSON outputs per step (persistent memory tier). step_summaries stores AI-generated conversation summaries per step (long-term memory tier). Without these tables, no context can flow between steps.

Output: Two new Drizzle schema files, updated schema index and relations, shared TypeScript types, and a database migration applied to Neon.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-context-architecture/07-RESEARCH.md

@src/db/schema/steps.ts
@src/db/schema/index.ts
@src/db/schema/relations.ts
@src/db/client.ts
@src/lib/ids.ts
@drizzle.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create step_artifacts and step_summaries schema files</name>
  <files>
    src/db/schema/step-artifacts.ts
    src/db/schema/step-summaries.ts
    src/lib/context/types.ts
  </files>
  <action>
Create two new Drizzle schema files following the exact patterns in src/db/schema/steps.ts (imports from drizzle-orm/pg-core, createPrefixedId from @/lib/ids, references to workshopSteps).

**src/db/schema/step-artifacts.ts:**
- Table name: 'step_artifacts'
- Columns:
  - id: text PK with $defaultFn(() => createPrefixedId('art'))
  - workshopStepId: text, NOT NULL, FK to workshopSteps.id with onDelete: 'cascade'
  - stepId: text, NOT NULL (semantic ID like 'challenge', 'stakeholder-mapping' — NOT a FK, same pattern as chatMessages.stepId)
  - artifact: jsonb, NOT NULL, typed as .$type<Record<string, unknown>>() for now (step-specific Zod schemas come in Phase 9)
  - schemaVersion: text, NOT NULL, default '1.0' (for future schema evolution)
  - extractedAt: timestamp with mode: 'date', precision: 3, NOT NULL, defaultNow()
  - version: integer, NOT NULL, default 1 (optimistic locking)
- Indexes: workshopStepId index (step_artifacts_workshop_step_id_idx)
- Add unique constraint on workshopStepId (one artifact per workshop step)

**src/db/schema/step-summaries.ts:**
- Table name: 'step_summaries'
- Columns:
  - id: text PK with $defaultFn(() => createPrefixedId('sum'))
  - workshopStepId: text, NOT NULL, FK to workshopSteps.id with onDelete: 'cascade'
  - stepId: text, NOT NULL (semantic ID — same pattern as chatMessages.stepId)
  - summary: text, NOT NULL
  - tokenCount: integer (nullable, for monitoring context budget)
  - generatedAt: timestamp with mode: 'date', precision: 3, NOT NULL, defaultNow()
- Indexes: workshopStepId index (step_summaries_workshop_step_id_idx)
- Add unique constraint on workshopStepId (one summary per workshop step)

**src/lib/context/types.ts:**
- Define StepContext interface: { persistentContext: string; summaries: string; messages: Array<{ role: string; content: string }> }
- Define ContextTier enum/type: 'short-term' | 'long-term' | 'persistent'
- Define ArtifactRecord type: Record<string, unknown> (placeholder until Phase 9 adds step-specific Zod schemas)
- Export all types

**Important:** Do NOT use the `unique()` import from drizzle-orm/pg-core if the existing codebase uses it differently. Check how src/db/schema/workshops.ts imports and uses unique() and follow that exact pattern.
  </action>
  <verify>
Run `npx tsc --noEmit` — TypeScript compilation succeeds with no errors.
Run `npx drizzle-kit generate` — migration SQL is generated without errors.
  </verify>
  <done>Both schema files exist with correct column definitions, types, indexes, and foreign key references. TypeScript compiles cleanly. Migration SQL generated.</done>
</task>

<task type="auto">
  <name>Task 2: Update schema index, relations, and run migration</name>
  <files>
    src/db/schema/index.ts
    src/db/schema/relations.ts
  </files>
  <action>
**src/db/schema/index.ts:**
Add two new export lines following existing pattern:
```
export * from './step-artifacts';
export * from './step-summaries';
```

**src/db/schema/relations.ts:**
Add imports for stepArtifacts and stepSummaries from their respective schema files.

Add relations for stepArtifacts:
```typescript
export const stepArtifactsRelations = relations(stepArtifacts, ({ one }) => ({
  workshopStep: one(workshopSteps, {
    fields: [stepArtifacts.workshopStepId],
    references: [workshopSteps.id],
  }),
}));
```

Add relations for stepSummaries:
```typescript
export const stepSummariesRelations = relations(stepSummaries, ({ one }) => ({
  workshopStep: one(workshopSteps, {
    fields: [stepSummaries.workshopStepId],
    references: [workshopSteps.id],
  }),
}));
```

Update workshopStepsRelations to add `many` relations to the new tables:
```typescript
export const workshopStepsRelations = relations(workshopSteps, ({ one, many }) => ({
  workshop: one(workshops, { ... }),  // existing
  stepDefinition: one(stepDefinitions, { ... }),  // existing
  artifacts: many(stepArtifacts),     // NEW
  summaries: many(stepSummaries),     // NEW
}));
```

**Run migration:**
Execute `npx drizzle-kit push` to apply schema changes to Neon database.

**Important:** The existing workshopStepsRelations uses `({ one })` — change to `({ one, many })` to add the new relations.
  </action>
  <verify>
Run `npx drizzle-kit push` — migration applies successfully (look for "Changes applied" or similar success message).
Run `npx tsc --noEmit` — TypeScript compilation succeeds.
Verify tables exist: The drizzle-kit push output should confirm step_artifacts and step_summaries tables were created.
  </verify>
  <done>Schema index re-exports both new tables. Relations connect stepArtifacts and stepSummaries to workshopSteps bidirectionally. Database migration applied successfully — step_artifacts and step_summaries tables exist in Neon.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npx drizzle-kit push` shows tables created successfully
3. Schema files follow same patterns as existing schema (prefixed IDs, timestamp precision, index naming)
4. Relations are bidirectional (workshopSteps -> artifacts/summaries, artifacts/summaries -> workshopStep)
</verification>

<success_criteria>
- step_artifacts and step_summaries tables exist in Neon database
- Both tables have proper foreign keys, indexes, and optimistic locking columns
- TypeScript types for context architecture are defined and exported
- All existing code still compiles (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/07-context-architecture/07-01-SUMMARY.md`
</output>
