---
phase: 23-ai-suggest-then-confirm-placement
plan: 02
type: execute
wave: 2
depends_on: ["23-01"]
files_modified:
  - src/components/canvas/post-it-node.tsx
  - src/components/canvas/react-flow-canvas.tsx
  - src/components/canvas/grid-overlay.tsx
  - src/components/workshop/chat-panel.tsx
autonomous: true

must_haves:
  truths:
    - "AI-suggested grid items appear as semi-transparent preview nodes with Add to Canvas and Skip buttons"
    - "Target cell pulses with yellow border animation when AI suggests placement there"
    - "Clicking Add to Canvas converts preview node to permanent (full opacity, draggable, editable)"
    - "Clicking Skip removes preview node from canvas entirely"
    - "Preview nodes are not draggable, not selectable, and buttons work without triggering drag"
    - "Cell highlight clears when preview is confirmed or rejected"
  artifacts:
    - path: "src/components/canvas/post-it-node.tsx"
      provides: "Conditional preview UI with semi-transparent styling and action buttons"
      contains: "isPreview"
    - path: "src/components/canvas/react-flow-canvas.tsx"
      provides: "Preview node handling (draggable=false, selectable=false, confirm/reject callbacks)"
      contains: "confirmPreview"
    - path: "src/components/canvas/grid-overlay.tsx"
      provides: "Yellow pulsing cell highlight for AI-suggested placement targets"
      contains: "animate-pulse"
    - path: "src/components/workshop/chat-panel.tsx"
      provides: "Cell highlight state management for grid item suggestions"
      contains: "setHighlightedCell"
  key_links:
    - from: "src/components/canvas/post-it-node.tsx"
      to: "src/stores/canvas-store.ts"
      via: "onConfirm/onReject callbacks passed through node data trigger confirmPreview/rejectPreview"
      pattern: "onConfirm|onReject"
    - from: "src/components/canvas/react-flow-canvas.tsx"
      to: "src/components/canvas/post-it-node.tsx"
      via: "nodes useMemo passes isPreview, onConfirm, onReject into PostItNodeData"
      pattern: "isPreview.*onConfirm.*onReject"
    - from: "src/components/canvas/grid-overlay.tsx"
      to: "src/components/canvas/react-flow-canvas.tsx"
      via: "highlightedCell prop controls yellow pulse animation rendering"
      pattern: "highlightedCell.*animate-pulse"
---

<objective>
Build the visual UI layer for suggest-then-confirm placement: preview node rendering in PostItNode, ReactFlowCanvas wiring for preview node behavior, yellow pulsing cell highlight in GridOverlay, and chat-panel integration to trigger cell highlighting when AI suggests grid items.

Purpose: This plan creates the user-facing interaction loop where AI suggestions appear as visual previews on the canvas, target cells pulse to show where placement is proposed, and users confirm or reject each suggestion with clear button controls.

Output: Complete suggest-then-confirm UX flow from AI response through preview node display to user confirmation/rejection.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-ai-suggest-then-confirm-placement/23-RESEARCH.md
@.planning/phases/23-ai-suggest-then-confirm-placement/23-01-SUMMARY.md

# Key source files
@src/components/canvas/post-it-node.tsx
@src/components/canvas/react-flow-canvas.tsx
@src/components/canvas/grid-overlay.tsx
@src/components/workshop/chat-panel.tsx
@src/stores/canvas-store.ts
@src/lib/canvas/grid-layout.ts
@src/lib/canvas/step-canvas-config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Preview node rendering in PostItNode and ReactFlowCanvas wiring</name>
  <files>src/components/canvas/post-it-node.tsx, src/components/canvas/react-flow-canvas.tsx</files>
  <action>
  **post-it-node.tsx — Extend PostItNodeData type:**
  Add preview-related fields to `PostItNodeData`:
  ```typescript
  export type PostItNodeData = {
    text: string;
    color: PostItColor;
    isEditing: boolean;
    dragging?: boolean;
    isPreview?: boolean;
    previewReason?: string;
    onConfirm?: (id: string) => void;
    onReject?: (id: string) => void;
    onTextChange?: (id: string, text: string) => void;
    onEditComplete?: (id: string) => void;
  };
  ```

  **post-it-node.tsx — Add preview rendering branch:**
  At the top of the PostItNode component (inside the memo, before the regular return), add an early return for preview nodes:

  ```tsx
  if (data.isPreview) {
    return (
      <div
        className={cn(
          bgColor,
          'shadow-md rounded-sm p-3',
          'font-sans text-sm text-gray-800',
          'opacity-60',
          'ring-2 ring-blue-400 ring-offset-1',
        )}
        style={{
          width: '120px',
          minHeight: '120px',
          touchAction: 'none',
        }}
      >
        <Handle type="target" position={Position.Top} className="!opacity-0 !w-0 !h-0" />

        <p className="break-words whitespace-pre-wrap mb-2 text-xs">{data.text || ''}</p>

        {data.previewReason && (
          <p className="text-[10px] text-gray-500 italic mb-2 leading-tight">{data.previewReason}</p>
        )}

        <div className="flex gap-1.5 mt-auto pt-1">
          <button
            onClick={(e) => {
              e.stopPropagation();
              data.onConfirm?.(id);
            }}
            className="nodrag nopan flex-1 px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors font-medium"
          >
            Add
          </button>
          <button
            onClick={(e) => {
              e.stopPropagation();
              data.onReject?.(id);
            }}
            className="nodrag nopan flex-1 px-2 py-1 text-xs bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition-colors"
          >
            Skip
          </button>
        </div>

        <Handle type="source" position={Position.Bottom} className="!opacity-0 !w-0 !h-0" />
      </div>
    );
  }
  ```

  Key design choices:
  - `opacity-60` makes preview semi-transparent (distinguishes from permanent nodes)
  - `ring-2 ring-blue-400` adds always-visible outline (even when not selected)
  - `nodrag nopan` classes on buttons prevent ReactFlow from intercepting clicks
  - `e.stopPropagation()` in onClick handlers prevents event bubbling to node/canvas
  - Text uses `text-xs` for slightly smaller text since preview nodes show action buttons too
  - No edit mode (no TextareaAutosize) — preview nodes are read-only

  **react-flow-canvas.tsx — Wire preview node behavior:**

  1. Add store selectors for confirmPreview and rejectPreview (near other store selectors at top):
  ```typescript
  const confirmPreview = useCanvasStore((s) => s.confirmPreview);
  const rejectPreview = useCanvasStore((s) => s.rejectPreview);
  ```

  2. Create confirm/reject handler functions that also clear the highlighted cell:
  ```typescript
  const handleConfirmPreview = useCallback((id: string) => {
    confirmPreview(id);
    setHighlightedCell(null);
  }, [confirmPreview]);

  const handleRejectPreview = useCallback((id: string) => {
    rejectPreview(id);
    setHighlightedCell(null);
  }, [rejectPreview]);
  ```

  3. In the `nodes` useMemo, modify the mapping to handle preview nodes. After the existing `data` construction, add preview-specific overrides:
  ```typescript
  return sorted.map((postIt) => {
    const isPreview = postIt.isPreview === true;

    return {
      id: postIt.id,
      type: postIt.type || 'postIt',
      position: postIt.position,
      parentId: postIt.parentId,
      extent: postIt.parentId ? ('parent' as const) : undefined,
      draggable: !isPreview,
      selectable: !isPreview,
      data: {
        text: postIt.text,
        color: postIt.color || 'yellow',
        isEditing: isPreview ? false : editingNodeId === postIt.id,
        dragging: draggingNodeId === postIt.id,
        onTextChange: handleTextChange,
        onEditComplete: handleEditComplete,
        ...(isPreview ? {
          isPreview: true,
          previewReason: postIt.previewReason,
          onConfirm: handleConfirmPreview,
          onReject: handleRejectPreview,
        } : {}),
      } as PostItNodeData,
      style: postIt.type === 'group'
        ? { width: postIt.width, height: postIt.height }
        : { width: postIt.width, height: 'auto' },
    };
  });
  ```

  Add `handleConfirmPreview` and `handleRejectPreview` to the useMemo dependency array.

  Key behaviors:
  - `draggable: !isPreview` prevents drag on preview nodes
  - `selectable: !isPreview` prevents selection (no blue ring from ReactFlow)
  - `isEditing: false` when preview — prevents double-click edit mode
  - Confirm/reject callbacks clear the highlighted cell
  </action>
  <verify>
  Run `npx tsc --noEmit` — zero TypeScript errors.
  Grep for `isPreview` in post-it-node.tsx — should appear in PostItNodeData type and conditional render.
  Grep for `onConfirm` in post-it-node.tsx — should appear in type and onClick handler.
  Grep for `confirmPreview` in react-flow-canvas.tsx — should appear in store selector and handler.
  Grep for `rejectPreview` in react-flow-canvas.tsx — should appear in store selector and handler.
  Grep for `draggable.*isPreview` in react-flow-canvas.tsx — preview nodes are not draggable.
  </verify>
  <done>PostItNode renders preview UI branch with semi-transparent styling, Add/Skip buttons, and read-only text. ReactFlowCanvas maps preview PostIts to non-draggable, non-selectable nodes with confirm/reject callbacks that clear cell highlighting.</done>
</task>

<task type="auto">
  <name>Task 2: Yellow pulse cell highlight and chat-panel cell highlighting integration</name>
  <files>src/components/canvas/grid-overlay.tsx, src/components/workshop/chat-panel.tsx</files>
  <action>
  **grid-overlay.tsx — Replace blue cell highlight with yellow pulse for AI suggestions:**

  The existing cell highlight (lines ~90-103) renders a static light blue rectangle. Replace it with a yellow pulsing highlight:

  Replace the existing `{highlightedCell && ...}` block with:
  ```tsx
  {highlightedCell && (() => {
    const bounds = getCellBounds(highlightedCell, { ...config, columns: effectiveColumns });
    const topLeft = toScreen(bounds.x, bounds.y);
    return (
      <g className="animate-pulse">
        <rect
          x={topLeft.x}
          y={topLeft.y}
          width={bounds.width * zoom}
          height={bounds.height * zoom}
          fill="#fef3c7"
          opacity={0.3}
        />
        <rect
          x={topLeft.x}
          y={topLeft.y}
          width={bounds.width * zoom}
          height={bounds.height * zoom}
          fill="none"
          stroke="#eab308"
          strokeWidth={3}
        />
      </g>
    );
  })()}
  ```

  IMPORTANT: Use `{ ...config, columns: effectiveColumns }` for the getCellBounds call instead of just `config`, because `effectiveColumns` reflects the dynamic column state from the store (columns may have been added/removed by the user). The existing code uses `config` directly which could have stale column data.

  The animation uses:
  - `animate-pulse` (Tailwind built-in): fades opacity 100% -> 50% -> 100% on a 2-second cycle
  - `#fef3c7` fill (amber-100): subtle yellow background fill at 0.3 opacity
  - `#eab308` stroke (yellow-500): visible yellow border at 3px width
  - Two rects: filled background for area attention + stroked outline for border definition

  **chat-panel.tsx — Add cell highlighting when AI suggests grid items:**

  This requires the chat-panel to communicate with the canvas about which cell to highlight. Since chat-panel and ReactFlowCanvas are sibling components (not parent-child), use the canvas store for cross-component communication.

  1. Add a `highlightedCell` state to the canvas store. In `src/stores/canvas-store.ts`, add to CanvasState:
  ```typescript
  highlightedCell: { row: number; col: number } | null;
  ```

  Initialize to `null` in DEFAULT_STATE.

  Add to CanvasActions:
  ```typescript
  setHighlightedCell: (cell: { row: number; col: number } | null) => void;
  ```

  Implementation:
  ```typescript
  setHighlightedCell: (cell) =>
    set(() => ({
      highlightedCell: cell,
    })),
  ```

  NOTE: Do NOT include `highlightedCell` in the temporal `partialize` — it's ephemeral UI state, not canvas data that should participate in undo/redo.

  2. In `react-flow-canvas.tsx`, remove the local `highlightedCell` useState and instead use the store:
  ```typescript
  const highlightedCell = useCanvasStore((s) => s.highlightedCell);
  const setHighlightedCell = useCanvasStore((s) => s.setHighlightedCell);
  ```

  Remove the line: `const [highlightedCell, setHighlightedCell] = useState<CellCoordinate | null>(null);`

  All existing usages of `highlightedCell` and `setHighlightedCell` in react-flow-canvas.tsx (drag handling, confirm/reject handlers) continue to work since the API is the same.

  3. In `chat-panel.tsx`, add store selector and step config imports:
  ```typescript
  import { getStepCanvasConfig } from '@/lib/canvas/step-canvas-config';
  ```

  Add store selectors:
  ```typescript
  const setHighlightedCell = useCanvasStore((state) => state.setHighlightedCell);
  ```

  4. In the auto-add useEffect (where canvasItems are processed), after the `addPostIt` call, add cell highlighting for grid items:
  ```typescript
  // Highlight target cell for grid items
  if (item.isGridItem && cellAssignment) {
    const stepConfig = getStepCanvasConfig(step.id);
    const gridConfig = stepConfig.gridConfig;
    if (gridConfig) {
      const rowIndex = gridConfig.rows.findIndex(r => r.id === cellAssignment.row);
      const colIndex = gridConfig.columns.findIndex(c => c.id === cellAssignment.col);
      if (rowIndex !== -1 && colIndex !== -1) {
        setHighlightedCell({ row: rowIndex, col: colIndex });
      }
    }
  }
  ```

  NOTE: This highlights the LAST grid item's cell (since the loop overwrites). This is acceptable — when AI suggests 3-5 items, the most recent cell gets the attention pulse. The preview nodes themselves provide visual presence in their respective cells.

  5. In `grid-overlay.tsx`, also subscribe to `highlightedCell` from the store instead of relying solely on props. Since the prop is still passed from react-flow-canvas.tsx AND the store now holds it, use the store value directly:
  ```typescript
  const storeHighlightedCell = useCanvasStore((s) => s.highlightedCell);
  ```

  Use `storeHighlightedCell ?? highlightedCell` (prefer store value, fall back to prop for drag highlighting). Actually, since we're moving highlightedCell to the store, the prop value and store value will be the same. Keep the prop interface for API clarity but use the store value internally:

  Change the highlight rendering to use the prop (which now comes from the store via react-flow-canvas.tsx). No changes needed in GridOverlay's own usage — just verify the prop is being passed correctly from react-flow-canvas.tsx which now reads from the store.
  </action>
  <verify>
  Run `npx tsc --noEmit` — zero TypeScript errors.
  Run `npm run build` — production build succeeds.
  Grep for `animate-pulse` in grid-overlay.tsx — should appear in the highlight group element.
  Grep for `#eab308` in grid-overlay.tsx — yellow stroke color present.
  Grep for `highlightedCell` in canvas-store.ts — present in state type, default state, and action.
  Grep for `setHighlightedCell` in chat-panel.tsx — present in store selector and useEffect.
  Verify no `useState.*highlightedCell` remains in react-flow-canvas.tsx (should use store instead).
  </verify>
  <done>GridOverlay renders yellow pulsing cell highlight with animate-pulse animation. highlightedCell moved from local state to canvas store for cross-component communication. Chat-panel sets highlighted cell when AI suggests grid items. ReactFlowCanvas reads highlighted cell from store (clears on drag-stop, confirm, reject).</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm run build` produces successful production build
3. PostItNode renders semi-transparent preview with Add/Skip buttons when `data.isPreview === true`
4. Preview nodes have `draggable: false` and `selectable: false` in ReactFlow
5. Clicking Add button calls `confirmPreview` (converts to permanent) and clears cell highlight
6. Clicking Skip button calls `rejectPreview` (removes node) and clears cell highlight
7. GridOverlay renders yellow pulsing rectangle (animate-pulse + #eab308 stroke) for highlighted cell
8. Chat-panel sets highlightedCell in store when processing [GRID_ITEM] tags
9. `highlightedCell` is in canvas store (not local useState) for cross-component access
10. Drag-and-drop cell highlighting still works (uses same store-based highlightedCell)
</verification>

<success_criteria>
- Preview nodes appear semi-transparent with blue ring and Add/Skip buttons
- Target cells pulse with yellow border when AI suggests grid placement
- Confirm action converts preview to full permanent node
- Reject action removes preview node entirely
- Cell highlight clears after confirm or reject
- Preview buttons work (nodrag nopan, stopPropagation) without triggering drag
- Existing drag-highlighting behavior preserved
- TypeScript compilation and production build both pass
</success_criteria>

<output>
After completion, create `.planning/phases/23-ai-suggest-then-confirm-placement/23-02-SUMMARY.md`
</output>
