---
phase: 23-ai-suggest-then-confirm-placement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/stores/canvas-store.ts
  - src/components/workshop/chat-panel.tsx
  - src/lib/ai/chat-config.ts
  - src/lib/workshop/context/canvas-context.ts
autonomous: true

must_haves:
  truths:
    - "PostIt type supports isPreview flag distinguishing preview from permanent nodes"
    - "Canvas store has confirmPreview and rejectPreview actions that toggle/delete preview nodes"
    - "Parser recognizes [GRID_ITEM row=X col=Y]...[/GRID_ITEM] markup alongside existing [CANVAS_ITEM]"
    - "AI system prompt instructs journey-mapping step to use [GRID_ITEM] format instead of [CANVAS_ITEM]"
    - "AI context assembly filters out preview nodes so AI only sees confirmed content"
  artifacts:
    - path: "src/stores/canvas-store.ts"
      provides: "PostIt.isPreview flag, confirmPreview/rejectPreview actions"
      contains: "isPreview"
    - path: "src/components/workshop/chat-panel.tsx"
      provides: "Extended parseCanvasItems that handles both CANVAS_ITEM and GRID_ITEM tags"
      contains: "GRID_ITEM"
    - path: "src/lib/ai/chat-config.ts"
      provides: "Updated journey-mapping prompt with [GRID_ITEM] format instructions"
      contains: "GRID_ITEM"
    - path: "src/lib/workshop/context/canvas-context.ts"
      provides: "Preview node filtering in assembleJourneyMapCanvasContext"
      contains: "isPreview"
  key_links:
    - from: "src/components/workshop/chat-panel.tsx"
      to: "src/stores/canvas-store.ts"
      via: "parseCanvasItems returns isGridItem flag, used to set PostIt.isPreview on addPostIt"
      pattern: "isGridItem.*isPreview"
    - from: "src/lib/workshop/context/canvas-context.ts"
      to: "src/stores/canvas-store.ts"
      via: "assembleJourneyMapCanvasContext filters postIts where isPreview is true"
      pattern: "!p\\.isPreview"
---

<objective>
Extend the data layer and AI integration for suggest-then-confirm placement: add preview node types to canvas store, extend the markup parser to recognize [GRID_ITEM] tags, update the AI prompt for journey-mapping to use the new format, and filter preview nodes from AI context assembly.

Purpose: Establish the foundational data model and AI communication protocol that Plan 02's UI components will consume. Without this, preview nodes cannot be distinguished from permanent nodes, and the AI cannot suggest grid-specific placements.

Output: Extended PostIt type with isPreview flag, confirmPreview/rejectPreview store actions, dual-tag markup parser, updated AI prompt, filtered context assembly.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-ai-suggest-then-confirm-placement/23-RESEARCH.md

# Key source files
@src/stores/canvas-store.ts
@src/components/workshop/chat-panel.tsx
@src/lib/ai/chat-config.ts
@src/lib/workshop/context/canvas-context.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend PostIt type and canvas store with preview actions</name>
  <files>src/stores/canvas-store.ts, src/lib/workshop/context/canvas-context.ts</files>
  <action>
  **canvas-store.ts — Extend PostIt type:**
  Add two optional fields to the `PostIt` type:
  - `isPreview?: boolean` — When true, indicates this is an AI-suggested preview node awaiting user confirmation
  - `previewReason?: string` — Optional AI explanation for why this placement was suggested

  **canvas-store.ts — Add preview actions to CanvasActions:**
  Add two new actions:
  - `confirmPreview: (id: string) => void` — Converts a preview node to permanent by setting `isPreview: false` and clearing `previewReason`. Sets `isDirty: true`.
  - `rejectPreview: (id: string) => void` — Removes a preview node from the store entirely. Sets `isDirty: true`.

  **canvas-store.ts — Implementation:**
  ```
  confirmPreview: (id) =>
    set((state) => ({
      postIts: state.postIts.map((postIt) =>
        postIt.id === id ? { ...postIt, isPreview: false, previewReason: undefined } : postIt
      ),
      isDirty: true,
    })),

  rejectPreview: (id) =>
    set((state) => ({
      postIts: state.postIts.filter((postIt) => postIt.id !== id),
      isDirty: true,
    })),
  ```

  Place these after `markClean` in the store definition.

  **canvas-context.ts — Filter preview nodes:**
  In `assembleJourneyMapCanvasContext`, change the filter line from:
  `const items = postIts.filter(p => !p.type || p.type === 'postIt');`
  to:
  `const items = postIts.filter(p => (!p.type || p.type === 'postIt') && !p.isPreview);`

  This ensures the AI never sees unconfirmed preview nodes in its context, preventing it from referencing items the user hasn't accepted yet.

  Also apply the same filter in `assembleCanvasContextForStep` at the top-level filter (line ~215) so all step context assembly excludes previews:
  `const items = postIts.filter(p => (!p.type || p.type === 'postIt') && !p.isPreview);`
  </action>
  <verify>
  Run `npx tsc --noEmit` — zero TypeScript errors.
  Grep for `isPreview` in canvas-store.ts — should appear in PostIt type + two action implementations.
  Grep for `isPreview` in canvas-context.ts — should appear in filter conditions.
  Grep for `confirmPreview` and `rejectPreview` in canvas-store.ts — both present in CanvasActions type and implementation.
  </verify>
  <done>PostIt type has isPreview and previewReason fields. Canvas store has confirmPreview (toggle to permanent) and rejectPreview (delete) actions. Context assembly excludes preview nodes.</done>
</task>

<task type="auto">
  <name>Task 2: Extend markup parser and update AI prompt for [GRID_ITEM]</name>
  <files>src/components/workshop/chat-panel.tsx, src/lib/ai/chat-config.ts</files>
  <action>
  **chat-panel.tsx — Extend parseCanvasItems:**

  Add `isGridItem?: boolean` to the `CanvasItemParsed` type:
  ```typescript
  type CanvasItemParsed = {
    text: string;
    quadrant?: string;
    row?: string;
    col?: string;
    category?: string;
    isGridItem?: boolean;
  };
  ```

  Update the regex in `parseCanvasItems` to match both `[CANVAS_ITEM]` and `[GRID_ITEM]`:
  ```typescript
  const regex = /\[(CANVAS_ITEM|GRID_ITEM)(?:\s+([^\]]*))?\](.*?)\[\/(CANVAS_ITEM|GRID_ITEM)\]/g;
  ```

  When iterating matches, capture the tag type from `match[1]` and set `isGridItem: tagType === 'GRID_ITEM'`:
  ```typescript
  while ((match = regex.exec(content)) !== null) {
    const tagType = match[1]; // CANVAS_ITEM or GRID_ITEM
    const attrString = match[2] || '';
    const text = match[3].trim();
    if (text.length === 0) continue;

    // Parse attributes (same as before)
    const attrs: Record<string, string> = {};
    const attrRegex = /(\w+)="([^"]*)"/g;
    let attrMatch;
    while ((attrMatch = attrRegex.exec(attrString)) !== null) {
      attrs[attrMatch[1]] = attrMatch[2];
    }

    items.push({
      text,
      quadrant: attrs.quadrant,
      row: attrs.row,
      col: attrs.col,
      category: attrs.category,
      isGridItem: tagType === 'GRID_ITEM',
    });
  }
  ```

  Update the clean content regex to strip both tag types:
  ```typescript
  const cleanContent = content
    .replace(/\s*\[(CANVAS_ITEM|GRID_ITEM)(?:\s+[^\]]*?)?\].*?\[\/(CANVAS_ITEM|GRID_ITEM)\]\s*/g, ' ')
    .trim();
  ```

  **chat-panel.tsx — Update auto-add useEffect:**
  In the auto-add useEffect (the one that processes `canvasItems`), modify the `addPostIt` call to pass `isPreview` for grid items:
  ```typescript
  const newPostIt = {
    text: item.text,
    position,
    width: POST_IT_WIDTH,
    height: POST_IT_HEIGHT,
    color,
    quadrant,
    cellAssignment,
    isPreview: item.isGridItem || false,
  };
  ```

  This ensures `[GRID_ITEM]` tags create preview nodes while `[CANVAS_ITEM]` tags continue auto-adding permanent nodes.

  **chat-config.ts — Update journey-mapping prompt:**
  In the `buildStepSystemPrompt` function, find the `journey-mapping` branch (line ~183) in the CANVAS ACTIONS section. Change the format from `[CANVAS_ITEM]` to `[GRID_ITEM]` for journey-mapping only:

  Replace the journey-mapping block (from `} else if (stepId === 'journey-mapping') {` to the closing `}`):
  ```typescript
  } else if (stepId === 'journey-mapping') {
    prompt += `

Format: [GRID_ITEM row="<row>" col="<col>"]Brief item text (max 80 characters)[/GRID_ITEM]
Valid rows: actions, goals, barriers, touchpoints, emotions, moments, opportunities
Valid cols: Use the column IDs from the canvas state (these are dynamic and user-editable)

Items appear as PREVIEWS on the canvas. The user will see "Add to Canvas" and "Skip" buttons on each suggestion, and the target cell pulses yellow to show where you're suggesting placement.

Example: "For the awareness stage: [GRID_ITEM row="actions" col="awareness"]Researches options online[/GRID_ITEM] and [GRID_ITEM row="emotions" col="awareness"]Curious but uncertain[/GRID_ITEM]"

Important: Reference the current canvas state to avoid suggesting duplicates. Briefly explain WHY you're placing an item in a specific cell (e.g., "This goes in Actions/Awareness because...").`;
  }
  ```

  Key change: Column IDs are now described as "dynamic and user-editable" (since Phase 22 allows adding/renaming columns), and the format switches from CANVAS_ITEM to GRID_ITEM for journey-mapping.
  </action>
  <verify>
  Run `npx tsc --noEmit` — zero TypeScript errors.
  Run `npm run build` — production build succeeds.
  Grep for `GRID_ITEM` in chat-panel.tsx — should appear in regex patterns and CanvasItemParsed type.
  Grep for `GRID_ITEM` in chat-config.ts — should appear in journey-mapping prompt section.
  Grep for `isGridItem` in chat-panel.tsx — should appear in CanvasItemParsed type, push to items array, and auto-add useEffect.
  Confirm `[CANVAS_ITEM]` is still used for stakeholder-mapping, sense-making, and persona steps (no regression).
  </verify>
  <done>parseCanvasItems recognizes both [CANVAS_ITEM] and [GRID_ITEM] tags. Grid items are flagged with isGridItem=true and create preview nodes (isPreview=true) in the auto-add logic. AI prompt instructs journey-mapping to use [GRID_ITEM] format. Other canvas steps unchanged.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm run build` produces successful production build
3. PostIt type in canvas-store.ts includes `isPreview?: boolean` and `previewReason?: string`
4. CanvasActions type includes `confirmPreview` and `rejectPreview`
5. parseCanvasItems regex matches both `CANVAS_ITEM` and `GRID_ITEM` tag variants
6. CanvasItemParsed type includes `isGridItem?: boolean`
7. Auto-add useEffect sets `isPreview: item.isGridItem || false` on new post-its
8. Journey-mapping AI prompt uses `[GRID_ITEM]` format, not `[CANVAS_ITEM]`
9. `assembleJourneyMapCanvasContext` filters out nodes where `isPreview === true`
10. Steps 2, 4, 5 still use `[CANVAS_ITEM]` format (no regression)
</verification>

<success_criteria>
- Canvas store has preview node distinction (isPreview flag + confirm/reject actions)
- Dual-tag parser handles both [CANVAS_ITEM] and [GRID_ITEM] with backward compatibility
- AI prompt for journey-mapping uses [GRID_ITEM] with preview semantics
- Context assembly excludes preview nodes from AI context
- TypeScript compilation and production build both pass
</success_criteria>

<output>
After completion, create `.planning/phases/23-ai-suggest-then-confirm-placement/23-01-SUMMARY.md`
</output>
