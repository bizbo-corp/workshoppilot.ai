---
phase: 13.1-reset-step-step-8-ideation-sub-steps
plan: 03
type: execute
subsystem: workshop-ui
tags: [step-8, ideation, sub-steps, tabbed-navigation, idea-selection, artifact-confirmation]
dependencies:
  requires: [13.1-02, step-container, output-panel, chat-panel, artifact-confirmation]
  provides: [ideation-sub-step-container, idea-selection]
  affects: [step-container]
tech-stack:
  added: [react-resizable-panels, shadcn-tabs]
  patterns: [tabbed-navigation, forceMount-state-preservation, interactive-selection]
key-files:
  created:
    - src/components/workshop/ideation-sub-step-container.tsx
    - src/components/workshop/idea-selection.tsx
  modified:
    - src/components/workshop/step-container.tsx
    - src/components/workshop/chat-panel.tsx
    - src/lib/ai/chat-config.ts
    - src/app/api/chat/route.ts
key-decisions:
  - decision: forceMount + CSS hidden for tab state preservation
    rationale: Radix TabsContent supports forceMount. Applying conditional 'hidden' class preserves all 3 sub-step chat histories without remounting
    alternatives: [remount-on-switch (loses state), custom-state-management (complex)]
  - decision: Sub-step prompt override via instructionsOverride parameter in buildStepSystemPrompt
    rationale: Allows chat API to inject sub-step-specific prompts without hardcoding Step 8 logic into chat-config.ts
    alternatives: [sub-step-specific-system-prompts (duplicative), client-side-prompt-switching (unreliable)]
  - decision: Selection merge happens in handleConfirm before setting artifactConfirmed
    rationale: Ensures selectedIdeaTitles and userIdeas are part of the artifact before confirmation saves to database
    alternatives: [merge-on-extraction (loses user selections on re-extract), separate-API-call (race condition)]
  - decision: IdeaSelection only shown in brain-writing tab after extraction
    rationale: Brain Writing is the final sub-step (after Mind Mapping and Crazy 8s), natural place for idea consolidation and selection
    alternatives: [show-in-all-tabs (confusing), separate-selection-step (breaks flow)]
metrics:
  duration: 227s (3m 47s)
  completed: 2026-02-09T23:00:33Z
---

# Phase 13.1 Plan 03: Step 8 Sub-Step UI with Tabbed Navigation and Idea Selection Summary

**One-liner:** Tabbed sub-step container for Step 8 Ideation with focused AI prompts per sub-step (Mind Mapping → Crazy 8s → Brain Writing), interactive idea selection UI with max 4 toggle selection and free-text user input, and artifact confirmation with selection merge into selectedIdeaTitles field.

## What Was Built

### 1. IdeationSubStepContainer (Task 1 - Prior Session)
**Shell with tabbed navigation:**
- 3 sub-steps: Mind Mapping (8a), Crazy 8s (8b), Brain Writing (8c)
- Radix Tabs with icons (Lightbulb, Zap, PenTool)
- forceMount + CSS hidden for state preservation across tab switches
- Sub-step progress header showing current sub-step (8a/8b/8c)
- Mobile/desktop responsive (stacked vs resizable panels)
- ChatPanel receives `subStep` prop passed to chat API
- chat-config.ts `buildStepSystemPrompt` accepts optional `instructionsOverride` parameter
- chat API parses `subStep` from body, calls `getIdeationSubStepInstructions`, passes as `instructionsOverride`
- step-container.tsx conditionally renders IdeationSubStepContainer for Step 8

**Commit:** 3cdb8b8 (prior session)

### 2. Extraction Lifecycle and Artifact Confirmation (Task 2)
**Full artifact lifecycle:**
- `extractArtifact` callback with error handling (same pattern as step-container.tsx)
- `isExtracting`, `extractionError` state
- `artifactConfirmed` state (pre-populated from stepStatus === 'complete')
- `selectedIdeas` and `userAddedIdeas` state for idea selection
- Sub-step engagement tracking: `mindMappingEngaged`, `crazyEightsEngaged`, `brainWritingEngaged`
- Engagement triggered when liveMessageCount > 2 in a sub-step
- Check marks appear on tab triggers when engaged
- `handleConfirm` merges `selectedIdeas` into `artifact.selectedIdeaTitles` and `userAddedIdeas` into `artifact.userIdeas` before confirming
- `handleEdit` clears artifact and confirmation
- `hasEnoughMessages` derived from liveMessageCount >= 4

**Refactored rendering:**
- `renderChatPanel(subStep)` helper: ChatPanel + Extract Output button (shown in active tab when hasEnoughMessages && !artifact && !isExtracting)
- `renderOutputPanel(subStep)` helper: OutputPanel + IdeaSelection (in brain-writing tab) + ArtifactConfirmation
- Extract Output button placement: below ChatPanel with border-t (matches step-container.tsx)
- ArtifactConfirmation placement: below OutputPanel with border-t (matches step-container.tsx)
- Real `artifactConfirmed` state passed to StepNavigation

**Files modified:** src/components/workshop/ideation-sub-step-container.tsx

**Commit:** fe53f6d

### 3. IdeaSelection Component (Task 3)
**Interactive idea selection:**
- Created `src/components/workshop/idea-selection.tsx`
- Props: ideas (IdeaItem[]), selectedTitles (string[]), onSelectionChange, userAddedIdeas, onAddUserIdea, onRemoveUserIdea, maxSelection (default 4)
- Ideas grouped by source with section headers (Mind Mapping, Crazy 8s, Brain Writing, Your Ideas)
- Toggle selection on click (green highlight + check icon when selected)
- Max 4 selection enforced (button disabled when limit reached and not already selected)
- Wild card badge (amber text) for isWildCard ideas
- Free-text "Add Your Own Idea" with title and optional description
- User-added ideas shown in separate list with remove button
- Auto-select user-added idea if under maxSelection
- Selection summary with green badge showing count and selected titles

**Wired into IdeationSubStepContainer:**
- `allIdeasFromArtifact` memo extracts ideas from artifact:
  - Clusters from mind mapping (title, description, isWildCard, source: 'mind-mapping')
  - Crazy 8s ideas (title, description, source: 'crazy-eights')
  - Brain written ideas (finalVersion as title, evolutionDescription, source: 'brain-writing')
  - Existing user ideas (title, description, source: 'user')
- Pre-populates `selectedIdeas` from `artifact.selectedIdeaTitles` on load
- `handleAddUserIdea` appends to `userAddedIdeas` state
- `handleRemoveUserIdea` removes from `userAddedIdeas` and `selectedIdeas`
- IdeaSelection rendered in brain-writing tab between OutputPanel and ArtifactConfirmation
- Only shown when artifact exists and not yet confirmed

**Files created:** src/components/workshop/idea-selection.tsx
**Files modified:** src/components/workshop/ideation-sub-step-container.tsx

**Commit:** 7bea126

## Architecture Decisions

### Tab State Preservation: forceMount + CSS Hidden
**Problem:** Switching tabs normally unmounts inactive content, losing chat state.

**Solution:** Radix Tabs `forceMount` prop keeps all tabs mounted. Conditional `hidden` class hides inactive tabs while preserving state.

```tsx
<TabsContent
  value="mind-mapping"
  forceMount
  className={cn(
    'flex-1 min-h-0 mt-0',
    currentSubStep !== 'mind-mapping' && 'hidden'
  )}
>
```

**Why this works:**
- All 3 sub-steps share the same sessionId and stepOrder=8
- ChatPanel state persists across tab switches
- Each sub-step sends `subStep` prop to chat API for focused prompts
- Conversation is continuous, prompts adjust per sub-step

**Alternatives considered:**
- Remount on switch: Simple but loses chat history when switching back
- Custom state management: Complex, reinventing Radix behavior

### Sub-Step Prompt Override: instructionsOverride Parameter
**Problem:** Step 8 needs different prompts per sub-step (Mind Mapping vs Crazy 8s vs Brain Writing).

**Solution:** chat-config.ts `buildStepSystemPrompt` accepts optional 7th parameter `instructionsOverride`. When provided, it replaces `getStepSpecificInstructions(stepId)`.

**Flow:**
1. ChatPanel passes `subStep` prop to chat API
2. chat API parses `subStep` from body
3. If stepId === 'ideation' && subStep exists, call `getIdeationSubStepInstructions(subStep)`
4. Pass result as `instructionsOverride` to `buildStepSystemPrompt`
5. `buildStepSystemPrompt` uses `instructionsOverride || getStepSpecificInstructions(stepId)`

**Why this works:**
- Backward compatible (undefined instructionsOverride falls back to generic step instructions)
- No hardcoded Step 8 logic in chat-config.ts
- Extensible for future sub-step scenarios

**Alternatives considered:**
- Sub-step-specific system prompts: Duplicative, doesn't reuse arc phase logic
- Client-side prompt switching: Unreliable, LLM sees inconsistent context

### Selection Merge: handleConfirm Before setArtifactConfirmed
**Problem:** User selections (selectedIdeas, userAddedIdeas) need to be part of the artifact before confirmation saves to database.

**Solution:** `handleConfirm` merges selections into artifact, then sets `artifactConfirmed = true`.

```tsx
const handleConfirm = React.useCallback(() => {
  if (artifact) {
    const updatedArtifact = {
      ...artifact,
      selectedIdeaTitles: selectedIdeas,
      userIdeas: [
        ...((artifact.userIdeas as Array<{title: string; description: string}>) || []),
        ...userAddedIdeas.filter(ua =>
          !((artifact.userIdeas as Array<{title: string; description: string}>) || [])
            .some(existing => existing.title === ua.title)
        ),
      ],
    };
    setArtifact(updatedArtifact);
  }
  setArtifactConfirmed(true);
}, [artifact, selectedIdeas, userAddedIdeas]);
```

**Why this works:**
- ArtifactConfirmation's onConfirm triggers state update to artifactConfirmed
- step-container.tsx (and IdeationSubStepContainer) don't persist artifact on confirmation (just sets confirmed state)
- advanceToNextStep server action reads artifact from state and saves to database
- Merged artifact with selections is what gets saved

**Alternatives considered:**
- Merge on extraction: Loses selections if user clicks "Re-extract"
- Separate API call: Race condition between merge and confirmation

### IdeaSelection Placement: Brain Writing Tab Only
**Problem:** Where to show idea selection UI for consolidation?

**Solution:** Render IdeaSelection in brain-writing tab (the final sub-step) between OutputPanel and ArtifactConfirmation, only when artifact exists and not yet confirmed.

**Why this works:**
- Brain Writing is the last sub-step (Mind Mapping → Crazy 8s → Brain Writing)
- Natural place for consolidation and selection after exploring all 3 techniques
- User can switch back to earlier tabs to review ideas before selecting
- IdeaSelection disappears after confirmation (artifact confirmed state)

**Alternatives considered:**
- Show in all tabs: Confusing, redundant
- Separate selection step: Breaks flow, adds extra step

## Deviations from Plan

### Post-Checkpoint Fixes

**1. [Rule 1 - Bug] Reset didn't clear chat without browser refresh**
- **Found during:** Human verification
- **Issue:** router.refresh() re-fetches server data but useChat hook preserves internal message state
- **Fix:** Added resetKey counter in step-container.tsx, passed as key prop to force re-mount
- **Files modified:** src/components/workshop/step-container.tsx
- **Committed in:** 2affdb2

**2. [User Feedback] Sub-steps needed explicit completion flow with auto-advance**
- **Found during:** Human verification
- **Issue:** No way to mark a sub-step as done and advance to next tab
- **Fix:** Added "Continue to [next]" button on non-last tabs, Extract Output only on last tab, with SUB_STEP_ORDER/SUB_STEP_LABELS constants and getNextSubStep helper
- **Files modified:** src/components/workshop/ideation-sub-step-container.tsx
- **Committed in:** 2affdb2

---

**Total deviations:** 2 (1 bug fix, 1 UX enhancement from user feedback)
**Impact on plan:** Both fixes improve core UX. No scope creep.

## Technical Implementation Notes

### Sub-Step Progress Tracking
Engagement is tracked via message count threshold (liveMessageCount > 2) per sub-step. When user switches tabs, the check mark persists because state is preserved via forceMount. This provides visual feedback that a sub-step has been explored.

**Implementation:**
```tsx
React.useEffect(() => {
  if (liveMessageCount > 2) {
    if (currentSubStep === 'mind-mapping') setMindMappingEngaged(true);
    if (currentSubStep === 'crazy-eights') setCrazyEightsEngaged(true);
    if (currentSubStep === 'brain-writing') setBrainWritingEngaged(true);
  }
}, [liveMessageCount, currentSubStep]);
```

### Idea Extraction from Artifact
`allIdeasFromArtifact` memo handles different schema structures per sub-step:

- **Mind Mapping clusters:** Array of objects with `theme` and `ideas[]`. Each idea has `title`, `description`, optional `isWildCard`.
- **Crazy 8s:** Array of objects with `title`, `description`.
- **Brain Writing:** Array of objects with `originalTitle`, `finalVersion`, `evolutionDescription`. Uses `finalVersion` as title.
- **User ideas:** Array of objects with `title`, `description`.

All are normalized to `IdeaItem` with `source` field for grouping.

### Pre-Population Logic
When artifact loads (from `initialArtifact` or extraction), `selectedIdeas` state is pre-populated from `artifact.selectedIdeaTitles` if it exists. This enables "view completed step" to show previous selections.

**Implementation:**
```tsx
React.useEffect(() => {
  if (artifact && (artifact.selectedIdeaTitles as string[])?.length > 0) {
    setSelectedIdeas((artifact.selectedIdeaTitles as string[]) || []);
  }
}, [artifact]);
```

### Selection Merge De-Duplication
When merging `userAddedIdeas` into `artifact.userIdeas`, the code filters out duplicates by title:

```tsx
userIdeas: [
  ...((artifact.userIdeas as Array<{title: string; description: string}>) || []),
  ...userAddedIdeas.filter(ua =>
    !((artifact.userIdeas as Array<{title: string; description: string}>) || [])
      .some(existing => existing.title === ua.title)
  ),
]
```

This prevents duplicate user ideas if the user clicks "Re-extract" and then "Looks Good" multiple times.

## Integration Points

### Step Container Integration
step-container.tsx conditionally renders IdeationSubStepContainer for Step 8:

```tsx
if (stepOrder === 8) {
  return (
    <>
      <IdeationSubStepContainer
        sessionId={sessionId}
        workshopId={workshopId}
        initialMessages={initialMessages}
        initialArtifact={initialArtifact}
        stepStatus={stepStatus}
        onRevise={handleRevise}
        onReset={() => setShowResetDialog(true)}
      />
      <ResetStepDialog
        open={showResetDialog}
        onOpenChange={setShowResetDialog}
        onConfirm={handleReset}
        isResetting={isResetting}
        stepName={getStepByOrder(stepOrder)?.name || `Step ${stepOrder}`}
      />
    </>
  );
}
```

### Chat Panel Integration
ChatPanel receives optional `subStep` prop and passes it to chat API body:

```tsx
const transport = React.useMemo(
  () =>
    new DefaultChatTransport({
      api: '/api/chat',
      body: { sessionId, stepId: step.id, workshopId, subStep },
    }),
  [sessionId, step.id, workshopId, subStep]
);
```

### Chat API Integration
chat API parses `subStep` from body and conditionally injects sub-step instructions:

```tsx
const { messages, sessionId, stepId, workshopId, subStep } = await req.json();

// Sub-step prompt override for Step 8 Ideation
let instructionsOverride: string | undefined;
if (stepId === 'ideation' && subStep) {
  const { getIdeationSubStepInstructions } = await import('@/lib/ai/prompts/step-prompts');
  instructionsOverride = getIdeationSubStepInstructions(subStep);
}

const systemPrompt = buildStepSystemPrompt(
  stepId,
  stepName,
  arcPhase,
  stepDescription,
  stepContext.persistentContext,
  stepContext.summaries,
  instructionsOverride
);
```

### chat-config.ts Integration
`buildStepSystemPrompt` accepts optional 7th parameter:

```tsx
export function buildStepSystemPrompt(
  stepId: string,
  stepName: string,
  arcPhase: ArcPhase,
  stepDescription: string,
  persistentContext: string,
  summaries: string,
  instructionsOverride?: string
): string {
  // ...
  const stepInstructions = instructionsOverride || getStepSpecificInstructions(stepId);
  // ...
}
```

## Verification Results

### TypeScript Compilation
```bash
npx tsc --noEmit
```
**Result:** ✅ Passed (no errors)

### Production Build
```bash
npm run build
```
**Result:** ✅ Passed
- Compiled successfully in 2.1s
- No type errors
- All routes generated

### Schema Field Name Check
Verified no stale references to `selectedIdeas` field (renamed to `selectedIdeaTitles` in Plan 02):

```bash
grep -r "selectedIdeas[^T]" src/lib/ai/prompts/step-prompts.ts
grep -r "selectedIdeas[^T]" src/lib/schemas/step-schemas.ts
```
**Result:** ✅ No matches found

### Step 9 Compatibility
Verified `selectedIdeaTitles` field name is used consistently:
- ✅ ideation-artifact-schema.ts: `selectedIdeaTitles: z.array(z.string()).min(1).max(4)`
- ✅ IdeationSubStepContainer: merges `selectedIdeas` into `artifact.selectedIdeaTitles`
- ✅ IdeationClusterView: renders `artifact.selectedIdeaTitles` in "Selected for Concept Development" section (from Plan 02)

## Self-Check

### Created Files
```bash
[ -f "src/components/workshop/ideation-sub-step-container.tsx" ] && echo "FOUND"
[ -f "src/components/workshop/idea-selection.tsx" ] && echo "FOUND"
```
**Result:**
- ✅ FOUND: src/components/workshop/ideation-sub-step-container.tsx
- ✅ FOUND: src/components/workshop/idea-selection.tsx

### Commits Exist
```bash
git log --oneline --all | grep -E "(3cdb8b8|fe53f6d|7bea126)"
```
**Result:**
- ✅ 3cdb8b8 feat(13.1-03): create IdeationSubStepContainer shell with tabbed navigation (Task 1, prior session)
- ✅ fe53f6d feat(13.1-03): add extraction lifecycle and artifact confirmation to IdeationSubStepContainer (Task 2)
- ✅ 7bea126 feat(13.1-03): create IdeaSelection component and wire into IdeationSubStepContainer (Task 3)

### Modified Files
```bash
git log --oneline --all -5 --name-only | grep -E "(step-container|chat-panel|chat-config|route\.ts)"
```
**Result:**
- ✅ src/components/workshop/step-container.tsx (Task 1, prior session)
- ✅ src/components/workshop/chat-panel.tsx (Task 1, prior session)
- ✅ src/lib/ai/chat-config.ts (Task 1, prior session)
- ✅ src/app/api/chat/route.ts (Task 1, prior session)

## Self-Check: PASSED

All created files exist. All commits exist. All modified files tracked. Build passes. No stale field name references.

## Next Steps

1. **Human verification (checkpoint:human-verify):** User navigates to Step 8, tests tabbed sub-step navigation, chat state preservation across tabs, Extract Output, IdeaSelection, and artifact confirmation with selection merge.

2. **After verification:** Complete Phase 13.1 by:
   - Updating STATE.md with Phase 13.1 completion
   - Final metadata commit

3. **Phase 14:** Production hardening (rate limiting, error boundaries, health checks)

## Success Criteria Met

- ✅ Step 8 shows 3 tabbed sub-steps with correct labels and icons
- ✅ Each sub-step has focused AI conversation (sub-step instructions injected via chat route -> buildStepSystemPrompt instructionsOverride)
- ✅ Chat state preserved across tab switches via forceMount + hidden
- ✅ Extract Output button below chat panel in active tab (4+ messages), ArtifactConfirmation below output panel (matching step-container.tsx)
- ✅ IdeaSelection shows all ideas with toggle, max 4 limit, and user input
- ✅ Selected ideas merged into artifact.selectedIdeaTitles on confirmation
- ✅ User-added ideas merged into artifact.userIdeas on confirmation
- ✅ Reset step clears artifactConfirmed state (from Plan 01)
- ✅ selectedIdeaTitles field name works across Step 8 extraction, IdeationClusterView, and Step 9 (no stale references)
- ✅ No regressions to other steps (Steps 1-7, 9-10 render normally)
- ✅ Build passes

---

**Plan 13.1-03 execution complete.** Human verified and approved 2026-02-10.
