---
phase: 13.1-reset-step-step-8-ideation-sub-steps
plan: 03
type: execute
wave: 2
depends_on: ["13.1-02"]
files_modified:
  - src/components/workshop/ideation-sub-step-container.tsx
  - src/components/workshop/idea-selection.tsx
  - src/components/workshop/step-container.tsx
  - src/components/workshop/output-panel.tsx
  - src/app/api/chat/route.ts
autonomous: false

must_haves:
  truths:
    - "Step 8 shows tabbed navigation with 3 sub-steps: Mind Mapping, Crazy 8s, Brain Writing"
    - "Each sub-step has its own chat conversation with focused AI prompts"
    - "Each sub-step produces intermediate output visible in the output panel"
    - "Users can select ideas from all sub-steps via interactive selection UI"
    - "Users can add their own ideas via free-text input"
    - "Selected ideas (max 3-4) flow forward to Step 9 Concept Development"
    - "Sub-step progress persists across tab switches (state lifted to parent)"
  artifacts:
    - path: "src/components/workshop/ideation-sub-step-container.tsx"
      provides: "Tabbed container for Step 8 sub-steps with shared state"
      exports: ["IdeationSubStepContainer"]
    - path: "src/components/workshop/idea-selection.tsx"
      provides: "Interactive idea selection component with toggle and free-text input"
      exports: ["IdeaSelection"]
    - path: "src/components/workshop/step-container.tsx"
      provides: "Conditional rendering: uses IdeationSubStepContainer for Step 8"
    - path: "src/components/workshop/output-panel.tsx"
      provides: "Sub-step-aware output rendering for Step 8"
    - path: "src/app/api/chat/route.ts"
      provides: "Sub-step-aware prompt injection for Step 8"
  key_links:
    - from: "src/components/workshop/step-container.tsx"
      to: "src/components/workshop/ideation-sub-step-container.tsx"
      via: "conditional render when stepOrder === 8"
      pattern: "stepOrder === 8.*IdeationSubStepContainer"
    - from: "src/components/workshop/ideation-sub-step-container.tsx"
      to: "src/components/workshop/idea-selection.tsx"
      via: "rendered in brain-writing tab after completion"
      pattern: "IdeaSelection"
    - from: "src/app/api/chat/route.ts"
      to: "src/lib/ai/prompts/step-prompts.ts"
      via: "getIdeationSubStepInstructions call for sub-step-aware prompts"
      pattern: "getIdeationSubStepInstructions"
---

<objective>
Build the Step 8 sub-step UI: tabbed navigation container, sub-step-specific chat and output panels, interactive idea selection component, and wire into existing step-container and chat API.

Purpose: Step 8 Ideation is the longest step. Breaking it into 3 tabbed sub-steps (Mind Mapping, Crazy 8s, Brain Writing) with focused AI prompts per sub-step reduces cognitive overload. Interactive idea selection at the end replaces text-only selection for better UX.

Output: IdeationSubStepContainer with tabs, IdeaSelection component, wired into step-container.tsx, output-panel.tsx, and chat API.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13.1-reset-step-step-8-ideation-sub-steps/13.1-RESEARCH.md
@.planning/phases/13.1-reset-step-step-8-ideation-sub-steps/13.1-02-SUMMARY.md

# Key source files to read before implementing:
@src/components/workshop/step-container.tsx
@src/components/workshop/output-panel.tsx
@src/components/workshop/ideation-cluster-view.tsx
@src/components/workshop/chat-panel.tsx
@src/app/api/chat/route.ts
@src/lib/ai/prompts/step-prompts.ts
@src/lib/schemas/step-schemas.ts
@src/components/ui/tabs.tsx
@src/lib/ai/chat-config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create IdeationSubStepContainer with tabbed navigation and sub-step chat/output routing</name>
  <files>
    src/components/workshop/ideation-sub-step-container.tsx
    src/components/workshop/step-container.tsx
    src/components/workshop/output-panel.tsx
    src/app/api/chat/route.ts
  </files>
  <action>
**Create `src/components/workshop/ideation-sub-step-container.tsx`:**

A new client component that wraps Step 8 with tabbed sub-step navigation:

1. 'use client' directive
2. Import: `useState` from 'react', `Tabs, TabsContent, TabsList, TabsTrigger` from `@/components/ui/tabs`, `ChatPanel` from `./chat-panel`, `OutputPanel` from `./output-panel`, `ArtifactConfirmation` from `./artifact-confirmation`, `StepNavigation` from `./step-navigation`, `IdeaSelection` from `./idea-selection`, `cn` from `@/lib/utils`, `Group, Panel, Separator` from `react-resizable-panels`, `Check, Lightbulb, Zap, PenTool` from `lucide-react`
3. Import `type UIMessage` from 'ai'

4. Define type: `type IdeationSubStep = 'mind-mapping' | 'crazy-eights' | 'brain-writing'`

5. Interface `IdeationSubStepContainerProps`:
   - `sessionId: string`
   - `workshopId: string`
   - `initialMessages?: UIMessage[]`
   - `initialArtifact?: Record<string, unknown> | null`
   - `stepStatus?: 'not_started' | 'in_progress' | 'complete' | 'needs_regeneration'`
   - `onRevise?: () => void`
   - `onReset?: () => void`

6. State management (ALL lifted to parent container):
   - `currentSubStep: IdeationSubStep` (default 'mind-mapping')
   - `artifact` and `isExtracting`, `extractionError`, `artifactConfirmed` — same pattern as StepContainer
   - `liveMessageCount` for extract button visibility
   - `selectedIdeas: string[]` — array of selected idea titles (persists across tab switches)
   - `userAddedIdeas: Array<{title: string, description: string}>` — ideas user typed via free-text

7. Sub-step progress tracking:
   - For each sub-step, track a simple boolean indicating if the user has engaged with it (based on message count or explicit signal)
   - `mindMappingEngaged`, `crazyEightsEngaged`, `brainWritingEngaged` — set to true when message count for that sub-step > 2

8. Render structure:
   ```
   <div className="flex h-full flex-col">
     {/* Sub-step progress header */}
     <div className="border-b bg-muted/30 px-6 py-3">
       <div className="flex items-center gap-2 text-sm">
         <span className="font-medium">Step 8: Ideation</span>
         <span className="text-muted-foreground">—</span>
         <span className="text-muted-foreground">
           {currentSubStep === 'mind-mapping' && '8a: Mind Mapping'}
           {currentSubStep === 'crazy-eights' && '8b: Crazy 8s'}
           {currentSubStep === 'brain-writing' && '8c: Brain Writing'}
         </span>
       </div>
     </div>

     {/* Tabs navigation */}
     <Tabs value={currentSubStep} onValueChange={(v) => setCurrentSubStep(v as IdeationSubStep)} className="flex flex-1 flex-col min-h-0">
       <div className="border-b px-6">
         <TabsList className="h-10">
           <TabsTrigger value="mind-mapping" className="gap-2">
             <Lightbulb className="h-3.5 w-3.5" />
             Mind Mapping
             {mindMappingEngaged && <Check className="h-3 w-3 text-green-600" />}
           </TabsTrigger>
           <TabsTrigger value="crazy-eights" className="gap-2">
             <Zap className="h-3.5 w-3.5" />
             Crazy 8s
             {crazyEightsEngaged && <Check className="h-3 w-3 text-green-600" />}
           </TabsTrigger>
           <TabsTrigger value="brain-writing" className="gap-2">
             <PenTool className="h-3.5 w-3.5" />
             Brain Writing
             {brainWritingEngaged && <Check className="h-3 w-3 text-green-600" />}
           </TabsTrigger>
         </TabsList>
       </div>

       {/* Each tab has the same chat + output split layout */}
       <TabsContent value="mind-mapping" className="flex-1 min-h-0 mt-0">
         {/* Resizable panels: Chat | Output */}
       </TabsContent>
       <TabsContent value="crazy-eights" className="flex-1 min-h-0 mt-0">
         {/* Same layout */}
       </TabsContent>
       <TabsContent value="brain-writing" className="flex-1 min-h-0 mt-0">
         {/* Same layout + IdeaSelection at bottom of output */}
       </TabsContent>
     </Tabs>

     {/* Step navigation (shared across all sub-steps) */}
     <StepNavigation ... />
   </div>
   ```

9. **Chat per sub-step:** Each TabsContent renders a `<ChatPanel>` with the same sessionId, workshopId, and stepOrder=8, but pass a new prop `subStep` to ChatPanel. This subStep parameter will be sent to the chat API so the AI knows which sub-step prompt to use.

   IMPORTANT: All 3 sub-steps share the same chat history (stepId='ideation', same sessionId). They share conversation context so the AI in 8b can reference ideas from 8a. The `subStep` prop is sent as part of the chat API request body so the system prompt adjusts per sub-step.

10. **Output per sub-step:** Each TabsContent renders an `<OutputPanel>` with stepOrder=8. The output panel shows the current extraction state (same as regular step container). The final artifact when extracted covers all sub-steps.

11. **Extraction:** The "Extract Output" button and extraction logic works the same as step-container — it appears after enough messages, calls /api/extract, and populates the artifact state. The extraction runs once at the end (covers all sub-steps since they share conversation).

12. Add a `forceUpdate` prop to `TabsContent` components to ensure they don't unmount when switching tabs (use `forceMount` prop on TabsContent if available in shadcn Tabs, or use CSS display:none/block approach to preserve chat state). Check shadcn Tabs docs — if `forceMount` is supported, use it on all 3 TabsContents to prevent chat state loss on tab switch.

**In `src/components/workshop/step-container.tsx`:**

Conditionally render `IdeationSubStepContainer` when stepOrder === 8:

1. Import `IdeationSubStepContainer` from `./ideation-sub-step-container`
2. At the top of the component (after state declarations), add:
   ```
   // Step 8 uses specialized sub-step container
   if (stepOrder === 8) {
     return (
       <>
         <IdeationSubStepContainer
           sessionId={sessionId}
           workshopId={workshopId}
           initialMessages={initialMessages}
           initialArtifact={initialArtifact}
           stepStatus={stepStatus}
           onRevise={handleRevise}
           onReset={() => setShowResetDialog(true)}
         />
         <ResetStepDialog
           open={showResetDialog}
           onOpenChange={setShowResetDialog}
           onConfirm={handleReset}
           isResetting={isResetting}
           stepName="Ideation"
         />
       </>
     );
   }
   ```
3. Keep all existing rendering logic for steps 1-7 and 9-10 unchanged.

**In `src/app/api/chat/route.ts`:**

Add sub-step awareness for Step 8:

1. Read the research first to understand the current chat API structure
2. Parse `subStep` from the request body (alongside existing sessionId, stepId, workshopId)
3. When building the system prompt for stepId === 'ideation' AND subStep is provided:
   - Import `getIdeationSubStepInstructions` from `@/lib/ai/prompts/step-prompts`
   - Replace the generic ideation instructions with the sub-step-specific instructions: `getIdeationSubStepInstructions(subStep)`
4. When subStep is NOT provided (fallback), use the existing coordinator prompt as before

**In `src/components/workshop/chat-panel.tsx`:**

Add optional `subStep` prop:

1. Add `subStep?: 'mind-mapping' | 'crazy-eights' | 'brain-writing'` to `ChatPanelProps`
2. Include `subStep` in the DefaultChatTransport body: `body: { sessionId, stepId: step.id, workshopId, subStep }`
3. This passes through to the chat API where it's used for prompt selection
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit`
- Step 8 renders IdeationSubStepContainer instead of default step-container layout
- Tab switching works without losing chat state
- Chat API accepts subStep parameter and uses sub-step-specific prompts
- Steps 1-7 and 9-10 render normally (no regression)
- `npm run build` passes
  </verify>
  <done>
Step 8 shows tabbed UI with Mind Mapping, Crazy 8s, Brain Writing sub-steps. Each sub-step has chat panel with focused AI prompt. Tabs preserve state on switch. Chat API injects sub-step-specific instructions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create interactive IdeaSelection component and wire into Brain Writing tab</name>
  <files>
    src/components/workshop/idea-selection.tsx
    src/components/workshop/ideation-sub-step-container.tsx
  </files>
  <action>
**Create `src/components/workshop/idea-selection.tsx`:**

An interactive component for selecting ideas from all sub-steps, displayed in the output panel area of the Brain Writing tab (or as a separate section after brain writing):

1. 'use client' directive
2. Import: `useState` from 'react', `Button` from `@/components/ui/button`, `Input` from `@/components/ui/input`, `cn` from `@/lib/utils`, `Plus, X, Check` from `lucide-react`

3. Interface `IdeaItem`:
   - `title: string`
   - `description: string`
   - `source: 'mind-mapping' | 'crazy-eights' | 'brain-writing' | 'user'`
   - `isWildCard?: boolean`

4. Interface `IdeaSelectionProps`:
   - `ideas: IdeaItem[]` — all ideas from all sub-steps
   - `selectedTitles: string[]` — currently selected idea titles
   - `onSelectionChange: (titles: string[]) => void`
   - `userAddedIdeas: Array<{title: string, description: string}>`
   - `onAddUserIdea: (idea: {title: string, description: string}) => void`
   - `onRemoveUserIdea: (title: string) => void`
   - `maxSelection?: number` (default 4)

5. Component renders:
   ```
   <div className="space-y-4">
     <div className="flex items-center justify-between">
       <h4 className="font-semibold text-sm">Select Ideas for Concept Development</h4>
       <span className="text-xs text-muted-foreground">
         {selectedTitles.length}/{maxSelection} selected
       </span>
     </div>

     {/* Idea cards — grouped by source */}
     {/* Section: Mind Mapping Ideas */}
     {/* Section: Crazy 8s Ideas */}
     {/* Section: Brain Writing Ideas */}
     {/* Section: Your Ideas (user-added) */}

     {/* Each idea card: */}
     <button
       onClick={() => toggleSelection(idea.title)}
       disabled={!isSelected && selectedTitles.length >= maxSelection}
       className={cn(
         'w-full text-left rounded-lg border p-3 transition-colors',
         isSelected
           ? 'border-green-500 bg-green-50/50 dark:bg-green-950/20'
           : 'hover:border-primary/50',
         disabled && 'opacity-50 cursor-not-allowed'
       )}
     >
       <div className="flex items-start justify-between gap-2">
         <div>
           <div className="flex items-center gap-2">
             <span className="font-medium text-sm">{idea.title}</span>
             {idea.isWildCard && <span className="text-xs text-amber-600">Wild Card</span>}
             <span className="text-xs text-muted-foreground capitalize">{idea.source}</span>
           </div>
           <p className="text-xs text-muted-foreground mt-1">{idea.description}</p>
         </div>
         {isSelected && <Check className="h-4 w-4 text-green-600 shrink-0" />}
       </div>
     </button>

     {/* Add your own idea */}
     <div className="border-t pt-4">
       <p className="text-sm font-medium mb-2">Add Your Own Idea</p>
       <div className="flex gap-2">
         <Input
           placeholder="Idea title..."
           value={newIdeaTitle}
           onChange={(e) => setNewIdeaTitle(e.target.value)}
           className="flex-1"
         />
         <Button
           size="sm"
           variant="outline"
           onClick={handleAddIdea}
           disabled={!newIdeaTitle.trim()}
         >
           <Plus className="h-4 w-4" />
         </Button>
       </div>
       {/* Optional: description field */}
       {newIdeaTitle.trim() && (
         <Input
           placeholder="Brief description (optional)..."
           value={newIdeaDescription}
           onChange={(e) => setNewIdeaDescription(e.target.value)}
           className="mt-2"
         />
       )}

       {/* User-added ideas list */}
       {userAddedIdeas.map((idea) => (
         <div key={idea.title} className="flex items-center justify-between mt-2 rounded border p-2">
           <span className="text-sm">{idea.title}</span>
           <button onClick={() => onRemoveUserIdea(idea.title)}>
             <X className="h-3.5 w-3.5 text-muted-foreground hover:text-destructive" />
           </button>
         </div>
       ))}
     </div>

     {/* Selection summary */}
     {selectedTitles.length > 0 && (
       <div className="rounded-lg border border-green-500/50 bg-green-50/50 p-3 dark:bg-green-950/20">
         <p className="text-xs font-semibold text-green-800 dark:text-green-200 mb-1">
           Selected for Step 9:
         </p>
         <div className="flex flex-wrap gap-1.5">
           {selectedTitles.map((title) => (
             <span key={title} className="rounded-md bg-green-500/20 px-2 py-0.5 text-xs font-medium text-green-800 dark:text-green-200">
               {title}
             </span>
           ))}
         </div>
       </div>
     )}
   </div>
   ```

6. toggleSelection function:
   - If already selected, remove from selectedTitles
   - If not selected and count < maxSelection, add to selectedTitles
   - If not selected and count >= maxSelection, do nothing (button is disabled)

7. handleAddIdea function:
   - Call `onAddUserIdea({ title: newIdeaTitle.trim(), description: newIdeaDescription.trim() })`
   - Clear newIdeaTitle and newIdeaDescription
   - Auto-select the user-added idea if under maxSelection

**Wire into `src/components/workshop/ideation-sub-step-container.tsx`:**

1. In the Brain Writing tab's output area, after the regular OutputPanel, conditionally render `<IdeaSelection>` when the artifact has been extracted OR when brain writing is engaged:
   ```
   {/* Show IdeaSelection in the brain-writing tab output area */}
   {currentSubStep === 'brain-writing' && (artifact || brainWritingEngaged) && (
     <IdeaSelection
       ideas={allIdeasFromArtifact}
       selectedTitles={selectedIdeas}
       onSelectionChange={setSelectedIdeas}
       userAddedIdeas={userAddedIdeas}
       onAddUserIdea={handleAddUserIdea}
       onRemoveUserIdea={handleRemoveUserIdea}
       maxSelection={4}
     />
   )}
   ```

2. The `allIdeasFromArtifact` function extracts ideas from the artifact (if available) or from conversation state. Since ideas flow through the chat conversation and get extracted into the artifact, the IdeaSelection populates from the extracted artifact:
   ```typescript
   const allIdeasFromArtifact: IdeaItem[] = React.useMemo(() => {
     if (!artifact) return [];
     const items: IdeaItem[] = [];
     // Clusters from mind mapping
     const clusters = (artifact.clusters as Array<{theme: string, ideas: Array<{title: string, description: string, isWildCard?: boolean}>}>) || [];
     clusters.forEach(cluster => {
       cluster.ideas.forEach(idea => {
         items.push({ ...idea, source: 'mind-mapping' });
       });
     });
     // Crazy 8s ideas
     const crazy8s = (artifact.crazyEightsIdeas as Array<{title: string, description: string}>) || [];
     crazy8s.forEach(idea => {
       items.push({ ...idea, source: 'crazy-eights' });
     });
     // Brain written ideas
     const brainWritten = (artifact.brainWrittenIdeas as Array<{originalTitle: string, finalVersion: string, evolutionDescription: string}>) || [];
     brainWritten.forEach(idea => {
       items.push({ title: idea.finalVersion, description: idea.evolutionDescription, source: 'brain-writing' });
     });
     // User ideas
     const userIdeaList = (artifact.userIdeas as Array<{title: string, description: string}>) || [];
     userIdeaList.forEach(idea => {
       items.push({ ...idea, source: 'user' as const });
     });
     return items;
   }, [artifact]);
   ```

3. User-added ideas (from free-text input) are managed in the container state and appended to the artifact when it's saved. Add handlers:
   ```typescript
   const handleAddUserIdea = (idea: {title: string, description: string}) => {
     setUserAddedIdeas(prev => [...prev, idea]);
   };
   const handleRemoveUserIdea = (title: string) => {
     setUserAddedIdeas(prev => prev.filter(i => i.title !== title));
     setSelectedIdeas(prev => prev.filter(t => t !== title));
   };
   ```
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit`
- IdeaSelection renders in the Brain Writing tab output area
- Clicking an idea toggles its selected state (green highlight + check)
- Cannot select more than 4 ideas (button disabled)
- Free-text "Add Your Own Idea" adds to the list and can be selected
- Removing a user-added idea also deselects it
- `npm run build` passes
  </verify>
  <done>
Interactive IdeaSelection component renders grouped ideas from all sub-steps with toggle selection, max 4 limit, and free-text user idea input. Wired into IdeationSubStepContainer's Brain Writing tab.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
  Reset Step functionality (Plan 01) and Step 8 Sub-Step restructure (Plans 02-03):

  1. **Reset Step**: Reset button on in-progress/needs_regeneration steps, confirmation dialog, clears conversation/artifact/summary, cascade-invalidates downstream
  2. **Step 8 Sub-Steps**: Tabbed UI (Mind Mapping -> Crazy 8s -> Brain Writing), focused AI prompts per sub-step, interactive idea selection with free-text user input
  </what-built>
  <how-to-verify>
  **Reset Step:**
  1. Start a workshop and reach Step 2 (complete Step 1 first)
  2. Navigate to Step 2 (in_progress) — verify "Reset" button appears in navigation bar
  3. Click "Reset" — verify confirmation dialog shows with step name and warning text
  4. Click "Cancel" — verify dialog closes, nothing changes
  5. Click "Reset Step" — verify:
     - Chat panel clears (AI re-starts from scratch)
     - Output panel clears (artifact gone)
     - Step still shows as in_progress
  6. Navigate back to Step 1 (completed) — verify "Revise This Step" still works normally
  7. Go to Step 3+ — verify downstream steps show needs_regeneration status if they were started

  **Step 8 Sub-Steps:**
  1. Navigate to Step 8 Ideation
  2. Verify tabbed navigation appears: Mind Mapping | Crazy 8s | Brain Writing
  3. Start Mind Mapping — AI generates themed clusters with wild cards and asks for user ideas
  4. Switch to Crazy 8s tab — AI generates 8 rapid-fire ideas
  5. Switch back to Mind Mapping — verify chat state is preserved (messages still there)
  6. Switch to Brain Writing tab — AI presents ideas for brain writing evolution
  7. Click "Extract Output" — verify extraction produces artifact with all sub-step data
  8. Verify IdeaSelection appears: shows ideas grouped by source (mind mapping, crazy 8s, brain writing)
  9. Click ideas to select (max 4) — verify green highlight and count updates
  10. Use "Add Your Own Idea" — verify it appears in list and can be selected
  11. Verify selected ideas count shows in selection summary
  </how-to-verify>
  <resume-signal>Type "approved" to complete Phase 13.1, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. Step 8 renders tabbed UI instead of default step container
2. Each sub-step tab shows chat panel with AI using focused sub-step prompt
3. Tab switches preserve chat state (messages persist)
4. Brain Writing tab shows IdeaSelection after artifact extraction
5. IdeaSelection shows ideas grouped by source with toggle selection
6. Max 4 ideas can be selected
7. Free-text user idea input works
8. Steps 1-7 and 9-10 render normally (no regression)
9. Build passes: `npm run build`
</verification>

<success_criteria>
- Step 8 shows 3 tabbed sub-steps with correct labels and icons
- Each sub-step has focused AI conversation
- Chat state preserved across tab switches
- IdeaSelection shows all ideas with toggle, max 4 limit, and user input
- Selected ideas visible in summary section
- No regressions to other steps
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/13.1-reset-step-step-8-ideation-sub-steps/13.1-03-SUMMARY.md`
</output>
