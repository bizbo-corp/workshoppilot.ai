---
phase: 13.1-reset-step-step-8-ideation-sub-steps
plan: 03
type: execute
wave: 2
depends_on: ["13.1-02"]
files_modified:
  - src/components/workshop/ideation-sub-step-container.tsx
  - src/components/workshop/idea-selection.tsx
  - src/components/workshop/step-container.tsx
  - src/app/api/chat/route.ts
  - src/components/workshop/chat-panel.tsx
  - src/lib/ai/chat-config.ts
autonomous: false

must_haves:
  truths:
    - "Step 8 shows tabbed navigation with 3 sub-steps: Mind Mapping, Crazy 8s, Brain Writing"
    - "Each sub-step has its own chat conversation with focused AI prompts"
    - "Each sub-step produces intermediate output visible in the output panel"
    - "Users can select ideas from all sub-steps via interactive selection UI"
    - "Users can add their own ideas via free-text input"
    - "Selected ideas (max 3-4) are persisted into the artifact's selectedIdeaTitles field before confirmation"
    - "Sub-step progress persists across tab switches (forceMount + CSS hide)"
    - "Resetting Step 8 also resets artifactConfirmed state"
  artifacts:
    - path: "src/components/workshop/ideation-sub-step-container.tsx"
      provides: "Tabbed container for Step 8 sub-steps with shared state, artifact confirmation, and extraction button"
      exports: ["IdeationSubStepContainer"]
    - path: "src/components/workshop/idea-selection.tsx"
      provides: "Interactive idea selection component with toggle and free-text input"
      exports: ["IdeaSelection"]
    - path: "src/components/workshop/step-container.tsx"
      provides: "Conditional rendering: uses IdeationSubStepContainer for Step 8"
    - path: "src/app/api/chat/route.ts"
      provides: "Sub-step-aware prompt injection for Step 8"
    - path: "src/components/workshop/chat-panel.tsx"
      provides: "Accepts optional subStep prop and passes to API body"
    - path: "src/lib/ai/chat-config.ts"
      provides: "buildStepSystemPrompt accepts optional instructionsOverride parameter"
  key_links:
    - from: "src/components/workshop/step-container.tsx"
      to: "src/components/workshop/ideation-sub-step-container.tsx"
      via: "conditional render when stepOrder === 8"
      pattern: "stepOrder === 8.*IdeationSubStepContainer"
    - from: "src/components/workshop/ideation-sub-step-container.tsx"
      to: "src/components/workshop/idea-selection.tsx"
      via: "rendered in brain-writing tab after artifact extraction"
      pattern: "IdeaSelection"
    - from: "src/components/workshop/ideation-sub-step-container.tsx"
      to: "src/components/workshop/artifact-confirmation.tsx"
      via: "ArtifactConfirmation rendered below output with handleConfirm merging selections into artifact"
      pattern: "ArtifactConfirmation"
    - from: "src/app/api/chat/route.ts"
      to: "src/lib/ai/prompts/step-prompts.ts"
      via: "getIdeationSubStepInstructions call for sub-step-aware prompts"
      pattern: "getIdeationSubStepInstructions"
    - from: "src/app/api/chat/route.ts"
      to: "src/lib/ai/chat-config.ts"
      via: "passes instructionsOverride to buildStepSystemPrompt"
      pattern: "buildStepSystemPrompt.*instructionsOverride"
---

<objective>
Build the Step 8 sub-step UI: tabbed navigation container, sub-step-specific chat and output panels, interactive idea selection component, and wire into existing step-container and chat API. Includes artifact confirmation with selection persistence and extraction button placement.

Purpose: Step 8 Ideation is the longest step. Breaking it into 3 tabbed sub-steps (Mind Mapping, Crazy 8s, Brain Writing) with focused AI prompts per sub-step reduces cognitive overload. Interactive idea selection at the end replaces text-only selection for better UX.

Output: IdeationSubStepContainer with tabs, IdeaSelection component, wired into step-container.tsx, output-panel.tsx, chat-panel.tsx, chat-config.ts, and chat API.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13.1-reset-step-step-8-ideation-sub-steps/13.1-RESEARCH.md
@.planning/phases/13.1-reset-step-step-8-ideation-sub-steps/13.1-02-SUMMARY.md

# Key source files to read before implementing:
@src/components/workshop/step-container.tsx
@src/components/workshop/output-panel.tsx
@src/components/workshop/ideation-cluster-view.tsx
@src/components/workshop/chat-panel.tsx
@src/components/workshop/artifact-confirmation.tsx
@src/app/api/chat/route.ts
@src/lib/ai/prompts/step-prompts.ts
@src/lib/schemas/step-schemas.ts
@src/components/ui/tabs.tsx
@src/lib/ai/chat-config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create IdeationSubStepContainer shell with tabbed navigation and ChatPanel wiring</name>
  <files>
    src/components/workshop/ideation-sub-step-container.tsx
    src/components/workshop/step-container.tsx
    src/components/workshop/chat-panel.tsx
    src/app/api/chat/route.ts
    src/lib/ai/chat-config.ts
  </files>
  <action>
**Create `src/components/workshop/ideation-sub-step-container.tsx`:**

A new client component that wraps Step 8 with tabbed sub-step navigation. This task creates the SHELL only -- tabbed navigation with ChatPanel and OutputPanel per tab, wired into step-container.tsx. Extraction, confirmation, and progress tracking are added in Task 2.

1. 'use client' directive

2. **Concrete imports list:**
   ```typescript
   import * as React from 'react';
   import { Group, Panel, Separator } from 'react-resizable-panels';
   import type { UIMessage } from 'ai';
   import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
   import { ChatPanel } from './chat-panel';
   import { OutputPanel } from './output-panel';
   import { StepNavigation } from './step-navigation';
   import { cn } from '@/lib/utils';
   import { Lightbulb, Zap, PenTool } from 'lucide-react';
   ```

3. Define type: `type IdeationSubStep = 'mind-mapping' | 'crazy-eights' | 'brain-writing'`

4. Interface `IdeationSubStepContainerProps`:
   - `sessionId: string`
   - `workshopId: string`
   - `initialMessages?: UIMessage[]`
   - `initialArtifact?: Record<string, unknown> | null`
   - `stepStatus?: 'not_started' | 'in_progress' | 'complete' | 'needs_regeneration'`
   - `onRevise?: () => void`
   - `onReset?: () => void`

5. **State management (shell only -- no extraction/confirmation yet):**
   - `currentSubStep: IdeationSubStep` (default 'mind-mapping')
   - `isMobile: boolean` (same resize logic as step-container.tsx -- check window width < 768)
   - `artifact: Record<string, unknown> | null` (pre-populated from `initialArtifact || null`)
   - `liveMessageCount: number` (default 0, for future extract button visibility)

6. **Tab persistence approach -- forceMount + CSS hide:**

   Radix TabsContent supports `forceMount` prop. When set, the content stays mounted even when inactive. To hide inactive tabs while keeping them mounted (preserving chat state), apply conditional `hidden` class:

   ```tsx
   <TabsContent
     value="mind-mapping"
     forceMount
     className={cn(
       'flex-1 min-h-0 mt-0',
       currentSubStep !== 'mind-mapping' && 'hidden'
     )}
   >
   ```

   Apply `forceMount` + conditional `hidden` class to ALL 3 TabsContent components.

7. **Render structure:**
   ```tsx
   <div className="flex h-full flex-col">
     {/* Sub-step progress header */}
     <div className="border-b bg-muted/30 px-6 py-3">
       <div className="flex items-center gap-2 text-sm">
         <span className="font-medium">Step 8: Ideation</span>
         <span className="text-muted-foreground">--</span>
         <span className="text-muted-foreground">
           {currentSubStep === 'mind-mapping' && '8a: Mind Mapping'}
           {currentSubStep === 'crazy-eights' && '8b: Crazy 8s'}
           {currentSubStep === 'brain-writing' && '8c: Brain Writing'}
         </span>
       </div>
     </div>

     {/* Tabs navigation */}
     <Tabs
       value={currentSubStep}
       onValueChange={(v) => setCurrentSubStep(v as IdeationSubStep)}
       className="flex flex-1 flex-col min-h-0"
     >
       <div className="border-b px-6">
         <TabsList className="h-10">
           <TabsTrigger value="mind-mapping" className="gap-2">
             <Lightbulb className="h-3.5 w-3.5" />
             Mind Mapping
           </TabsTrigger>
           <TabsTrigger value="crazy-eights" className="gap-2">
             <Zap className="h-3.5 w-3.5" />
             Crazy 8s
           </TabsTrigger>
           <TabsTrigger value="brain-writing" className="gap-2">
             <PenTool className="h-3.5 w-3.5" />
             Brain Writing
           </TabsTrigger>
         </TabsList>
       </div>

       {/* Each tab: forceMount + hidden class for state preservation */}
       {(['mind-mapping', 'crazy-eights', 'brain-writing'] as const).map((subStep) => (
         <TabsContent
           key={subStep}
           value={subStep}
           forceMount
           className={cn(
             'flex-1 min-h-0 mt-0',
             currentSubStep !== subStep && 'hidden'
           )}
         >
           {isMobile ? (
             /* Mobile: stacked layout */
             <div className="flex h-full flex-col">
               <div className="min-h-0 flex-1 border-b">
                 <ChatPanel
                   stepOrder={8}
                   sessionId={sessionId}
                   workshopId={workshopId}
                   initialMessages={initialMessages}
                   onMessageCountChange={setLiveMessageCount}
                   subStep={subStep}
                 />
               </div>
               <div className="min-h-0 flex-1">
                 <OutputPanel
                   stepOrder={8}
                   artifact={artifact}
                   isExtracting={false}
                   extractionError={null}
                   onRetry={() => {}}
                 />
               </div>
             </div>
           ) : (
             /* Desktop: resizable panels */
             <Group orientation="horizontal" className="h-full">
               <Panel defaultSize={50} minSize={30}>
                 <ChatPanel
                   stepOrder={8}
                   sessionId={sessionId}
                   workshopId={workshopId}
                   initialMessages={initialMessages}
                   onMessageCountChange={setLiveMessageCount}
                   subStep={subStep}
                 />
               </Panel>
               <Separator className="group relative w-px bg-border hover:bg-ring data-[resize-handle-state=drag]:bg-ring">
                 <div className="absolute inset-y-0 -left-3 -right-3" />
                 <div className="absolute inset-y-0 left-0 w-px bg-ring opacity-0 transition-opacity group-hover:opacity-100 group-data-[resize-handle-state=drag]:opacity-100" />
               </Separator>
               <Panel defaultSize={50} minSize={25}>
                 <OutputPanel
                   stepOrder={8}
                   artifact={artifact}
                   isExtracting={false}
                   extractionError={null}
                   onRetry={() => {}}
                 />
               </Panel>
             </Group>
           )}
         </TabsContent>
       ))}
     </Tabs>

     {/* Step navigation (shared across all sub-steps) */}
     <StepNavigation
       sessionId={sessionId}
       workshopId={workshopId}
       currentStepOrder={8}
       artifactConfirmed={false}
       stepStatus={stepStatus}
       onRevise={onRevise}
       onReset={onReset}
     />
   </div>
   ```

**IMPORTANT:** All 3 sub-steps share the SAME chat history (same sessionId, stepOrder=8). The `subStep` prop on ChatPanel is sent to the chat API so the system prompt adjusts per sub-step, but the conversation is continuous.

---

**In `src/components/workshop/step-container.tsx`:**

Conditionally render `IdeationSubStepContainer` when stepOrder === 8:

1. Add import at top: `import { IdeationSubStepContainer } from './ideation-sub-step-container';`
2. After the existing state declarations and before `renderContent()`, add the Step 8 early return:
   ```typescript
   // Step 8 uses specialized sub-step container
   if (stepOrder === 8) {
     return (
       <>
         <IdeationSubStepContainer
           sessionId={sessionId}
           workshopId={workshopId}
           initialMessages={initialMessages}
           initialArtifact={initialArtifact}
           stepStatus={stepStatus}
           onRevise={handleRevise}
           onReset={() => setShowResetDialog(true)}
         />
         <ResetStepDialog
           open={showResetDialog}
           onOpenChange={setShowResetDialog}
           onConfirm={handleReset}
           isResetting={isResetting}
           stepName="Ideation"
         />
       </>
     );
   }
   ```
   NOTE: `showResetDialog`, `setShowResetDialog`, `handleReset`, `isResetting`, and `ResetStepDialog` are added by Plan 01. If Plan 01 has not been executed yet, guard with: check if these exist in step-container.tsx. If the ResetStepDialog import and state don't exist yet, just pass `onReset` as undefined and omit the dialog -- Plan 01 will add it.

3. Keep all existing rendering logic for steps 1-7 and 9-10 unchanged.

---

**In `src/components/workshop/chat-panel.tsx`:**

Add optional `subStep` prop:

1. Add `subStep?: 'mind-mapping' | 'crazy-eights' | 'brain-writing'` to `ChatPanelProps` interface
2. Destructure `subStep` from props
3. Update the DefaultChatTransport body to include subStep:
   ```typescript
   const transport = React.useMemo(
     () =>
       new DefaultChatTransport({
         api: '/api/chat',
         body: { sessionId, stepId: step.id, workshopId, subStep },
       }),
     [sessionId, step.id, workshopId, subStep]
   );
   ```
   Add `subStep` to the dependency array.

---

**In `src/lib/ai/chat-config.ts`:**

Update `buildStepSystemPrompt` to accept an optional `instructionsOverride` parameter:

1. Add a 7th parameter to the function signature:
   ```typescript
   export function buildStepSystemPrompt(
     stepId: string,
     stepName: string,
     arcPhase: ArcPhase,
     stepDescription: string,
     persistentContext: string,
     summaries: string,
     instructionsOverride?: string  // <-- NEW: overrides getStepSpecificInstructions output
   ): string {
   ```
2. Where the function currently calls `getStepSpecificInstructions(stepId)` (around line 66), change to:
   ```typescript
   const stepInstructions = instructionsOverride || getStepSpecificInstructions(stepId);
   ```
   This allows callers to provide sub-step-specific instructions that replace the generic step instructions entirely.

---

**In `src/app/api/chat/route.ts`:**

Add sub-step awareness for Step 8:

1. Parse `subStep` from the request body (alongside existing fields):
   ```typescript
   const { messages, sessionId, stepId, workshopId, subStep } = await req.json();
   ```

2. After the existing `stepDescription` assignment and BEFORE the `buildStepSystemPrompt` call, conditionally get sub-step instructions:
   ```typescript
   // Sub-step prompt override for Step 8 Ideation
   let instructionsOverride: string | undefined;
   if (stepId === 'ideation' && subStep) {
     const { getIdeationSubStepInstructions } = await import('@/lib/ai/prompts/step-prompts');
     instructionsOverride = getIdeationSubStepInstructions(subStep);
   }
   ```

3. Pass `instructionsOverride` as the 7th argument to `buildStepSystemPrompt`:
   ```typescript
   const systemPrompt = buildStepSystemPrompt(
     stepId,
     stepName,
     arcPhase,
     stepDescription,
     stepContext.persistentContext,
     stepContext.summaries,
     instructionsOverride  // <-- NEW: undefined for non-ideation steps, sub-step instructions for Step 8
   );
   ```

4. When subStep is NOT provided (undefined), `instructionsOverride` is undefined, so `buildStepSystemPrompt` falls back to `getStepSpecificInstructions(stepId)` as before. No behavior change for non-Step-8 routes.
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit`
- Step 8 renders IdeationSubStepContainer instead of default step-container layout
- Tab switching works without losing chat state (forceMount + hidden class)
- Chat API accepts subStep parameter and uses sub-step-specific prompts when provided
- `buildStepSystemPrompt` still works without instructionsOverride (backward compatible)
- Steps 1-7 and 9-10 render normally (no regression)
- `npm run build` passes
  </verify>
  <done>
Step 8 shows tabbed UI with Mind Mapping, Crazy 8s, Brain Writing sub-steps. Each tab renders ChatPanel with subStep prop and OutputPanel. Tabs preserve state via forceMount + CSS hidden. Chat API parses subStep from body, gets sub-step instructions via getIdeationSubStepInstructions, passes as instructionsOverride to buildStepSystemPrompt. chat-config.ts buildStepSystemPrompt uses instructionsOverride when provided, falls back to getStepSpecificInstructions otherwise.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add extraction lifecycle, artifact confirmation, progress tracking, and selection merge to IdeationSubStepContainer</name>
  <files>
    src/components/workshop/ideation-sub-step-container.tsx
  </files>
  <action>
**In `src/components/workshop/ideation-sub-step-container.tsx`:**

Enhance the shell from Task 1 with the full artifact lifecycle: extraction, confirmation, progress tracking, and selection merge. This requires adding state, callbacks, and updating the render to include Extract Output button and ArtifactConfirmation.

1. **Add imports** (to the existing import block from Task 1):
   ```typescript
   import { useRouter } from 'next/navigation';
   import { ArtifactConfirmation } from './artifact-confirmation';
   import { Button } from '@/components/ui/button';
   import { Check, Sparkles } from 'lucide-react';
   ```

2. **Add state variables** (alongside existing state from Task 1):
   ```typescript
   const router = useRouter();
   const [isExtracting, setIsExtracting] = React.useState(false);
   const [extractionError, setExtractionError] = React.useState<string | null>(null);
   const [artifactConfirmed, setArtifactConfirmed] = React.useState(
     stepStatus === 'complete' && initialArtifact !== null
   );
   const [selectedIdeas, setSelectedIdeas] = React.useState<string[]>([]);
   const [userAddedIdeas, setUserAddedIdeas] = React.useState<Array<{title: string; description: string}>>([]);
   ```

3. **Sub-step progress tracking:**
   ```typescript
   const [mindMappingEngaged, setMindMappingEngaged] = React.useState(false);
   const [crazyEightsEngaged, setCrazyEightsEngaged] = React.useState(false);
   const [brainWritingEngaged, setBrainWritingEngaged] = React.useState(false);
   ```
   Track engagement: set the current sub-step as engaged when `liveMessageCount` increases while that tab is active. Use a useEffect:
   ```typescript
   React.useEffect(() => {
     if (liveMessageCount > 2) {
       if (currentSubStep === 'mind-mapping') setMindMappingEngaged(true);
       if (currentSubStep === 'crazy-eights') setCrazyEightsEngaged(true);
       if (currentSubStep === 'brain-writing') setBrainWritingEngaged(true);
     }
   }, [liveMessageCount, currentSubStep]);
   ```

4. **Extract artifact callback** (replicated from step-container.tsx):
   ```typescript
   const extractArtifact = React.useCallback(async () => {
     setIsExtracting(true);
     setExtractionError(null);
     try {
       const { getStepByOrder } = await import('@/lib/workshop/step-metadata');
       const step = getStepByOrder(8);
       if (!step) { setExtractionError('Step not found'); return; }
       const response = await fetch('/api/extract', {
         method: 'POST',
         headers: { 'Content-Type': 'application/json' },
         body: JSON.stringify({ workshopId, stepId: step.id, sessionId }),
       });
       const data = await response.json();
       if (response.ok) {
         setArtifact(data.artifact);
         setExtractionError(null);
       } else if (response.status === 422) {
         setExtractionError(data.message || 'Failed to extract artifact');
       } else if (response.status === 400) {
         setExtractionError(data.message || 'Not enough conversation to extract');
       } else if (response.status === 404) {
         setExtractionError('Session not found');
       } else {
         setExtractionError('An unexpected error occurred');
       }
     } catch (error) {
       console.error('Extraction error:', error);
       setExtractionError('Network error - please try again');
     } finally {
       setIsExtracting(false);
     }
   }, [workshopId, sessionId]);
   ```

5. **ArtifactConfirmation handlers** (with selection merge):

   `handleConfirm` -- merges selectedIdeas and userAddedIdeas into artifact BEFORE confirming:
   ```typescript
   const handleConfirm = React.useCallback(() => {
     if (artifact) {
       const updatedArtifact = {
         ...artifact,
         selectedIdeaTitles: selectedIdeas,
         userIdeas: [
           ...((artifact.userIdeas as Array<{title: string; description: string}>) || []),
           ...userAddedIdeas.filter(ua =>
             !((artifact.userIdeas as Array<{title: string; description: string}>) || [])
               .some(existing => existing.title === ua.title)
           ),
         ],
       };
       setArtifact(updatedArtifact);
     }
     setArtifactConfirmed(true);
   }, [artifact, selectedIdeas, userAddedIdeas]);
   ```

   `handleEdit`:
   ```typescript
   const handleEdit = React.useCallback(() => {
     setArtifactConfirmed(false);
     setArtifact(null);
   }, []);
   ```

6. **Derive `hasEnoughMessages`** for extract button visibility:
   ```typescript
   const hasEnoughMessages = liveMessageCount >= 4;
   ```

7. **Update TabsTrigger to show engagement indicators.** Add the Check icon to each tab trigger:
   ```tsx
   <TabsTrigger value="mind-mapping" className="gap-2">
     <Lightbulb className="h-3.5 w-3.5" />
     Mind Mapping
     {mindMappingEngaged && <Check className="h-3 w-3 text-green-600" />}
   </TabsTrigger>
   <TabsTrigger value="crazy-eights" className="gap-2">
     <Zap className="h-3.5 w-3.5" />
     Crazy 8s
     {crazyEightsEngaged && <Check className="h-3 w-3 text-green-600" />}
   </TabsTrigger>
   <TabsTrigger value="brain-writing" className="gap-2">
     <PenTool className="h-3.5 w-3.5" />
     Brain Writing
     {brainWritingEngaged && <Check className="h-3 w-3 text-green-600" />}
   </TabsTrigger>
   ```

8. **Refactor the inline ChatPanel/OutputPanel rendering into helper functions** to add Extract Output button and ArtifactConfirmation.

   **`renderChatPanel(subStep)` helper:**
   ```tsx
   const renderChatPanel = (subStep: IdeationSubStep) => (
     <div className="flex h-full min-h-0 flex-col">
       <div className="min-h-0 flex-1">
         <ChatPanel
           stepOrder={8}
           sessionId={sessionId}
           workshopId={workshopId}
           initialMessages={initialMessages}
           onMessageCountChange={setLiveMessageCount}
           subStep={subStep}
         />
       </div>
       {/* Extract Output button -- only shown in the active tab when conditions met */}
       {currentSubStep === subStep && hasEnoughMessages && !artifact && !isExtracting && (
         <div className="flex shrink-0 justify-center border-t bg-background p-4">
           <Button onClick={extractArtifact} variant="outline" size="sm">
             <Sparkles className="mr-2 h-4 w-4" />
             Extract Output
           </Button>
         </div>
       )}
     </div>
   );
   ```
   The "Extract Output" button appears below the ChatPanel in the chat side, matching step-container.tsx's placement. It only renders in the currently active tab to avoid duplicate buttons. The button triggers a single extraction covering ALL sub-steps (since they share one conversation).

   **`renderOutputPanel(subStep)` helper:**
   ```tsx
   const renderOutputPanel = (subStep: IdeationSubStep) => (
     <div className="flex h-full flex-col">
       <div className="flex-1 overflow-hidden">
         <OutputPanel
           stepOrder={8}
           artifact={artifact}
           isExtracting={isExtracting}
           extractionError={extractionError}
           onRetry={extractArtifact}
         />
       </div>
       {/* ArtifactConfirmation -- same placement as step-container.tsx (border-t below output) */}
       {currentSubStep === subStep && artifact && (
         <div className="border-t bg-background p-4">
           <ArtifactConfirmation
             onConfirm={handleConfirm}
             onEdit={handleEdit}
             isConfirming={false}
             isConfirmed={artifactConfirmed}
           />
         </div>
       )}
     </div>
   );
   ```
   ArtifactConfirmation renders below the OutputPanel with `border-t`, identical to step-container.tsx. It only shows in the active tab.

9. **Replace the inline ChatPanel/OutputPanel in each TabsContent** with calls to `renderChatPanel(subStep)` and `renderOutputPanel(subStep)`. Update both mobile and desktop branches inside the `.map()` loop.

10. **Update the OutputPanel props** to use actual extraction state (replace the placeholder `isExtracting={false}` and `extractionError={null}` from Task 1):
    - `isExtracting={isExtracting}`
    - `extractionError={extractionError}`
    - `onRetry={extractArtifact}`

11. **Update StepNavigation** to pass real `artifactConfirmed`:
    ```tsx
    <StepNavigation
      sessionId={sessionId}
      workshopId={workshopId}
      currentStepOrder={8}
      artifactConfirmed={artifactConfirmed}
      stepStatus={stepStatus}
      onRevise={onRevise}
      onReset={onReset}
    />
    ```
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit`
- "Extract Output" button appears below ChatPanel in the active tab after 4+ messages
- Clicking "Extract Output" calls /api/extract and populates artifact
- ArtifactConfirmation appears below OutputPanel with border-t in the active tab
- Progress check marks appear on tab triggers after engagement
- `npm run build` passes
  </verify>
  <done>
IdeationSubStepContainer has full artifact lifecycle: Extract Output button below chat panel, ArtifactConfirmation below output panel, extraction callback, confirmation with selection merge (selectedIdeas into selectedIdeaTitles, userAddedIdeas into userIdeas), progress tracking with engagement booleans and check marks on tab triggers.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create IdeaSelection component and wire selection persistence into artifact</name>
  <files>
    src/components/workshop/idea-selection.tsx
    src/components/workshop/ideation-sub-step-container.tsx
  </files>
  <action>
**Create `src/components/workshop/idea-selection.tsx`:**

An interactive component for selecting ideas from all sub-steps, displayed in the output panel area of the Brain Writing tab after extraction:

1. 'use client' directive
2. Import: `useState` from 'react', `Button` from `@/components/ui/button`, `Input` from `@/components/ui/input`, `cn` from `@/lib/utils`, `Plus, X, Check` from `lucide-react`

3. Interface `IdeaItem`:
   - `title: string`
   - `description: string`
   - `source: 'mind-mapping' | 'crazy-eights' | 'brain-writing' | 'user'`
   - `isWildCard?: boolean`

4. Interface `IdeaSelectionProps`:
   - `ideas: IdeaItem[]` -- all ideas from all sub-steps
   - `selectedTitles: string[]` -- currently selected idea titles
   - `onSelectionChange: (titles: string[]) => void`
   - `userAddedIdeas: Array<{title: string, description: string}>`
   - `onAddUserIdea: (idea: {title: string, description: string}) => void`
   - `onRemoveUserIdea: (title: string) => void`
   - `maxSelection?: number` (default 4)

5. Component renders:
   ```tsx
   <div className="space-y-4">
     <div className="flex items-center justify-between">
       <h4 className="font-semibold text-sm">Select Ideas for Concept Development</h4>
       <span className="text-xs text-muted-foreground">
         {selectedTitles.length}/{maxSelection} selected
       </span>
     </div>

     {/* Idea cards -- grouped by source */}
     {/* Section: Mind Mapping Ideas */}
     {/* Section: Crazy 8s Ideas */}
     {/* Section: Brain Writing Ideas */}
     {/* Section: Your Ideas (user-added) */}

     {/* Each idea card: */}
     <button
       onClick={() => toggleSelection(idea.title)}
       disabled={!isSelected && selectedTitles.length >= maxSelection}
       className={cn(
         'w-full text-left rounded-lg border p-3 transition-colors',
         isSelected
           ? 'border-green-500 bg-green-50/50 dark:bg-green-950/20'
           : 'hover:border-primary/50',
         disabled && 'opacity-50 cursor-not-allowed'
       )}
     >
       <div className="flex items-start justify-between gap-2">
         <div>
           <div className="flex items-center gap-2">
             <span className="font-medium text-sm">{idea.title}</span>
             {idea.isWildCard && <span className="text-xs text-amber-600">Wild Card</span>}
             <span className="text-xs text-muted-foreground capitalize">{idea.source.replace('-', ' ')}</span>
           </div>
           <p className="text-xs text-muted-foreground mt-1">{idea.description}</p>
         </div>
         {isSelected && <Check className="h-4 w-4 text-green-600 shrink-0" />}
       </div>
     </button>

     {/* Add your own idea */}
     <div className="border-t pt-4">
       <p className="text-sm font-medium mb-2">Add Your Own Idea</p>
       <div className="flex gap-2">
         <Input
           placeholder="Idea title..."
           value={newIdeaTitle}
           onChange={(e) => setNewIdeaTitle(e.target.value)}
           className="flex-1"
         />
         <Button
           size="sm"
           variant="outline"
           onClick={handleAddIdea}
           disabled={!newIdeaTitle.trim()}
         >
           <Plus className="h-4 w-4" />
         </Button>
       </div>
       {newIdeaTitle.trim() && (
         <Input
           placeholder="Brief description (optional)..."
           value={newIdeaDescription}
           onChange={(e) => setNewIdeaDescription(e.target.value)}
           className="mt-2"
         />
       )}

       {/* User-added ideas list */}
       {userAddedIdeas.map((idea) => (
         <div key={idea.title} className="flex items-center justify-between mt-2 rounded border p-2">
           <span className="text-sm">{idea.title}</span>
           <button onClick={() => onRemoveUserIdea(idea.title)}>
             <X className="h-3.5 w-3.5 text-muted-foreground hover:text-destructive" />
           </button>
         </div>
       ))}
     </div>

     {/* Selection summary */}
     {selectedTitles.length > 0 && (
       <div className="rounded-lg border border-green-500/50 bg-green-50/50 p-3 dark:bg-green-950/20">
         <p className="text-xs font-semibold text-green-800 dark:text-green-200 mb-1">
           Selected for Step 9:
         </p>
         <div className="flex flex-wrap gap-1.5">
           {selectedTitles.map((title) => (
             <span key={title} className="rounded-md bg-green-500/20 px-2 py-0.5 text-xs font-medium text-green-800 dark:text-green-200">
               {title}
             </span>
           ))}
         </div>
       </div>
     )}
   </div>
   ```

6. `toggleSelection` function:
   - If already selected, remove from selectedTitles
   - If not selected and count < maxSelection, add to selectedTitles
   - If not selected and count >= maxSelection, do nothing (button is disabled)

7. `handleAddIdea` function:
   - Call `onAddUserIdea({ title: newIdeaTitle.trim(), description: newIdeaDescription.trim() })`
   - Clear newIdeaTitle and newIdeaDescription
   - Auto-select the user-added idea if under maxSelection

---

**Wire into `src/components/workshop/ideation-sub-step-container.tsx`:**

1. **Import IdeaSelection:** `import { IdeaSelection } from './idea-selection';`

2. **IdeaSelection rendering** -- In the `renderOutputPanel` function, AFTER the OutputPanel but BEFORE the ArtifactConfirmation, conditionally render `<IdeaSelection>` when the artifact has been extracted AND user is on brain-writing tab:
   ```tsx
   const renderOutputPanel = (subStep: IdeationSubStep) => (
     <div className="flex h-full flex-col">
       <div className="flex-1 overflow-y-auto">
         <OutputPanel
           stepOrder={8}
           artifact={artifact}
           isExtracting={isExtracting}
           extractionError={extractionError}
           onRetry={extractArtifact}
         />
         {/* IdeaSelection -- shown in brain-writing tab when artifact exists */}
         {currentSubStep === subStep && subStep === 'brain-writing' && artifact && !artifactConfirmed && (
           <div className="border-t p-4">
             <IdeaSelection
               ideas={allIdeasFromArtifact}
               selectedTitles={selectedIdeas}
               onSelectionChange={setSelectedIdeas}
               userAddedIdeas={userAddedIdeas}
               onAddUserIdea={handleAddUserIdea}
               onRemoveUserIdea={handleRemoveUserIdea}
               maxSelection={4}
             />
           </div>
         )}
       </div>
       {/* ArtifactConfirmation below */}
       {currentSubStep === subStep && artifact && (
         <div className="border-t bg-background p-4">
           <ArtifactConfirmation
             onConfirm={handleConfirm}
             onEdit={handleEdit}
             isConfirming={false}
             isConfirmed={artifactConfirmed}
           />
         </div>
       )}
     </div>
   );
   ```

   **KEY FLOW:** After extraction, the user sees the IdeationClusterView in OutputPanel (artifact rendering) with the IdeaSelection component below it. The user selects their top 3-4 ideas and optionally adds custom ones. When they click "Looks Good" in ArtifactConfirmation, `handleConfirm` fires which MERGES `selectedIdeas` and `userAddedIdeas` into the artifact's `selectedIdeaTitles` and `userIdeas` fields BEFORE setting `artifactConfirmed = true`.

3. **`allIdeasFromArtifact` memo** -- Extracts ideas from the artifact:
   ```typescript
   const allIdeasFromArtifact = React.useMemo(() => {
     if (!artifact) return [];
     const items: Array<{title: string; description: string; source: 'mind-mapping' | 'crazy-eights' | 'brain-writing' | 'user'; isWildCard?: boolean}> = [];
     // Clusters from mind mapping
     const clusters = (artifact.clusters as Array<{theme: string; ideas: Array<{title: string; description: string; isWildCard?: boolean}>}>) || [];
     clusters.forEach(cluster => {
       cluster.ideas.forEach(idea => {
         items.push({ ...idea, source: 'mind-mapping' });
       });
     });
     // Crazy 8s ideas
     const crazy8s = (artifact.crazyEightsIdeas as Array<{title: string; description: string}>) || [];
     crazy8s.forEach(idea => {
       items.push({ ...idea, source: 'crazy-eights' });
     });
     // Brain written ideas (use finalVersion as title)
     const brainWritten = (artifact.brainWrittenIdeas as Array<{originalTitle: string; finalVersion: string; evolutionDescription: string}>) || [];
     brainWritten.forEach(idea => {
       items.push({ title: idea.finalVersion, description: idea.evolutionDescription, source: 'brain-writing' });
     });
     // User ideas already in artifact
     const existingUserIdeas = (artifact.userIdeas as Array<{title: string; description: string}>) || [];
     existingUserIdeas.forEach(idea => {
       items.push({ ...idea, source: 'user' });
     });
     return items;
   }, [artifact]);
   ```

4. **Pre-populate selectedIdeas from artifact** -- When artifact loads (from `initialArtifact` or extraction), pre-populate `selectedIdeas` if the artifact already has `selectedIdeaTitles`:
   ```typescript
   React.useEffect(() => {
     if (artifact && (artifact.selectedIdeaTitles as string[])?.length > 0) {
       setSelectedIdeas((artifact.selectedIdeaTitles as string[]) || []);
     }
   }, [artifact]);
   ```

5. **User idea handlers:**
   ```typescript
   const handleAddUserIdea = (idea: {title: string; description: string}) => {
     setUserAddedIdeas(prev => [...prev, idea]);
   };
   const handleRemoveUserIdea = (title: string) => {
     setUserAddedIdeas(prev => prev.filter(i => i.title !== title));
     setSelectedIdeas(prev => prev.filter(t => t !== title));
   };
   ```
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit`
- IdeaSelection renders in the Brain Writing tab output area when artifact exists and not yet confirmed
- Clicking an idea toggles its selected state (green highlight + check)
- Cannot select more than 4 ideas (button disabled)
- Free-text "Add Your Own Idea" adds to the list and can be selected
- Removing a user-added idea also deselects it
- Clicking "Looks Good" in ArtifactConfirmation merges selectedIdeas into artifact's selectedIdeaTitles
- After confirmation, `artifact.selectedIdeaTitles` contains the selected titles array
- Pre-existing selectedIdeaTitles from initialArtifact are pre-populated on load
- **Step 9 field compatibility check:** Run `grep -r "selectedIdeas" src/lib/ai/prompts/step-prompts.ts src/lib/schemas/step-schemas.ts` to verify no stale references to old field name remain after Plan 02's rename to `selectedIdeaTitles`. If any are found, update them.
- `npm run build` passes with no references to old `selectedIdeas` field name
  </verify>
  <done>
Interactive IdeaSelection component renders grouped ideas from all sub-steps with toggle selection, max 4 limit, and free-text user idea input. Wired into IdeationSubStepContainer's Brain Writing tab. Selected ideas are merged into artifact's selectedIdeaTitles field on confirmation. User-added ideas are appended to artifact's userIdeas field. Pre-existing selections are pre-populated on load. Step 9 compatibility verified (no stale selectedIdeas references).
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
  Reset Step functionality (Plan 01) and Step 8 Sub-Step restructure (Plans 02-03):

  1. **Reset Step**: Reset button on in-progress/needs_regeneration steps, confirmation dialog, clears conversation/artifact/summary, cascade-invalidates downstream
  2. **Step 8 Sub-Steps**: Tabbed UI (Mind Mapping -> Crazy 8s -> Brain Writing), focused AI prompts per sub-step, interactive idea selection with free-text user input
  3. **Selection persistence**: Selected ideas merged into artifact before confirmation, flows to Step 9
  </what-built>
  <how-to-verify>
  **Reset Step:**
  1. Start a workshop and reach Step 2 (complete Step 1 first)
  2. Navigate to Step 2 (in_progress) -- verify "Reset" button appears in navigation bar
  3. Click "Reset" -- verify confirmation dialog shows with step name and warning text
  4. Click "Cancel" -- verify dialog closes, nothing changes
  5. Click "Reset Step" -- verify:
     - Chat panel clears (AI re-starts from scratch)
     - Output panel clears (artifact gone)
     - Step still shows as in_progress
     - artifactConfirmed state is reset (no green "Output confirmed" bar)
  6. Navigate back to Step 1 (completed) -- verify "Revise This Step" still works normally
  7. Go to Step 3+ -- verify downstream steps show needs_regeneration status if they were started

  **Step 8 Sub-Steps:**
  1. Navigate to Step 8 Ideation
  2. Verify tabbed navigation appears: Mind Mapping | Crazy 8s | Brain Writing
  3. Start Mind Mapping -- AI generates themed clusters with wild cards and asks for user ideas
  4. Switch to Crazy 8s tab -- AI generates 8 rapid-fire ideas
  5. Switch back to Mind Mapping -- verify chat state is preserved (messages still there)
  6. Switch to Brain Writing tab -- AI presents ideas for brain writing evolution
  7. Click "Extract Output" (appears below chat panel) -- verify extraction produces artifact with all sub-step data
  8. Verify IdeaSelection appears in Brain Writing tab output area (below IdeationClusterView, above ArtifactConfirmation)
  9. Click ideas to select (max 4) -- verify green highlight and count updates
  10. Use "Add Your Own Idea" -- verify it appears in list and can be selected
  11. Click "Looks Good" -- verify artifact is confirmed
  12. Check: after confirmation, the IdeationClusterView's "Selected for Concept Development" section shows the selected idea titles (these were merged into artifact.selectedIdeaTitles)

  **Step 9 Compatibility:**
  13. Navigate to Step 9 Concept Development -- verify it can reference the selected ideas from Step 8
  14. Verify the schema field `selectedIdeaTitles` (renamed from `selectedIdeas` in Plan 02) works throughout
  </how-to-verify>
  <resume-signal>Type "approved" to complete Phase 13.1, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. Step 8 renders tabbed UI instead of default step container
2. Each sub-step tab shows chat panel with AI using focused sub-step prompt (injected via instructionsOverride in buildStepSystemPrompt)
3. Tab switches preserve chat state (forceMount + hidden class)
4. "Extract Output" button appears below ChatPanel in the active tab (matching step-container.tsx placement)
5. ArtifactConfirmation renders below OutputPanel with border-t (matching step-container.tsx pattern)
6. Brain Writing tab shows IdeaSelection between OutputPanel and ArtifactConfirmation after extraction
7. IdeaSelection shows ideas grouped by source with toggle selection
8. Max 4 ideas can be selected
9. Free-text user idea input works
10. Clicking "Looks Good" merges selectedIdeas into artifact.selectedIdeaTitles and userAddedIdeas into artifact.userIdeas
11. Pre-existing selectedIdeaTitles from initialArtifact are pre-populated on load
12. Reset Step also resets artifactConfirmed state
13. Schema field name selectedIdeaTitles works in Step 9 prompt/extraction (renamed from selectedIdeas in Plan 02) -- verified by grep for stale "selectedIdeas" references in step-prompts.ts and step-schemas.ts
14. Steps 1-7 and 9-10 render normally (no regression)
15. Build passes: `npm run build`
</verification>

<success_criteria>
- Step 8 shows 3 tabbed sub-steps with correct labels and icons
- Each sub-step has focused AI conversation (sub-step instructions injected via chat route -> buildStepSystemPrompt instructionsOverride)
- Chat state preserved across tab switches via forceMount + hidden
- Extract Output button below chat panel, ArtifactConfirmation below output panel (matching step-container.tsx)
- IdeaSelection shows all ideas with toggle, max 4 limit, and user input
- Selected ideas merged into artifact.selectedIdeaTitles on confirmation
- User-added ideas merged into artifact.userIdeas on confirmation
- Reset step clears artifactConfirmed state
- selectedIdeaTitles field name works across Step 8 extraction, IdeationClusterView, and Step 9 (no stale references)
- No regressions to other steps
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/13.1-reset-step-step-8-ideation-sub-steps/13.1-03-SUMMARY.md`
</output>
