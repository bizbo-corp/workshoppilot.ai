---
phase: 13.1-reset-step-step-8-ideation-sub-steps
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/actions/workshop-actions.ts
  - src/components/dialogs/reset-step-dialog.tsx
  - src/components/workshop/step-navigation.tsx
  - src/components/workshop/step-container.tsx
autonomous: true

must_haves:
  truths:
    - "User can click Reset Step on any in-progress or completed step and sees a confirmation dialog"
    - "Confirming reset clears conversation, artifact, and summary for the current step only"
    - "Downstream steps are marked needs_regeneration after reset (cascade invalidation)"
    - "After reset, step re-enters in_progress with arcPhase orient and AI re-starts"
  artifacts:
    - path: "src/actions/workshop-actions.ts"
      provides: "resetStep server action"
      exports: ["resetStep"]
    - path: "src/components/dialogs/reset-step-dialog.tsx"
      provides: "Confirmation dialog for step reset"
      exports: ["ResetStepDialog"]
    - path: "src/components/workshop/step-navigation.tsx"
      provides: "Reset Step button for in-progress steps"
    - path: "src/components/workshop/step-container.tsx"
      provides: "Reset handler + dialog state management"
  key_links:
    - from: "src/components/workshop/step-navigation.tsx"
      to: "src/components/workshop/step-container.tsx"
      via: "onReset callback prop"
      pattern: "onReset"
    - from: "src/components/workshop/step-container.tsx"
      to: "src/actions/workshop-actions.ts"
      via: "resetStep server action call"
      pattern: "resetStep\\("
    - from: "src/actions/workshop-actions.ts"
      to: "src/lib/navigation/cascade-invalidation.ts"
      via: "invalidateDownstreamSteps call after clearing data"
      pattern: "invalidateDownstreamSteps"
---

<objective>
Add Reset Step functionality allowing users to clear conversation, artifact, and summary for any step and start fresh with cascade invalidation of downstream steps.

Purpose: Users who go down a wrong path in a step need a clean way to start over without leaving the workshop. This extends the existing "Revise This Step" pattern (which preserves data) with a destructive "Reset Step" that clears all data for the current step.

Output: resetStep server action, ResetStepDialog confirmation component, wired into step-container and step-navigation.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13.1-reset-step-step-8-ideation-sub-steps/13.1-RESEARCH.md

# Key source files to read before implementing:
@src/actions/workshop-actions.ts
@src/lib/navigation/cascade-invalidation.ts
@src/components/dialogs/exit-workshop-dialog.tsx
@src/components/workshop/step-container.tsx
@src/components/workshop/step-navigation.tsx
@src/db/schema/chat-messages.ts
@src/db/schema/step-artifacts.ts
@src/db/schema/step-summaries.ts
@src/db/schema/steps.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create resetStep server action and ResetStepDialog confirmation component</name>
  <files>
    src/actions/workshop-actions.ts
    src/components/dialogs/reset-step-dialog.tsx
  </files>
  <action>
**In `src/actions/workshop-actions.ts`:**

Add a new exported server action `resetStep(workshopId: string, stepId: string, sessionId: string): Promise<void>` following the existing `reviseStep` pattern but with additional data deletion:

1. Import `chatMessages`, `stepArtifacts`, `stepSummaries` from `@/db/schema` (add to existing imports)
2. Find the workshopStep record: `db.select({ id: workshopSteps.id }).from(workshopSteps).where(and(eq(workshopSteps.workshopId, workshopId), eq(workshopSteps.stepId, stepId))).limit(1)`
3. If not found, throw error `'Workshop step not found: ${stepId}'`
4. Delete chat messages for this step: `db.delete(chatMessages).where(and(eq(chatMessages.sessionId, sessionId), eq(chatMessages.stepId, stepId)))`
5. Delete step artifact: `db.delete(stepArtifacts).where(eq(stepArtifacts.workshopStepId, workshopStepRecord.id))`
6. Delete step summary: `db.delete(stepSummaries).where(eq(stepSummaries.workshopStepId, workshopStepRecord.id))`
7. Call `invalidateDownstreamSteps(workshopId, stepId)` — this resets the current step to in_progress with arcPhase: orient AND marks downstream as needs_regeneration
8. Revalidate path: `revalidatePath('/workshop/${sessionId}')`
9. Wrap everything in try/catch with `console.error('Failed to reset step:', error)` and re-throw

**In `src/components/dialogs/reset-step-dialog.tsx`:**

Create a new confirmation dialog following the exact pattern of `exit-workshop-dialog.tsx`:

1. 'use client' directive
2. Import Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle from `@/components/ui/dialog`
3. Import Button from `@/components/ui/button`
4. Interface `ResetStepDialogProps`: `open: boolean`, `onOpenChange: (open: boolean) => void`, `onConfirm: () => void`, `isResetting: boolean`, `stepName: string`
5. Export function `ResetStepDialog({ open, onOpenChange, onConfirm, isResetting, stepName })`
6. Dialog title: `"Reset ${stepName}?"`
7. Dialog description: `"This will clear your conversation, extracted output, and summary for this step. Downstream steps will be marked as needing regeneration. This cannot be undone."`
8. Footer buttons:
   - Cancel: `<Button variant="outline" onClick={() => onOpenChange(false)} disabled={isResetting}>Cancel</Button>`
   - Confirm: `<Button variant="destructive" onClick={onConfirm} disabled={isResetting}>{isResetting ? 'Resetting...' : 'Reset Step'}</Button>`
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit` passes (or check for errors in the two modified/created files)
- `resetStep` is exported from `workshop-actions.ts`
- `ResetStepDialog` is exported from `reset-step-dialog.tsx`
- Dialog has variant="destructive" button and isResetting loading state
  </verify>
  <done>
resetStep server action exists that deletes messages, artifacts, summaries for current step then cascade-invalidates downstream. ResetStepDialog shows confirmation with step name, loading state, and destructive confirm button.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire reset functionality into StepNavigation and StepContainer</name>
  <files>
    src/components/workshop/step-navigation.tsx
    src/components/workshop/step-container.tsx
  </files>
  <action>
**In `src/components/workshop/step-navigation.tsx`:**

Add "Reset Step" button for in-progress and needs_regeneration steps:

1. Add `onReset?: () => void` to `StepNavigationProps` interface
2. Import `RotateCcw` icon from `lucide-react` (alongside existing ChevronLeft, ChevronRight, AlertTriangle)
3. In the render, add a Reset button to the LEFT side (next to Back button), shown only when step is `in_progress` or `needs_regeneration`:
   - After the existing Back button section but before the spacer, add conditional:
   ```
   {(stepStatus === 'in_progress' || stepStatus === 'needs_regeneration') && onReset && (
     <Button onClick={onReset} variant="ghost" size="sm" disabled={isNavigating} className="text-muted-foreground hover:text-destructive">
       <RotateCcw className="mr-2 h-4 w-4" />
       Reset
     </Button>
   )}
   ```
4. Restructure the left side to use a flex container with gap-2 that holds both Back and Reset buttons. Keep existing Back button logic.

**In `src/components/workshop/step-container.tsx`:**

Add reset state management and dialog:

1. Import `ResetStepDialog` from `@/components/dialogs/reset-step-dialog.tsx`
2. Import `resetStep` from `@/actions/workshop-actions` (add to existing reviseStep import)
3. Import `getStepByOrder` at the top level (currently imported dynamically inside callbacks — keep the dynamic import in extractArtifact and handleRevise, but add a top-level import for use in JSX rendering)
4. Add state: `const [showResetDialog, setShowResetDialog] = React.useState(false)` and `const [isResetting, setIsResetting] = React.useState(false)`
5. Add `handleReset` callback:
   ```typescript
   const handleReset = React.useCallback(async () => {
     try {
       setIsResetting(true);
       const { getStepByOrder } = await import('@/lib/workshop/step-metadata');
       const step = getStepByOrder(stepOrder);
       if (!step) {
         console.error('Step not found for reset');
         return;
       }
       await resetStep(workshopId, step.id, sessionId);
       setShowResetDialog(false);
       // Reset local state
       setArtifact(null);
       setArtifactConfirmed(false);
       setExtractionError(null);
       // Refresh page to reload with cleared state
       router.refresh();
     } catch (error) {
       console.error('Failed to reset step:', error);
     } finally {
       setIsResetting(false);
     }
   }, [workshopId, stepOrder, sessionId, router]);
   ```
6. Pass `onReset={() => setShowResetDialog(true)}` to both `<StepNavigation>` instances (mobile and desktop)
7. Add `<ResetStepDialog>` at the end of both mobile and desktop render blocks (just before closing div):
   ```
   <ResetStepDialog
     open={showResetDialog}
     onOpenChange={setShowResetDialog}
     onConfirm={handleReset}
     isResetting={isResetting}
     stepName={getStepByOrder(stepOrder)?.name || `Step ${stepOrder}`}
   />
   ```
   For the stepName prop, use the top-level `getStepByOrder` import.
8. Only render one ResetStepDialog instance (outside the mobile/desktop conditional), so move it to after the mobile/desktop ternary but inside the outer div. This avoids duplicating the dialog.
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit` passes
- Run `npm run build` to confirm no build errors
- In the running app: navigate to any in-progress step and verify "Reset" button appears in the navigation bar
- Click "Reset" and verify confirmation dialog appears with step name and destructive button
  </verify>
  <done>
Reset Step button visible on in-progress/needs_regeneration steps. Clicking it shows confirmation dialog. Confirming calls resetStep server action, clears local state, and refreshes page. Downstream steps cascade-invalidated.
  </done>
</task>

</tasks>

<verification>
1. Navigate to any in-progress step — "Reset" button should appear in the navigation bar (left side, ghost variant)
2. Click "Reset" — confirmation dialog appears: "Reset [Step Name]?" with description about clearing data
3. Click "Cancel" — dialog closes, no changes
4. Click "Reset Step" — dialog shows "Resetting..." loading state, then:
   - Chat panel clears (messages deleted from DB)
   - Output panel clears (artifact deleted)
   - Step status resets to in_progress with orient arc phase
   - AI auto-starts fresh conversation
5. Navigate to a downstream step — should show needs_regeneration status (amber indicators)
6. On completed steps, "Revise This Step" button still works as before (unchanged)
7. Build passes: `npm run build` succeeds
</verification>

<success_criteria>
- resetStep server action deletes messages, artifact, summary for current step then cascade-invalidates
- ResetStepDialog shows confirmation with step name and destructive button with loading state
- Reset button appears on in-progress and needs_regeneration steps
- After reset, step re-enters fresh state with AI auto-starting
- Downstream steps marked needs_regeneration
- No regressions to existing Revise This Step functionality
</success_criteria>

<output>
After completion, create `.planning/phases/13.1-reset-step-step-8-ideation-sub-steps/13.1-01-SUMMARY.md`
</output>
