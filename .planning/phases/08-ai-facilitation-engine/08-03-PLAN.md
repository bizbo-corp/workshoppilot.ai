---
phase: 08-ai-facilitation-engine
plan: 03
type: execute
wave: 2
depends_on: ["08-01", "08-02"]
files_modified:
  - src/lib/ai/chat-config.ts
  - src/app/api/chat/route.ts
autonomous: true

must_haves:
  truths:
    - "AI system prompt includes step-specific instructions for the current step"
    - "AI system prompt includes arc phase behavioral instructions matching tracked phase"
    - "AI system prompt includes validation criteria during Validate arc phase"
    - "Chat API reads arc phase from database and injects it into system prompt"
    - "AI references prior step outputs by name in conversation context"
  artifacts:
    - path: "src/lib/ai/chat-config.ts"
      provides: "Enhanced buildStepSystemPrompt with arc phase and step instructions"
      exports: ["buildStepSystemPrompt"]
      min_lines: 40
    - path: "src/app/api/chat/route.ts"
      provides: "Chat API wired to arc phase tracking and step-specific prompts"
      min_lines: 50
  key_links:
    - from: "src/app/api/chat/route.ts"
      to: "src/lib/ai/conversation-state.ts"
      via: "getCurrentArcPhase call before building prompt"
      pattern: "getCurrentArcPhase"
    - from: "src/lib/ai/chat-config.ts"
      to: "src/lib/ai/prompts/step-prompts.ts"
      via: "getStepSpecificInstructions call in prompt builder"
      pattern: "getStepSpecificInstructions"
    - from: "src/lib/ai/chat-config.ts"
      to: "src/lib/ai/prompts/arc-phases.ts"
      via: "getArcPhaseInstructions call in prompt builder"
      pattern: "getArcPhaseInstructions"
    - from: "src/lib/ai/chat-config.ts"
      to: "src/lib/ai/prompts/validation-criteria.ts"
      via: "getValidationCriteria injected during validate phase"
      pattern: "getValidationCriteria"
    - from: "src/app/api/chat/route.ts"
      to: "src/lib/ai/chat-config.ts"
      via: "buildStepSystemPrompt with arcPhase parameter"
      pattern: "buildStepSystemPrompt.*arcPhase"
---

<objective>
Wire step-specific prompts, arc phase tracking, and validation criteria into the chat API so every AI response is step-aware and arc-phase-aware.

Purpose: This is the integration layer that connects the prompt content (Plan 01) and state tracking (Plan 02) into the existing chat API. After this plan, every chat message will include step-specific instructions, current arc phase guidance, and (during Validate phase) quality criteria in the system prompt.

Output: Updated chat-config.ts and route.ts that produce step-aware, arc-phase-aware AI responses.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-ai-facilitation-engine/08-RESEARCH.md
@.planning/phases/08-ai-facilitation-engine/08-01-SUMMARY.md
@.planning/phases/08-ai-facilitation-engine/08-02-SUMMARY.md
@src/lib/ai/chat-config.ts
@src/app/api/chat/route.ts
@src/lib/ai/prompts/step-prompts.ts
@src/lib/ai/prompts/arc-phases.ts
@src/lib/ai/prompts/validation-criteria.ts
@src/lib/ai/conversation-state.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance buildStepSystemPrompt with arc phase and step-specific instructions</name>
  <files>src/lib/ai/chat-config.ts</files>
  <action>
Update `src/lib/ai/chat-config.ts` to integrate step-specific prompts, arc phase instructions, and validation criteria:

1. Add imports:
   - `import { getStepSpecificInstructions } from './prompts/step-prompts'`
   - `import { getArcPhaseInstructions, type ArcPhase } from './prompts/arc-phases'`
   - `import { getValidationCriteria } from './prompts/validation-criteria'`

2. Update `buildStepSystemPrompt` signature to accept `arcPhase: ArcPhase` as third parameter (after stepName, before persistentContext):
   ```
   buildStepSystemPrompt(stepId, stepName, arcPhase, persistentContext, summaries)
   ```

3. Restructure the prompt assembly:
   - Start with role: "You are an AI design thinking facilitator guiding the user through Step: {stepName}."
   - Add arc phase instructions from getArcPhaseInstructions(arcPhase) under a "CURRENT PHASE" header
   - Add step-specific instructions from getStepSpecificInstructions(stepId) under a "STEP INSTRUCTIONS" header
   - If arcPhase is 'validate', inject validation criteria from getValidationCriteria(stepId) formatted as a checklist under "VALIDATION CRITERIA" header. Format each criterion as: "- {name}: {checkPrompt}"
   - Keep existing persistent context (Tier 1) and summaries (Tier 2) injection logic unchanged
   - Keep existing CONTEXT USAGE RULES unchanged
   - Add general behavioral guidance: "Be encouraging, ask probing questions, and help them think deeply. Keep responses concise and actionable. Ask one question at a time during Gather phase."

4. Keep GENERIC_SYSTEM_PROMPT export as-is (still used as fallback)

5. Re-export ArcPhase type from this module for convenience: `export type { ArcPhase } from './prompts/arc-phases'`
  </action>
  <verify>
`npx tsc --noEmit` passes. Grep confirms buildStepSystemPrompt now accepts 5 parameters (stepId, stepName, arcPhase, persistentContext, summaries). Grep confirms imports from all three prompt modules.
  </verify>
  <done>
buildStepSystemPrompt produces system prompts that include step-specific instructions, arc phase guidance, and (during validate phase) quality criteria. Existing context injection is preserved.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire arc phase into chat API route</name>
  <files>src/app/api/chat/route.ts</files>
  <action>
Update `src/app/api/chat/route.ts` to read arc phase from database and pass it to the system prompt builder:

1. Add import: `import { getCurrentArcPhase } from '@/lib/ai/conversation-state'`

2. After the existing `assembleStepContext` call, add arc phase retrieval:
   ```
   const arcPhase = await getCurrentArcPhase(workshopId, stepId);
   ```

3. Update the `buildStepSystemPrompt` call to pass `arcPhase` as the third parameter:
   ```
   const systemPrompt = buildStepSystemPrompt(
     stepId,
     stepName,
     arcPhase,
     stepContext.persistentContext,
     stepContext.summaries
   );
   ```

4. Keep everything else unchanged: streaming, message persistence, error handling, maxDuration.

Note: Arc phase transitions are NOT handled in this plan. The AI will always receive the current arc phase in its system prompt. Phase transitions (when the AI suggests "Ready to see a draft?" and the conversation moves from Gather to Synthesize) will be handled by a future mechanism -- either the client sending a transition request, or the AI detecting it. For now, the system starts at 'orient' and the system prompt reflects that. This is intentional: getting the prompts right is step 1, transitions are step 2 (gap closure or Phase 11+).
  </action>
  <verify>
`npx tsc --noEmit` passes. Grep confirms getCurrentArcPhase is imported and called in route.ts. Grep confirms buildStepSystemPrompt is called with 5 arguments. Run `npm run build` to verify no build errors.
  </verify>
  <done>
Chat API reads arc phase from database, passes it to buildStepSystemPrompt, and produces arc-phase-aware system prompts. Every AI response now includes step-specific instructions and current arc phase guidance.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- `npm run build` succeeds
- Chat API route imports and calls getCurrentArcPhase
- buildStepSystemPrompt accepts arcPhase parameter and injects arc phase instructions
- Validation criteria are injected when arcPhase is 'validate'
- Step-specific instructions are injected for every request
- Existing context injection (persistent artifacts, summaries) is preserved
- GENERIC_SYSTEM_PROMPT still exported as fallback
</verification>

<success_criteria>
- Every chat request produces a system prompt with: step-specific instructions + arc phase guidance + prior context
- Validate phase includes quality criteria checklist in the prompt
- Arc phase is read from database (not hardcoded)
- No regression in existing chat functionality (streaming, persistence, error handling)
- Build completes successfully
</success_criteria>

<output>
After completion, create `.planning/phases/08-ai-facilitation-engine/08-03-SUMMARY.md`
</output>
