---
phase: 40-production-auth
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/layout/landing-header.tsx
  - src/components/layout/header.tsx
  - src/components/auth/sign-in-modal.tsx
  - src/components/auth/sign-up-modal.tsx
  - src/components/auth/auth-wall-modal.tsx
  - src/components/auth/auth-guard.tsx
  - src/components/dashboard/dashboard-header.tsx
  - src/proxy.ts
  - src/app/layout.tsx
  - src/app/globals.css
  - src/app/dashboard/page.tsx
autonomous: true
requirements: [AUTH-01, AUTH-02, AUTH-04]

user_setup:
  - service: clerk
    why: "Production domain configuration for workshoppilot.ai"
    env_vars:
      - name: NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY
        source: "Clerk Dashboard → workshoppilot.ai instance → API Keys → Publishable key (must be pk_live_*)"
      - name: CLERK_SECRET_KEY
        source: "Clerk Dashboard → workshoppilot.ai instance → API Keys → Secret key (must be sk_live_*)"
    dashboard_config:
      - task: "Uncomment the production Clerk keys in .env.local and comment out the test keys (pk_test_*/sk_test_*), or set production keys in Vercel Dashboard → Environment Variables"
        location: ".env.local or Vercel Dashboard → Settings → Environment Variables"
      - task: "Add workshoppilot.ai as an allowed origin in Clerk Dashboard"
        location: "Clerk Dashboard → workshoppilot.ai instance → Settings → Domains → Allowed origins"
      - task: "Enable email verification in Clerk Dashboard"
        location: "Clerk Dashboard → Configure → Email, phone, username → Email address → Require verification"

must_haves:
  truths:
    - "Sign-in button is visible on the landing page header as a secondary-styled button"
    - "Clicking 'Sign in' opens a Clerk modal overlay styled with olive theme"
    - "The Clerk modal allows both sign-in and sign-up without navigating to a separate page"
    - "After successful sign-in, user is redirected to /dashboard"
    - "When signed in, header shows user avatar/initials linking to dashboard"
    - "Auth errors appear as toast notifications, not inline in the modal"
    - "Protected routes show sign-in modal on the page instead of redirecting away"
  artifacts:
    - path: "src/components/layout/landing-header.tsx"
      provides: "Landing header with single secondary Sign in button and signed-in avatar linking to dashboard"
    - path: "src/components/auth/sign-in-modal.tsx"
      provides: "Olive-themed Clerk modal overlay for sign-in/sign-up"
    - path: "src/proxy.ts"
      provides: "Middleware with correct public/protected route configuration"
    - path: "src/app/layout.tsx"
      provides: "ClerkProvider with olive appearance theme and afterSignIn redirect"
    - path: "src/components/auth/auth-guard.tsx"
      provides: "Client-side auth guard that shows SignInModal on protected pages when unauthenticated"
  key_links:
    - from: "src/components/layout/landing-header.tsx"
      to: "src/components/auth/sign-in-modal.tsx"
      via: "onClick opens modal"
      pattern: "setShowSignIn\\(true\\)"
    - from: "src/app/layout.tsx"
      to: "@clerk/nextjs ClerkProvider"
      via: "appearance prop"
      pattern: "appearance.*variables"
    - from: "src/components/auth/auth-guard.tsx"
      to: "src/components/auth/sign-in-modal.tsx"
      via: "renders SignInModal when !userId"
      pattern: "useAuth.*SignInModal"
---

<objective>
Fix production sign-in visibility and configure Clerk for the workshoppilot.ai domain. Restyle the sign-in button as secondary, apply olive theming to all Clerk modals, add toast error handling for auth failures, and update protected route behavior to show the sign-in modal in-place.

Purpose: Production sign-in is currently broken — users cannot sign in on workshoppilot.ai. This plan makes auth functional and visually native to the olive theme.

Output: Working sign-in/sign-up flow via Clerk modal overlay, olive-themed, with toast errors and correct redirect behavior.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-production-auth/40-CONTEXT.md
@src/app/layout.tsx
@src/components/layout/landing-header.tsx
@src/components/layout/header.tsx
@src/components/auth/sign-in-modal.tsx
@src/components/auth/sign-up-modal.tsx
@src/components/auth/auth-wall-modal.tsx
@src/components/dashboard/dashboard-header.tsx
@src/proxy.ts
@src/app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Restyle sign-in entry points and configure Clerk olive appearance</name>
  <files>
    src/components/layout/landing-header.tsx
    src/components/layout/header.tsx
    src/components/dashboard/dashboard-header.tsx
    src/app/layout.tsx
  </files>
  <action>
    **Landing header (landing-header.tsx):**
    - Change the "Sign in" button from `variant="outline"` to a secondary-styled button per user decision: "not high-contrast, blends with the header". Use `variant="ghost"` or a subtle custom style: `text-sm font-medium text-muted-foreground hover:text-foreground transition-colors` (no background, no border — blends into header).
    - **Button-to-modal wiring:** The component already has `useState` for `showSignIn` and imports `SignInModal`. Ensure the sign-in button's `onClick` calls `setShowSignIn(true)`, and `<SignInModal open={showSignIn} onOpenChange={setShowSignIn} />` is rendered at the bottom of the component. Remove the `onSwitchToSignUp` prop from the `<SignInModal>` call (no longer needed — Clerk handles toggle internally). The mobile sheet's sign-in button should also call `setSheetOpen(false); setShowSignIn(true);` (already does in current code — preserve this).
    - When signed in: replace UserButton with a clickable avatar/initials that links to `/dashboard`. Use Clerk's `<UserButton>` but wrap it so the avatar area links to dashboard. Alternatively, show a small avatar circle (from Clerk user image or initials) as a `<Link href="/dashboard">` with a tooltip "Go to Dashboard", and keep `<UserButton>` for the dropdown menu. Per user decision: "show user avatar/initials with a button to go to the dashboard". The simplest approach: keep `<UserButton>` (it has its own dropdown), but ADD a separate "Dashboard" link/button next to it when signed in. The `<SignedIn>` block should show: `<Link href="/dashboard">Dashboard</Link>` styled as a ghost button + `<UserButton />`.
    - Remove the separate `SignUpModal` import and usage — per user decision, single button opens a flow where users can sign in OR create an account (Clerk's `<SignIn>` component already has a "Sign up" link built in when configured). The `onSwitchToSignUp` prop on SignInModal can be removed.
    - The mobile hamburger menu should also show the same single "Sign in" button (not separate sign-up).

    **Header component (header.tsx):**
    - This is the older generic header. Update it to match the same pattern: single secondary "Sign in" button, remove separate sign-up button and modal. When signed in, show Dashboard link + UserButton.

    **Dashboard header (dashboard-header.tsx):**
    - Add "Home" or logo click goes to `/` (already does). No changes needed unless the avatar should also link somewhere — currently has UserButton which is fine.

    **Root layout ClerkProvider (layout.tsx):**
    - Add Clerk `appearance` prop to ClerkProvider to apply olive theming globally to all Clerk components (SignIn, SignUp, UserButton, UserProfile). Use `@clerk/themes` dark theme as base, then override with olive CSS variables:
      ```tsx
      appearance={{
        variables: {
          colorPrimary: '#6b7a2f',        // olive-600
          colorBackground: 'hsl(var(--card))',
          colorText: 'hsl(var(--foreground))',
          colorInputBackground: 'hsl(var(--background))',
          colorInputText: 'hsl(var(--foreground))',
          borderRadius: '0.5rem',
          fontFamily: 'var(--font-geist-sans)',
        },
        elements: {
          card: 'shadow-none',
          formButtonPrimary: 'bg-primary hover:bg-primary/90 text-primary-foreground',
          footerActionLink: 'text-primary hover:text-primary/80',
          identityPreviewEditButton: 'text-primary',
        },
      }}
      ```
    - Keep `signInFallbackRedirectUrl="/dashboard"` and `signUpFallbackRedirectUrl="/dashboard"` (already present).
  </action>
  <verify>
    Run `npx next build` to check for compile errors. Visually inspect that landing-header renders a single subtle "Sign in" button. Check that ClerkProvider has appearance prop with olive variables.
  </verify>
  <done>
    Landing header shows a single secondary "Sign in" button. When signed in, shows Dashboard link + avatar. Root layout ClerkProvider applies olive theming to all Clerk UI. No separate sign-up button exists.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rebuild sign-in modal as unified olive-themed Clerk overlay with toast errors</name>
  <files>
    src/components/auth/sign-in-modal.tsx
    src/components/auth/sign-up-modal.tsx
    src/components/auth/auth-wall-modal.tsx
    src/components/auth/auth-guard.tsx
    src/proxy.ts
    src/app/dashboard/page.tsx
  </files>
  <action>
    **Sign-in modal (sign-in-modal.tsx):**
    - Rebuild as a unified auth modal. Use Clerk's `<SignIn>` component which already includes "Don't have an account? Sign up" link (Clerk handles the toggle internally when using `routing="hash"`).
    - Remove the `onSwitchToSignUp` prop — Clerk's built-in UI handles the sign-in/sign-up toggle.
    - Keep the modal overlay pattern (fixed inset-0, z-50, backdrop) but enhance:
      - Backdrop: `bg-black/50 backdrop-blur-sm` for a frosted glass feel.
      - Modal card: `bg-card rounded-xl shadow-2xl` with olive border: `border border-border`.
      - Close button: use X icon from lucide-react instead of inline SVG.
    - The Clerk `<SignIn>` appearance should inherit from the global ClerkProvider appearance (set in Task 1), so no additional appearance prop needed here — just keep `routing="hash"` and `fallbackRedirectUrl="/dashboard"`.
    - **Toast errors instead of inline errors (per user decision):** Suppress Clerk's built-in inline validation errors and surface them as toasts. Apply these Clerk appearance element overrides to hide inline error UI:
      ```tsx
      appearance={{
        elements: {
          rootBox: 'w-full',
          card: 'shadow-none border-0',
          formFieldErrorText: 'sr-only',
          alert: 'sr-only',
          alertText: 'sr-only',
        },
      }}
      ```
      Then add a MutationObserver inside the modal that watches the Clerk form container for error text elements (`.cl-formFieldErrorText`, `.cl-alert`). When error text content changes (i.e., Clerk injects an error message), read the `textContent` from the sr-only element and call `toast.error(textContent)` from sonner. Implementation:
      ```tsx
      const formRef = useRef<HTMLDivElement>(null);
      useEffect(() => {
        if (!open || !formRef.current) return;
        const observer = new MutationObserver((mutations) => {
          for (const mutation of mutations) {
            if (mutation.type === 'childList' || mutation.type === 'characterData') {
              const errorEls = formRef.current?.querySelectorAll(
                '.cl-formFieldErrorText, .cl-alert__text'
              );
              errorEls?.forEach((el) => {
                const text = el.textContent?.trim();
                if (text) toast.error(text);
              });
            }
          }
        });
        observer.observe(formRef.current, {
          childList: true, subtree: true, characterData: true
        });
        return () => observer.disconnect();
      }, [open]);
      ```
      Wrap the `<SignIn>` component in a `<div ref={formRef}>`. Also wrap the entire `<SignIn>` in a React error boundary that catches render/network errors and shows `toast.error('Something went wrong. Please try again.')`.

    **Sign-up modal (sign-up-modal.tsx):**
    - This file can be simplified since Clerk's SignIn component includes sign-up navigation. Keep the file but update it to match the same olive-themed modal pattern as sign-in-modal for cases where it's still imported directly. Apply the same styling changes (backdrop blur, rounded-xl, border-border, lucide X icon).
    - Remove `onSwitchToSignIn` prop — Clerk handles this internally.

    **Auth wall modal (auth-wall-modal.tsx):**
    - Update to match olive theme — replace the current two-column layout's `<SignUp>` with `<SignIn>` (per decision: single flow where users can sign in OR create an account). The left column's step preview content is fine; update the right column to use `<SignIn routing="hash" fallbackRedirectUrl="/dashboard" />`.
    - Apply same olive styling (border-border, rounded-xl).

    **Proxy/middleware (proxy.ts):**
    - The current protected route handler redirects to `/` when not authenticated. Per user decision: "show sign-in modal on that page (not redirect to landing)". Change the protected route behavior: for protected PAGE routes, let the request through (`NextResponse.next()`) so the page component renders and the client-side AuthGuard shows the sign-in modal. For protected API routes, return 401.
    - Update the protected route logic:
      ```typescript
      if (isProtectedRoute(req) && !userId) {
        const isApiRoute = pathname.startsWith('/api/');
        if (isApiRoute) {
          return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
        }
        // For page routes, let through — AuthGuard will show sign-in modal
        return NextResponse.next();
      }
      ```

    **AuthGuard component (auth-guard.tsx) — NEW FILE:**
    - Create a client-side auth guard component that wraps protected page content. Uses Clerk's `useAuth()` hook to detect authentication state. When `!isSignedIn` and `!isLoaded`, show a loading skeleton. When `!isSignedIn` and `isLoaded`, render the `<SignInModal>` full-screen (no close button variant, or with close navigating to `/`) instead of the page content. When `isSignedIn`, render `children`.
    - Implementation:
      ```tsx
      'use client';
      import { useAuth } from '@clerk/nextjs';
      import { SignInModal } from './sign-in-modal';

      export function AuthGuard({ children }: { children: React.ReactNode }) {
        const { isSignedIn, isLoaded } = useAuth();

        if (!isLoaded) {
          return <div className="flex h-screen items-center justify-center">
            <div className="animate-pulse text-muted-foreground">Loading...</div>
          </div>;
        }

        if (!isSignedIn) {
          return <SignInModal open={true} onOpenChange={() => {}} />;
        }

        return <>{children}</>;
      }
      ```

    **Dashboard page (src/app/dashboard/page.tsx):**
    - The dashboard is a server component that currently does `if (!userId) { redirect('/'); }`. Since middleware now lets unauthenticated page requests through, this server-side `redirect('/')` must be replaced. Convert the auth check portion: remove the `redirect('/')` call when `!userId`. Instead, when `!userId`, return a client component wrapper that renders the AuthGuard with a message or just the sign-in modal. The simplest approach: when `!userId`, return `<AuthGuardPage />` — a small client component that imports and renders `<AuthGuard>` with a placeholder message like "Sign in to access your dashboard". The rest of the dashboard (data fetching, workshop list) remains unchanged inside the `userId` branch.
  </action>
  <verify>
    Run `npx next build` to verify no compile errors. Check that sign-in-modal renders with olive-themed Clerk component. Check that proxy.ts correctly separates API vs page route handling (API returns 401, page routes pass through). Check that auth-guard.tsx exists and exports AuthGuard. Check that dashboard page shows sign-in modal when unauthenticated instead of redirecting.
  </verify>
  <done>
    Sign-in modal uses unified Clerk `<SignIn>` with olive theming inherited from ClerkProvider, inline errors suppressed and surfaced as sonner toasts via MutationObserver. Sign-up modal and auth-wall modal updated to match. Proxy differentiates API routes (401) from page routes (pass through). AuthGuard component shows sign-in modal on protected pages for unauthenticated users. Dashboard page uses AuthGuard instead of redirecting. Close button uses lucide-react X icon.
  </done>
</task>

</tasks>

<verification>
1. `npx next build` completes without errors
2. Landing page header shows a single, secondary-styled "Sign in" button
3. Clicking "Sign in" opens a Clerk modal overlay with olive theming (no white/blue Clerk default styling visible)
4. The modal supports both sign-in and sign-up (Clerk handles toggle internally)
5. After successful sign-in, user lands on /dashboard
6. When signed in, header shows Dashboard link and user avatar
7. Clerk components (UserButton, SignIn) use olive color palette
8. Navigating to /dashboard while unauthenticated shows the sign-in modal on that page (no redirect to /)
9. Auth validation errors (wrong password, etc.) appear as sonner toasts, not inline in the Clerk form
10. Protected API routes return 401 when unauthenticated (not redirect)
</verification>

<success_criteria>
- Sign-in button is visible and styled as secondary on the production landing page
- Clerk modal overlay opens for auth (not a separate page)
- All Clerk UI surfaces (SignIn, SignUp, UserButton) use olive theme variables
- Auth flow redirects to /dashboard on success
- No separate "Sign up" button — single entry point handles both flows
- Protected pages show sign-in modal in-place when unauthenticated (no redirect away)
- Auth errors surface as toast notifications, not inline in the Clerk modal
</success_criteria>

<output>
After completion, create `.planning/phases/40-production-auth/40-01-SUMMARY.md`
</output>
