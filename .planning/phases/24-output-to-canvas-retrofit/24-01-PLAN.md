---
phase: 24-output-to-canvas-retrofit
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/canvas/ring-layout.ts
  - src/lib/canvas/empathy-zones.ts
  - src/lib/canvas/step-canvas-config.ts
  - src/lib/canvas/canvas-position.ts
  - src/lib/canvas/migration-helpers.ts
autonomous: true

must_haves:
  truths:
    - "Ring layout distributes cards evenly around concentric circles at specified radii"
    - "Empathy zone layout distributes cards in tidy grid within 6 rectangular zones"
    - "Zone detection correctly identifies which ring or empathy zone a position falls into"
    - "Step canvas config declares ring config for stakeholder-mapping and empathy zone config for sense-making"
    - "Canvas position computation handles ring-based and empathy-zone-based placement for new items"
    - "Migration helpers convert stakeholder artifacts to ring-assigned post-its and empathy artifacts to zone-assigned post-its"
  artifacts:
    - path: "src/lib/canvas/ring-layout.ts"
      provides: "RingConfig type, distributeCardsOnRing(), detectRing() functions"
      exports: ["RingConfig", "distributeCardsOnRing", "detectRing"]
    - path: "src/lib/canvas/empathy-zones.ts"
      provides: "EmpathyZone type, EmpathyZoneConfig type, getZoneForPosition(), distributeCardsInZone() functions"
      exports: ["EmpathyZone", "EmpathyZoneConfig", "getZoneForPosition", "distributeCardsInZone"]
    - path: "src/lib/canvas/step-canvas-config.ts"
      provides: "Extended StepCanvasConfig with hasRings/hasEmpathyZones/ringConfig/empathyZoneConfig"
      contains: "hasRings"
    - path: "src/lib/canvas/canvas-position.ts"
      provides: "Updated computeCanvasPosition with ring and empathy-zone branches"
      contains: "distributeCardsOnRing"
    - path: "src/lib/canvas/migration-helpers.ts"
      provides: "migrateStakeholdersToCanvas(), migrateEmpathyToCanvas() functions"
      exports: ["migrateStakeholdersToCanvas", "migrateEmpathyToCanvas"]
  key_links:
    - from: "src/lib/canvas/step-canvas-config.ts"
      to: "src/lib/canvas/ring-layout.ts"
      via: "import RingConfig type"
      pattern: "import.*RingConfig.*ring-layout"
    - from: "src/lib/canvas/step-canvas-config.ts"
      to: "src/lib/canvas/empathy-zones.ts"
      via: "import EmpathyZoneConfig type"
      pattern: "import.*EmpathyZoneConfig.*empathy-zones"
    - from: "src/lib/canvas/canvas-position.ts"
      to: "src/lib/canvas/ring-layout.ts"
      via: "uses distributeCardsOnRing for ring-based placement"
      pattern: "distributeCardsOnRing"
    - from: "src/lib/canvas/migration-helpers.ts"
      to: "src/lib/canvas/ring-layout.ts"
      via: "uses distributeCardsOnRing for stakeholder migration"
      pattern: "distributeCardsOnRing"
---

<objective>
Create spatial layout types, zone detection algorithms, canvas position extensions, and migration helpers for concentric rings (Step 2) and empathy map zones (Step 4).

Purpose: Establish the pure-function data layer that all UI components depend on. Ring layout computes radial card distribution. Empathy zones define 6-region rectangular layout. Migration helpers convert existing artifact data to canvas post-its with correct zone assignments.

Output: 5 TypeScript modules (2 new layout files, 1 updated config, 1 updated position, 1 new migration helper)
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-output-to-canvas-retrofit/24-RESEARCH.md

@src/lib/canvas/step-canvas-config.ts
@src/lib/canvas/canvas-position.ts
@src/lib/canvas/grid-layout.ts
@src/lib/canvas/quadrant-detection.ts
@src/lib/schemas/step-schemas.ts
@src/stores/canvas-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ring layout and empathy zone layout modules, update step canvas config</name>
  <files>
    src/lib/canvas/ring-layout.ts
    src/lib/canvas/empathy-zones.ts
    src/lib/canvas/step-canvas-config.ts
  </files>
  <action>
    **Create `src/lib/canvas/ring-layout.ts`** (new file):

    Define `RingConfig` type:
    ```typescript
    type RingConfig = {
      rings: Array<{ id: string; label?: string; radius: number; color: string }>;
      center: { x: number; y: number };
    };
    ```

    Implement `distributeCardsOnRing(cardCount: number, ringRadius: number, center: {x,y})`:
    - Distribute positions evenly around circumference using `2*PI / cardCount` angle stepping
    - Start from top (angle = -PI/2) for visual balance
    - Return array of {x, y} positions (card centers, not top-left corners)
    - Offset by half POST_IT_WIDTH and POST_IT_HEIGHT for top-left corner placement
    - Handle cardCount=0 gracefully (return empty array)

    Implement `detectRing(position: {x,y}, config: RingConfig)`:
    - Calculate Euclidean distance from position center to ring center
    - Return ring ID for the ring whose radius boundary contains the distance
    - Rings are ordered inner-to-outer; a position belongs to a ring if distance < ring.radius AND distance >= previous ring radius (or 0 for innermost)
    - Return 'outer' (last ring) if distance exceeds all ring radii (forgiving fallback)
    - Return 'inner' (first ring) if distance is 0 or very small

    **Create `src/lib/canvas/empathy-zones.ts`** (new file):

    Define types:
    ```typescript
    type EmpathyZone = 'says' | 'thinks' | 'feels' | 'does' | 'pains' | 'gains';
    type EmpathyZoneConfig = {
      zones: Record<EmpathyZone, {
        bounds: { x: number; y: number; width: number; height: number };
        label: string;
        color: string;
      }>;
    };
    ```

    Implement `getZoneForPosition(position: {x,y}, config: EmpathyZoneConfig)`:
    - Use card center point for detection
    - Simple rectangular bounds check: x >= bounds.x && x < bounds.x + bounds.width, same for y
    - Return zone key or null if outside all zones

    Implement `distributeCardsInZone(cardCount, zoneBounds, cardSize, padding)`:
    - Calculate max columns that fit: `floor((zoneBounds.width - 2*padding) / (cardSize.width + padding))`
    - Offset from zone top-left by padding + zone label header height (40px reserved)
    - Layout cards in rows, left-to-right then top-to-bottom
    - Return array of {x, y} positions for top-left corner of each card

    **Update `src/lib/canvas/step-canvas-config.ts`**:

    Extend `StepCanvasConfig` type with:
    ```typescript
    hasRings?: boolean;
    hasEmpathyZones?: boolean;
    ringConfig?: RingConfig;
    empathyZoneConfig?: EmpathyZoneConfig;
    ```

    Import `RingConfig` from `./ring-layout` and `EmpathyZoneConfig` from `./empathy-zones`.

    **Replace** the `stakeholder-mapping` config entry:
    - Set `hasQuadrants: false`, `hasRings: true`
    - Define `ringConfig` with 3 rings:
      - inner: `{ id: 'inner', label: 'Most Important', radius: 320, color: '#3b82f6' }` (blue)
      - middle: `{ id: 'middle', radius: 520, color: '#8b5cf6' }` (purple)
      - outer: `{ id: 'outer', radius: 720, color: '#6366f1' }` (indigo)
    - center: `{ x: 0, y: 0 }` (canvas origin, like existing quadrant center)
    - Remove old quadrantConfig and quadrantType

    **Replace** the `sense-making` config entry:
    - Set `hasQuadrants: false`, `hasEmpathyZones: true`
    - Define `empathyZoneConfig` with 6 zones (classic empathy map layout):
      - 4 quadrants occupy top area (~800px wide x 400px tall total), gap between them:
        - `says`:   `{ bounds: { x: -420, y: -350, width: 400, height: 330 }, label: 'Says',   color: '#94a3b8' }` (slate)
        - `thinks`: `{ bounds: { x: -420, y: -700, width: 400, height: 330 }, label: 'Thinks', color: '#a1a1aa' }` (zinc)
        - `feels`:  `{ bounds: { x:   20, y: -700, width: 400, height: 330 }, label: 'Feels',  color: '#a3a3a3' }` (neutral)
        - `does`:   `{ bounds: { x:   20, y: -350, width: 400, height: 330 }, label: 'Does',   color: '#9ca3af' }` (gray)
      - 2 horizontal strips below:
        - `pains`:  `{ bounds: { x: -420, y:    0, width: 840, height: 250 }, label: 'Pains',  color: '#f87171' }` (warm red)
        - `gains`:  `{ bounds: { x: -420, y:  270, width: 840, height: 250 }, label: 'Gains',  color: '#34d399' }` (cool green)
    - Remove old quadrantConfig and quadrantType

    Keep `journey-mapping` config unchanged.
  </action>
  <verify>
    Run `npx tsc --noEmit` — no type errors in new or modified files. Verify `getStepCanvasConfig('stakeholder-mapping').hasRings === true` and `getStepCanvasConfig('sense-making').hasEmpathyZones === true` by inspecting the code.
  </verify>
  <done>
    ring-layout.ts exports RingConfig, distributeCardsOnRing, detectRing. empathy-zones.ts exports EmpathyZone, EmpathyZoneConfig, getZoneForPosition, distributeCardsInZone. step-canvas-config.ts uses new layout types for stakeholder-mapping and sense-making entries. TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend canvas-position.ts for ring/zone placement and create migration helpers</name>
  <files>
    src/lib/canvas/canvas-position.ts
    src/lib/canvas/migration-helpers.ts
  </files>
  <action>
    **Update `src/lib/canvas/canvas-position.ts`**:

    Import new modules:
    ```typescript
    import { distributeCardsOnRing, type RingConfig } from './ring-layout';
    import { distributeCardsInZone, type EmpathyZoneConfig, type EmpathyZone } from './empathy-zones';
    ```

    Add two new branches to `computeCanvasPosition()` before the existing quadrant branch:

    **Ring-based branch** (for Step 2 with `metadata.quadrant` containing ring ID like 'inner', 'middle', 'outer'):
    - Get ringConfig from `STEP_CANVAS_CONFIGS['stakeholder-mapping']`
    - Find the ring matching `metadata.quadrant` (which reuses the quadrant field to carry ring ID)
    - Count existing postIts in same ring: `existingPostIts.filter(p => p.cellAssignment?.row === metadata.quadrant)`
    - Call `distributeCardsOnRing(sameRingCount + 1, ring.radius, ringConfig.center)` to get positions
    - Use the last position (for the new card)
    - Return `{ position, cellAssignment: { row: metadata.quadrant, col: '' } }`
    - Detect ring-based step by checking `STEP_CANVAS_CONFIGS[stepId]?.hasRings`

    **Empathy zone branch** (for Step 4 with `metadata.quadrant` containing zone ID like 'says', 'thinks', 'feels', 'does', 'pains', 'gains'):
    - Get empathyZoneConfig from `STEP_CANVAS_CONFIGS['sense-making']`
    - Find the zone matching `metadata.quadrant`
    - Count existing postIts in same zone: `existingPostIts.filter(p => p.cellAssignment?.row === metadata.quadrant)`
    - Call `distributeCardsInZone(sameZoneCount + 1, zone.bounds, { width: POST_IT_WIDTH, height: POST_IT_HEIGHT }, 15)` to get positions
    - Use the last position
    - Return `{ position, cellAssignment: { row: metadata.quadrant, col: '' } }`
    - Detect empathy-zone step by checking `STEP_CANVAS_CONFIGS[stepId]?.hasEmpathyZones`

    **Important:** These new branches must be checked BEFORE the existing `QUADRANT_BASES` branch since stakeholder-mapping and sense-making previously had quadrant configs. The new branches take priority for these steps.

    Add a color helper for empathy zone cards:
    ```typescript
    export const ZONE_COLORS: Record<string, PostItColor> = {
      pains: 'pink',
      gains: 'green',
      // Other zones use default 'yellow'
    };
    ```
    Import `PostItColor` from canvas-store.

    **Create `src/lib/canvas/migration-helpers.ts`** (new file):

    Import types from step-schemas, ring-layout, empathy-zones, canvas-position, and step-canvas-config.

    Implement `migrateStakeholdersToCanvas(artifact: Record<string, unknown>)`:
    - Cast artifact to `StakeholderArtifact` shape (with stakeholders array)
    - Calculate importance score for each stakeholder: `power === 'high' ? 3 : power === 'medium' ? 2 : 1` + same for interest. Range: 2-6.
    - Assign rings: importance >= 5 = 'inner', importance >= 3 = 'middle', else 'outer'
    - For each ring group, call `distributeCardsOnRing()` to get positions
    - Return array of `Omit<PostIt, 'id'>` objects with: text (stakeholder name + optional notes), position, width=POST_IT_WIDTH, height=POST_IT_HEIGHT, color='yellow', cellAssignment: { row: ringId, col: '' }

    Implement `migrateEmpathyToCanvas(artifact: Record<string, unknown>)`:
    - Cast artifact to `SenseMakingArtifact` shape (with themes, pains, gains arrays)
    - Distribute themes across 4 quadrant zones (says, thinks, feels, does) round-robin
    - Each theme's evidence items become individual cards in the assigned zone
    - Map pains array items to 'pains' zone
    - Map gains array items to 'gains' zone
    - For each zone group, call `distributeCardsInZone()` to get positions
    - Return array of `Omit<PostIt, 'id'>` objects with: text, position, width=POST_IT_WIDTH, height=POST_IT_HEIGHT, color (pink for pains, green for gains, yellow for others), cellAssignment: { row: zoneId, col: '' }

    Both functions should be pure (no side effects), take artifact data and return post-it arrays. They are called at the page/container level.
  </action>
  <verify>
    Run `npx tsc --noEmit` — no type errors. Verify that `computeCanvasPosition('stakeholder-mapping', { quadrant: 'inner' }, [])` returns a position with cellAssignment.row === 'inner'. Verify that `migrateStakeholdersToCanvas({ stakeholders: [{ name: 'User', power: 'high', interest: 'high', category: 'core' }] })` returns a non-empty array.
  </verify>
  <done>
    canvas-position.ts handles ring-based and empathy-zone-based placement. migration-helpers.ts exports migrateStakeholdersToCanvas and migrateEmpathyToCanvas that convert artifact data to positioned post-it arrays. TypeScript compiles without errors.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. New files exist: `src/lib/canvas/ring-layout.ts`, `src/lib/canvas/empathy-zones.ts`, `src/lib/canvas/migration-helpers.ts`
3. `step-canvas-config.ts` has `hasRings: true` for stakeholder-mapping and `hasEmpathyZones: true` for sense-making
4. `canvas-position.ts` handles ring and empathy-zone branches
5. Migration helpers produce valid PostIt arrays from artifact data
</verification>

<success_criteria>
- All 5 TypeScript modules compile without errors
- Ring distribution produces evenly-spaced radial positions
- Empathy zone distribution produces tidy grid positions within zone bounds
- Migration helpers correctly map stakeholder importance to rings and empathy categories to zones
- Existing journey-mapping grid config unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/24-output-to-canvas-retrofit/24-01-SUMMARY.md`
</output>
