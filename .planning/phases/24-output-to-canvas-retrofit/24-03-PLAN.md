---
phase: 24-output-to-canvas-retrofit
plan: 03
type: execute
wave: 3
depends_on: ["24-01", "24-02"]
files_modified:
  - src/components/workshop/step-container.tsx
  - src/components/workshop/right-panel.tsx
  - src/app/workshop/[sessionId]/step/[stepId]/page.tsx
  - src/components/workshop/chat-panel.tsx
autonomous: true

must_haves:
  truths:
    - "Step 2 displays split-screen with chat left and canvas-only right (no output panel)"
    - "Step 4 displays split-screen with chat left and canvas-only right (no output panel)"
    - "Existing workshops with stakeholder artifact data but no canvas state auto-migrate to ring-positioned post-its on page load"
    - "Existing workshops with empathy artifact data but no canvas state auto-migrate to zone-positioned post-its on page load"
    - "AI 'Add to Whiteboard' button in chat places cards at correct ring/zone positions for Steps 2 & 4"
    - "Auto-zoom to fit after card placement from Add to Whiteboard"
    - "Canvas positions persist lazily — only written to DB after first user interaction (drag, add)"
    - "Steps 1, 3, 5, 7-10 remain unchanged with output panels"
    - "Step 6 Journey Mapping remains unchanged"
  artifacts:
    - path: "src/components/workshop/step-container.tsx"
      provides: "Canvas-only rendering path for Steps 2 & 4 (no output panel, no Extract Output button)"
      contains: "CANVAS_ONLY_STEPS"
    - path: "src/app/workshop/[sessionId]/step/[stepId]/page.tsx"
      provides: "Lazy migration — detect artifact without canvas, seed initial positions, pass to CanvasStoreProvider"
      contains: "migrateStakeholdersToCanvas"
    - path: "src/components/workshop/chat-panel.tsx"
      provides: "Correct ring/zone-aware Add to Whiteboard for Steps 2 & 4"
      contains: "ZONE_COLORS"
  key_links:
    - from: "src/app/workshop/[sessionId]/step/[stepId]/page.tsx"
      to: "src/lib/canvas/migration-helpers.ts"
      via: "import and call migrateStakeholdersToCanvas/migrateEmpathyToCanvas"
      pattern: "migrateStakeholdersToCanvas|migrateEmpathyToCanvas"
    - from: "src/components/workshop/step-container.tsx"
      to: "src/components/canvas/canvas-wrapper.tsx"
      via: "render CanvasWrapper directly for canvas-only steps"
      pattern: "CANVAS_ONLY_STEPS.*CanvasWrapper"
    - from: "src/components/workshop/chat-panel.tsx"
      to: "src/lib/canvas/canvas-position.ts"
      via: "computeCanvasPosition with ring/zone metadata"
      pattern: "computeCanvasPosition"
---

<objective>
Retrofit step container to render canvas-only layout for Steps 2 & 4 (removing output panel), implement lazy migration of existing artifact data to canvas positions at the page level, and update the Add to Whiteboard flow to work with ring/zone placement.

Purpose: Complete the user-facing integration. Users see the canvas as the primary interface for Steps 2 & 4, existing data migrates silently, and the AI chat panel works seamlessly with the new spatial layouts.

Output: 4 updated files completing the canvas-first retrofit for Steps 2 & 4
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/24-output-to-canvas-retrofit/24-RESEARCH.md
@.planning/phases/24-output-to-canvas-retrofit/24-01-SUMMARY.md
@.planning/phases/24-output-to-canvas-retrofit/24-02-SUMMARY.md

@src/components/workshop/step-container.tsx
@src/components/workshop/right-panel.tsx
@src/components/workshop/chat-panel.tsx
@src/app/workshop/[sessionId]/step/[stepId]/page.tsx
@src/lib/canvas/canvas-position.ts
@src/lib/canvas/migration-helpers.ts
@src/actions/canvas-actions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Retrofit step-container.tsx for canvas-only Steps 2 & 4</name>
  <files>
    src/components/workshop/step-container.tsx
    src/components/workshop/right-panel.tsx
  </files>
  <action>
    **Update `src/components/workshop/step-container.tsx`**:

    Add a new constant for steps that should render canvas-only (no output panel):
    ```typescript
    const CANVAS_ONLY_STEPS = ['stakeholder-mapping', 'sense-making'];
    ```

    Import `CanvasWrapper`:
    ```typescript
    import { CanvasWrapper } from '@/components/canvas/canvas-wrapper';
    ```

    **Modify desktop rendering logic** (the resizable panels section):

    For canvas-only steps, the right panel should render `CanvasWrapper` directly instead of `RightPanel` (which has the output accordion and vertical split). The layout should be: chat left (25%), canvas right (75%) — same proportions as current.

    In the desktop rendering section where `<Panel defaultSize={75} minSize={40}>` wraps `<RightPanel>`, add a conditional:
    ```tsx
    <Panel defaultSize={75} minSize={40}>
      {step && CANVAS_ONLY_STEPS.includes(step.id) ? (
        <div className="h-full relative">
          {/* Collapse button */}
          {!canvasCollapsed && (
            <div className="absolute top-2 right-2 z-10">
              <button
                onClick={() => setCanvasCollapsed(true)}
                className="rounded-md bg-background/80 p-1 text-muted-foreground shadow-sm hover:bg-muted hover:text-foreground transition-colors"
                title="Collapse canvas"
              >
                <PanelRightClose className="h-4 w-4" />
              </button>
            </div>
          )}
          <CanvasWrapper
            sessionId={sessionId}
            stepId={step.id}
            workshopId={workshopId}
          />
        </div>
      ) : (
        <RightPanel
          stepOrder={stepOrder}
          sessionId={sessionId}
          workshopId={workshopId}
          artifact={artifact}
          isExtracting={isExtracting}
          extractionError={extractionError}
          onRetry={extractArtifact}
          artifactConfirmed={effectiveConfirmed}
          onConfirm={handleConfirm}
          onEdit={handleEdit}
          onCollapse={() => setCanvasCollapsed(true)}
        />
      )}
    </Panel>
    ```

    Import `PanelRightClose` from lucide-react (add to existing import if not there).

    Apply the same pattern to the other places where `RightPanel` appears:
    - `chatCollapsed && !canvasCollapsed` section
    - Mobile tab layout (when mobileTab === 'canvas')

    **Hide the "Extract Output" button** for canvas-only steps. The existing conditional `!isCanvasStep && hasEnoughMessages && !artifact && !isExtracting` already hides it for canvas steps since `isCanvasStep` is true. But verify that `CANVAS_ENABLED_STEPS` still includes `stakeholder-mapping` and `sense-making` — if not, add them.

    **The `effectiveConfirmed` logic** already handles canvas steps: `isCanvasStep ? canvasHasContent : artifactConfirmed`. This is correct — for canvas-only steps, the step is "confirmed" when post-its exist on canvas.

    **Do NOT modify `right-panel.tsx`** unless needed — Steps 2 & 4 no longer route through it. RightPanel continues to serve Steps 1, 3, 5, 7-10 unchanged.
  </action>
  <verify>
    Run `npx tsc --noEmit` — no type errors. Run `npm run dev`, navigate to Step 2 — should see chat left, canvas right with ring overlay, NO output accordion. Navigate to Step 4 — should see chat left, canvas right with empathy map overlay, NO output accordion. Navigate to Step 6 — should still show RightPanel with canvas + output accordion as before.
  </verify>
  <done>
    Steps 2 & 4 render split-screen with chat left and canvas-only right (no output panel). Steps 1, 3, 5, 6, 7-10 are unchanged. Extract Output button hidden for canvas-only steps. effectiveConfirmed correctly checks canvas content for Steps 2 & 4.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement lazy migration at page level and update Add to Whiteboard for ring/zone placement</name>
  <files>
    src/app/workshop/[sessionId]/step/[stepId]/page.tsx
    src/components/workshop/chat-panel.tsx
  </files>
  <action>
    **Update `src/app/workshop/[sessionId]/step/[stepId]/page.tsx`**:

    Import migration helpers:
    ```typescript
    import { migrateStakeholdersToCanvas, migrateEmpathyToCanvas } from '@/lib/canvas/migration-helpers';
    ```

    After loading canvas state (line ~92: `const canvasData = await loadCanvasState(...)`), add lazy migration logic:

    ```typescript
    let initialCanvasPostIts: PostIt[] = canvasData?.postIts || [];
    const initialGridColumns: GridColumn[] = canvasData?.gridColumns || [];

    // Lazy migration: if artifact exists but no canvas state, derive initial positions
    if (initialCanvasPostIts.length === 0 && initialArtifact && step) {
      if (step.id === 'stakeholder-mapping') {
        initialCanvasPostIts = migrateStakeholdersToCanvas(initialArtifact);
      } else if (step.id === 'sense-making') {
        initialCanvasPostIts = migrateEmpathyToCanvas(initialArtifact);
      }
    }
    ```

    **IMPORTANT:** This migration is lazy (client-side seeding via initial props). The migrated post-its are passed to `CanvasStoreProvider` as `initialPostIts` but NOT persisted to DB. Persistence happens only when the user interacts (drag, add) — the existing `useCanvasAutosave` hook handles this because it watches `isDirty` flag. Migration itself does not set `isDirty` since the store is initialized with these post-its (they're initial state, not mutations).

    **Note on initialArtifact:** The current code already strips `_canvas` from initialArtifact (line 86). So initialArtifact for migration will contain the structured artifact data (stakeholders array, themes/pains/gains) without canvas metadata. This is correct.

    Also note: For `in_progress` steps, initialArtifact is null (only loaded for complete/needs_regeneration steps). Migration only applies to completed workshops being revisited, which is the intended behavior.

    **Update `src/components/workshop/chat-panel.tsx`**:

    Import zone color map:
    ```typescript
    import { ZONE_COLORS } from '@/lib/canvas/canvas-position';
    ```

    The existing `handleAddToWhiteboard` function already calls `computeCanvasPosition(step.id, metadata, existingPostIts)` which will now route through the new ring/zone branches from Plan 01. **However**, update the color logic:

    In `handleAddToWhiteboard`, after `computeCanvasPosition`, update the color assignment:
    ```typescript
    // Color priority: category-specific > zone-specific > default yellow
    const color = (item.category && CATEGORY_COLORS[item.category])
      || (item.quadrant && ZONE_COLORS[item.quadrant])
      || 'yellow';
    ```

    This ensures:
    - Step 2 ring items: all yellow (no zone color mapping needed for rings)
    - Step 4 empathy items: pains=pink, gains=green, others=yellow
    - Step 5 persona items: category-based colors (existing behavior)
    - Step 6 grid items: default yellow (existing behavior)

    **Verify Add to Whiteboard flow:**
    - AI responds with `[CANVAS_ITEM quadrant="inner"]Stakeholder Name[/CANVAS_ITEM]` for Step 2
    - AI responds with `[CANVAS_ITEM quadrant="pains"]User frustration[/CANVAS_ITEM]` for Step 4
    - The `quadrant` attribute carries the ring ID or zone ID
    - `computeCanvasPosition` routes to ring/zone branch based on `STEP_CANVAS_CONFIGS[stepId].hasRings` or `.hasEmpathyZones`
    - Auto-zoom via `setPendingFitView(true)` already in place

    **No changes needed to AI prompts** — the existing CANVAS_ITEM markup pattern works. The AI already uses `quadrant="..."` attributes. For Steps 2 & 4, the AI will use ring IDs (inner/middle/outer) or zone IDs (says/thinks/feels/does/pains/gains) in the quadrant attribute. This is handled by the system prompts which reference quadrant names.
  </action>
  <verify>
    Run `npx tsc --noEmit` — no type errors. Test migration: create a workshop, complete Step 2 with stakeholder output, navigate away and back — should see post-its on rings. Test Add to Whiteboard: have AI suggest items with [CANVAS_ITEM quadrant="inner"]...[/CANVAS_ITEM] — clicking "Add to Whiteboard" should place card on inner ring. Test Step 4 similarly with empathy zones.
  </verify>
  <done>
    Page-level lazy migration converts existing stakeholder and empathy artifacts to canvas post-its on first load. Post-its render at correct ring/zone positions. Add to Whiteboard places cards at correct ring/zone positions with appropriate colors. Canvas positions persist lazily (only on user interaction). Steps 1, 3, 5, 6, 7-10 unaffected.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm run dev` — navigate to Step 2:
   - Split-screen: chat left, canvas right (no output panel)
   - Empty rings visible before any AI content
   - AI Add to Whiteboard places cards on correct rings
3. Navigate to Step 4:
   - Split-screen: chat left, canvas right (no output panel)
   - Empty zones visible before any AI content
   - AI Add to Whiteboard places cards in correct zones (pains=pink, gains=green)
4. Open existing workshop with completed Step 2 — stakeholder post-its appear on rings
5. Open existing workshop with completed Step 4 — empathy post-its appear in zones
6. Navigate to Step 6 — Journey Map grid still works as before
7. Navigate to Steps 1, 3, 5, 7-10 — output panels still shown
8. Canvas auto-saves only after user interaction (not on migration load)
</verification>

<success_criteria>
- Steps 2 & 4 use canvas-only layout (no output panel, no Extract Output button)
- Existing artifacts auto-migrate to canvas positions on first load
- Add to Whiteboard works correctly with ring/zone placement
- Auto-zoom to fit after card placement
- Lazy persistence (no DB write until user interacts)
- All other steps unaffected
- Mobile layout works (canvas tab for Steps 2 & 4)
</success_criteria>

<output>
After completion, create `.planning/phases/24-output-to-canvas-retrofit/24-03-SUMMARY.md`
</output>
