---
phase: 24-output-to-canvas-retrofit
plan: 02
type: execute
wave: 2
depends_on: ["24-01"]
files_modified:
  - src/components/canvas/concentric-rings-overlay.tsx
  - src/components/canvas/empathy-map-overlay.tsx
  - src/components/canvas/react-flow-canvas.tsx
autonomous: true

must_haves:
  truths:
    - "Step 2 canvas shows 3 visible concentric ring boundaries with color-coded background tints"
    - "Step 2 canvas shows 'Most Important' center label"
    - "Step 4 canvas shows 6 labeled zones (Says, Thinks, Feels, Does, Pains, Gains) with color-coded backgrounds"
    - "Ring boundaries and zone boundaries transform correctly with viewport pan and zoom"
    - "Dragging a card in Step 2 auto-detects ring assignment on drop"
    - "Dragging a card in Step 4 auto-re-associates zone on drop (no confirmation)"
    - "Double-click creates post-it at correct ring/zone position"
    - "Canvas renders empty ring/zone layout on step entry before any AI content"
  artifacts:
    - path: "src/components/canvas/concentric-rings-overlay.tsx"
      provides: "SVG overlay with 3 concentric rings, background tints, center label"
      exports: ["ConcentricRingsOverlay"]
    - path: "src/components/canvas/empathy-map-overlay.tsx"
      provides: "SVG overlay with 6 rectangular zones, color-coded backgrounds, zone header labels"
      exports: ["EmpathyMapOverlay"]
    - path: "src/components/canvas/react-flow-canvas.tsx"
      provides: "Updated canvas with ring/zone overlay rendering, ring/zone snap-on-drag, ring/zone-aware creation"
      contains: "ConcentricRingsOverlay"
  key_links:
    - from: "src/components/canvas/react-flow-canvas.tsx"
      to: "src/components/canvas/concentric-rings-overlay.tsx"
      via: "conditionally rendered inside ReactFlow when stepConfig.hasRings"
      pattern: "stepConfig\\.hasRings.*ConcentricRingsOverlay"
    - from: "src/components/canvas/react-flow-canvas.tsx"
      to: "src/components/canvas/empathy-map-overlay.tsx"
      via: "conditionally rendered inside ReactFlow when stepConfig.hasEmpathyZones"
      pattern: "stepConfig\\.hasEmpathyZones.*EmpathyMapOverlay"
    - from: "src/components/canvas/react-flow-canvas.tsx"
      to: "src/lib/canvas/ring-layout.ts"
      via: "detectRing() on drag end for ring auto-assignment"
      pattern: "detectRing"
    - from: "src/components/canvas/react-flow-canvas.tsx"
      to: "src/lib/canvas/empathy-zones.ts"
      via: "getZoneForPosition() on drag end for zone auto-reassignment"
      pattern: "getZoneForPosition"
---

<objective>
Build the visual overlay components and integrate them into the ReactFlow canvas. ConcentricRingsOverlay renders 3 visible ring boundaries with Miro/FigJam aesthetic. EmpathyMapOverlay renders 6 color-coded zones. ReactFlowCanvas gains ring/zone-aware drag-and-drop behavior.

Purpose: Provide the visual spatial structure that makes Steps 2 & 4 function as organized whiteboards rather than freeform post-it dumps. Users see ring/zone boundaries immediately on step entry, before any AI content.

Output: 2 new overlay components, 1 major update to react-flow-canvas.tsx
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/24-output-to-canvas-retrofit/24-RESEARCH.md
@.planning/phases/24-output-to-canvas-retrofit/24-01-SUMMARY.md

@src/components/canvas/react-flow-canvas.tsx
@src/components/canvas/quadrant-overlay.tsx
@src/components/canvas/grid-overlay.tsx
@src/lib/canvas/ring-layout.ts
@src/lib/canvas/empathy-zones.ts
@src/lib/canvas/step-canvas-config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ConcentricRingsOverlay and EmpathyMapOverlay components</name>
  <files>
    src/components/canvas/concentric-rings-overlay.tsx
    src/components/canvas/empathy-map-overlay.tsx
  </files>
  <action>
    **Create `src/components/canvas/concentric-rings-overlay.tsx`**:

    Follow the exact same viewport-aware SVG pattern as `quadrant-overlay.tsx` and `grid-overlay.tsx`:
    - Import `useStore as useReactFlowStore` from `@xyflow/react`
    - Use `viewportSelector` for `{ x, y, zoom }` transform subscription
    - Accept `config: RingConfig` prop (from ring-layout.ts)

    Render within `<svg className="absolute inset-0 pointer-events-none z-10">`:

    **Ring boundaries** (iterate config.rings from outermost to innermost for correct layering):
    - For each ring, render a background tint `<circle>` with `fill={ring.color}` and `opacity={0.06}` — render outer rings first so inner tints overlay
    - For each ring, render a boundary `<circle>` with `fill="none"`, `stroke="#d1d5db"`, `strokeWidth={1}`, `strokeDasharray="6 3"` for dashed outer rings and `strokeDasharray="none"` (solid) for innermost ring
    - All circles: `cx={centerScreen.x}`, `cy={centerScreen.y}`, `r={ring.radius * zoom}`
    - Use `toScreen(config.center.x, config.center.y)` to get screen-space center

    **Center label** ("Most Important"):
    - Use `<foreignObject>` centered on screen center: `x={centerScreen.x - 60}`, `y={centerScreen.y - 16}`, `width={120}`, `height={32}`
    - Inner div: `flex items-center justify-center`
    - Text: `<span className="text-xs font-semibold text-gray-500 bg-white/80 px-2 py-0.5 rounded">Most Important</span>`

    **Create `src/components/canvas/empathy-map-overlay.tsx`**:

    Same viewport-aware SVG pattern. Accept `config: EmpathyZoneConfig` prop.

    Render within `<svg className="absolute inset-0 pointer-events-none z-10">`:

    **Zone backgrounds** (iterate Object.entries(config.zones)):
    - For each zone, calculate screen-space bounds: `toScreen(bounds.x, bounds.y)`
    - Render `<rect>` background tint: `fill={zone.color}`, `opacity={0.08}`, screen-space x/y, `width={bounds.width * zoom}`, `height={bounds.height * zoom}`
    - Render `<rect>` boundary: `fill="none"`, `stroke="#e5e7eb"`, `strokeWidth={1}`, `strokeDasharray="4 4"` — dashed lines

    **Zone header labels** (persistent, always visible):
    - Use `<foreignObject>` at top-left of each zone, offset 12px inward
    - Width: `bounds.width * zoom - 24`, height: 28px
    - Inner content: `<span className="text-sm font-semibold" style={{ color: zone.color }}>` with zone label
    - For pains and gains zones, use bolder/darker text variants: pains = `text-red-600`, gains = `text-emerald-600`
    - For neutral quadrant zones (says, thinks, feels, does), use `text-gray-600`

    **Miro/FigJam aesthetic details:**
    - Rounded corners on zone rects: `rx={8}` for subtle softness
    - Slightly thicker border for pains/gains strips to visually separate them from quadrant area
  </action>
  <verify>
    Run `npx tsc --noEmit` — no type errors. Visually inspect that both components follow the same SVG pattern as existing quadrant-overlay.tsx. Verify both use `useReactFlowStore(viewportSelector)` for viewport-awareness.
  </verify>
  <done>
    ConcentricRingsOverlay renders 3 concentric circles with background tints, dashed/solid boundaries, and center "Most Important" label. EmpathyMapOverlay renders 6 color-coded rectangular zones with persistent header labels. Both transform with viewport pan/zoom using ReactFlow store subscription.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate overlays and ring/zone-aware behavior into ReactFlowCanvas</name>
  <files>src/components/canvas/react-flow-canvas.tsx</files>
  <action>
    **Import new components and functions:**
    ```typescript
    import { ConcentricRingsOverlay } from './concentric-rings-overlay';
    import { EmpathyMapOverlay } from './empathy-map-overlay';
    import { detectRing } from '@/lib/canvas/ring-layout';
    import { getZoneForPosition } from '@/lib/canvas/empathy-zones';
    ```

    **Add overlay rendering** inside the `<ReactFlow>` component, alongside the existing QuadrantOverlay and GridOverlay conditionals:
    ```tsx
    {stepConfig.hasRings && stepConfig.ringConfig && (
      <ConcentricRingsOverlay config={stepConfig.ringConfig} />
    )}
    {stepConfig.hasEmpathyZones && stepConfig.empathyZoneConfig && (
      <EmpathyMapOverlay config={stepConfig.empathyZoneConfig} />
    )}
    ```

    **Update `handleNodesChange`** (drag end logic):

    Add a new branch BEFORE the existing quadrant branch for ring-based steps:
    ```typescript
    if (stepConfig.hasRings && stepConfig.ringConfig) {
      const snappedPosition = snapToGrid(change.position);
      const ringId = detectRing(
        { x: snappedPosition.x + 60, y: snappedPosition.y + 50 }, // card center
        stepConfig.ringConfig
      );
      updatePostIt(change.id, {
        position: snappedPosition,
        cellAssignment: { row: ringId, col: '' },
      });
    }
    ```

    Add another branch for empathy-zone steps:
    ```typescript
    else if (stepConfig.hasEmpathyZones && stepConfig.empathyZoneConfig) {
      const snappedPosition = snapToGrid(change.position);
      const zone = getZoneForPosition(
        { x: snappedPosition.x + 60, y: snappedPosition.y + 50 }, // card center
        stepConfig.empathyZoneConfig
      );
      updatePostIt(change.id, {
        position: snappedPosition,
        cellAssignment: zone ? { row: zone, col: '' } : undefined,
      });
    }
    ```

    **Update `createPostItAtPosition`** (double-click creation):

    Add ring-based creation branch:
    - If `stepConfig.hasRings && stepConfig.ringConfig`: snap to grid, call `detectRing()` to find which ring the click landed in, set `cellAssignment: { row: ringId, col: '' }`

    Add empathy-zone creation branch:
    - If `stepConfig.hasEmpathyZones && stepConfig.empathyZoneConfig`: snap to grid, call `getZoneForPosition()`, set `cellAssignment: { row: zone, col: '' }`

    **Update `handleToolbarAdd`** similarly for toolbar creation.

    **Update `handleEmotionAdd`** similarly (though emotion post-its are primarily for journey-mapping, handle gracefully).

    **Update `handleInit`** (viewport initialization):

    Add initialization for ring steps: center viewport on (0,0) similar to quadrant steps — rings are centered at canvas origin.
    ```typescript
    if (stepConfig.hasRings && postIts.length === 0) {
      // Center viewport on (0,0) for ring layout
      const container = document.querySelector('.react-flow');
      if (container) {
        const rect = container.getBoundingClientRect();
        instance.setViewport({
          x: rect.width / 2,
          y: rect.height / 2,
          zoom: 0.7, // Slightly zoomed out so all 3 rings visible
        });
      }
    }
    ```

    Add initialization for empathy zone steps: Center on the empathy map layout area.
    ```typescript
    else if (stepConfig.hasEmpathyZones && postIts.length === 0) {
      // Center viewport to show full empathy map
      const container = document.querySelector('.react-flow');
      if (container) {
        const rect = container.getBoundingClientRect();
        instance.setViewport({
          x: rect.width / 2 + 210, // Center horizontally on the zone layout
          y: rect.height / 2 + 200, // Center vertically
          zoom: 0.6, // Zoomed out enough to see all 6 zones
        });
      }
    }
    ```

    **IMPORTANT: Remove old quadrant overlay for Steps 2 & 4.** Since stakeholder-mapping and sense-making no longer have `hasQuadrants: true` in step-canvas-config.ts (changed in Plan 01), the existing `QuadrantOverlay` conditional will naturally not render for these steps. No code removal needed — the config change handles it. But verify this is the case.
  </action>
  <verify>
    Run `npx tsc --noEmit` — no type errors. Run `npm run dev` and navigate to Step 2 — should see 3 concentric ring boundaries. Navigate to Step 4 — should see 6 colored zone areas. Double-click inside a ring/zone should create a post-it. Drag a post-it between rings/zones should auto-reassign.
  </verify>
  <done>
    ReactFlowCanvas renders ConcentricRingsOverlay for Step 2 and EmpathyMapOverlay for Step 4. Drag-and-drop auto-detects ring/zone assignment. Post-it creation detects ring/zone at click position. Empty layout template visible on step entry. Old quadrant overlays no longer shown for Steps 2 & 4.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. Step 2 canvas shows 3 concentric rings with "Most Important" center label on empty canvas
3. Step 4 canvas shows 6 zones (Says, Thinks, Feels, Does, Pains, Gains) with headers on empty canvas
4. Drag a post-it between rings in Step 2 — cellAssignment.row updates to new ring
5. Drag a post-it between zones in Step 4 — cellAssignment.row updates to new zone
6. Overlays scale and pan correctly with viewport transforms
7. Step 6 Journey Mapping still works exactly as before (no regressions)
</verification>

<success_criteria>
- Both overlay components render correctly with viewport-aware transforms
- Ring/zone auto-assignment works on drag drop
- Empty layout templates visible on step entry
- Miro/FigJam visual aesthetic (color tints, dashed lines, clean labels)
- No regressions to Step 6 Journey Mapping or Step 5 Persona canvas
</success_criteria>

<output>
After completion, create `.planning/phases/24-output-to-canvas-retrofit/24-02-SUMMARY.md`
</output>
