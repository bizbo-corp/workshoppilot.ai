---
phase: 50-credit-actions-server-enforcement
plan: 02
type: execute
wave: 2
depends_on: [50-01]
files_modified:
  - src/actions/workshop-actions.ts
  - src/app/workshop/[sessionId]/step/[stepId]/page.tsx
  - src/components/workshop/paywall-overlay.tsx
requirements: [PAYW-01, PAYW-05, PAYW-06]
autonomous: true
must_haves:
  truths:
    - "Steps 1-6 load for any authenticated user with zero credits — no paywall check fires"
    - "advanceToNextStep() at Step 6 with zero credits returns { paywallRequired: true, hasCredits: false } and does NOT redirect — no credit is deducted"
    - "advanceToNextStep() at Step 6 with credits returns { paywallRequired: true, hasCredits: true } — the actual consumption happens in the client-triggered consumeCredit() call (Phase 51 UI), not in advanceToNextStep()"
    - "Direct URL navigation to /workshop/[id]/step/7 for a workshop without creditConsumedAt renders PaywallOverlay instead of step content"
    - "Workshops with createdAt < PAYWALL_CUTOFF_DATE bypass the paywall check entirely (grandfathered)"
    - "When PAYWALL_ENABLED=false, no paywall check runs anywhere"
    - "PaywallOverlay is a client component showing a lock icon, message, credit balance, and Buy Credits button"
  artifacts:
    - path: src/actions/workshop-actions.ts
      provides: "Modified advanceToNextStep() with Step 6→7 credit gate"
      exports: ["advanceToNextStep"]
    - path: src/app/workshop/[sessionId]/step/[stepId]/page.tsx
      provides: "Server Component paywall check for steps 7-10"
    - path: src/components/workshop/paywall-overlay.tsx
      provides: "In-place paywall overlay for blocked direct URL access"
      exports: ["PaywallOverlay"]
  key_links:
    - from: src/actions/workshop-actions.ts
      to: src/actions/billing-actions.ts
      via: "Import PAYWALL_CUTOFF_DATE constant for grandfathering check"
      pattern: "import.*PAYWALL_CUTOFF_DATE.*from.*billing-actions"
    - from: src/app/workshop/[sessionId]/step/[stepId]/page.tsx
      to: src/actions/billing-actions.ts
      via: "Import PAYWALL_CUTOFF_DATE for Server Component check"
      pattern: "import.*PAYWALL_CUTOFF_DATE.*from.*billing-actions"
    - from: src/app/workshop/[sessionId]/step/[stepId]/page.tsx
      to: src/components/workshop/paywall-overlay.tsx
      via: "Render PaywallOverlay when workshop not unlocked and not grandfathered"
      pattern: "<PaywallOverlay"
    - from: src/components/workshop/paywall-overlay.tsx
      to: src/actions/billing-actions.ts
      via: "Call getCredits() on mount to display balance"
      pattern: "getCredits()"
---

# Plan 50-02: Step 6→7 Credit Gate and Server Component Paywall

<objective>
Wire the server-side paywall enforcement: modify `advanceToNextStep()` to gate Step 6→7 progression, add a credit check to the `StepPage` Server Component for Steps 7-10, and create the `PaywallOverlay` component for blocked direct URL access.
Purpose: Ensures the paywall is enforced server-side (PAYW-05) — not just by client checks — preventing direct URL bypass. Steps 1-6 remain unconditionally free (PAYW-01). Grandfathered workshops pass through (PAYW-06).
Output: Modified `workshop-actions.ts`, modified `page.tsx`, new `paywall-overlay.tsx`.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/50-credit-actions-server-enforcement/50-RESEARCH.md
@.planning/phases/50-credit-actions-server-enforcement/50-01-SUMMARY.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->
<!-- Executor should use these directly — no codebase exploration needed. -->

From src/actions/billing-actions.ts (created in Plan 50-01):
```typescript
export type ConsumeCreditResult =
  | { status: 'consumed'; newBalance: number }
  | { status: 'insufficient_credits' }
  | { status: 'already_unlocked' }
  | { status: 'grandfathered' }
  | { status: 'paywall_disabled' }
  | { status: 'error'; message: string };

export const PAYWALL_CUTOFF_DATE: Date;  // new Date(1772051653843) — migration 0008 timestamp
export async function consumeCredit(workshopId: string): Promise<ConsumeCreditResult>;
export async function getCredits(): Promise<number>;
export async function markOnboardingComplete(): Promise<void>;
```

From src/actions/workshop-actions.ts (current signature):
```typescript
export async function advanceToNextStep(
  workshopId: string,
  currentStepId: string,
  nextStepId: string,
  sessionId: string
): Promise<{ nextStepOrder: number }>;
// Currently always redirects — never actually returns the Promise value.
// The redirect() call is OUTSIDE the try/catch block (line 331).
```

From src/components/workshop/step-navigation.tsx (current handleNext):
```typescript
// Lines 117-122: Calls advanceToNextStep(), catches errors.
// NEXT_REDIRECT is rethrown so Next.js handles navigation.
// A non-redirect return (paywallRequired) currently falls through silently.
// Phase 51 will add the dialog — Phase 50 just needs the return shape.
```

From src/lib/workshop/step-metadata.ts:
```typescript
// Step 6 = 'journey-mapping', Step 7 = 'reframe'
export const STEPS: StepDefinition[];
export function getStepById(id: string): StepDefinition | undefined;
```

From src/app/workshop/[sessionId]/step/[stepId]/page.tsx (key structure):
```typescript
// session.workshop is fetched with `with: { steps: true }`
// session.workshop has: id, creditConsumedAt, createdAt, clerkUserId, status, steps[]
// stepNumber is parsed from URL param stepId
// The component renders <StepContainer> inside <CanvasStoreProvider>
```

From src/db/schema/workshops.ts:
```typescript
// workshops.creditConsumedAt: timestamp, nullable
// workshops.createdAt: timestamp, not null
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Step 6→7 credit gate to advanceToNextStep()</name>
  <files>src/actions/workshop-actions.ts</files>
  <action>
Modify `advanceToNextStep()` in `src/actions/workshop-actions.ts` to add a paywall check at the Step 6→7 boundary.

**Return type change:**
The function currently has return type `Promise<{ nextStepOrder: number }>` but never actually returns (always redirects). Change the return type to:
```typescript
Promise<{ nextStepOrder: number } | { paywallRequired: true; hasCredits: boolean; creditBalance: number }>
```

**Add imports at top of file:**
```typescript
import { PAYWALL_CUTOFF_DATE } from '@/actions/billing-actions';
import { users } from '@/db/schema';
import { gt } from 'drizzle-orm';
```
Note: `users` and `gt` may already be imported — check first. `workshops` is already imported.

**Add paywall gate INSIDE the try block, BEFORE the existing step completion logic.** The gate must run before `updateStepStatus` marks the current step complete. Insert at the start of the try block (after `try {`, before `// Mark current step complete`):

```typescript
// Paywall gate: Step 6 → Step 7 boundary
const STEP_6_ID = 'journey-mapping';
if (process.env.PAYWALL_ENABLED !== 'false' && currentStepId === STEP_6_ID) {
  const gatUserId = await getUserId();
  if (!gatUserId) throw new Error('Authentication required');

  // Check workshop credit state
  const workshopRecord = await db.query.workshops.findFirst({
    where: and(
      eq(workshops.id, workshopId),
      eq(workshops.clerkUserId, gatUserId)
    ),
    columns: { creditConsumedAt: true, createdAt: true },
  });

  if (workshopRecord) {
    const isUnlocked = workshopRecord.creditConsumedAt !== null;
    const isGrandfathered =
      workshopRecord.creditConsumedAt === null &&
      workshopRecord.createdAt < PAYWALL_CUTOFF_DATE;

    if (!isUnlocked && !isGrandfathered) {
      // Check credit balance to inform UI which dialog to show
      const userRecord = await db.query.users.findFirst({
        where: eq(users.clerkUserId, gatUserId),
        columns: { creditBalance: true },
      });
      const balance = userRecord?.creditBalance ?? 0;
      return {
        paywallRequired: true,
        hasCredits: balance > 0,
        creditBalance: balance,
      };
    }
  }
}
```

**CRITICAL: Keep redirect() OUTSIDE the try/catch block.** The existing `redirect()` call on line 331 must stay exactly where it is — outside the try/catch. The `return` inside the gate exits the function before reaching `redirect()`, which is the correct behavior for the paywall case.

**CRITICAL: The gate returns BEFORE calling `updateStepStatus()`.** This means Step 6 is NOT marked complete when the paywall fires — the user stays on Step 6. Step 6 completion only happens when the user has credits and the advanceToNextStep is called again after credit consumption. This is correct because:
- Phase 51 UI will call `consumeCredit()` first, then call `advanceToNextStep()` again
- The second call will pass through the gate (workshop now has creditConsumedAt set) and proceed normally

**Do NOT modify the step-navigation.tsx client code** — that is Phase 51 UI work. The current handleNext() will silently receive the paywallRequired return value without acting on it. The button will appear to do nothing at Step 6 with no credits. Phase 51 adds the dialog handling.
  </action>
  <verify>
1. `npx tsc --noEmit` — no type errors
2. Grep for `STEP_6_ID = 'journey-mapping'` — constant defined
3. Grep for `paywallRequired: true` — return statement present
4. Grep for `PAYWALL_CUTOFF_DATE` — imported from billing-actions
5. Verify redirect() is still outside try/catch (should be on the last line of the function, after the catch block)
6. Verify the gate is inside the try block, before `updateStepStatus`
  </verify>
  <done>
advanceToNextStep() checks the Step 6→7 boundary. For unlocked or grandfathered workshops, it passes through to normal advance. For workshops needing a credit, it returns { paywallRequired: true, hasCredits, creditBalance } without marking Step 6 complete and without redirecting.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PaywallOverlay component and add Server Component credit check to StepPage</name>
  <files>src/components/workshop/paywall-overlay.tsx, src/app/workshop/[sessionId]/step/[stepId]/page.tsx</files>
  <action>
**Part A: Create `src/components/workshop/paywall-overlay.tsx`**

This is a **Client Component** (`'use client'`) that replaces step content when a user directly navigates to Step 7-10 without a credit.

Props:
```typescript
interface PaywallOverlayProps {
  sessionId: string;
  workshopId: string;
  stepNumber: number;
}
```

Implementation:
1. On mount, call `getCredits()` server action to fetch current balance. Store in state with a loading flag.
2. Render a full-height container matching the step content area. Use relative positioning with:
   - A **blurred placeholder background** — render a few decorative elements (gradient blobs, faded text placeholders) behind a `backdrop-blur-sm` or CSS blur to hint at locked content. Keep it simple — this is motivational, not real data. Use `blur-md` on the background elements.
   - A **centered overlay card** (z-10, semi-transparent dark background) containing:
     - Lock icon (`Lock` from lucide-react, size h-12 w-12, `text-muted-foreground`)
     - Heading: "Unlock Steps 7-10" (text-xl font-semibold)
     - Subheading: "Use a credit to continue your workshop" (text-muted-foreground)
     - Credit balance display: "You have {N} credits" or "No credits available" (shown after loading)
     - If balance > 0: Primary button "Use 1 Credit to Unlock" — this button calls `consumeCredit(workshopId)` server action. On success, call `router.refresh()` to re-render the Server Component. On failure, show error via `toast.error()`.
     - If balance === 0: Primary button "Buy Credits" linking to `/api/billing/checkout` page (or the pricing page — for now, use `router.push('/pricing')` since the purchase flow requires selecting a package). Also show secondary text: "Starting at $79 for one workshop credit"
     - A "Back to Step 6" ghost button that navigates to the previous step: `router.push(\`/workshop/${sessionId}/step/6\`)`

Import `getCredits` and `consumeCredit` from `@/actions/billing-actions`.
Import `useRouter` from `next/navigation`.
Import `toast` from `sonner`.
Import `Lock` from `lucide-react`.
Import `Button` from `@/components/ui/button`.

Style with Tailwind. The overlay should feel like part of the app, not a disruptive modal. Use `bg-background/80` backdrop and `border rounded-lg p-8` card styling consistent with the project's olive/neutral theme.

**Part B: Add Server Component paywall check to StepPage (`page.tsx`)**

In `src/app/workshop/[sessionId]/step/[stepId]/page.tsx`, add the paywall check AFTER the session fetch and sequential enforcement block, BEFORE the chat message loading. The check should go right after the `stepRecord?.status === "not_started"` redirect block (around line 88).

Add imports at top:
```typescript
import { PAYWALL_CUTOFF_DATE } from '@/actions/billing-actions';
import { PaywallOverlay } from '@/components/workshop/paywall-overlay';
```

Add the check:
```typescript
// Paywall enforcement: Steps 7-10 require credit or grandfathering
const PAYWALL_ENABLED = process.env.PAYWALL_ENABLED !== 'false';

if (PAYWALL_ENABLED && stepNumber >= 7) {
  const workshop = session.workshop;
  const isUnlocked = workshop.creditConsumedAt !== null;
  const isGrandfathered =
    workshop.creditConsumedAt === null &&
    workshop.createdAt < PAYWALL_CUTOFF_DATE;

  if (!isUnlocked && !isGrandfathered) {
    return (
      <div className="h-full">
        <PaywallOverlay
          sessionId={sessionId}
          workshopId={workshop.id}
          stepNumber={stepNumber}
        />
      </div>
    );
  }
}
```

**IMPORTANT: The `session.workshop` object already has `creditConsumedAt` and `createdAt` fields** because the Drizzle query in page.tsx fetches `session.workshop` via a relation that includes all workshop columns. No additional query is needed.

**IMPORTANT: The `<div className="h-full">` wrapper matches the existing return pattern** at the bottom of the component (line 473).
  </action>
  <verify>
1. `npx tsc --noEmit` — no type errors
2. `src/components/workshop/paywall-overlay.tsx` exists with `'use client'` directive
3. Grep for `PAYWALL_ENABLED` in page.tsx — env var check present
4. Grep for `stepNumber >= 7` in page.tsx — only steps 7-10 checked
5. Grep for `<PaywallOverlay` in page.tsx — component rendered for locked access
6. Grep for `PAYWALL_CUTOFF_DATE` in page.tsx — grandfathering check present
7. Grep for `consumeCredit` in paywall-overlay.tsx — credit consumption wired
8. Grep for `getCredits` in paywall-overlay.tsx — balance fetch wired
9. Verify page.tsx paywall block is BEFORE chat message loading (should be around line 90, before `loadMessages`)
  </verify>
  <done>
Server Component paywall check blocks Steps 7-10 for non-unlocked, non-grandfathered workshops by rendering PaywallOverlay instead of StepContainer. PaywallOverlay shows lock icon, credit balance, and action buttons. Steps 1-6 are completely unaffected (stepNumber < 7 skips the check). PAYWALL_ENABLED=false disables all checks.
  </done>
</task>

<task type="auto">
  <name>Task 3: TypeScript compilation and end-to-end verification</name>
  <files>src/actions/workshop-actions.ts, src/app/workshop/[sessionId]/step/[stepId]/page.tsx, src/components/workshop/paywall-overlay.tsx</files>
  <action>
Run full project verification:

1. `npx tsc --noEmit` — fix any type errors across all modified files.

2. Verify no import cycles:
   - `billing-actions.ts` imports from schema/client only (no action imports)
   - `workshop-actions.ts` imports `PAYWALL_CUTOFF_DATE` from `billing-actions.ts` (one-way dependency, no cycle)
   - `paywall-overlay.tsx` imports `consumeCredit`, `getCredits` from `billing-actions.ts` (client component calling server actions — standard pattern)

3. Check that `step-navigation.tsx` still compiles — the return type of `advanceToNextStep()` changed from `Promise<{ nextStepOrder: number }>` to a union. The current `handleNext()` in step-navigation.tsx calls `await advanceToNextStep(...)` but doesn't use the return value (the redirect causes a throw before the await resolves). The new union return type should not break existing callsite compilation because:
   - The `await` is inside a try block
   - The redirect throws NEXT_REDIRECT before the promise resolves for the normal (non-paywall) case
   - For the paywall case, the promise resolves silently and falls through (Phase 51 handles it)

4. Verify the paywall check in page.tsx doesn't interfere with the existing sequential enforcement or the completed step view. Steps 1-6 must still work identically (the `stepNumber >= 7` guard ensures they're untouched).

5. Run `next build` dry check if feasible, or at minimum run `npx tsc --noEmit` with strict mode.
  </action>
  <verify>
`npx tsc --noEmit` exits with code 0.
  </verify>
  <done>
All three modified files compile cleanly. No import cycles. step-navigation.tsx is unaffected by the return type change. Steps 1-6 load without paywall checks. Server Component paywall correctly gates steps 7-10. PaywallOverlay renders for locked workshops.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes — zero type errors
2. `src/components/workshop/paywall-overlay.tsx` exists with 'use client' directive
3. `src/actions/workshop-actions.ts` has paywall gate inside advanceToNextStep for Step 6→7
4. `src/app/workshop/[sessionId]/step/[stepId]/page.tsx` has paywall check for stepNumber >= 7
5. Steps 1-6 have NO paywall code paths — the check only runs for stepNumber >= 7
6. advanceToNextStep returns paywallRequired for Step 6 without marking step complete
7. Server Component renders PaywallOverlay instead of StepContainer for locked workshops
8. PAYWALL_ENABLED=false skips all checks in both advanceToNextStep and StepPage
9. Grandfathered workshops (createdAt < PAYWALL_CUTOFF_DATE) pass through both checks
</verification>

<success_criteria>
- advanceToNextStep() returns { paywallRequired: true, hasCredits, creditBalance } at Step 6→7 for non-unlocked, non-grandfathered workshops — does not redirect
- StepPage Server Component renders PaywallOverlay for direct URL access to Step 7-10 when workshop is locked
- PaywallOverlay shows credit balance, lock icon, and action buttons (Use Credit or Buy Credits)
- Steps 1-6 are completely unaffected by all paywall changes
- PAYWALL_ENABLED=false disables paywall in both enforcement points
- Grandfathered workshops pass through both enforcement points
- TypeScript compilation passes with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/50-credit-actions-server-enforcement/50-02-SUMMARY.md`
</output>
