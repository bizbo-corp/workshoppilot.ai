---
phase: 02-authentication-roles
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/db/schema/users.ts
  - src/db/schema/index.ts
  - src/db/schema/relations.ts
  - src/db/types.ts
  - src/app/layout.tsx
  - src/middleware.ts
  - .env.local
autonomous: true
user_setup:
  - service: clerk
    why: "Managed authentication provider"
    env_vars:
      - name: NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY
        source: "Clerk Dashboard -> API Keys"
      - name: CLERK_SECRET_KEY
        source: "Clerk Dashboard -> API Keys"
    dashboard_config:
      - task: "Create Clerk application with email+password and Google OAuth enabled"
        location: "dashboard.clerk.com -> Create Application"
      - task: "Enable first name and last name as required fields"
        location: "Clerk Dashboard -> Configure -> User & Authentication -> Email, Phone, Username"
      - task: "Enable Google as social connection"
        location: "Clerk Dashboard -> Configure -> SSO Connections -> Add connection -> Google"

must_haves:
  truths:
    - "Clerk SDK is installed and ClerkProvider wraps the entire application"
    - "Users table exists in database with clerkUserId, email, firstName, lastName, company, deletedAt fields"
    - "Middleware intercepts requests and applies route protection rules"
    - "Application builds without errors with Clerk integration"
  artifacts:
    - path: "src/db/schema/users.ts"
      provides: "Users table definition synced from Clerk"
      exports: ["users"]
      contains: "pgTable.*users"
    - path: "src/middleware.ts"
      provides: "Clerk middleware with route matchers for public, protected, and admin routes"
      exports: ["default", "config"]
      contains: "clerkMiddleware"
    - path: "src/app/layout.tsx"
      provides: "Root layout wrapped with ClerkProvider"
      contains: "ClerkProvider"
  key_links:
    - from: "src/app/layout.tsx"
      to: "@clerk/nextjs"
      via: "ClerkProvider component wrapping children"
      pattern: "ClerkProvider"
    - from: "src/middleware.ts"
      to: "@clerk/nextjs/server"
      via: "clerkMiddleware and createRouteMatcher imports"
      pattern: "clerkMiddleware.*createRouteMatcher"
    - from: "src/db/schema/users.ts"
      to: "src/lib/ids.ts"
      via: "createPrefixedId for usr_ prefix IDs"
      pattern: "createPrefixedId.*usr"
---

<objective>
Install Clerk SDK and dependencies, create the users database table, wrap the application in ClerkProvider, and configure middleware for route protection. This is the foundation for all authentication features in Phase 2.

Purpose: Every other auth plan depends on Clerk being installed, the users table existing, and middleware running. This plan unblocks all subsequent work.
Output: Working Clerk integration with database schema and middleware route protection.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-authentication-roles/02-CONTEXT.md
@.planning/phases/02-authentication-roles/02-RESEARCH.md
@src/db/schema/index.ts
@src/db/schema/workshops.ts
@src/db/schema/relations.ts
@src/db/types.ts
@src/app/layout.tsx
@src/lib/ids.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create users database schema</name>
  <files>package.json, src/db/schema/users.ts, src/db/schema/index.ts, src/db/schema/relations.ts, src/db/types.ts</files>
  <action>
    1. Install Clerk and supporting packages:
       ```
       npm install @clerk/nextjs @clerk/themes svix
       ```
       Note: zustand is NOT needed yet (deferred to when workshop state management is needed). zod is already installed.

    2. Create `src/db/schema/users.ts` with the users table definition:
       - id: text primary key using `createPrefixedId('usr')` (following existing ID convention)
       - clerkUserId: text, notNull, unique (links to Clerk's user ID)
       - email: text, notNull
       - firstName: text (nullable, from Clerk)
       - lastName: text (nullable, from Clerk)
       - imageUrl: text (nullable, Clerk-provided avatar URL)
       - company: text (nullable, optional field from sign-up unsafeMetadata)
       - roles: text array stored as JSON text field. Default: `'["facilitator"]'`. Per user decision: roles stored as array in database, future-proofed for participant role. Use a text column storing JSON (Neon supports this; avoid pg array for simpler Drizzle handling).
       - deletedAt: timestamp (nullable, for soft delete per user decision)
       - createdAt: timestamp, notNull, defaultNow
       - updatedAt: timestamp, notNull, defaultNow, $onUpdate(() => new Date())
       - Add index on clerkUserId for fast lookups
       - Add index on email for uniqueness checks
       - Follow exact patterns from `src/db/schema/workshops.ts` for timestamp precision (3) and mode ('date')

    3. Update `src/db/schema/index.ts` to export from `./users`

    4. Update `src/db/schema/relations.ts`:
       - Import users table
       - Add usersRelations: user has many workshops (via clerkUserId field match — note: this is a logical relation, workshops.clerkUserId references users.clerkUserId, NOT users.id. Use a custom relation or skip Drizzle relation here since it's a text match, not a foreign key. Simply add a comment noting the logical relationship.)

    5. Update `src/db/types.ts`:
       - Import users from schema
       - Export User and NewUser types using InferSelectModel/InferInsertModel

    6. Push schema to Neon:
       ```
       npm run db:push:dev
       ```
  </action>
  <verify>
    - `npm run db:push:dev` completes without errors
    - `npx drizzle-kit studio` shows users table with all expected columns
    - `npm run build` compiles without TypeScript errors related to schema
  </verify>
  <done>Users table exists in Neon with all required columns (id, clerkUserId, email, firstName, lastName, imageUrl, company, roles, deletedAt, createdAt, updatedAt). Schema exports and types are available throughout the app.</done>
</task>

<task type="auto">
  <name>Task 2: Configure ClerkProvider and middleware</name>
  <files>src/app/layout.tsx, src/middleware.ts, .env.local</files>
  <action>
    1. Add Clerk environment variables to `.env.local` (if not already present — the user will have set these up from Clerk Dashboard):
       ```
       NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_...
       CLERK_SECRET_KEY=sk_test_...
       ADMIN_EMAIL=owner@workshoppilot.ai
       ```
       If the env vars don't exist yet, add placeholder comments so the executor knows they're needed. Do NOT hardcode real values.

    2. Update `src/app/layout.tsx`:
       - Import ClerkProvider from '@clerk/nextjs'
       - Wrap the entire app (inside <html>) with <ClerkProvider>
       - Set `signInFallbackRedirectUrl="/dashboard"` and `signUpFallbackRedirectUrl="/dashboard"` on ClerkProvider (per research: use new redirect props, not deprecated afterSignIn/afterSignUp)
       - Keep existing Geist font setup and className on body
       - Update metadata title to "WorkshopPilot" and description to match the product
       - Do NOT add @clerk/themes import yet (styling is Claude's discretion, keep it simple for now)

    3. Create `src/middleware.ts` at project root (NOT inside src/app):
       - Import clerkMiddleware and createRouteMatcher from '@clerk/nextjs/server'
       - Import NextResponse from 'next/server'

       - Define route matchers:
         * isPublicRoute: matches '/', '/sign-in(.*)', '/sign-up(.*)', '/api/webhooks(.*)', '/api/health'
         * isAdminRoute: matches '/admin(.*)'
         * isProtectedRoute: matches '/dashboard(.*)', '/api/workshops(.*)', '/api/sessions(.*)'
         Note: Workshop step routes (/workshop/[id]/step/[N]) are NOT in middleware matchers yet since workshop routes don't exist in this phase. They'll be added in Phase 3. For now, the middleware handles the core routes.

       - Implement clerkMiddleware async handler:
         a. Get userId and sessionClaims from await auth()
         b. Admin routes: if isAdminRoute(req) AND no userId → redirect to '/' (landing page, where sign-in modal will appear). If userId exists but roles don't include 'admin' → redirect to '/dashboard' silently (per user decision).
         c. Protected routes: if isProtectedRoute(req) AND no userId → redirect to '/' (landing, sign-in modal)
         d. Landing page redirect: if pathname === '/' AND userId → redirect to '/dashboard' (per user decision: signed-in users auto-redirect to dashboard)
         e. Default: NextResponse.next()

       - For role checking in middleware: read roles from sessionClaims. Clerk stores publicMetadata in session claims. Access via `(sessionClaims?.metadata as Record<string, unknown>)?.roles` or similar. The exact path depends on Clerk's session claims structure — check `sessionClaims?.publicMetadata?.roles` first, falling back to metadata path. Cast as needed.

       - Export config with matcher array (standard Clerk matcher that skips static files):
         ```
         export const config = {
           matcher: [
             '/((?!_next|[^?]*\\.(?:html?|css|js(?!on)|jpe?g|webp|png|gif|svg|ttf|woff2?|ico|csv|docx?|xlsx?|zip|webmanifest)).*)',
             '/(api|trpc)(.*)',
           ],
         };
         ```

    4. Defense in depth note: Middleware is the FIRST layer of protection. Per CVE-2025-29927 research, components and API routes must ALSO verify auth. This will be implemented in subsequent plans (Plan 04 adds auth checks in page components).
  </action>
  <verify>
    - `npm run build` completes without errors
    - `npm run dev` starts successfully and the landing page loads at http://localhost:3000
    - If Clerk env vars are set: ClerkProvider initializes (check browser console for no "ClerkProvider" errors)
    - Visiting /dashboard while unauthenticated redirects to / (landing page)
  </verify>
  <done>ClerkProvider wraps the application. Middleware protects /dashboard and /admin routes, redirects unauthenticated users to landing page, and redirects authenticated users from landing to dashboard. Next.js 16.1.1 is used (post-CVE-2025-29927 patch).</done>
</task>

</tasks>

<verification>
1. `npm run build` passes with zero errors
2. Users table visible in Drizzle Studio or Neon console with all columns
3. Middleware.ts exists at project root with route matchers
4. ClerkProvider wraps app in layout.tsx
5. Schema exports include users table and User/NewUser types
</verification>

<success_criteria>
- @clerk/nextjs, @clerk/themes, and svix packages installed
- Users table schema created with usr_ prefixed IDs, soft delete, roles as JSON text
- ClerkProvider wraps entire application with fallback redirect URLs
- Middleware protects /dashboard and /admin routes with appropriate redirects
- Application builds and runs without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication-roles/02-01-SUMMARY.md`
</output>
