---
phase: 01-foundation-database
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - drizzle.config.ts
  - src/db/client.ts
  - src/lib/ids.ts
  - .env.local
  - .gitignore
autonomous: true
user_setup:
  - service: neon
    why: "Serverless Postgres database"
    env_vars:
      - name: DATABASE_URL
        source: "Neon Console -> Project -> Connection Details -> Connection string (select 'Drizzle' driver option)"
    dashboard_config:
      - task: "Create Neon project if not exists"
        location: "console.neon.tech -> New Project"
      - task: "Create dev branch"
        location: "Neon Console -> Branches -> Create Branch (name: dev/michael, parent: main)"

must_haves:
  truths:
    - "Drizzle ORM connects to Neon Postgres via @neondatabase/serverless HTTP driver"
    - "CUID2 IDs can be generated in the application layer"
    - "drizzle.config.ts points to schema directory and uses DATABASE_URL"
  artifacts:
    - path: "src/db/client.ts"
      provides: "Database client singleton using neon-http driver"
      exports: ["db"]
      contains: "drizzle"
    - path: "src/lib/ids.ts"
      provides: "ID generation utility wrapping cuid2"
      exports: ["createId"]
      contains: "cuid2"
    - path: "drizzle.config.ts"
      provides: "Drizzle Kit configuration for schema management"
      contains: "defineConfig"
  key_links:
    - from: "src/db/client.ts"
      to: "@neondatabase/serverless"
      via: "neon() HTTP driver import"
      pattern: "neon.*DATABASE_URL"
    - from: "drizzle.config.ts"
      to: "src/db/schema/index.ts"
      via: "schema path reference"
      pattern: "schema.*db/schema"
---

<objective>
Install database dependencies and create the foundation infrastructure: Drizzle ORM client configured with Neon serverless HTTP driver, CUID2 ID generation utility, and Drizzle Kit configuration.

Purpose: Establishes the database connection layer and tooling that all schema definitions and queries depend on. Without this, no database work can proceed.
Output: Working db client module, ID generator, Drizzle config, and all dependencies installed.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-database/01-CONTEXT.md
@.planning/phases/01-foundation-database/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install database dependencies and configure Drizzle Kit</name>
  <files>
    package.json
    drizzle.config.ts
    .gitignore
  </files>
  <action>
    1. Install production dependencies:
       ```
       npm install drizzle-orm @neondatabase/serverless @paralleldrive/cuid2 zod
       ```

    2. Install dev dependencies:
       ```
       npm install -D drizzle-kit
       ```

    3. Create `drizzle.config.ts` at project root:
       - Use `defineConfig` from `drizzle-kit`
       - Set `schema` to `'./src/db/schema/index.ts'`
       - Set `out` to `'./drizzle'` (migration output directory)
       - Set `dialect` to `'postgresql'`
       - Set `dbCredentials.url` to `process.env.DATABASE_URL!`

    4. Update `.gitignore` to add:
       - `.env.local` (if not already present)
       - `.env*.local` pattern (if not already present)

    Do NOT add `drizzle/` to .gitignore — migration files should be committed for production deploys.
  </action>
  <verify>
    - `npm ls drizzle-orm @neondatabase/serverless @paralleldrive/cuid2 zod drizzle-kit` shows all packages installed
    - `npx drizzle-kit --version` returns version number
    - `drizzle.config.ts` exists with correct schema path and dialect
  </verify>
  <done>All 5 packages installed (drizzle-orm, @neondatabase/serverless, @paralleldrive/cuid2, zod, drizzle-kit). Drizzle config points to schema directory. .gitignore updated.</done>
</task>

<task type="auto">
  <name>Task 2: Create database client and ID generation utility</name>
  <files>
    src/db/client.ts
    src/lib/ids.ts
    src/db/schema/index.ts
  </files>
  <action>
    1. Create `src/db/client.ts`:
       - Import `drizzle` from `'drizzle-orm/neon-http'`
       - Import `neon` from `'@neondatabase/serverless'`
       - Import `* as schema` from `'./schema'` (will be populated in Plan 02)
       - Guard: throw Error if `process.env.DATABASE_URL` is not set
       - Create neon SQL client: `const sql = neon(process.env.DATABASE_URL)`
       - Export db singleton: `export const db = drizzle(sql, { schema })`
       - Use HTTP mode (neon-http), NOT WebSocket — per user decision, best for serverless one-shot queries

    2. Create `src/db/schema/index.ts`:
       - Empty barrel file for now, just a comment: `// Schema exports — populated in Plan 02`
       - This file must exist so client.ts can import from it without errors

    3. Create `src/lib/ids.ts`:
       - Import `createId` from `'@paralleldrive/cuid2'`
       - Re-export `createId` for use across schema files
       - Export a `createPrefixedId` function that takes a prefix string and returns `${prefix}_${createId()}` — useful for debugging which table an ID belongs to (e.g., `ws_clxyz...` for workshops)
       - Decide: use prefixed IDs for readability in logs/URLs. Prefixes: `ws` (workshop), `wm` (workshop_member), `sd` (step_definition — but these use semantic IDs), `wst` (workshop_step), `ses` (session), `bp` (build_pack)

    NOTE on prefixed IDs (Claude's discretion): Prefixed IDs improve debuggability but add complexity. If implementing, keep it simple — a helper function, not a framework. The schema files will use `$defaultFn(() => createPrefixedId('ws'))` instead of `$defaultFn(() => createId())`.
  </action>
  <verify>
    - `src/db/client.ts` exists and imports from neon-http driver
    - `src/lib/ids.ts` exists and exports createId
    - `src/db/schema/index.ts` exists (even if minimal)
    - `npx tsc --noEmit` passes (no TypeScript errors) — may need to create a stub .env.local with a placeholder DATABASE_URL for type checking
  </verify>
  <done>Database client singleton exports `db` using neon-http driver. ID utility exports `createId` wrapping cuid2. Schema barrel file exists for future population.</done>
</task>

</tasks>

<verification>
1. All packages in package.json (drizzle-orm, @neondatabase/serverless, @paralleldrive/cuid2, zod, drizzle-kit)
2. `drizzle.config.ts` exists with postgresql dialect and correct schema path
3. `src/db/client.ts` exports `db` using neon-http driver
4. `src/lib/ids.ts` exports ID generation functions
5. `src/db/schema/index.ts` exists as barrel file
6. TypeScript compilation succeeds (`npx tsc --noEmit`)
</verification>

<success_criteria>
- npm install succeeds with no peer dependency conflicts
- drizzle-kit CLI is accessible
- db client module compiles without errors
- ID generation produces valid cuid2 strings
- Foundation is ready for schema definitions in Plan 02
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-database/01-01-SUMMARY.md`
</output>
