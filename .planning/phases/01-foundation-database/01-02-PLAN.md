---
phase: 01-foundation-database
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/db/schema/workshops.ts
  - src/db/schema/steps.ts
  - src/db/schema/sessions.ts
  - src/db/schema/build-packs.ts
  - src/db/schema/relations.ts
  - src/db/schema/index.ts
  - src/db/types.ts
autonomous: true

must_haves:
  truths:
    - "Workshops table stores id, title, original_idea, status, clerk_user_id, nullable org_id/template_id, visibility/share_token with created_at/updated_at"
    - "Workshop members table stores workshop_id, clerk_user_id, role (extensible text, not enum)"
    - "Step definitions table holds 10 design thinking step references with order, name, description"
    - "Workshop steps table tracks per-workshop progress with status, jsonb output, started_at, completed_at"
    - "Sessions table stores lean timestamp-only session data linked to workshops"
    - "Build packs table references workshops with format_type for multiple output formats"
    - "All tables use cuid2 application-layer IDs, snake_case naming, plural table names"
    - "Foreign keys have indexes for query performance"
  artifacts:
    - path: "src/db/schema/workshops.ts"
      provides: "workshops and workshop_members table definitions"
      exports: ["workshops", "workshopMembers"]
      contains: "pgTable"
    - path: "src/db/schema/steps.ts"
      provides: "step_definitions and workshop_steps table definitions"
      exports: ["stepDefinitions", "workshopSteps"]
      contains: "pgTable"
    - path: "src/db/schema/sessions.ts"
      provides: "sessions table definition"
      exports: ["sessions"]
      contains: "pgTable"
    - path: "src/db/schema/build-packs.ts"
      provides: "build_packs table definition"
      exports: ["buildPacks"]
      contains: "pgTable"
    - path: "src/db/schema/relations.ts"
      provides: "Drizzle relations for relational queries"
      exports: ["workshopsRelations", "workshopMembersRelations", "stepDefinitionsRelations", "workshopStepsRelations", "sessionsRelations", "buildPacksRelations"]
      contains: "relations"
    - path: "src/db/schema/index.ts"
      provides: "Barrel file re-exporting all schema and relations"
    - path: "src/db/types.ts"
      provides: "Inferred TypeScript types from schema"
      exports: ["Workshop", "WorkshopMember", "StepDefinition", "WorkshopStep", "Session", "BuildPack"]
      contains: "InferSelectModel"
  key_links:
    - from: "src/db/schema/workshops.ts"
      to: "src/lib/ids.ts"
      via: "ID generation in $defaultFn"
      pattern: "createId|createPrefixedId"
    - from: "src/db/schema/steps.ts"
      to: "src/db/schema/workshops.ts"
      via: "foreign key reference"
      pattern: "references.*workshops\\.id"
    - from: "src/db/schema/sessions.ts"
      to: "src/db/schema/workshops.ts"
      via: "foreign key reference"
      pattern: "references.*workshops\\.id"
    - from: "src/db/schema/build-packs.ts"
      to: "src/db/schema/workshops.ts"
      via: "foreign key reference"
      pattern: "references.*workshops\\.id"
    - from: "src/db/schema/relations.ts"
      to: "src/db/schema/workshops.ts"
      via: "relational query definitions"
      pattern: "relations.*workshops"
    - from: "src/db/schema/index.ts"
      to: "src/db/schema/*.ts"
      via: "barrel re-exports"
      pattern: "export \\*"
---

<objective>
Define the complete database schema: all tables (workshops, workshop_members, step_definitions, workshop_steps, sessions, build_packs), Drizzle relations for relational queries, indexes for known query patterns, and inferred TypeScript types.

Purpose: This is the core data model for WorkshopPilot.ai. Every feature in subsequent phases depends on these table definitions being correct — auth references clerk_user_id, the app shell queries workshops and steps, navigation reads step progress, and AI chat stores messages in step outputs.
Output: Complete Drizzle schema files, relations, barrel exports, and TypeScript type definitions.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-database/01-CONTEXT.md
@.planning/phases/01-foundation-database/01-RESEARCH.md
@.planning/phases/01-foundation-database/01-01-SUMMARY.md
@src/db/client.ts
@src/lib/ids.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define all table schemas with indexes</name>
  <files>
    src/db/schema/workshops.ts
    src/db/schema/steps.ts
    src/db/schema/sessions.ts
    src/db/schema/build-packs.ts
  </files>
  <action>
    Create 4 schema files following the exact patterns from RESEARCH.md. All tables MUST follow locked decisions:
    - snake_case column naming, plural table names
    - text('id').primaryKey().$defaultFn(() => createId() or createPrefixedId(...)) for all PKs
    - text('clerk_user_id') for Clerk references (NO local users table)
    - timestamp with { mode: 'date', precision: 3 } everywhere
    - Hard deletes (no deleted_at columns)
    - Indexes on all foreign keys and commonly filtered columns

    **src/db/schema/workshops.ts:**
    - `workshops` table: id (PK), clerk_user_id (not null), title (text, not null), original_idea (text, not null), status (text, typed as 'draft'|'active'|'paused'|'completed', not null, default 'draft'), org_id (text, nullable), template_id (text, nullable), visibility (text, typed as 'private'|'shared', not null, default 'private'), share_token (text, nullable), created_at (defaultNow, not null), updated_at (defaultNow + $onUpdate, not null)
    - Indexes: clerk_user_id, status, org_id
    - `workshopMembers` table: id (PK), workshop_id (FK to workshops.id, cascade delete, not null), clerk_user_id (text, not null), role (text, not null — extensible: 'owner', 'editor', 'viewer'), created_at (defaultNow, not null)
    - Indexes: workshop_id, clerk_user_id
    - Add unique constraint on (workshop_id, clerk_user_id) to prevent duplicate memberships

    **src/db/schema/steps.ts:**
    - `stepDefinitions` table: id (text PK — semantic IDs like 'empathize', 'define', NOT cuid2), order (integer, not null), name (text, not null), description (text, not null), prompt_template (text, nullable), created_at (defaultNow, not null), updated_at (defaultNow + $onUpdate, not null)
    - Note: stepDefinitions uses semantic string IDs (e.g., 'empathize'), not generated cuid2 — these are reference data, not user-generated rows
    - `workshopSteps` table: id (PK, cuid2), workshop_id (FK to workshops.id, cascade delete, not null), step_id (FK to stepDefinitions.id, not null), status (text, typed as 'not_started'|'in_progress'|'complete', not null, default 'not_started'), output (jsonb, nullable, typed as Record<string, unknown>), started_at (timestamp, nullable), completed_at (timestamp, nullable), created_at (defaultNow, not null), updated_at (defaultNow + $onUpdate, not null)
    - Indexes: workshop_id, step_id, status
    - Import `workshops` from './workshops' for FK reference
    - Import `integer` and `jsonb` from 'drizzle-orm/pg-core'

    **src/db/schema/sessions.ts:**
    - `sessions` table: id (PK, cuid2), workshop_id (FK to workshops.id, cascade delete, not null), started_at (timestamp, defaultNow, not null), ended_at (timestamp, nullable), created_at (defaultNow, not null)
    - Note: lean session data — timestamps only per user decision. No updated_at needed (sessions are write-once, close-once).
    - Indexes: workshop_id

    **src/db/schema/build-packs.ts:**
    - `buildPacks` table: id (PK, cuid2), workshop_id (FK to workshops.id, cascade delete, not null), title (text, not null), format_type (text, typed as 'markdown'|'pdf'|'json', not null, default 'markdown'), content (text, nullable — assembled from step outputs at generation time), created_at (defaultNow, not null), updated_at (defaultNow + $onUpdate, not null)
    - Indexes: workshop_id
    - Note: content is assembled from CURRENT step outputs at generation time, not snapshots — per user decision

    Import createId (or createPrefixedId if implemented in Plan 01) from '@/lib/ids' for all $defaultFn callbacks.
  </action>
  <verify>
    - All 4 schema files exist in src/db/schema/
    - Each file exports table definitions using pgTable()
    - All foreign keys have corresponding index definitions
    - All timestamps use precision: 3
    - No enum types used (text with $type<> instead)
    - No deleted_at columns (hard deletes per user decision)
    - No local users table (clerk_user_id references only)
    - `npx tsc --noEmit` passes
  </verify>
  <done>6 tables defined across 4 files: workshops, workshop_members, step_definitions, workshop_steps, sessions, build_packs. All with proper indexes, FK constraints, timestamps, and TypeScript types.</done>
</task>

<task type="auto">
  <name>Task 2: Define Drizzle relations, barrel exports, and inferred types</name>
  <files>
    src/db/schema/relations.ts
    src/db/schema/index.ts
    src/db/types.ts
  </files>
  <action>
    1. Create `src/db/schema/relations.ts`:
       - Import `relations` from `'drizzle-orm'`
       - Import all tables from their respective schema files
       - Define relations for relational queries (db.query.workshops.findFirst with `with:` option):

       ```
       workshopsRelations: workshops -> many(workshopSteps), many(workshopMembers), many(sessions), many(buildPacks)
       workshopMembersRelations: workshopMembers -> one(workshops, fields: [workshopId], references: [workshops.id])
       stepDefinitionsRelations: stepDefinitions -> many(workshopSteps)
       workshopStepsRelations: workshopSteps -> one(workshops, ...), one(stepDefinitions, ...)
       sessionsRelations: sessions -> one(workshops, ...)
       buildPacksRelations: buildPacks -> one(workshops, ...)
       ```

       Use exact Drizzle relations API: `relations(tableName, ({ one, many }) => ({ ... }))`

    2. Update `src/db/schema/index.ts`:
       - Re-export everything from all schema files:
         ```
         export * from './workshops';
         export * from './steps';
         export * from './sessions';
         export * from './build-packs';
         export * from './relations';
         ```

    3. Create `src/db/types.ts`:
       - Import `InferSelectModel` and `InferInsertModel` from `'drizzle-orm'`
       - Import all table definitions from `'./schema'`
       - Export inferred types for each table:
         ```
         export type Workshop = InferSelectModel<typeof workshops>;
         export type NewWorkshop = InferInsertModel<typeof workshops>;
         export type WorkshopMember = InferSelectModel<typeof workshopMembers>;
         export type NewWorkshopMember = InferInsertModel<typeof workshopMembers>;
         // ... same pattern for all 6 tables
         ```
       - These types are used throughout the app for type-safe database operations
  </action>
  <verify>
    - `src/db/schema/relations.ts` exports 6 relation definitions
    - `src/db/schema/index.ts` re-exports from all 5 schema files (4 tables + 1 relations)
    - `src/db/types.ts` exports Select and Insert types for all 6 tables (12 type exports)
    - `npx tsc --noEmit` passes with no errors
    - Verify relations are correctly wired: `import { db } from '@/db/client'` should enable `db.query.workshops.findFirst({ with: { members: true } })` (compile check only, no runtime query needed)
  </verify>
  <done>Relations defined for all tables enabling Drizzle relational queries. Barrel file exports all schemas. TypeScript types inferred for type-safe database operations throughout the app.</done>
</task>

</tasks>

<verification>
1. All 6 tables defined: workshops, workshop_members, step_definitions, workshop_steps, sessions, build_packs
2. All tables use snake_case columns, plural table names, text PKs with cuid2
3. step_definitions uses semantic string IDs (not cuid2)
4. Foreign keys: workshop_steps -> workshops + step_definitions, sessions -> workshops, build_packs -> workshops, workshop_members -> workshops
5. All FKs have cascade delete and corresponding indexes
6. No enum types, no soft deletes, no local users table
7. Relations enable `db.query.workshops.findFirst({ with: { steps: true, members: true } })`
8. TypeScript types inferred for all tables (Select + Insert variants)
9. `npx tsc --noEmit` passes
</verification>

<success_criteria>
- Complete Drizzle schema compiles without TypeScript errors
- All user-locked decisions implemented (check against CONTEXT.md decisions list)
- Schema is ready for `drizzle-kit push` in Plan 03
- Types are ready for use in API routes and server components
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-database/01-02-SUMMARY.md`
</output>
