---
phase: 01-foundation-database
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - src/app/api/health/route.ts
  - package.json
  - drizzle/seed/step-definitions.sql
autonomous: false

must_haves:
  truths:
    - "GET /api/health returns 200 with {status: 'healthy'} when database is connected"
    - "GET /api/health returns 500 with {status: 'unhealthy'} when database is unreachable"
    - "drizzle-kit push successfully creates all 6 tables in Neon dev branch"
    - "Step definitions for all 10 design thinking steps exist in the database"
    - "npm scripts exist for db:push:dev, db:generate, db:migrate, db:studio, and vercel-build"
  artifacts:
    - path: "src/app/api/health/route.ts"
      provides: "Health check endpoint verifying database connectivity"
      exports: ["GET"]
      contains: "SELECT 1"
    - path: "package.json"
      provides: "Database management scripts"
      contains: "db:push:dev"
    - path: "drizzle/seed/step-definitions.sql"
      provides: "SQL seed for 10 design thinking step definitions"
      contains: "ON CONFLICT"
  key_links:
    - from: "src/app/api/health/route.ts"
      to: "src/db/client.ts"
      via: "db import for connectivity check"
      pattern: "import.*db.*from.*db/client"
    - from: "package.json"
      to: "drizzle-kit"
      via: "npm scripts calling drizzle-kit commands"
      pattern: "drizzle-kit (push|generate|migrate|studio)"
---

<objective>
Push schema to Neon, seed step definitions, create health check endpoint, and configure npm scripts for database workflows. Verify end-to-end database connectivity.

Purpose: This plan proves the entire foundation works — schema pushed to real database, reference data seeded, health endpoint confirming connectivity, and developer scripts ready for daily use. After this plan, Phase 1 success criteria are met.
Output: Working /api/health endpoint, 6 tables in Neon, 10 step definitions seeded, complete npm script suite.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-database/01-CONTEXT.md
@.planning/phases/01-foundation-database/01-RESEARCH.md
@.planning/phases/01-foundation-database/01-01-SUMMARY.md
@.planning/phases/01-foundation-database/01-02-SUMMARY.md
@src/db/client.ts
@src/db/schema/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create health check endpoint and npm scripts</name>
  <files>
    src/app/api/health/route.ts
    package.json
  </files>
  <action>
    1. Create `src/app/api/health/route.ts`:
       - Import `db` from `'@/db/client'`
       - Import `sql` from `'drizzle-orm'`
       - Import `NextResponse` from `'next/server'`
       - Export async GET handler
       - Execute `db.execute(sql\`SELECT 1 as health\`)` inside try/catch
       - Add 5-second timeout using Promise.race pattern (from RESEARCH.md Pattern 7)
       - On success: return 200 with `{ status: 'healthy', database: 'connected', timestamp: new Date().toISOString() }`
       - On error: return 500 with `{ status: 'unhealthy', database: 'disconnected', error: error.message }`
       - Do NOT add `export const runtime = 'edge'` — leave as default Node.js runtime for now. Edge runtime can be added later when verified with Neon HTTP driver in production.

    2. Update `package.json` scripts — add these scripts alongside existing ones:
       ```
       "db:push:dev": "drizzle-kit push",
       "db:generate": "drizzle-kit generate",
       "db:migrate": "drizzle-kit migrate",
       "db:studio": "drizzle-kit studio",
       "db:seed": "psql $DATABASE_URL -f drizzle/seed/step-definitions.sql",
       "vercel-build": "npm run db:migrate && npm run build"
       ```
       Keep all existing scripts (dev, build, start, lint) unchanged.
       Note: `vercel-build` runs migrations before build for production auto-deploy.
  </action>
  <verify>
    - `src/app/api/health/route.ts` exists with GET export
    - `package.json` contains all 6 new db scripts
    - `npm run build` succeeds (TypeScript compilation check)
  </verify>
  <done>Health check endpoint created at /api/health. All database management scripts added to package.json including vercel-build for production auto-migration.</done>
</task>

<task type="auto">
  <name>Task 2: Push schema to Neon and seed step definitions</name>
  <files>
    drizzle/seed/step-definitions.sql
  </files>
  <action>
    1. Create `drizzle/seed/step-definitions.sql`:
       - INSERT all 10 design thinking step definitions with ON CONFLICT DO UPDATE (idempotent)
       - Use the exact step IDs and names from the WorkshopPilot design:
         1. empathize - "Empathize" - "Understand your users and their needs deeply through research and observation"
         2. define - "Define" - "Synthesize research into a clear problem statement"
         3. ideate - "Ideate" - "Generate a wide range of creative solutions"
         4. prototype - "Prototype" - "Create low-fidelity representations of your solutions"
         5. test - "Test" - "Validate prototypes with real users and gather feedback"
         6. prioritize - "Prioritize" - "Evaluate and rank features for your minimum viable product"
         7. architect - "Architect" - "Design the technical architecture and system structure"
         8. spec - "Spec" - "Write detailed product requirements and specifications"
         9. story - "Story" - "Break specifications into actionable user stories"
         10. pack - "Pack" - "Assemble the complete Build Pack for development handoff"
       - Use ON CONFLICT (id) DO UPDATE SET for all fields to make re-runs safe
       - Leave prompt_template as NULL for now (will be populated in AI phase)

    2. Run `npm run db:push:dev` to push schema to Neon dev branch:
       - This requires DATABASE_URL to be set in .env.local
       - If DATABASE_URL is not set, this will fail — that's expected and will be handled by user_setup
       - drizzle-kit push will create all 6 tables in Neon

    3. After schema push succeeds, run the seed:
       - Execute the step definitions SQL against the database
       - If psql is not available, use an alternative: create a TypeScript seed script that uses the db client directly
       - Alternative approach: create `scripts/seed-steps.ts` that imports db and stepDefinitions, then uses db.insert().values().onConflictDoUpdate()

    4. Verify by querying:
       - Use drizzle-kit studio (`npm run db:studio`) or direct query to confirm:
         - 6 tables exist
         - step_definitions has 10 rows
         - All tables have correct columns and indexes

    IMPORTANT: If DATABASE_URL is not configured, document clearly what failed and why. The user_setup in Plan 01 frontmatter covers Neon project/branch creation.
  </action>
  <verify>
    - `npm run db:push:dev` completes without errors (schema pushed to Neon)
    - `drizzle/seed/step-definitions.sql` exists with 10 step definitions and ON CONFLICT clause
    - Step definitions are in the database (verify via db:studio or health check query)
    - `curl http://localhost:3000/api/health` returns 200 with `{ status: 'healthy' }` (requires dev server running)
  </verify>
  <done>All 6 tables created in Neon dev branch. 10 step definitions seeded. Health check endpoint confirms database connectivity.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete database foundation: 6 tables pushed to Neon, 10 step definitions seeded, health check endpoint, and all npm scripts configured.</what-built>
  <how-to-verify>
    1. Start the dev server: `npm run dev`
    2. Visit http://localhost:3000/api/health in your browser
    3. Expected: JSON response `{ "status": "healthy", "database": "connected", "timestamp": "..." }`
    4. Run `npm run db:studio` to open Drizzle Studio
    5. Verify 6 tables are visible: workshops, workshop_members, step_definitions, workshop_steps, sessions, build_packs
    6. Click on step_definitions table — verify 10 rows with correct step names and order
    7. Check that workshop_members has a unique constraint on (workshop_id, clerk_user_id)
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues with the schema, health check, or database state</resume-signal>
</task>

</tasks>

<verification>
1. GET /api/health returns 200 with healthy status
2. 6 tables exist in Neon: workshops, workshop_members, step_definitions, workshop_steps, sessions, build_packs
3. step_definitions contains exactly 10 rows (empathize through pack)
4. All npm scripts work: db:push:dev, db:generate, db:migrate, db:studio, vercel-build
5. drizzle/seed/step-definitions.sql is idempotent (can run multiple times safely)
6. vercel-build script chains migration + build correctly
</verification>

<success_criteria>
- Health check proves end-to-end Neon connectivity from Next.js
- Schema matches all locked decisions from CONTEXT.md
- Step definitions seeded for all 10 design thinking steps
- Developer workflow scripts ready for daily use
- Phase 1 success criteria fully met:
  1. Neon Postgres database accepts connections from local dev [health check proves this]
  2. Drizzle ORM schema defines core tables [6 tables pushed]
  3. Database queries execute in serverless environment using edge-compatible driver [neon-http driver]
  4. Migrations run successfully and schema matches code [db:push:dev succeeded]
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-database/01-03-SUMMARY.md`
</output>
