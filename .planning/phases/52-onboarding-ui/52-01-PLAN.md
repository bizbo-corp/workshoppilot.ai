---
phase: 52-onboarding-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/dashboard/welcome-modal.tsx
  - src/app/dashboard/page.tsx
autonomous: true
requirements:
  - ONBD-01
  - ONBD-02
  - ONBD-03

must_haves:
  truths:
    - "A new authenticated user visiting the dashboard for the first time sees a welcome modal explaining the app, chat/canvas/steps layout, and the taste-test model"
    - "Dismissing the modal via the CTA button or X close button calls markOnboardingComplete() and the modal never reappears"
    - "Signing in from a different browser or device after dismissal does not show the modal — users.onboardingComplete in Neon is the source of truth"
    - "The welcome modal is rendered client-side only with no hydration mismatches"
  artifacts:
    - path: "src/components/dashboard/welcome-modal.tsx"
      provides: "Welcome modal Dialog component for first-time users"
      exports: ["WelcomeModal"]
    - path: "src/app/dashboard/page.tsx"
      provides: "Dashboard page with showWelcomeModal prop wiring"
      contains: "WelcomeModal"
  key_links:
    - from: "src/app/dashboard/page.tsx"
      to: "src/components/dashboard/welcome-modal.tsx"
      via: "showWelcomeModal={!user.onboardingComplete} prop"
      pattern: "WelcomeModal.*showWelcomeModal"
    - from: "src/components/dashboard/welcome-modal.tsx"
      to: "src/actions/billing-actions.ts"
      via: "markOnboardingComplete() server action call on dismiss"
      pattern: "markOnboardingComplete"
---

<objective>
Create the welcome modal for first-time users and wire it into the dashboard page.

Purpose: New users need orientation to the app's three key areas (AI chat, canvas, step navigation) and the taste-test model (Steps 1-6 free). The modal must persist dismissal state cross-device via the existing DB-backed `onboardingComplete` flag.

Output: `welcome-modal.tsx` component + modified `dashboard/page.tsx` with server-side prop injection.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/52-onboarding-ui/52-RESEARCH.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->
<!-- Executor should use these directly -- no codebase exploration needed. -->

From src/actions/billing-actions.ts:
```typescript
export async function markOnboardingComplete(): Promise<void>;
// 'use server' — sets users.onboardingComplete = true via Drizzle UPDATE.
// Authenticates via auth(). Idempotent. Returns early for unauthenticated callers.
```

From src/components/ui/dialog.tsx:
```typescript
export { Dialog, DialogClose, DialogContent, DialogDescription, DialogFooter,
         DialogHeader, DialogOverlay, DialogPortal, DialogTitle, DialogTrigger };
// DialogContent has showCloseButton?: boolean (default true) — X button renders automatically.
// DialogContent onOpenChange fires on X click, Escape key, and overlay click.
```

From src/app/dashboard/page.tsx (current user query):
```typescript
// Line 38-40: Full user row fetch — no columns: restriction
const user = await db.query.users.findFirst({
  where: eq(users.clerkUserId, userId),
});
// user.onboardingComplete is available — boolean, default false from Phase 47 migration
```

From src/components/ui/button.tsx:
```typescript
export { Button, buttonVariants };
// Standard shadcn Button with variant, size props
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WelcomeModal component</name>
  <files>src/components/dashboard/welcome-modal.tsx</files>
  <action>
Create `src/components/dashboard/welcome-modal.tsx` as a `'use client'` component using shadcn Dialog.

**Component structure:**

```typescript
'use client';

import { useState } from 'react';
import { Sparkles, MessageSquare, LayoutGrid, ListChecks } from 'lucide-react';
import { markOnboardingComplete } from '@/actions/billing-actions';
import {
  Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';

interface WelcomeModalProps {
  showWelcomeModal: boolean;
}

export function WelcomeModal({ showWelcomeModal }: WelcomeModalProps) {
  const [open, setOpen] = useState(showWelcomeModal);
  // ...
}
```

**Critical implementation details:**

1. **State initialization from prop:** `const [open, setOpen] = useState(showWelcomeModal)` — NOT `useState(true)`. The prop is computed server-side from `!user.onboardingComplete`. This prevents hydration mismatches and ensures the modal is only open when the server says so.

2. **Dismiss handler (async):**
   ```typescript
   async function handleDismiss() {
     setOpen(false);              // Close immediately (sync)
     await markOnboardingComplete(); // Persist to DB (async)
   }
   ```
   Call `setOpen(false)` FIRST so the dialog closes instantly. The server action runs async in the background.

3. **Wire onOpenChange for all dismiss paths:**
   ```typescript
   <Dialog open={open} onOpenChange={(isOpen) => {
     if (!isOpen) handleDismiss();
   }}>
   ```
   This catches: X button click, Escape key, overlay click, AND the CTA button. All paths call `markOnboardingComplete()`.

4. **Modal content — three key areas:**
   - **AI Chat** (MessageSquare icon): "Ask questions, get guidance, and brainstorm with your AI facilitator"
   - **Canvas** (LayoutGrid icon): "Visualize your ideas with mind maps, sketches, and concept cards"
   - **Steps** (ListChecks icon): "Follow 10 design thinking steps from vague idea to validated Build Pack"

5. **Taste-test model explanation:**
   Below the three areas, add a brief note: "Steps 1-6 are free — experience the full workshop flow before deciding to unlock your Build Pack."

6. **CTA button:** "Get Started" — calls `handleDismiss()` via `onClick`.

7. **Dialog sizing:** Use `className="sm:max-w-lg"` on DialogContent for a comfortable reading width.

8. **Visual design — follow project conventions:**
   - Sparkles icon in an olive circle at the top (same pattern as UpgradeDialog's Lock icon in olive circle)
   - Title: "Welcome to WorkshopPilot"
   - Description below title (use DialogDescription)
   - Each feature area as a row with icon + text (icon in a small muted rounded container)
   - Use olive color accents for icons: `text-olive-700 dark:text-olive-400`
   - Use `bg-olive-100 dark:bg-olive-900/50` for icon containers

**Do NOT:**
- Use localStorage for any state
- Use useEffect to control dialog open state (causes flash)
- Make the dialog an SSR-rendered component (must be 'use client')
- Add navigation to the CTA (just dismiss — the dashboard has its own "Start Workshop" CTA)
  </action>
  <verify>
    <automated>ls -la src/components/dashboard/welcome-modal.tsx && grep -c "use client" src/components/dashboard/welcome-modal.tsx && grep -c "markOnboardingComplete" src/components/dashboard/welcome-modal.tsx && grep -c "useState(showWelcomeModal)" src/components/dashboard/welcome-modal.tsx && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
  </verify>
  <done>WelcomeModal component exists with 'use client' directive, imports markOnboardingComplete, initializes open state from showWelcomeModal prop, handles all dismiss paths (X, Escape, CTA) via onOpenChange, and passes TypeScript type checking.</done>
</task>

<task type="auto">
  <name>Task 2: Wire WelcomeModal into dashboard page</name>
  <files>src/app/dashboard/page.tsx</files>
  <action>
Modify `src/app/dashboard/page.tsx` to pass `showWelcomeModal` prop to the WelcomeModal component.

**Step 1: Add import at the top of the file (with the other component imports):**

```typescript
import { WelcomeModal } from '@/components/dashboard/welcome-modal';
```

**Step 2: Add WelcomeModal to the JSX return.**

The dashboard page already fetches `user` (full row, line 38-40) which includes `onboardingComplete`. Insert the WelcomeModal BEFORE the `<MigrationCheck />` component, inside the existing `<>` fragment:

```typescript
return (
  <>
    {/* Welcome modal for first-time users */}
    <WelcomeModal showWelcomeModal={!user.onboardingComplete} />

    {/* Migration check component - triggers anonymous session migration */}
    <MigrationCheck />
    {/* ... rest of existing JSX unchanged ... */}
  </>
);
```

**Critical details:**

1. The `user` variable is already fetched at line 38 with NO `columns:` restriction, so `user.onboardingComplete` is available. No additional DB query needed.

2. The modal MUST be placed AFTER the `if (!user)` guard (line 44-71) — by the time we reach the return statement, `user` is guaranteed to exist.

3. Do NOT render WelcomeModal in the unauthenticated or loading states (the early returns at lines 23-71 already handle those cases). The modal only appears in the authenticated, user-exists branch.

4. Do NOT modify `dashboard/layout.tsx` — the modal belongs in `page.tsx` only (dashboard home), not on all dashboard routes.

5. Do NOT add a separate DB query for `onboardingComplete` — it's already in the `user` object from the existing query.

**What NOT to change:**
- Do not modify any existing components, queries, or business logic in the file
- Do not move the user query or add columns restrictions
- Do not change the page's `force-dynamic` export
  </action>
  <verify>
    <automated>grep -n "WelcomeModal" src/app/dashboard/page.tsx && grep -n "showWelcomeModal" src/app/dashboard/page.tsx && grep -n "onboardingComplete" src/app/dashboard/page.tsx && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
  </verify>
  <done>Dashboard page imports WelcomeModal, passes `showWelcomeModal={!user.onboardingComplete}` as prop, modal renders before MigrationCheck in the authenticated return path, and TypeScript compiles without errors.</done>
</task>

</tasks>

<verification>
1. **TypeScript compilation:** `npx tsc --noEmit` passes with zero errors
2. **Component exists:** `src/components/dashboard/welcome-modal.tsx` exists with `'use client'` directive
3. **Server action wiring:** `markOnboardingComplete` is imported and called in the dismiss handler
4. **State pattern:** `useState(showWelcomeModal)` initializes from server prop (not hardcoded true)
5. **Dashboard wiring:** `WelcomeModal` is imported and rendered in `src/app/dashboard/page.tsx` with `showWelcomeModal={!user.onboardingComplete}`
6. **No new DB queries:** The existing `db.query.users.findFirst()` call in dashboard page.tsx is unchanged — no additional queries added
7. **No localStorage:** grep for `localStorage` in welcome-modal.tsx returns zero hits
</verification>

<success_criteria>
- New authenticated user with `onboardingComplete=false` sees the welcome modal on dashboard load
- Modal explains three key areas: AI chat, canvas, and steps
- Modal mentions the taste-test model (Steps 1-6 free)
- Clicking "Get Started", the X button, pressing Escape, or clicking overlay all dismiss the modal AND call markOnboardingComplete()
- After dismissal, refreshing the page does NOT show the modal again (DB state persists)
- Existing users with `onboardingComplete=true` never see the modal
- No hydration mismatches in browser console
</success_criteria>

<output>
After completion, create `.planning/phases/52-onboarding-ui/52-01-SUMMARY.md`
</output>
