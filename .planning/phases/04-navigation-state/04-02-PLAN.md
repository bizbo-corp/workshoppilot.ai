---
phase: 04-navigation-state
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/components/layout/workshop-sidebar.tsx
  - src/components/layout/mobile-stepper.tsx
  - src/components/workshop/step-navigation.tsx
  - src/app/workshop/[sessionId]/step/[stepId]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Sidebar shows checkmark for complete steps, highlight for current step, disabled/grayed for not_started steps"
    - "User cannot click on not_started steps in sidebar or mobile stepper"
    - "User can click Next button to advance to next step (marks current complete, next in_progress)"
    - "User can click Back button to return to previous step"
    - "User cannot skip ahead by typing URL of a not_started step (redirected to current step)"
    - "Step completion state persists across navigation and page refresh"
    - "MobileStepper determines current step from pathname (not hardcoded prop)"
  artifacts:
    - path: "src/components/layout/workshop-sidebar.tsx"
      provides: "Database-driven step status display with disabled not_started steps"
    - path: "src/components/layout/mobile-stepper.tsx"
      provides: "Database-driven mobile stepper with pathname-based current step detection"
    - path: "src/components/workshop/step-navigation.tsx"
      provides: "Next/Back navigation buttons with async state management"
    - path: "src/app/workshop/[sessionId]/step/[stepId]/page.tsx"
      provides: "Server-side sequential enforcement via redirect"
  key_links:
    - from: "src/components/workshop/step-navigation.tsx"
      to: "src/actions/workshop-actions.ts"
      via: "advanceToNextStep server action call"
      pattern: "advanceToNextStep"
    - from: "src/components/layout/workshop-sidebar.tsx"
      to: "workshopSteps prop"
      via: "Status lookup from workshopSteps array prop"
      pattern: "workshopSteps"
    - from: "src/app/workshop/[sessionId]/step/[stepId]/page.tsx"
      to: "src/db/schema/steps.ts"
      via: "Database query to validate step access"
      pattern: "status.*not_started.*redirect"
---

<objective>
Wire sidebar, mobile stepper, and step pages to database step state. Create Next/Back navigation buttons. Implement sequential enforcement preventing skip-ahead.

Purpose: This is the UI layer of Phase 4 that makes navigation functional. Users see accurate progress (complete/current/upcoming), navigate forward and backward, and are prevented from skipping to steps they haven't reached yet.

Output: Updated sidebar and mobile stepper showing real step states, new StepNavigation component with Next/Back buttons, and step page with server-side sequential enforcement.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-navigation-state/04-RESEARCH.md
@.planning/phases/04-navigation-state/04-01-SUMMARY.md

# Files to modify
@src/components/layout/workshop-sidebar.tsx
@src/components/layout/mobile-stepper.tsx
@src/app/workshop/[sessionId]/step/[stepId]/page.tsx

# Reference files
@src/actions/workshop-actions.ts
@src/lib/workshop/step-metadata.ts
@src/db/schema/steps.ts
@src/db/schema/relations.ts
@src/app/workshop/[sessionId]/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update WorkshopSidebar and MobileStepper for database-driven step states</name>
  <files>
    src/components/layout/workshop-sidebar.tsx
    src/components/layout/mobile-stepper.tsx
  </files>
  <action>
**WorkshopSidebar (`src/components/layout/workshop-sidebar.tsx`):**

1. Update the `WorkshopSidebarProps` interface to accept `workshopSteps`:
   ```typescript
   interface WorkshopSidebarProps {
     sessionId: string;
     workshopSteps: Array<{
       stepId: string;
       status: 'not_started' | 'in_progress' | 'complete';
     }>;
   }
   ```

2. Replace the current completion logic (lines 88-90):
   ```typescript
   // OLD: const isComplete = currentStepNumber ? step.order < currentStepNumber : false;
   ```
   With database-driven logic:
   ```typescript
   const statusLookup = new Map(workshopSteps.map(s => [s.stepId, s.status]));
   // Inside the STEPS.map():
   const status = statusLookup.get(step.id) || 'not_started';
   const isComplete = status === 'complete';
   const isCurrent = step.order === currentStepNumber;
   const isAccessible = status !== 'not_started';
   ```
   Create the `statusLookup` Map ONCE above the return statement (not inside the map callback).

3. Update the step rendering to disable not_started steps:
   - When `isAccessible` is true: render as `<Link>` (existing behavior)
   - When `isAccessible` is false: render as a `<div>` with `className="cursor-not-allowed opacity-50"` instead of a Link
   - Use `asChild={isAccessible}` on `SidebarMenuButton`
   - Keep the existing step indicator styling (checkmark for complete, border for current, muted for upcoming)

4. Keep ALL existing functionality: sidebar collapse/expand, Cmd+B shortcut, localStorage persistence, loading skeleton, Logo rendering.

**MobileStepper (`src/components/layout/mobile-stepper.tsx`):**

1. Update the interface — remove `currentStep` prop, add `workshopSteps`:
   ```typescript
   interface MobileStepperProps {
     sessionId: string;
     workshopSteps: Array<{
       stepId: string;
       status: 'not_started' | 'in_progress' | 'complete';
     }>;
   }
   ```

2. Determine current step from pathname using `usePathname()`:
   ```typescript
   import { usePathname } from 'next/navigation';
   // Inside component:
   const pathname = usePathname();
   const stepMatch = pathname.match(/\/workshop\/[^/]+\/step\/(\d+)/);
   const currentStep = stepMatch ? parseInt(stepMatch[1], 10) : 1;
   ```

3. Replace URL-based completion inference with database state lookup:
   ```typescript
   const statusLookup = new Map(workshopSteps.map(s => [s.stepId, s.status]));
   // In STEPS.map:
   const status = statusLookup.get(step.id) || 'not_started';
   const isComplete = status === 'complete';
   const isCurrent = step.order === currentStep;
   const isAccessible = status !== 'not_started';
   ```

4. Disable not_started steps in the sheet step list:
   - Accessible steps: keep as `<Link>` with onClick close behavior
   - Not_started steps: render as `<div>` with `cursor-not-allowed opacity-50` — no Link, no click handler
   - Keep existing visual styling (checkmark for complete, highlighted border for current, muted for not_started)

5. Keep ALL existing functionality: Sheet trigger with "Step X of Y" text, step descriptions in sheet, close-on-navigate behavior.
  </action>
  <verify>
Run `npx tsc --noEmit` — should compile without errors. Visually check sidebar and mobile stepper show correct step states when running `npm run dev`.
  </verify>
  <done>
WorkshopSidebar shows database-driven step states: checkmark for complete, highlighted for current, grayed+disabled for not_started. MobileStepper uses usePathname for current step detection (no more hardcoded prop). Not_started steps are non-clickable in both components.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create StepNavigation component and add sequential enforcement to step page</name>
  <files>
    src/components/workshop/step-navigation.tsx
    src/app/workshop/[sessionId]/step/[stepId]/page.tsx
  </files>
  <action>
**StepNavigation component (`src/components/workshop/step-navigation.tsx`):**

Create a new client component with 'use client' directive:

1. Props interface:
   ```typescript
   interface StepNavigationProps {
     sessionId: string;
     workshopId: string;
     currentStepOrder: number;
   }
   ```

2. Import `useRouter` from `next/navigation`, `useState` from React, `Button` from `@/components/ui/button`, `ChevronLeft` and `ChevronRight` from `lucide-react`, `advanceToNextStep` from `@/actions/workshop-actions`, and `STEPS` from `@/lib/workshop/step-metadata`.

3. Implement navigation logic:
   - `isFirstStep = currentStepOrder === 1`
   - `isLastStep = currentStepOrder === STEPS.length`
   - Track `isNavigating` state (boolean, default false) to prevent double-clicks

4. `handleNext` async function:
   - Guard: if `isNavigating || isLastStep` return early
   - Set `isNavigating = true`
   - Find current step and next step from STEPS array by order
   - Call `await advanceToNextStep(workshopId, currentStep.id, nextStep.id, sessionId)`
   - Call `router.push(\`/workshop/\${sessionId}/step/\${currentStepOrder + 1}\`)`
   - In finally block: set `isNavigating = false`
   - Wrap in try/catch, console.error on failure

5. `handleBack` function:
   - Guard: if `isFirstStep` return early
   - `router.push(\`/workshop/\${sessionId}/step/\${currentStepOrder - 1}\`)`
   - No database state change needed for going back (user is revisiting a completed step)

6. Render a bottom bar with flex justify-between:
   ```tsx
   <div className="flex items-center justify-between border-t bg-background px-6 py-4">
     {/* Left: Back button (hidden on step 1) */}
     {!isFirstStep ? (
       <Button variant="ghost" onClick={handleBack} disabled={isNavigating}>
         <ChevronLeft className="mr-2 h-4 w-4" />
         Back
       </Button>
     ) : (
       <div /> {/* Spacer */}
     )}

     {/* Right: Next button (hidden on step 10) */}
     {!isLastStep ? (
       <Button onClick={handleNext} disabled={isNavigating}>
         {isNavigating ? 'Advancing...' : 'Next'}
         {!isNavigating && <ChevronRight className="ml-2 h-4 w-4" />}
       </Button>
     ) : (
       <div /> {/* Spacer */}
     )}
   </div>
   ```

**Step Page (`src/app/workshop/[sessionId]/step/[stepId]/page.tsx`):**

1. Add imports: `db` from `@/db/client`, `sessions` from `@/db/schema`, `eq` from `drizzle-orm`, `redirect` from `next/navigation`, `STEPS` from `@/lib/workshop/step-metadata`, `StepNavigation` from `@/components/workshop/step-navigation`.

2. Add database query to fetch session with workshop and steps:
   ```typescript
   const session = await db.query.sessions.findFirst({
     where: eq(sessions.id, sessionId),
     with: {
       workshop: {
         with: {
           steps: true,
         },
       },
     },
   });

   if (!session) redirect('/dashboard');
   ```

3. Add sequential enforcement AFTER step metadata lookup:
   ```typescript
   const stepRecord = session.workshop.steps.find(s => s.stepId === step.id);

   if (stepRecord?.status === 'not_started') {
     // Find the current in_progress step (or first not_started if none in_progress)
     const activeStep = session.workshop.steps.find(s => s.status === 'in_progress');
     if (activeStep) {
       const activeStepDef = STEPS.find(s => s.id === activeStep.stepId);
       redirect(`/workshop/${sessionId}/step/${activeStepDef?.order || 1}`);
     }
     redirect(`/workshop/${sessionId}/step/1`);
   }
   ```

4. Add StepNavigation component below the step content area:
   ```tsx
   return (
     <div className="flex h-full flex-col">
       {/* Step header (existing) */}
       <div className="border-b bg-background px-6 py-4">
         <h1 className="text-xl font-semibold">Step {step.order}: {step.name}</h1>
         <p className="mt-1 text-sm text-muted-foreground">{step.description}</p>
       </div>

       {/* Step content area (existing) */}
       <div className="flex-1 overflow-hidden">
         <StepContainer stepOrder={stepNumber} />
       </div>

       {/* Navigation buttons (NEW) */}
       <StepNavigation
         sessionId={sessionId}
         workshopId={session.workshop.id}
         currentStepOrder={stepNumber}
       />
     </div>
   );
   ```

5. Keep the existing step number validation (1-10 range check) and getStepByOrder lookup.
  </action>
  <verify>
Run `npx tsc --noEmit` — all files compile without errors. Run `npm run dev` and verify:
1. Step 1 shows "Next" button but no "Back" button
2. Clicking "Next" advances to step 2 and sidebar updates
3. Step 2 shows both "Back" and "Next" buttons
4. Manually navigating to `/workshop/{id}/step/5` when only step 1-2 are completed redirects to current step
5. Step 10 shows "Back" button but no "Next" button
  </verify>
  <done>
StepNavigation component renders Next/Back buttons. Next button marks current step complete and next step in_progress before navigating. Back button navigates without state change. Step page redirects users who try to access not_started steps. Sequential enforcement works both via UI (disabled sidebar links) and route level (redirect).
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` compiles without errors
2. `npm run dev` — full navigation flow works:
   a. Start new workshop → lands on step 1
   b. Sidebar shows step 1 highlighted (current), steps 2-10 grayed (not_started)
   c. Click "Next" → step 1 gets checkmark, step 2 becomes current
   d. Click "Back" → returns to step 1 (still shows checkmark)
   e. Navigate forward to step 2 → step 2 is current
   f. Type URL for step 5 → redirected to step 2 (current in_progress step)
   g. Mobile stepper shows correct "Step X of 10" based on pathname
   h. Refresh page → step states persist from database
3. "Next" button shows "Advancing..." during processing (prevents double-click)
4. Step 10 has no "Next" button, Step 1 has no "Back" button
</verification>

<success_criteria>
Complete navigation flow: sidebar and mobile stepper reflect database step states, Next/Back buttons advance through steps, sequential enforcement prevents skipping ahead via both UI and direct URL access, step completion state persists across navigation and page refresh.
</success_criteria>

<output>
After completion, create `.planning/phases/04-navigation-state/04-02-SUMMARY.md`
</output>
