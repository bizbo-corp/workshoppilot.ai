---
phase: 04-navigation-state
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/actions/workshop-actions.ts
  - src/app/workshop/[sessionId]/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Workshop layout fetches step completion state from database"
    - "Server action can mark a step complete and next step in_progress atomically"
    - "Sidebar and mobile stepper receive step status data as serializable props"
  artifacts:
    - path: "src/actions/workshop-actions.ts"
      provides: "updateStepStatus and advanceToNextStep server actions"
      exports: ["updateStepStatus", "advanceToNextStep"]
    - path: "src/app/workshop/[sessionId]/layout.tsx"
      provides: "Workshop layout with step status data fetching and prop passing"
  key_links:
    - from: "src/actions/workshop-actions.ts"
      to: "src/db/schema/steps.ts"
      via: "Drizzle update on workshopSteps table"
      pattern: "db\\.update\\(workshopSteps\\)"
    - from: "src/app/workshop/[sessionId]/layout.tsx"
      to: "src/db/schema/steps.ts"
      via: "Drizzle relational query with: { steps: true }"
      pattern: "with:\\s*\\{[\\s\\S]*steps:\\s*true"
---

<objective>
Add server actions for step state management and update the workshop layout to fetch step completion state from the database and pass it to child components.

Purpose: This is the data foundation for Phase 4. Currently, sidebar/stepper infer completion from URL position (steps before current = complete), which is wrong. This plan replaces that with real database state, enabling accurate progress tracking and sequential enforcement.

Output: Updated workshop-actions.ts with step state server actions, updated layout.tsx fetching workshop steps and passing them as serializable props.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-navigation-state/04-RESEARCH.md

# Existing files to modify
@src/actions/workshop-actions.ts
@src/app/workshop/[sessionId]/layout.tsx

# Reference for database schema and relations
@src/db/schema/steps.ts
@src/db/schema/relations.ts
@src/lib/workshop/step-metadata.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add step state management server actions</name>
  <files>src/actions/workshop-actions.ts</files>
  <action>
Add two new exported server actions to the existing workshop-actions.ts file:

1. **updateStepStatus** — Updates a single workshop step's status in the database.
   - Parameters: `workshopId: string`, `stepId: string`, `status: 'not_started' | 'in_progress' | 'complete'`, `sessionId: string`
   - When status is `'complete'`, set `completedAt` to `new Date()`
   - When status is `'in_progress'`, set `startedAt` to `new Date()`
   - When status is `'not_started'`, set both `completedAt` and `startedAt` to `null`
   - Use `db.update(workshopSteps).set({...}).where(and(eq(workshopSteps.workshopId, workshopId), eq(workshopSteps.stepId, stepId)))`
   - Call `revalidatePath(\`/workshop/\${sessionId}\`)` after the update to refresh layout data
   - Wrap in try/catch, log error and rethrow

2. **advanceToNextStep** — Atomically marks current step complete and next step in_progress, returns next step order number.
   - Parameters: `workshopId: string`, `currentStepId: string`, `nextStepId: string`, `sessionId: string`
   - Calls updateStepStatus for current step with 'complete'
   - Calls updateStepStatus for next step with 'in_progress'
   - Returns `{ nextStepOrder: number }` by looking up the next step's order from the STEPS array
   - Wrap in try/catch, log error and rethrow

Import `and` from `drizzle-orm` (already importing `eq`). Import `revalidatePath` from `next/cache` at the top level (not dynamic import — keep consistent, but note renameWorkshop uses dynamic import; use top-level import for the new functions for simplicity). Import `STEPS` if not already imported (it is already imported).

Do NOT modify the existing `createWorkshopSession` or `renameWorkshop` functions.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no TypeScript errors. Verify the file exports both new functions.
  </verify>
  <done>
workshop-actions.ts exports updateStepStatus and advanceToNextStep server actions. TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update workshop layout to fetch and pass step status data</name>
  <files>src/app/workshop/[sessionId]/layout.tsx</files>
  <action>
Update the workshop layout server component to:

1. **Expand the database query** — Change the existing `db.query.sessions.findFirst` to include workshop steps via the Drizzle relation:
   ```
   with: {
     workshop: {
       with: {
         steps: true,
       },
     },
   }
   ```
   This fetches all 10 workshop_steps records for the session's workshop.

2. **Serialize step data** — Extract the steps array from the query result and convert to a plain serializable array. Do NOT pass a Map (will cause RSC serialization error). Create a typed array:
   ```typescript
   const workshopSteps = session.workshop.steps.map(s => ({
     stepId: s.stepId,
     status: s.status as 'not_started' | 'in_progress' | 'complete',
   }));
   ```

3. **Pass to WorkshopSidebar** — Add `workshopSteps` prop alongside existing `sessionId` prop:
   ```
   <WorkshopSidebar sessionId={sessionId} workshopSteps={workshopSteps} />
   ```

4. **Pass to MobileStepper** — Replace the hardcoded `currentStep={1}` prop with `workshopSteps` prop. Remove `currentStep` prop entirely (MobileStepper will extract current step from pathname internally in Plan 02):
   ```
   <MobileStepper sessionId={sessionId} workshopSteps={workshopSteps} />
   ```

5. **Pass workshopId to children** — The step navigation component (Plan 02) will need the workshopId. Pass it via the main content area. The cleanest approach: pass `workshopId` as a data attribute or via a context. For simplicity, since page.tsx is a server component that can fetch its own data, just ensure workshopId is accessible. No change needed here beyond what's described above — page.tsx will fetch workshop data independently.

Do NOT change the header, SidebarProvider wrapping, or overall layout structure.

Note: The WorkshopSidebar and MobileStepper TypeScript interfaces will temporarily show type errors because their interfaces haven't been updated yet (that's Plan 02). This is expected — verify the layout file itself has correct types for the data it's preparing.
  </action>
  <verify>
Verify the layout.tsx file compiles (may have prop type warnings that Plan 02 resolves). Check that the query includes `with: { workshop: { with: { steps: true } } }`. Verify no Map objects are passed to client components.
  </verify>
  <done>
Layout fetches workshop steps from database via Drizzle relational query. Step status data is serialized as plain objects array. WorkshopSidebar and MobileStepper receive workshopSteps prop. MobileStepper no longer receives hardcoded currentStep={1}.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes (or only has expected Plan-02 interface mismatch warnings)
2. workshop-actions.ts exports: createWorkshopSession, renameWorkshop, updateStepStatus, advanceToNextStep
3. layout.tsx fetches session with workshop.steps relation
4. No Map or non-serializable objects passed as props to client components
</verification>

<success_criteria>
Server actions for step state management exist and compile. Layout fetches real step completion data from the database and prepares it as serializable props for sidebar and mobile stepper components.
</success_criteria>

<output>
After completion, create `.planning/phases/04-navigation-state/04-01-SUMMARY.md`
</output>
