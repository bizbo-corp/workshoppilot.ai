---
phase: 29-visual-concept-cards
plan: 02
type: execute
wave: 2
depends_on: ["29-01"]
files_modified:
  - src/components/canvas/react-flow-canvas.tsx
  - src/lib/canvas/step-canvas-config.ts
  - src/lib/canvas/concept-card-layout.ts
  - src/hooks/use-canvas-autosave.ts
  - src/actions/canvas-actions.ts
autonomous: true

must_haves:
  truths:
    - "Concept cards render as draggable ReactFlow nodes on canvas"
    - "New concept cards are placed with dealing-cards offset (30px x/y)"
    - "Concept card state persists across page refresh via autosave"
    - "Step 9 canvas config registered in step-canvas-config"
  artifacts:
    - path: "src/lib/canvas/concept-card-layout.ts"
      provides: "Dealing-cards position calculator for concept cards"
      exports: ["getNextConceptCardPosition"]
    - path: "src/components/canvas/react-flow-canvas.tsx"
      provides: "conceptCard registered in nodeTypes"
      contains: "conceptCard"
    - path: "src/hooks/use-canvas-autosave.ts"
      provides: "Autosave includes conceptCards state"
      contains: "conceptCards"
    - path: "src/actions/canvas-actions.ts"
      provides: "Save/load includes conceptCards"
      contains: "conceptCards"
  key_links:
    - from: "src/components/canvas/react-flow-canvas.tsx"
      to: "src/components/canvas/concept-card-node.tsx"
      via: "import and nodeTypes registration"
      pattern: "import.*ConceptCardNode.*concept-card-node"
    - from: "src/hooks/use-canvas-autosave.ts"
      to: "src/actions/canvas-actions.ts"
      via: "saveCanvasState call includes conceptCards"
      pattern: "conceptCards"
---

<objective>
Register ConceptCardNode as a ReactFlow node type, implement dealing-cards layout positioning, extend autosave and canvas-actions to persist concept card state, and add Step 9 canvas configuration.

Purpose: Makes concept cards visible and interactive on the ReactFlow canvas and ensures state survives page refresh. After this plan, concept cards can be manually added and will render, drag, and persist.

Output: Concept cards render on canvas, dealing-cards layout works, state persists via autosave.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-visual-concept-cards/29-RESEARCH.md
@.planning/phases/29-visual-concept-cards/29-01-SUMMARY.md

# Files being modified
@src/components/canvas/react-flow-canvas.tsx
@src/lib/canvas/step-canvas-config.ts
@src/hooks/use-canvas-autosave.ts
@src/actions/canvas-actions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register conceptCard node type and integrate with ReactFlow canvas</name>
  <files>
    src/components/canvas/react-flow-canvas.tsx
    src/lib/canvas/step-canvas-config.ts
    src/lib/canvas/concept-card-layout.ts
  </files>
  <action>
**concept-card-layout.ts:**
Create a layout utility for concept card positioning:

```typescript
import type { ConceptCardData } from './concept-card-types';

/**
 * Calculate position for next concept card using dealing-cards pattern
 * Offset from last card by 30px x and y for cascading stack effect
 */
export function getNextConceptCardPosition(
  existingCards: ConceptCardData[]
): { x: number; y: number } {
  if (existingCards.length === 0) {
    // First card: near viewport center (caller can adjust with screenToFlowPosition)
    return { x: 100, y: 100 };
  }

  const lastCard = existingCards[existingCards.length - 1];
  return {
    x: lastCard.position.x + 30,
    y: lastCard.position.y + 30,
  };
}
```

**react-flow-canvas.tsx:**
1. Add import at top (near other node imports):
   ```typescript
   import { ConceptCardNode } from './concept-card-node';
   import type { ConceptCardData } from '@/lib/canvas/concept-card-types';
   ```

2. Register in `nodeTypes` object (OUTSIDE component, stable reference):
   ```typescript
   const nodeTypes = {
     postIt: PostItNode,
     group: GroupNode,
     drawingImage: DrawingImageNode,
     conceptCard: ConceptCardNode,  // NEW
   };
   ```

3. Add store access for concept cards in `ReactFlowCanvasInner`:
   ```typescript
   const conceptCards = useCanvasStore((s) => s.conceptCards);
   const updateConceptCard = useCanvasStore((s) => s.updateConceptCard);
   ```

4. Add concept card field change handlers using `useCallback`:
   - `handleConceptFieldChange(id, field, value)` -- calls `updateConceptCard` with appropriate partial update. For nested fields like `billboardHero.headline`, split on `.` and build nested object update.
   - `handleConceptSWOTChange(id, quadrant, index, value)` -- reads current SWOT from conceptCards, clones the quadrant array, updates the index, calls `updateConceptCard` with new swot object.
   - `handleConceptFeasibilityChange(id, dimension, score?, rationale?)` -- reads current feasibility, updates the dimension with new score/rationale, calls `updateConceptCard`.

5. In the `nodes` useMemo, AFTER building `drawingReactFlowNodes`, build `conceptCardReactFlowNodes`:
   ```typescript
   const conceptCardReactFlowNodes: Node[] = conceptCards.map((card) => ({
     id: card.id,
     type: 'conceptCard' as const,
     position: card.position,
     draggable: true,
     selectable: true,
     selected: selectedNodeIds.includes(card.id),
     data: {
       ...card,
       onFieldChange: handleConceptFieldChange,
       onSWOTChange: handleConceptSWOTChange,
       onFeasibilityChange: handleConceptFeasibilityChange,
     },
     style: { width: 400 },
   }));
   ```

   Append to the return: `return [...postItReactFlowNodes, ...drawingReactFlowNodes, ...conceptCardReactFlowNodes];`

6. Update the `nodes` useMemo dependency array to include `conceptCards`, `handleConceptFieldChange`, `handleConceptSWOTChange`, `handleConceptFeasibilityChange`.

7. In `handleNodesChange`, update the position handler section to check for concept card nodes:
   After the existing drawing node position check (`if (drawingNode)`), add:
   ```typescript
   const conceptCard = conceptCards.find((cc) => cc.id === change.id);
   if (conceptCard) {
     const snappedPosition = snapToGrid(change.position);
     updateConceptCard(change.id, { position: snappedPosition });
     return;
   }
   ```

8. In `handleNodesDelete`, add concept card deletion alongside drawing node deletion:
   ```typescript
   const deleteConceptCard = useCanvasStore((s) => s.deleteConceptCard);
   ```
   In the callback: after drawing node deletion, filter for conceptCard type nodes and delete them.

9. Also handle `handleNodesChange` remove changes for concept cards (similar to drawing nodes).

10. Add `conceptCards` and `updateConceptCard` to the `handleNodesChange` dependency array.

**step-canvas-config.ts:**
Add Step 9 (concept) canvas configuration:

```typescript
// Step 9: Concept Development - Concept card canvas
'concept': {
  hasQuadrants: false,
  // Concept cards use dealing-cards layout (no grid/quadrant/ring overlays)
},
```

This registers the step so `getStepCanvasConfig('concept')` returns a config object (enabling canvas features). No overlay needed -- concept cards are free-floating.
  </action>
  <verify>
Run `npx tsc --noEmit` -- zero errors. Grep for `conceptCard` in react-flow-canvas.tsx to verify it appears in nodeTypes, nodes useMemo, and change handlers. Verify concept-card-layout.ts exports `getNextConceptCardPosition`. Verify step-canvas-config.ts has `'concept'` entry.
  </verify>
  <done>ConceptCardNode registered as ReactFlow node type, concept cards render as draggable/selectable nodes, position changes persist to store, dealing-cards layout utility available, Step 9 canvas config registered.</done>
</task>

<task type="auto">
  <name>Task 2: Extend autosave and canvas-actions for concept card persistence</name>
  <files>
    src/hooks/use-canvas-autosave.ts
    src/actions/canvas-actions.ts
  </files>
  <action>
**canvas-actions.ts:**
1. Add import at top:
   ```typescript
   import type { ConceptCardData } from '@/lib/canvas/concept-card-types';
   ```

2. Update `saveCanvasState` function parameter type to include:
   ```typescript
   conceptCards?: ConceptCardData[];
   ```

3. In the `saveCanvasState` body where `canvasState` is stored, conceptCards will be automatically included since the entire `canvasState` object is stored under `_canvas` key. No additional logic needed -- the spread already captures it.

4. Update `loadCanvasState` return type to include:
   ```typescript
   conceptCards?: ConceptCardData[];
   ```

5. In the `loadCanvasState` body, update the canvas type annotation to include `conceptCards?`:
   ```typescript
   const canvas = artifact._canvas as {
     postIts?: PostIt[];
     gridColumns?: GridColumn[];
     drawingNodes?: DrawingNode[];
     mindMapNodes?: MindMapNodeState[];
     mindMapEdges?: MindMapEdgeState[];
     crazy8sSlots?: Crazy8sSlot[];
     conceptCards?: ConceptCardData[];  // NEW
   };
   ```

6. In the return object, add:
   ```typescript
   ...(canvas.conceptCards ? { conceptCards: canvas.conceptCards } : {}),
   ```

**use-canvas-autosave.ts:**
1. Add concept cards to store subscriptions:
   ```typescript
   const conceptCards = useCanvasStore((s) => s.conceptCards);
   ```

2. In the `debouncedSave` callback, add conceptCards to the save payload:
   ```typescript
   ...(conceptCards.length > 0 ? { conceptCards } : {}),
   ```

3. Add `conceptCards` to the `useEffect` dependency array that triggers autosave:
   ```typescript
   }, [postIts, gridColumns, drawingNodes, mindMapNodes, mindMapEdges, crazy8sSlots, conceptCards, isDirty, debouncedSave]);
   ```

**IMPORTANT:** Follow the EXACT same pattern used for `crazy8sSlots` which was added in Phase 28-05. The pattern is:
- Subscribe to store selector
- Conditionally include in save payload (only if non-empty)
- Add to useEffect dependency array
  </action>
  <verify>
Run `npx tsc --noEmit` -- zero errors. Run `npm run build` to verify production build succeeds. Grep for `conceptCards` in use-canvas-autosave.ts (should appear 3 times: subscribe, save payload, dependency array). Grep for `conceptCards` in canvas-actions.ts (should appear in parameter type, load return type, and canvas type annotation).
  </verify>
  <done>Concept card state persists across page refresh. Autosave triggers on conceptCards changes. Load/save canvas actions include conceptCards in their types and data flow.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm run build` succeeds
3. ConceptCardNode registered in nodeTypes in react-flow-canvas.tsx
4. Concept card position changes update store (via handleNodesChange)
5. Concept card nodes are deletable (via handleNodesDelete)
6. Autosave includes conceptCards in save payload
7. loadCanvasState returns conceptCards from stored data
8. Step 9 canvas config exists in step-canvas-config.ts
</verification>

<success_criteria>
Concept cards render on ReactFlow canvas as draggable/selectable nodes. Position changes snap to grid and persist to store. Concept card state survives page refresh via autosave. Dealing-cards layout utility available for positioning new cards.
</success_criteria>

<output>
After completion, create `.planning/phases/29-visual-concept-cards/29-02-SUMMARY.md`
</output>
