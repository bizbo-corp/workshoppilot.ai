---
phase: 29-visual-concept-cards
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/canvas/concept-card-node.tsx
  - src/stores/canvas-store.ts
  - src/lib/canvas/concept-card-types.ts
autonomous: true

must_haves:
  truths:
    - "ConceptCardNode renders with header, sketch, pitch, SWOT, feasibility, and billboard sections"
    - "Canvas store has addConceptCard, updateConceptCard, deleteConceptCard actions"
    - "ConceptCardNodeData type matches conceptArtifactSchema structure"
  artifacts:
    - path: "src/components/canvas/concept-card-node.tsx"
      provides: "ConceptCardNode custom ReactFlow node with multi-section layout"
      min_lines: 200
    - path: "src/lib/canvas/concept-card-types.ts"
      provides: "ConceptCardData type and default factory"
      exports: ["ConceptCardData", "createDefaultConceptCard"]
    - path: "src/stores/canvas-store.ts"
      provides: "Concept card CRUD actions in canvas store"
      contains: "conceptCards"
  key_links:
    - from: "src/components/canvas/concept-card-node.tsx"
      to: "src/lib/canvas/concept-card-types.ts"
      via: "type import"
      pattern: "import.*ConceptCardData.*concept-card-types"
    - from: "src/stores/canvas-store.ts"
      to: "src/lib/canvas/concept-card-types.ts"
      via: "type import"
      pattern: "import.*ConceptCardData.*concept-card-types"
---

<objective>
Build the ConceptCardNode custom ReactFlow node component with all 6 collapsible sections (header, sketch thumbnail, elevator pitch, SWOT grid, feasibility dots, billboard hero), plus the concept card data type and canvas store CRUD actions.

Purpose: This is the foundational component for Phase 29. Everything else (layout, AI generation, Step 9 container) depends on this node existing and the store having concept card actions.

Output: ConceptCardNode component, ConceptCardData type, canvas store with concept card slice.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-visual-concept-cards/29-RESEARCH.md

# Key reference files for patterns
@src/components/canvas/post-it-node.tsx
@src/components/canvas/mind-map-node.tsx
@src/components/canvas/drawing-image-node.tsx
@src/components/workshop/concept-sheet-view.tsx
@src/stores/canvas-store.ts
@src/lib/schemas/step-schemas.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ConceptCardData type and ConceptCardNode component</name>
  <files>
    src/lib/canvas/concept-card-types.ts
    src/components/canvas/concept-card-node.tsx
  </files>
  <action>
**concept-card-types.ts:**
Create type definition file with:

```typescript
export interface ConceptCardData {
  id: string;
  position: { x: number; y: number };
  conceptName: string;
  ideaSource: string;
  sketchSlotId?: string;       // Crazy 8s slot ID for traceability
  sketchImageUrl?: string;     // Vercel Blob URL from Crazy 8s slot
  elevatorPitch: string;
  usp: string;
  swot: {
    strengths: string[];       // Exactly 3 items
    weaknesses: string[];      // Exactly 3 items
    opportunities: string[];   // Exactly 3 items
    threats: string[];         // Exactly 3 items
  };
  feasibility: {
    technical: { score: number; rationale: string };
    business: { score: number; rationale: string };
    userDesirability: { score: number; rationale: string };
  };
  billboardHero?: {
    headline: string;
    subheadline: string;
    cta: string;
  };
}
```

This aligns with the existing `conceptArtifactSchema` in step-schemas.ts but adds `position`, `id`, `sketchSlotId`, `sketchImageUrl` for canvas use. The feasibility structure groups score+rationale per dimension (vs the flat schema which has `technical` and `technicalRationale` as separate fields). The store actions will handle the mapping.

Add a factory function `createDefaultConceptCard(partial?: Partial<ConceptCardData>)` that returns a card with empty strings and 3 empty SWOT items per quadrant, score=3 defaults.

**concept-card-node.tsx:**
Create a `'use client'` memo-wrapped component following PostItNode and MindMapNode patterns:

1. **Component signature:** `memo(({ data, id, selected }: NodeProps<ConceptCardNodeType>))` where `ConceptCardNodeType = Node<ConceptCardNodeRendererData, 'conceptCard'>`.

2. **ConceptCardNodeRendererData** (the data prop type) extends ConceptCardData with callback props:
   - `onFieldChange: (id: string, field: string, value: any) => void`
   - `onSWOTChange: (id: string, quadrant: string, index: number, value: string) => void`
   - `onFeasibilityChange: (id: string, dimension: string, score?: number, rationale?: string) => void`

3. **Collapsible sections** using `useState<Set<string>>` initialized with `new Set(['header'])` (only header expanded by default per research recommendation).

4. **Section layout** (all in single component, no sub-files):
   - **Header** (always visible): Editable `conceptName` input + "From: {ideaSource}" subtitle. Use `nodrag nopan` class on input.
   - **Sketch Thumbnail** (collapsible, only if `sketchImageUrl` exists): `<img>` with `object-contain` for the Crazy 8s PNG.
   - **Elevator Pitch** (collapsible): `<textarea>` with `nodrag nopan`, `minRows={3}` behavior via min-h-[80px].
   - **SWOT Grid** (collapsible): 2x2 CSS grid with semantic colors matching concept-sheet-view.tsx exactly:
     - Strengths: `bg-green-50 dark:bg-green-950/20`, `border-green-500/30`
     - Weaknesses: `bg-red-50 dark:bg-red-950/20`, `border-red-500/30`
     - Opportunities: `bg-blue-50 dark:bg-blue-950/20`, `border-blue-500/30`
     - Threats: `bg-amber-50 dark:bg-amber-950/20`, `border-amber-500/30`
     - Each quadrant has colored dot indicator + label + 3 textarea inputs (use `<textarea>` not `<input>` per research pitfall #3 -- SWOT bullets need 2+ lines).
     - All textareas have `nodrag nopan` class.
   - **Feasibility** (collapsible): 3 dimensions (Technical, Business, Desirability). Each row: label + 5 clickable dots + rationale input. Use `FeasibilityDimension` internal sub-component. Score colors: >=4 green, 3 amber, <=2 red. Dots use `nodrag nopan`.
   - **Billboard Hero** (collapsible, only if `billboardHero` exists): headline, subheadline, CTA inputs with gradient background.

5. **Card container:** `max-w-[400px] w-full` (NOT fixed `w-[400px]` per research pitfall #2 for mobile). Border changes when selected. Hidden handles (opacity-0) top and bottom for future connections.

6. **Section toggle buttons:** Each collapsible section has a header bar with ChevronDown/ChevronRight from lucide-react, all with `nodrag nopan`.

7. **All inputs use `defaultValue` + `onBlur`** pattern (same as MindMapNode label editing). Never use `value` + `onChange` for ReactFlow node inputs to avoid re-render thrashing.

8. Import `cn` from `@/lib/utils`, `memo`, `useState`, `useCallback` from React, `Handle`, `Position`, `type NodeProps`, `type Node` from `@xyflow/react`, `ChevronDown`, `ChevronRight` from `lucide-react`.

9. Export both the component `ConceptCardNode` and the node type `ConceptCardNodeType`.
  </action>
  <verify>
Run `npx tsc --noEmit` -- zero errors on the new files. Verify concept-card-node.tsx has `nodrag nopan` on every input/textarea/button element. Verify ConceptCardData type has all fields from conceptArtifactSchema plus canvas-specific fields.
  </verify>
  <done>ConceptCardNode component renders all 6 sections with collapsible state, semantic SWOT colors, feasibility dots, inline editing via blur callbacks, and nodrag nopan on all interactive elements. ConceptCardData type exported from concept-card-types.ts.</done>
</task>

<task type="auto">
  <name>Task 2: Add concept card CRUD actions to canvas store</name>
  <files>
    src/stores/canvas-store.ts
  </files>
  <action>
Extend the existing canvas store with concept card state and actions:

1. **Add to CanvasState type:**
   ```typescript
   conceptCards: ConceptCardData[];
   ```

2. **Add import** at top of file:
   ```typescript
   import type { ConceptCardData } from '@/lib/canvas/concept-card-types';
   ```

3. **Add to CanvasActions type:**
   ```typescript
   addConceptCard: (card: Omit<ConceptCardData, 'id'>) => void;
   updateConceptCard: (id: string, updates: Partial<ConceptCardData>) => void;
   deleteConceptCard: (id: string) => void;
   setConceptCards: (cards: ConceptCardData[]) => void;
   ```

4. **Add to DEFAULT_STATE:**
   ```typescript
   conceptCards: initState?.conceptCards || [],
   ```

5. **Update `createCanvasStore` initState parameter** to include `conceptCards?: ConceptCardData[]`.

6. **Implement actions** in the store creation:
   - `addConceptCard`: Spread card data, assign `id: crypto.randomUUID()`, append to conceptCards array, set `isDirty: true`.
   - `updateConceptCard`: Map over conceptCards, merge updates for matching id, set `isDirty: true`. Support nested updates for `swot` and `feasibility` objects (the caller passes complete sub-objects, no deep merge needed).
   - `deleteConceptCard`: Filter out by id, set `isDirty: true`.
   - `setConceptCards`: Replace entire array (used during canvas load).

7. **Temporal exclusion:** The concept card actions should be tracked by zundo temporal (undo/redo). No changes needed to the `partialize` function since conceptCards will be in state and tracked by default.

IMPORTANT: Do NOT modify any existing actions or state fields. Only ADD new fields and actions. The existing postIts, drawingNodes, mindMapNodes, mindMapEdges, crazy8sSlots code must remain untouched.
  </action>
  <verify>
Run `npx tsc --noEmit` -- zero errors. Grep for `conceptCards` in canvas-store.ts to verify it appears in state, default, and all 4 action implementations. Run `npm run build` to verify no build errors.
  </verify>
  <done>Canvas store has conceptCards state array and addConceptCard, updateConceptCard, deleteConceptCard, setConceptCards actions. Existing store functionality unchanged.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm run build` succeeds
3. concept-card-node.tsx exports `ConceptCardNode` component
4. concept-card-types.ts exports `ConceptCardData` type and `createDefaultConceptCard` factory
5. canvas-store.ts has `conceptCards` in CanvasState and all 4 CRUD actions
6. All input/textarea/button elements in ConceptCardNode have `nodrag nopan` class
</verification>

<success_criteria>
ConceptCardNode component exists with 6 collapsible sections (header, sketch, pitch, SWOT, feasibility, billboard), semantic SWOT colors, feasibility dot rating, inline editing via blur. Canvas store has concept card CRUD actions. TypeScript compiles without errors.
</success_criteria>

<output>
After completion, create `.planning/phases/29-visual-concept-cards/29-01-SUMMARY.md`
</output>
