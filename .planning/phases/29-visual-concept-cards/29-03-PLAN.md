---
phase: 29-visual-concept-cards
plan: 03
type: execute
wave: 2
depends_on: ["29-01"]
files_modified:
  - src/app/api/ai/generate-concept/route.ts
  - src/lib/ai/prompts/step-prompts.ts
autonomous: true

must_haves:
  truths:
    - "POST /api/ai/generate-concept returns structured concept card JSON from selected sketch + workshop context"
    - "AI output includes conceptName, elevatorPitch, SWOT (3 items per quadrant), feasibility (score + rationale), and billboardHero"
    - "AI references persona pains, HMW statement, and research insights in SWOT bullets and feasibility rationale"
    - "Endpoint falls back gracefully on AI failure with structured error response"
  artifacts:
    - path: "src/app/api/ai/generate-concept/route.ts"
      provides: "AI concept generation endpoint"
      exports: ["POST", "maxDuration"]
    - path: "src/lib/ai/prompts/step-prompts.ts"
      provides: "Concept generation prompt template"
      contains: "CONCEPT_GENERATION_PROMPT"
  key_links:
    - from: "src/app/api/ai/generate-concept/route.ts"
      to: "src/lib/ai/gemini-retry.ts"
      via: "generateTextWithRetry import"
      pattern: "import.*generateTextWithRetry"
    - from: "src/app/api/ai/generate-concept/route.ts"
      to: "src/db/schema"
      via: "workshop context query"
      pattern: "import.*workshopSteps.*stepArtifacts"
---

<objective>
Create the AI concept generation API endpoint that takes a selected Crazy 8s sketch + workshop context and generates structured concept card data (name, pitch, SWOT, feasibility, billboard hero) using Gemini.

Purpose: This is the "AI pre-fills concept card fields" requirement (CONCEPT-07). The endpoint queries workshop context from prior steps (persona, HMW statement, research insights) and generates evidence-based concept cards that reference actual workshop data.

Output: API endpoint at /api/ai/generate-concept that returns structured JSON matching ConceptCardData shape.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-visual-concept-cards/29-RESEARCH.md
@.planning/phases/29-visual-concept-cards/29-01-SUMMARY.md

# Reference files for AI integration patterns
@src/app/api/ai/suggest-sketch-prompts/route.ts
@src/lib/ai/gemini-retry.ts
@src/lib/schemas/step-schemas.ts
@src/lib/ai/prompts/step-prompts.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create concept generation prompt template</name>
  <files>
    src/lib/ai/prompts/step-prompts.ts
  </files>
  <action>
Add an exported constant `CONCEPT_GENERATION_PROMPT` to step-prompts.ts. Place it AFTER the existing `getIdeationSubStepInstructions` function (not inside it).

The prompt template uses placeholder tokens that the API route will replace:

```typescript
/**
 * Prompt template for AI concept card generation from selected Crazy 8s sketches.
 * Placeholder tokens: {personaName}, {personaGoals}, {personaPains}, {hmwStatement},
 * {crazy8sTitle}, {slotId}, {keyInsights}, {stakeholderChallenges}
 */
export const CONCEPT_GENERATION_PROMPT = `You are facilitating Step 9 (Develop Concepts) of a design thinking workshop.

**Workshop Context:**
- Persona: {personaName}
  - Goals: {personaGoals}
  - Pain Points: {personaPains}
- HMW Statement: {hmwStatement}
- Selected Crazy 8s Sketch: "{crazy8sTitle}" (Slot {slotId})
- Key Research Insights: {keyInsights}
- Stakeholder Challenges: {stakeholderChallenges}

**Task:**
Develop a complete concept card for this Crazy 8s sketch. The concept should:
1. Directly address the HMW statement
2. Solve at least one persona pain point
3. Build on the direction suggested by the sketch title
4. Be grounded in research evidence from earlier steps

**Output JSON Structure:**
{
  "conceptName": "2-4 word marketable name (evocative, memorable)",
  "elevatorPitch": "2-3 sentence pitch following Problem → Solution → Benefit structure",
  "usp": "One sentence: what makes this concept different from current solutions",
  "swot": {
    "strengths": ["strength 1 citing specific persona gains", "strength 2 citing research evidence", "strength 3"],
    "weaknesses": ["weakness 1 citing specific persona pains or limitations", "weakness 2", "weakness 3"],
    "opportunities": ["opportunity 1 from research insights", "opportunity 2 from market context", "opportunity 3"],
    "threats": ["threat 1 from stakeholder challenges", "threat 2", "threat 3"]
  },
  "feasibility": {
    "technical": {
      "score": 1-5,
      "rationale": "Why this score, citing specific workshop evidence"
    },
    "business": {
      "score": 1-5,
      "rationale": "Why this score, citing market/stakeholder evidence"
    },
    "userDesirability": {
      "score": 1-5,
      "rationale": "Why this score, citing persona pains and gains"
    }
  },
  "billboardHero": {
    "headline": "6-10 word benefit-focused headline",
    "subheadline": "1-2 sentence explanation of how it solves the persona's pain",
    "cta": "Specific verb-driven call to action (e.g., 'Start your free trial')"
  }
}

**Evidence Requirements:**
- SWOT strengths MUST reference persona goals: {personaGoals}
- SWOT weaknesses MUST reference persona pains: {personaPains}
- SWOT opportunities MUST reference research: {keyInsights}
- SWOT threats MUST reference stakeholder challenges: {stakeholderChallenges}
- Feasibility rationales MUST cite specific workshop data (not generic reasoning)
- Scores should be realistic (don't default to all 4s and 5s)
- Each SWOT quadrant MUST have EXACTLY 3 items

Output ONLY valid JSON. No markdown, no code blocks, no explanation.`;
```

IMPORTANT: Do not modify any existing functions or prompts in step-prompts.ts. Only ADD this new export at the end of the file (or in a logical location near Step 9 content if there's a clear spot).
  </action>
  <verify>
Run `npx tsc --noEmit` -- zero errors. Grep for `CONCEPT_GENERATION_PROMPT` in step-prompts.ts to verify it exists as an exported constant.
  </verify>
  <done>CONCEPT_GENERATION_PROMPT exported from step-prompts.ts with placeholder tokens for workshop context injection and evidence requirements for SWOT/feasibility.</done>
</task>

<task type="auto">
  <name>Task 2: Create AI concept generation API endpoint</name>
  <files>
    src/app/api/ai/generate-concept/route.ts
  </files>
  <action>
Create a new API route following the exact pattern of `src/app/api/ai/suggest-sketch-prompts/route.ts`:

**Request body:**
```typescript
{
  workshopId: string;    // wks_xxx
  slotId: string;        // e.g., 'slot-1'
  crazy8sTitle: string;  // Title from the Crazy 8s slot
}
```

**Implementation:**

1. Set `export const maxDuration = 30;` (same as sketch prompts endpoint).

2. Validate required fields: `workshopId`, `slotId`, `crazy8sTitle`. Return 400 if missing.

3. Verify workshop exists (same query as suggest-sketch-prompts).

4. **Load workshop context from prior step artifacts:**
   - **Step 3 (define):** Query stepArtifacts for `stepId='define'`, extract `hmwStatement`.
   - **Step 4 (empathize / sense-making):** Query stepArtifacts for `stepId='sense-making'`, extract persona data:
     - `personaName` from `artifact.persona.name`
     - `personaGoals` from `artifact.persona.goals` (join array with '; ')
     - `personaPains` from `artifact.persona.painPoints` (join array with '; ')
   - **Step 1 (challenge):** Query stepArtifacts for `stepId='challenge'`, extract `keyInsights` from `artifact.insights` (join array with '; ').
   - **Step 2 (stakeholder-mapping):** Query stepArtifacts for `stepId='stakeholder-mapping'`, extract stakeholder challenges from `artifact.challenges` or `artifact.stakeholders` (join with '; '). If not found, use empty string.

   For each query, follow the EXACT pattern from suggest-sketch-prompts:
   ```typescript
   const stepRecord = await db.select({ id: workshopSteps.id })
     .from(workshopSteps)
     .where(and(eq(workshopSteps.workshopId, workshopId), eq(workshopSteps.stepId, 'define')))
     .limit(1);
   ```

5. **Build prompt** by importing `CONCEPT_GENERATION_PROMPT` from step-prompts.ts and replacing placeholder tokens:
   ```typescript
   const prompt = CONCEPT_GENERATION_PROMPT
     .replace(/{personaName}/g, personaName || 'Unknown')
     .replace(/{personaGoals}/g, personaGoals || 'Not specified')
     .replace(/{personaPains}/g, personaPains || 'Not specified')
     .replace(/{hmwStatement}/g, hmwStatement || 'Not specified')
     .replace(/{crazy8sTitle}/g, crazy8sTitle)
     .replace(/{slotId}/g, slotId)
     .replace(/{keyInsights}/g, keyInsights || 'No research insights available')
     .replace(/{stakeholderChallenges}/g, stakeholderChallenges || 'No stakeholder data available');
   ```
   Use global regex replacements (`/g`) since some tokens appear multiple times.

6. **Call Gemini** using `generateTextWithRetry` from gemini-retry.ts:
   ```typescript
   const result = await generateTextWithRetry({
     model: google('gemini-2.0-flash'),
     temperature: 0.5, // Lower than sketch prompts for more consistent structured output
     prompt,
   });
   ```

7. **Parse response:** Clean markdown code blocks, parse JSON, validate structure:
   ```typescript
   let cleanedText = result.text.trim();
   if (cleanedText.startsWith('```')) {
     cleanedText = cleanedText.replace(/```json?\n?/g, '').replace(/```\n?/g, '');
   }
   const concept = JSON.parse(cleanedText);
   ```

   Validate required fields exist: `conceptName`, `elevatorPitch`, `swot`, `feasibility`. If validation fails, return 500 with error.

8. **Return response:**
   ```typescript
   return new Response(JSON.stringify({ concept }), {
     status: 200,
     headers: { 'Content-Type': 'application/json' },
   });
   ```

9. **Error handling:** Wrap in try/catch. On AI error, return 500 with `{ error: 'Failed to generate concept' }`. On parse error, return 500 with `{ error: 'Failed to parse AI response' }`.

IMPORTANT: Do NOT use streamObject or streaming -- return a single complete JSON response. The client will show a loading state while waiting, then populate the concept card all at once. This is simpler and more reliable than streaming partial concept card fields.
  </action>
  <verify>
Run `npx tsc --noEmit` -- zero errors. Run `npm run build` to verify production build succeeds. Verify the route file exports `POST` and `maxDuration`. Check that imports from gemini-retry, db/schema, step-prompts are correct.
  </verify>
  <done>POST /api/ai/generate-concept endpoint accepts workshopId, slotId, crazy8sTitle, queries workshop context from prior steps, generates structured concept card JSON via Gemini, returns complete concept data. Handles errors gracefully with structured error responses.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm run build` succeeds
3. CONCEPT_GENERATION_PROMPT exported from step-prompts.ts
4. /api/ai/generate-concept/route.ts exports POST and maxDuration
5. Route queries HMW (define), persona (sense-making), insights (challenge), stakeholders (stakeholder-mapping)
6. Prompt includes evidence requirements for SWOT and feasibility
7. Response structure matches ConceptCardData fields
</verification>

<success_criteria>
POST /api/ai/generate-concept returns structured concept card JSON from selected Crazy 8s sketch + full workshop context. SWOT bullets and feasibility rationale reference actual persona/research data from prior steps. Fallback error responses prevent client crashes.
</success_criteria>

<output>
After completion, create `.planning/phases/29-visual-concept-cards/29-03-SUMMARY.md`
</output>
