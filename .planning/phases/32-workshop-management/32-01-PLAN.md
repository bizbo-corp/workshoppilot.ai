---
phase: 32-workshop-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/db/schema/workshops.ts
  - src/actions/workshop-actions.ts
  - src/app/dashboard/page.tsx
autonomous: true

must_haves:
  truths:
    - "Workshops table has a deletedAt nullable timestamp column"
    - "Soft-deleted workshops are excluded from dashboard query results"
    - "deleteWorkshops server action soft-deletes workshops by setting deletedAt"
    - "Server action validates workshop ownership before deletion"
  artifacts:
    - path: "src/db/schema/workshops.ts"
      provides: "deletedAt column on workshops table"
      contains: "deletedAt"
    - path: "src/actions/workshop-actions.ts"
      provides: "deleteWorkshops server action"
      exports: ["deleteWorkshops"]
    - path: "src/app/dashboard/page.tsx"
      provides: "Dashboard filtering out soft-deleted workshops"
      contains: "isNull"
  key_links:
    - from: "src/actions/workshop-actions.ts"
      to: "src/db/schema/workshops.ts"
      via: "Drizzle update setting deletedAt"
      pattern: "set.*deletedAt"
    - from: "src/app/dashboard/page.tsx"
      to: "src/db/schema/workshops.ts"
      via: "Query filtering where deletedAt isNull"
      pattern: "isNull.*deletedAt"
---

<objective>
Add soft delete infrastructure for workshops: deletedAt column on workshops table, a deleteWorkshops server action, and filter the dashboard query to exclude soft-deleted records.

Purpose: Enable workshop deletion without data loss. Soft delete preserves workshops in the database for recovery while hiding them from the user.
Output: Schema migration applied, server action ready for UI consumption, dashboard excludes deleted workshops.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/db/schema/workshops.ts
@src/db/schema/relations.ts
@src/db/types.ts
@src/actions/workshop-actions.ts
@src/app/dashboard/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add deletedAt column and push schema</name>
  <files>src/db/schema/workshops.ts</files>
  <action>
Add a `deletedAt` nullable timestamp column to the `workshops` table in `src/db/schema/workshops.ts`.

Add the column after `updatedAt`:
```typescript
deletedAt: timestamp('deleted_at', { mode: 'date', precision: 3 }),
```

No default value needed (null = not deleted). No index needed (dashboard query will use existing clerkUserId index + isNull filter).

After adding the column, run the Drizzle schema push to apply:
```bash
npm run db:push
```

This will add the column to the Neon database. Since it's nullable with no default, existing rows automatically get NULL (not deleted).
  </action>
  <verify>
Run `npm run db:push` successfully. Then verify with Drizzle Studio or by checking the schema output shows the new column without errors.

Run `npx tsc --noEmit` to confirm TypeScript compiles cleanly.
  </verify>
  <done>Workshops table has a `deleted_at` nullable timestamp column in both schema definition and database. TypeScript types automatically include `deletedAt` via InferSelectModel.</done>
</task>

<task type="auto">
  <name>Task 2: Add deleteWorkshops server action and filter dashboard query</name>
  <files>src/actions/workshop-actions.ts, src/app/dashboard/page.tsx</files>
  <action>
**In `src/actions/workshop-actions.ts`:**

1. Add `isNull` and `inArray` to the drizzle-orm imports (alongside existing `eq` and `and`).

2. Add a new `deleteWorkshops` server action after the existing `renameWorkshop` function:

```typescript
/**
 * Soft-deletes one or more workshops by setting deletedAt timestamp
 * Validates ownership: only workshops belonging to the current user are deleted
 */
export async function deleteWorkshops(workshopIds: string[]): Promise<{ deleted: number }> {
  const { userId } = await auth();
  if (!userId) {
    throw new Error('Authentication required');
  }

  if (workshopIds.length === 0) {
    return { deleted: 0 };
  }

  // Soft delete only workshops owned by this user (defense in depth)
  const result = await db
    .update(workshops)
    .set({ deletedAt: new Date() })
    .where(
      and(
        inArray(workshops.id, workshopIds),
        eq(workshops.clerkUserId, userId),
        isNull(workshops.deletedAt)
      )
    )
    .returning({ id: workshops.id });

  revalidatePath('/dashboard');

  return { deleted: result.length };
}
```

Note: The `revalidatePath` import already exists at the top of the file.

**In `src/app/dashboard/page.tsx`:**

1. Add `isNull` to the drizzle-orm import: `import { eq, desc, isNull } from 'drizzle-orm';`

2. Update the `findMany` query to add an `and` condition filtering out soft-deleted workshops. Change the `where` clause:

```typescript
// Before:
where: eq(workshops.clerkUserId, userId),

// After:
where: and(
  eq(workshops.clerkUserId, userId),
  isNull(workshops.deletedAt)
),
```

Also add `and` to the drizzle-orm import: `import { eq, desc, isNull, and } from 'drizzle-orm';`

3. Add `deleteWorkshops` to the import from `@/actions/workshop-actions`:
```typescript
import { createWorkshopSession, renameWorkshop, deleteWorkshops } from '@/actions/workshop-actions';
```

This is needed for Plan 02 which will wire the UI to the action. Adding the import now avoids Plan 02 needing to touch this server component file.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm TypeScript compiles cleanly.

Run `npm run dev` and visit `/dashboard` to confirm workshops still load correctly (soft-deleted filter doesn't break anything since all existing workshops have NULL deletedAt).
  </verify>
  <done>deleteWorkshops server action exists, validates ownership, sets deletedAt. Dashboard query excludes soft-deleted workshops. deleteWorkshops is imported in dashboard page for downstream UI wiring.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npm run db:push` applied successfully
3. Dashboard at `/dashboard` loads workshops correctly
4. Existing workshops are not affected (deletedAt is NULL)
5. deleteWorkshops action signature accepts string[] and returns { deleted: number }
</verification>

<success_criteria>
- Workshops schema includes deletedAt nullable timestamp column
- Database has the column applied via db:push
- deleteWorkshops server action soft-deletes by setting deletedAt, validates user ownership
- Dashboard query filters out workshops where deletedAt is not null
- All TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/32-workshop-management/32-01-SUMMARY.md`
</output>
