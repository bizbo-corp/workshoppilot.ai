---
phase: 12-definition-steps-5-7
plan: 03
type: execute
wave: 3
depends_on: ["12-01", "12-02"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "All 3 Definition step prompts mention every required schema field (schema-prompt alignment verified)"
    - "Step 5 prompt mentions all personaArtifactSchema fields including new ones (motivations, frustrations, gains, dayInTheLife)"
    - "Step 6 prompt mentions all 7 journey layers matching journeyMappingArtifactSchema (action, goals, barriers, touchpoints, emotions, momentsOfTruth, opportunities)"
    - "Step 7 prompt mentions 4-part HMW fields matching reframeArtifactSchema (givenThat, persona, immediateGoal, deeperGoal)"
    - "Human verified end-to-end flow for Steps 5-7"
  artifacts: []
  key_links:
    - from: "src/lib/ai/prompts/step-prompts.ts"
      to: "src/lib/schemas/step-schemas.ts"
      via: "Every required schema field mentioned in corresponding prompt GATHERING REQUIREMENTS"
      pattern: "GATHERING REQUIREMENTS"
---

<objective>
Verify schema-prompt alignment for Steps 5-7 and human-verify the end-to-end Definition steps flow.

Purpose: Extraction quality depends on prompt-schema alignment -- if the schema expects a field but the prompt doesn't mention it, the AI won't gather that data. This plan verifies alignment (automated) and validates the full user experience (human checkpoint). Same pattern as Phase 11 Plan 03.

Output: Verified schema-prompt alignment, human-approved Definition steps flow.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-definition-steps-5-7/12-01-SUMMARY.md
@.planning/phases/12-definition-steps-5-7/12-02-SUMMARY.md
@src/lib/schemas/step-schemas.ts
@src/lib/ai/prompts/step-prompts.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify build and schema-prompt alignment for Steps 5-7</name>
  <files></files>
  <action>
Run build verification and check schema-prompt alignment for Steps 5-7. Same pattern as Phase 11 Plan 03 Task 1.

1. Run `npx tsc --noEmit` to verify TypeScript compilation
2. Run `npm run build` to verify production build

3. Verify schema-prompt alignment for Step 5 (persona):
   - Read personaArtifactSchema from step-schemas.ts — list ALL required and optional fields
   - Read 'persona' prompt from step-prompts.ts — check GATHERING REQUIREMENTS section
   - Verify every required schema field is mentioned in the prompt:
     - name (required) -- mentioned in prompt?
     - role (required) -- mentioned?
     - bio (required) -- mentioned?
     - quote (required) -- mentioned?
     - goals (required) -- mentioned?
     - pains (required) -- mentioned?
     - gains (required) -- mentioned?
     - age (optional) -- mentioned?
     - location (optional) -- mentioned?
     - behaviors (optional) -- mentioned?
     - motivations (optional) -- mentioned?
     - frustrations (optional) -- mentioned?
     - dayInTheLife (optional) -- mentioned?
   - Flag any required field NOT mentioned in the prompt

4. Verify schema-prompt alignment for Step 6 (journey-mapping):
   - Read journeyMappingArtifactSchema — list ALL fields including stage layer fields
   - Read 'journey-mapping' prompt — check GATHERING REQUIREMENTS and 7-LAYER POPULATION sections
   - Verify the 7 stage layers are mentioned:
     - action (required) -- mentioned?
     - goals (required) -- mentioned?
     - barriers (required) -- mentioned?
     - touchpoints (required) -- mentioned?
     - emotions (required, enum) -- mentioned?
     - momentsOfTruth (optional) -- mentioned?
     - opportunities (optional) -- mentioned?
   - Verify top-level fields: personaName, stages, dipSummary, dipRationale
   - Flag any required field NOT mentioned

5. Verify schema-prompt alignment for Step 7 (reframe):
   - Read reframeArtifactSchema — list ALL fields
   - Read 'reframe' prompt — check 4-PART HMW BUILDER and GATHERING REQUIREMENTS sections
   - Verify HMW statement fields are mentioned:
     - givenThat -- mentioned?
     - persona -- mentioned?
     - immediateGoal -- mentioned?
     - deeperGoal -- mentioned?
     - fullStatement -- mentioned?
   - Verify top-level fields: originalHmw, hmwStatements, insightsApplied, evolution, selectedForIdeation
   - Flag any required field NOT mentioned

6. If any misalignment found:
   - Fix the prompt to mention the missing field in GATHERING REQUIREMENTS
   - OR fix the schema if the field is unnecessary
   - Re-run build to verify fix compiles

7. Document alignment results in summary
  </action>
  <verify>
- `npx tsc --noEmit` passes
- `npm run build` succeeds
- Step 5 alignment: all required personaArtifactSchema fields mentioned in prompt
- Step 6 alignment: all 7 journey layers mentioned in prompt, plus personaName and dipSummary
- Step 7 alignment: all 4 HMW builder fields mentioned in prompt, plus originalHmw and insightsApplied
- Any misalignments documented and fixed
  </verify>
  <done>
Build passes and schema-prompt alignment verified for all 3 Definition steps. Every required schema field is mentioned in the corresponding prompt's gathering requirements or instruction sections.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Definition Steps (5-7) implementation:
- Updated Zod schemas for persona (multi-persona, motivations, gains), journey (7 layers, traffic light, dip rationale), and reframe (4-part HMW builder, multiple statements)
- Enriched AI prompts with domain expertise: evidence traceability, collaborative stage creation, 4-part HMW builder flow
- Enhanced validation criteria for evidence grounding, emotional variance, and dip alignment
- PersonaCard component with initials avatar and skeleton cards
- JourneyMapGrid component with 7-layer grid, traffic light emotions, cell editing, dip highlight
- HMWBuilder component with 4-field mad-libs form and color-coded sections
- OutputPanel updated with step-specific rendering for Steps 5-7
  </what-built>
  <how-to-verify>
Test the full Definition steps flow in development:

1. Start dev server: `npm run dev`
2. Navigate to an existing workshop (or create new one and complete Steps 1-4 first)
3. Navigate to Step 5 (Persona Development):
   - Verify AI proactively drafts a persona based on Step 4 research
   - Verify AI references Step 4 pains/gains (evidence traceability in conversation)
   - Click "Extract Output" -- verify persona renders as structured CARD (not markdown prose)
   - Verify initials avatar circle, fields layout, and optional sections
   - Check AI follows arc progression (orient -> gather -> synthesize)
4. Complete Step 5, advance to Step 6 (Journey Mapping):
   - Verify AI suggests 4-8 journey stages based on persona
   - Verify AI populates 7 layers per stage
   - Click "Extract Output" -- verify journey renders as scrollable GRID (not markdown list)
   - Verify traffic light colors on emotions row (green/orange/red)
   - Verify dip column has red highlight and "The Dip" badge
   - Verify dip identification has rationale
5. Complete Step 6, advance to Step 7 (Reframing Challenge):
   - Verify AI drafts FRESH HMW (not just rewording Step 1)
   - Verify AI suggests 2-3 options per HMW field
   - Click "Extract Output" -- verify HMW renders as MAD-LIBS FORM (not plain text)
   - Verify 4 color-coded fields (Given that, How might we help, do/be/feel/achieve, So they can)
   - Verify original Step 1 HMW shown for reference
6. Navigate back to Steps 1-4 -- verify output panel still shows generic markdown (no regression)
  </how-to-verify>
  <resume-signal>Type "approved" to complete Phase 12, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npx tsc --noEmit` passes
2. Build: `npm run build` succeeds
3. Schema-prompt alignment: every required field mentioned in corresponding prompt
4. Human verification: end-to-end Definition steps flow approved
5. No regressions: Steps 1-4 and 8-10 output rendering unchanged
</verification>

<success_criteria>
- Schema-prompt alignment verified for all 3 Definition steps with zero mismatches
- Human confirms: AI facilitates Steps 5-7 with domain expertise and evidence traceability
- Human confirms: Output panel renders step-specific UI (card, grid, mad-libs form)
- Human confirms: No regressions in Steps 1-4 output rendering
</success_criteria>

<output>
After completion, create `.planning/phases/12-definition-steps-5-7/12-03-SUMMARY.md`
</output>
