---
phase: 12-definition-steps-5-7
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - src/components/workshop/persona-card.tsx
  - src/components/workshop/journey-map-grid.tsx
  - src/components/workshop/hmw-builder.tsx
  - src/components/workshop/output-panel.tsx
autonomous: true

must_haves:
  truths:
    - "Step 5 output panel renders persona as a structured card with initials avatar, not markdown prose"
    - "Step 5 shows skeleton placeholder cards for upcoming personas in multi-persona flow"
    - "Step 6 output panel renders journey map as a scrollable grid with card/post-it style cells"
    - "Step 6 journey map cells show traffic light colors (green/orange/red) for emotions"
    - "Step 6 supports cell-level click-to-edit for any journey map entry"
    - "Step 7 output panel renders HMW as a 4-field mad-libs form with editable text inputs"
    - "Steps 5-7 use step-specific UI components instead of generic markdown rendering"
  artifacts:
    - path: "src/components/workshop/persona-card.tsx"
      provides: "Persona card with initials avatar, field layout, skeleton cards"
      min_lines: 80
    - path: "src/components/workshop/journey-map-grid.tsx"
      provides: "7-layer journey grid with traffic light emotions, cell editing, dip highlight"
      min_lines: 120
    - path: "src/components/workshop/hmw-builder.tsx"
      provides: "4-field HMW mad-libs form with editable inputs"
      min_lines: 80
    - path: "src/components/workshop/output-panel.tsx"
      provides: "Updated output panel with step-specific rendering for Steps 5-7"
      contains: "PersonaCard"
  key_links:
    - from: "src/components/workshop/output-panel.tsx"
      to: "src/components/workshop/persona-card.tsx"
      via: "Conditional rendering when stepOrder === 5"
      pattern: "PersonaCard"
    - from: "src/components/workshop/output-panel.tsx"
      to: "src/components/workshop/journey-map-grid.tsx"
      via: "Conditional rendering when stepOrder === 6"
      pattern: "JourneyMapGrid"
    - from: "src/components/workshop/output-panel.tsx"
      to: "src/components/workshop/hmw-builder.tsx"
      via: "Conditional rendering when stepOrder === 7"
      pattern: "HMWBuilder"
---

<objective>
Build step-specific UI components for Steps 5-7 output panel: PersonaCard with initials avatar and skeleton cards, JourneyMapGrid with 7-layer scrollable grid and traffic light emotions, HMWBuilder with 4-field mad-libs form. Wire into OutputPanel for step-specific rendering.

Purpose: The current output panel renders ALL artifacts as generic markdown. Steps 5-7 need rich, structured display per user decisions: persona as card layout (not prose), journey as scrollable grid with cell editing (not text list), HMW as mad-libs form (not plain text). These components make the Definition phase feel like a professional design thinking tool.

Output: Three new UI components + updated OutputPanel with step-specific rendering.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-definition-steps-5-7/12-CONTEXT.md
@.planning/phases/12-definition-steps-5-7/12-RESEARCH.md
@.planning/phases/12-definition-steps-5-7/12-01-SUMMARY.md
@src/components/workshop/output-panel.tsx
@src/components/workshop/artifact-confirmation.tsx
@src/lib/schemas/step-schemas.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: PersonaCard and JourneyMapGrid components</name>
  <files>src/components/workshop/persona-card.tsx, src/components/workshop/journey-map-grid.tsx</files>
  <action>
Create two new UI components using existing Tailwind + shadcn patterns from the codebase.

**PersonaCard component (src/components/workshop/persona-card.tsx):**

'use client' component. Props: `persona: Record<string, unknown>`, `draft?: boolean`, `totalPersonas?: number`, `currentIndex?: number`, `allPersonas?: Record<string, unknown>[]`.

Structure:
1. **Initials Avatar Circle**: Circular div (h-16 w-16) with bg-primary/10, centered initials extracted from persona.name (first letter of first name + first letter of last name, or first 2 letters if single name). Text in primary color, font-bold.

2. **Header Section**: Name (text-xl font-semibold), Role (text-sm text-muted-foreground), optional Age and Location on same line if present.

3. **Quote Block**: Italic text in a left-bordered card (border-l-4 border-primary/30 pl-4 bg-muted/30 py-2).

4. **Bio Section**: Regular paragraph text.

5. **Grid of Lists**: 2-column grid on larger screens for Goals, Pains, Gains (if present), Motivations (if present). Each section: bold label, bullet list. Pains use text-red-600 dots, Gains use text-green-600 dots.

6. **Optional Sections** (only render if data present): Behaviors (bullet list), Frustrations (bullet list with amber dots), Day-in-the-life (paragraph).

7. **Draft Badge**: If `draft` prop is true, show a "Draft" badge in top-right corner (bg-amber-500/10 text-amber-700).

8. **Multi-persona indicator**: If `totalPersonas > 1`, show "Persona {currentIndex + 1} of {totalPersonas}" at the top.

9. **Skeleton Card component** (exported separately as PersonaSkeletonCard): Shows shimmer placeholder structure — circular avatar shimmer, name line shimmer, role line shimmer, quote block shimmer, list shimmers. Use `animate-pulse bg-muted rounded` for shimmer effect. Accepts `index: number` prop. Shows "Upcoming" badge.

10. **Multi-persona layout**: If `allPersonas` is provided and has length > 0, render completed personas as compact cards above the current persona card. Compact cards show just avatar + name + role in a horizontal row.

All styling via Tailwind classes, matching existing codebase patterns (rounded-lg, border, bg-card, shadow-xs). Use cn() from @/lib/utils for conditional classes.

**JourneyMapGrid component (src/components/workshop/journey-map-grid.tsx):**

'use client' component. Props: `artifact: Record<string, unknown>`, `onCellEdit?: (stageIndex: number, layer: string, value: string) => void`.

Structure:
1. **Scrollable container**: `overflow-x-auto` wrapper. The grid should scroll horizontally when stages exceed viewport width.

2. **Grid layout**: CSS grid or table where:
   - Columns = journey stages (4-8)
   - Rows = 7 layer labels (Action, Goals, Barriers, Touchpoints, Emotions, Moments of Truth, Opportunities)
   - First column is fixed layer labels (sticky left)

3. **Layer label column** (sticky): Each row label in a sticky left column (min-w-[140px] bg-background). Font-medium text-sm.

4. **Stage header row**: Stage name at top of each column. Bold text. If stage has `isDip: true`, add red left border (border-l-4 border-red-500) and subtle red background tint (bg-red-50 dark:bg-red-950/20).

5. **Cell styling**: Each cell is a card/post-it style (rounded border bg-card p-3 min-w-[180px] min-h-[60px]). Text-sm.

6. **Traffic light emotions row**: The Emotions row uses colored backgrounds instead of text:
   - `positive` = bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200 with a green dot indicator
   - `neutral` = bg-orange-100 dark:bg-orange-900/30 text-orange-800 dark:text-orange-200 with an orange dot indicator
   - `negative` = bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-200 with a red dot indicator

7. **Dip column highlight**: Stages where isDip is true get a persistent subtle red tint across ALL their cells (not just emotions row). Add a small "The Dip" badge at the top of the column.

8. **Cell-level editing**: Each cell is clickable. On click, replace text content with a textarea (auto-focus, same size). On blur or Enter, call `onCellEdit(stageIndex, layerKey, newValue)`. If `onCellEdit` is not provided, cells are read-only.

9. **Dip Summary section**: Below the grid, render `dipSummary` and `dipRationale` (if present) in a highlighted card (border-red-500/50 bg-red-50/50 dark:bg-red-950/20).

10. **Empty state**: If stages array is empty, show "Journey map will appear here after AI generates stages" in muted text.

Parse the artifact prop to extract stages array. Handle type safety with runtime checks (artifact may be Record<string, unknown>).
  </action>
  <verify>
- `npx tsc --noEmit` passes
- `npm run build` succeeds
- PersonaCard renders persona fields with initials avatar circle
- PersonaSkeletonCard exported for multi-persona placeholder
- JourneyMapGrid renders scrollable grid with 7 layer rows
- JourneyMapGrid emotions row uses traffic light colors (green/orange/red)
- JourneyMapGrid dip column has red highlight and "The Dip" badge
- Both components use 'use client' directive and Tailwind classes
  </verify>
  <done>
PersonaCard renders structured persona with initials avatar, field grid, optional sections, draft badge, and skeleton cards for multi-persona flow. JourneyMapGrid renders 7-layer scrollable grid with traffic light emotions, dip column highlighting, cell-level editing support, and dip summary section.
  </done>
</task>

<task type="auto">
  <name>Task 2: HMWBuilder component and OutputPanel integration</name>
  <files>src/components/workshop/hmw-builder.tsx, src/components/workshop/output-panel.tsx</files>
  <action>
Create HMWBuilder component and wire all 3 new components into OutputPanel for step-specific rendering.

**HMWBuilder component (src/components/workshop/hmw-builder.tsx):**

'use client' component. Props: `artifact: Record<string, unknown>`, `onFieldEdit?: (statementIndex: number, field: string, value: string) => void`.

Structure:
1. **Original HMW reference**: Show the Step 1 original HMW in a subtle card at the top (bg-muted/30 border-dashed text-sm text-muted-foreground) with label "Original Challenge (Step 1)".

2. **HMW Statement cards**: For each HMW statement in `hmwStatements` array, render a mad-libs style card:

   Each card has 4 labeled fields in a vertical stack:
   - **"Given that"** — Label in font-semibold text-xs uppercase text-muted-foreground, followed by editable text (click to edit, textarea on click, blur to save). Background tint: bg-blue-50 dark:bg-blue-950/20.
   - **"How might we help"** — Same pattern, bg-purple-50 dark:bg-purple-950/20.
   - **"do/be/feel/achieve"** — Same pattern, bg-amber-50 dark:bg-amber-950/20.
   - **"So they can"** — Same pattern, bg-green-50 dark:bg-green-950/20.

   Each field shows its value in regular text. Below all 4 fields, show the composed `fullStatement` in a highlighted summary card (border-primary/30 bg-primary/5 font-medium).

3. **Multiple HMW statements**: If more than one statement exists, show them as numbered cards ("HMW #1", "HMW #2") with visual separation.

4. **Ideation selection indicator**: If `selectedForIdeation` is present, show a checkmark badge on selected statements: "Selected for Ideation" in green.

5. **Insights Applied section**: Below the HMW cards, show the `insightsApplied` array as a compact list with label "Research Insights Applied".

6. **Evolution section**: If `evolution` is present, show in a subtle card explaining how the HMW changed from Step 1.

7. **Empty state**: If no hmwStatements, show "Your reframed HMW will appear here after the AI helps you build it" in muted text.

8. **Field editing**: Each field is click-to-edit. On click, replace text with textarea. On blur, call `onFieldEdit(statementIndex, fieldName, newValue)`. If onFieldEdit is not provided, fields are read-only.

Parse the artifact prop to extract hmwStatements array, originalHmw, insightsApplied, evolution, selectedForIdeation. Handle type safety with runtime checks.

**OutputPanel integration (src/components/workshop/output-panel.tsx):**

Update the existing OutputPanel to use step-specific rendering for Steps 5-7 instead of generic markdown.

In the "State 4: Artifact available" section, add step-specific rendering BEFORE the generic markdown fallback:

```typescript
// Step-specific rendering for Definition steps
if (artifact) {
  if (stepOrder === 5) {
    // Parse multi-persona: artifact may have personas array or be single persona
    return (
      <div className="flex h-full flex-col overflow-y-auto p-6">
        <div className="mb-4">
          <div className="flex items-center gap-2">
            <h3 className="text-lg font-semibold">{step.mockOutputType}</h3>
            <span className="rounded-md bg-green-500/10 px-2 py-0.5 text-xs text-green-700 dark:text-green-400">
              Extracted
            </span>
          </div>
        </div>
        <PersonaCard persona={artifact} />
      </div>
    );
  }

  if (stepOrder === 6) {
    return (
      <div className="flex h-full flex-col overflow-y-auto p-6">
        <div className="mb-4">
          <div className="flex items-center gap-2">
            <h3 className="text-lg font-semibold">{step.mockOutputType}</h3>
            <span className="rounded-md bg-green-500/10 px-2 py-0.5 text-xs text-green-700 dark:text-green-400">
              Extracted
            </span>
          </div>
        </div>
        <JourneyMapGrid artifact={artifact} />
      </div>
    );
  }

  if (stepOrder === 7) {
    return (
      <div className="flex h-full flex-col overflow-y-auto p-6">
        <div className="mb-4">
          <div className="flex items-center gap-2">
            <h3 className="text-lg font-semibold">{step.mockOutputType}</h3>
            <span className="rounded-md bg-green-500/10 px-2 py-0.5 text-xs text-green-700 dark:text-green-400">
              Extracted
            </span>
          </div>
        </div>
        <HMWBuilder artifact={artifact} />
      </div>
    );
  }

  // Default: generic markdown rendering (existing code for Steps 1-4, 8-10)
  const markdown = formatArtifactAsMarkdown(artifact, stepOrder);
  // ... existing markdown rendering code
}
```

Add imports at top of output-panel.tsx:
```typescript
import { PersonaCard } from './persona-card';
import { JourneyMapGrid } from './journey-map-grid';
import { HMWBuilder } from './hmw-builder';
```

Keep ALL existing OutputPanel logic intact for Steps 1-4 and 8-10. Only add conditional branches for Steps 5-7. The generic markdown rendering becomes the fallback for all other steps.

Do NOT add onCellEdit or onFieldEdit callbacks yet — for now, components render read-only in the output panel. Edit callbacks will be wired in a future phase if needed.
  </action>
  <verify>
- `npx tsc --noEmit` passes
- `npm run build` succeeds
- HMWBuilder renders 4-field mad-libs form with color-coded labels
- HMWBuilder shows original HMW reference, insights applied, evolution
- OutputPanel imports PersonaCard, JourneyMapGrid, HMWBuilder
- OutputPanel renders PersonaCard when stepOrder === 5
- OutputPanel renders JourneyMapGrid when stepOrder === 6
- OutputPanel renders HMWBuilder when stepOrder === 7
- OutputPanel still renders generic markdown for Steps 1-4 and 8-10 (not broken)
  </verify>
  <done>
HMWBuilder renders 4-field mad-libs form with color-coded fields, multiple statement support, ideation selection indicator, and research insights section. OutputPanel now uses step-specific rendering: PersonaCard for Step 5, JourneyMapGrid for Step 6, HMWBuilder for Step 7, generic markdown for all other steps.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npx tsc --noEmit` passes with zero errors
2. Build: `npm run build` succeeds
3. PersonaCard renders with initials avatar, not markdown prose
4. JourneyMapGrid renders scrollable grid with traffic light emotions
5. HMWBuilder renders 4-field mad-libs form
6. OutputPanel uses step-specific components for Steps 5-7
7. Steps 1-4 and 8-10 output rendering unchanged (generic markdown)
8. All components use 'use client' and existing Tailwind patterns
</verification>

<success_criteria>
- Step 5 persona renders as structured card with initials avatar and skeleton cards for multi-persona
- Step 6 journey map renders as scrollable grid with 7 layers, traffic light emotions, and dip highlight
- Step 7 HMW renders as 4-field mad-libs form with color-coded sections
- OutputPanel routes to correct component per step
- No regressions in Steps 1-4 and 8-10 rendering
</success_criteria>

<output>
After completion, create `.planning/phases/12-definition-steps-5-7/12-02-SUMMARY.md`
</output>
