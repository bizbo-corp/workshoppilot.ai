---
phase: 20-bundle-optimization-mobile-refinement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - next.config.ts
  - src/app/globals.css
  - src/app/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Canvas route client bundle is under 300KB gzipped"
    - "lucide-react tree-shaking is configured via optimizePackageImports"
    - "Next.js build completes without errors after config changes"
    - "Viewport meta tag prevents iOS double-tap zoom"
    - "Canvas container uses dvh for iOS Safari toolbar compatibility"
    - "Body overscroll-behavior prevents iOS bounce scroll"
  artifacts:
    - path: "next.config.ts"
      provides: "optimizePackageImports for lucide-react"
      contains: "optimizePackageImports"
    - path: "src/app/layout.tsx"
      provides: "Viewport meta with maximum-scale=1"
      contains: "maximumScale"
    - path: "src/app/globals.css"
      provides: "dvh viewport height and overscroll-behavior CSS"
      contains: "dvh"
  key_links:
    - from: "next.config.ts"
      to: "lucide-react imports across codebase"
      via: "optimizePackageImports config"
      pattern: "optimizePackageImports.*lucide-react"
    - from: "src/app/layout.tsx"
      to: "iOS Safari viewport behavior"
      via: "viewport metadata export"
      pattern: "maximumScale.*1"
---

<objective>
Optimize bundle size and configure viewport for mobile compatibility.

Purpose: Ensure canvas route stays under 300KB gzipped and iOS Safari viewport behavior is correct (no double-tap zoom, no toolbar height offset, no bounce scroll).
Output: Updated next.config.ts with optimizePackageImports, layout.tsx with viewport meta, globals.css with dvh/overscroll CSS. Build verification confirming bundle target.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-bundle-optimization-mobile-refinement/20-RESEARCH.md
@next.config.ts
@src/app/layout.tsx
@src/app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Bundle optimization config + viewport meta</name>
  <files>
    next.config.ts
    src/app/layout.tsx
  </files>
  <action>
    1. Update `next.config.ts` to add optimizePackageImports for lucide-react:
       ```typescript
       import type { NextConfig } from "next";

       const nextConfig: NextConfig = {
         experimental: {
           optimizePackageImports: ['lucide-react'],
         },
       };

       export default nextConfig;
       ```
       This ensures lucide-react (546 icons, potentially ~500KB unoptimized) only bundles actually-used icons. Next.js may auto-optimize some libraries, but explicit config ensures it.

    2. Update `src/app/layout.tsx` to add viewport metadata using Next.js metadata API. Add a `viewport` export (Next.js 14+ uses separate `viewport` export, NOT inside `metadata`):
       ```typescript
       import type { Metadata, Viewport } from "next";

       export const viewport: Viewport = {
         width: 'device-width',
         initialScale: 1,
         maximumScale: 1,
         userScalable: false,
       };
       ```
       This prevents iOS Safari double-tap zoom which conflicts with canvas double-click-to-create post-it. The `maximumScale: 1` and `userScalable: false` are both needed for reliable iOS behavior. Keep the existing `metadata` export unchanged.

    IMPORTANT: Do NOT add `@next/bundle-analyzer` as a dependency. We will use `npx next experimental-analyze` (built into Next.js 16.1+) for analysis, which requires no installation.
  </action>
  <verify>
    Run `npm run build` and confirm it completes without errors. Grep next.config.ts for "optimizePackageImports" and layout.tsx for "maximumScale" to confirm changes are in place.
  </verify>
  <done>
    next.config.ts has optimizePackageImports for lucide-react. layout.tsx has viewport export with maximumScale=1 and userScalable=false. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Mobile viewport CSS + bundle size verification</name>
  <files>
    src/app/globals.css
  </files>
  <action>
    1. Add mobile viewport and overscroll CSS to `src/app/globals.css`. Add these rules AFTER the existing `@layer base` block:

       ```css
       /* Mobile viewport and canvas compatibility */
       @layer base {
         html, body {
           overscroll-behavior: none;
         }
       }

       /* Canvas container uses dynamic viewport height for iOS Safari toolbar */
       .canvas-container {
         height: 100dvh;
       }

       @supports not (height: 100dvh) {
         .canvas-container {
           height: 100vh;
         }
       }

       /* Prevent touch-action conflicts on canvas elements */
       .react-flow {
         touch-action: none;
       }
       ```

       The `overscroll-behavior: none` prevents iOS Safari bounce scroll which interferes with canvas panning. The `touch-action: none` on `.react-flow` prevents browser-default touch behaviors (scroll, zoom) from conflicting with ReactFlow's pointer event handling. The `dvh` unit accounts for iOS Safari's collapsing toolbar (44-88px offset with regular `vh`).

    2. Run `npm run build` to produce production bundle.

    3. After build completes, check the `.next` output for bundle sizes. Run:
       ```bash
       # Check total page bundle size for the step route
       ls -la .next/static/chunks/ | head -30
       # Look for the main canvas-related chunks
       find .next/static -name "*.js" -exec gzip -c {} \; -print | head -20
       ```

       The primary goal is to verify the build succeeds with all optimizations. Exact per-route bundle sizes in Next.js 16 require the experimental analyzer UI (which is interactive and can't run in CI). Instead, verify that:
       - Build succeeds without warnings about large bundles
       - No "First Load JS" warning exceeds 300KB for the step route
       - The build output shows reasonable chunk sizes

    4. If the build output shows any route with "First Load JS" exceeding 300KB, investigate by checking which dependencies are largest. Common culprits: framer-motion (~100KB), react-markdown, radix-ui. Document findings but do NOT remove dependencies â€” optimization beyond config changes is out of scope for this task.
  </action>
  <verify>
    Run `npm run build` and examine the route size output. Confirm the build completes. Grep globals.css for "overscroll-behavior", "dvh", and "touch-action" to confirm CSS changes. The step route (`/workshop/[sessionId]/step/[stepId]`) First Load JS should be documented (target: under 300KB).
  </verify>
  <done>
    globals.css has overscroll-behavior:none on html/body, dvh height on .canvas-container with vh fallback, and touch-action:none on .react-flow. Build completes successfully. Bundle size documented.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes without errors
2. `grep -r "optimizePackageImports" next.config.ts` returns match
3. `grep -r "maximumScale" src/app/layout.tsx` returns match
4. `grep -r "overscroll-behavior" src/app/globals.css` returns match
5. `grep -r "dvh" src/app/globals.css` returns match
6. `grep -r "touch-action" src/app/globals.css` returns match
7. Build output shows step route bundle sizes (documented)
</verification>

<success_criteria>
- next.config.ts configured with optimizePackageImports for lucide-react
- layout.tsx exports viewport metadata preventing iOS double-tap zoom
- globals.css has dvh viewport height, overscroll-behavior, and touch-action CSS
- Production build completes without errors
- Bundle size for step route documented (target: under 300KB)
</success_criteria>

<output>
After completion, create `.planning/phases/20-bundle-optimization-mobile-refinement/20-01-SUMMARY.md`
</output>
