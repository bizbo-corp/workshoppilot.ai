---
phase: 20-bundle-optimization-mobile-refinement
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/use-prevent-scroll-on-canvas.ts
  - src/components/canvas/react-flow-canvas.tsx
  - src/components/canvas/post-it-node.tsx
autonomous: true

must_haves:
  truths:
    - "Canvas panning does not trigger page scroll on iOS Safari"
    - "Post-it nodes are large enough for reliable touch targets (120x120px min)"
    - "Double-tap on canvas creates post-it instead of triggering iOS zoom"
    - "Canvas coordinates map correctly on mobile viewports via screenToFlowPosition"
    - "Touch drag on post-its works without triggering page scroll"
  artifacts:
    - path: "src/hooks/use-prevent-scroll-on-canvas.ts"
      provides: "iOS Safari scroll prevention hook with passive:false"
      exports: ["usePreventScrollOnCanvas"]
    - path: "src/components/canvas/react-flow-canvas.tsx"
      provides: "Canvas component with touch scroll prevention hook integrated"
      contains: "usePreventScrollOnCanvas"
    - path: "src/components/canvas/post-it-node.tsx"
      provides: "Post-it nodes with touch-action:none for mobile safety"
      contains: "touch-action"
  key_links:
    - from: "src/hooks/use-prevent-scroll-on-canvas.ts"
      to: "src/components/canvas/react-flow-canvas.tsx"
      via: "usePreventScrollOnCanvas hook import"
      pattern: "usePreventScrollOnCanvas"
    - from: "src/components/canvas/react-flow-canvas.tsx"
      to: "DOM .react-flow element"
      via: "native addEventListener with passive:false"
      pattern: "passive.*false"
---

<objective>
Add iOS Safari touch handling and mobile-specific refinements to canvas components.

Purpose: Prevent page scroll during canvas interactions on iOS Safari (which ignores React synthetic preventDefault), ensure touch targets are appropriately sized, and add touch-action CSS to prevent gesture conflicts. This addresses the known iOS Safari 11.3+ passive event listener issue where React's onTouchMove preventDefault is silently ignored.
Output: New usePreventScrollOnCanvas hook, updated canvas components with touch optimizations. All mobile touch interactions verified via build.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-bundle-optimization-mobile-refinement/20-RESEARCH.md
@src/components/canvas/react-flow-canvas.tsx
@src/components/canvas/post-it-node.tsx
@src/hooks/use-canvas-autosave.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create usePreventScrollOnCanvas hook</name>
  <files>src/hooks/use-prevent-scroll-on-canvas.ts</files>
  <action>
    Create `src/hooks/use-prevent-scroll-on-canvas.ts` -- a hook that prevents page scroll when touching the ReactFlow canvas on iOS Safari.

    CRITICAL: This hook MUST use native `addEventListener` with `{ passive: false }`, NOT React synthetic events. React's synthetic `onTouchMove` with `preventDefault()` does NOT work on iOS Safari 11.3+ because iOS made touch listeners passive by default. React synthetic events don't support the `passive` option, so `preventDefault()` is silently ignored.

    Implementation:
    ```typescript
    'use client';

    import { useEffect, useRef } from 'react';

    /**
     * Prevents page scroll when touching canvas on iOS Safari.
     * Uses native addEventListener with { passive: false } because
     * React synthetic events can't call preventDefault on iOS Safari 11.3+.
     *
     * @param containerRef - Ref to the canvas container element
     */
    export function usePreventScrollOnCanvas(containerRef: React.RefObject<HTMLDivElement | null>) {
      useEffect(() => {
        const container = containerRef.current;
        if (!container) return;

        // Find the .react-flow element within the container
        const reactFlowEl = container.querySelector('.react-flow');
        if (!reactFlowEl) return;

        const handleTouchMove = (e: Event) => {
          const touchEvent = e as TouchEvent;
          const target = touchEvent.target as HTMLElement;

          // Allow default touch behavior on interactive elements (buttons, inputs, textareas)
          if (
            target.closest('button') ||
            target.closest('textarea') ||
            target.closest('input') ||
            target.closest('.canvas-toolbar')
          ) {
            return;
          }

          // Prevent page scroll when panning canvas or dragging nodes
          touchEvent.preventDefault();
        };

        // CRITICAL: { passive: false } required for preventDefault on iOS Safari 11.3+
        reactFlowEl.addEventListener('touchmove', handleTouchMove, { passive: false });

        return () => {
          reactFlowEl.removeEventListener('touchmove', handleTouchMove);
        };
      }, [containerRef]);
    }
    ```

    Key design decisions:
    - Takes a ref instead of a CSS selector to avoid querying DOM by string (more React-idiomatic, avoids stale references)
    - Finds `.react-flow` within the container (not globally) to avoid conflicts if multiple ReactFlow instances exist
    - Allows touch on buttons/textareas/inputs to preserve form interaction
    - Allows touch on `.canvas-toolbar` for toolbar button taps
    - Uses `Event` type cast because addEventListener signature doesn't know about TouchEvent generics
  </action>
  <verify>
    Confirm the file exists and exports `usePreventScrollOnCanvas`. Run `npx tsc --noEmit` to verify TypeScript compiles without errors.
  </verify>
  <done>
    usePreventScrollOnCanvas hook created with native addEventListener, passive:false, and proper cleanup. TypeScript compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate touch hook + add mobile CSS to canvas components</name>
  <files>
    src/components/canvas/react-flow-canvas.tsx
    src/components/canvas/post-it-node.tsx
  </files>
  <action>
    1. Update `src/components/canvas/react-flow-canvas.tsx`:

       a. Add import for the new hook:
          ```typescript
          import { usePreventScrollOnCanvas } from '@/hooks/use-prevent-scroll-on-canvas';
          ```

       b. Add a ref to the canvas container div. Inside `ReactFlowCanvasInner`, add:
          ```typescript
          const canvasContainerRef = useRef<HTMLDivElement>(null);
          ```

       c. Call the hook after the ref:
          ```typescript
          // Prevent iOS Safari page scroll when panning canvas
          usePreventScrollOnCanvas(canvasContainerRef);
          ```

       d. Attach the ref to the outer container div. Change:
          ```tsx
          <div className="w-full h-full relative">
          ```
          to:
          ```tsx
          <div ref={canvasContainerRef} className="w-full h-full relative">
          ```

       That's it for react-flow-canvas.tsx. The `touch-action: none` CSS is handled globally in globals.css (Plan 01, Task 2). The viewport meta preventing double-tap zoom is handled in layout.tsx (Plan 01, Task 1). No other changes needed.

    2. Update `src/components/canvas/post-it-node.tsx`:

       Add inline `touch-action: none` style to the post-it container div to prevent the browser from interpreting touch gestures on post-its as scroll/zoom. This is a belt-and-suspenders approach alongside the global CSS.

       Change the style prop from:
       ```tsx
       style={{ width: '120px', minHeight: '120px' }}
       ```
       to:
       ```tsx
       style={{ width: '120px', minHeight: '120px', touchAction: 'none' }}
       ```

       This ensures that even if the global `.react-flow` touch-action CSS doesn't cascade properly to custom nodes (which render in a separate React portal in some configurations), the post-it nodes still prevent gesture conflicts.

    3. Run `npm run build` to verify everything compiles and builds correctly with the new hook integrated.
  </action>
  <verify>
    Run `npm run build` to confirm production build passes. Grep react-flow-canvas.tsx for "usePreventScrollOnCanvas" and post-it-node.tsx for "touchAction" to confirm changes.
  </verify>
  <done>
    react-flow-canvas.tsx imports and uses usePreventScrollOnCanvas with a container ref. post-it-node.tsx has touchAction:'none' on its container div. Production build passes.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes without errors
2. `grep -r "usePreventScrollOnCanvas" src/` returns matches in hook file AND react-flow-canvas.tsx
3. `grep -r "passive.*false" src/hooks/use-prevent-scroll-on-canvas.ts` returns match
4. `grep -r "touchAction" src/components/canvas/post-it-node.tsx` returns match
5. `npx tsc --noEmit` passes (TypeScript validation)
</verification>

<success_criteria>
- usePreventScrollOnCanvas hook exists with native addEventListener and passive:false
- Hook is integrated into ReactFlowCanvasInner via container ref
- Post-it nodes have touchAction:'none' inline style
- Production build passes without errors
- All TypeScript compiles without type errors
</success_criteria>

<output>
After completion, create `.planning/phases/20-bundle-optimization-mobile-refinement/20-02-SUMMARY.md`
</output>
