---
phase: 31-output-panel-retirement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/use-dev-output.ts
  - src/components/workshop/right-panel.tsx
  - src/components/workshop/step-container.tsx
  - src/components/workshop/ideation-sub-step-container.tsx
  - src/components/workshop/step-navigation.tsx
autonomous: true

must_haves:
  truths:
    - "Output panel is hidden by default for all users in production"
    - "Output panel is hidden by default on localhost until toggled"
    - "Localhost developers can toggle output panel visibility via footer button"
    - "Output panel toggle state persists across page navigation in dev mode"
    - "Extract Output button is hidden when output panel is disabled"
    - "Toggle button is invisible to production users"
  artifacts:
    - path: "src/hooks/use-dev-output.ts"
      provides: "Dev output toggle hook with localStorage persistence and localhost detection"
      exports: ["useDevOutput"]
    - path: "src/components/workshop/right-panel.tsx"
      provides: "Output panel gated by devOutputEnabled flag"
      contains: "useDevOutput"
    - path: "src/components/workshop/step-container.tsx"
      provides: "Extract Output button gated by devOutputEnabled flag"
      contains: "useDevOutput"
    - path: "src/components/workshop/ideation-sub-step-container.tsx"
      provides: "Idea-selection output panel gated by devOutputEnabled flag"
      contains: "useDevOutput"
    - path: "src/components/workshop/step-navigation.tsx"
      provides: "Dev toggle button visible only on localhost"
      contains: "useDevOutput"
  key_links:
    - from: "src/hooks/use-dev-output.ts"
      to: "localStorage"
      via: "getItem/setItem with key 'dev-output-enabled'"
      pattern: "localStorage\\.(get|set)Item.*dev-output-enabled"
    - from: "src/components/workshop/step-navigation.tsx"
      to: "src/hooks/use-dev-output.ts"
      via: "useDevOutput hook providing toggle callback"
      pattern: "useDevOutput"
    - from: "src/components/workshop/right-panel.tsx"
      to: "src/hooks/use-dev-output.ts"
      via: "useDevOutput hook providing devOutputEnabled boolean"
      pattern: "devOutputEnabled"
---

<objective>
Hide the output panel from production users while preserving localhost developer access via a toggle button in the step navigation footer.

Purpose: The output panel is a developer debugging tool, not a user-facing feature. The canvas is the user-facing view of structured outputs. Hiding the output panel simplifies the production UI.
Output: Output panel hidden by default everywhere, with a localhost-only toggle in the footer bar for developer inspection.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/components/workshop/right-panel.tsx
@src/components/workshop/step-container.tsx
@src/components/workshop/ideation-sub-step-container.tsx
@src/components/workshop/step-navigation.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useDevOutput hook and gate output panel visibility</name>
  <files>
    src/hooks/use-dev-output.ts
    src/components/workshop/right-panel.tsx
    src/components/workshop/step-container.tsx
    src/components/workshop/ideation-sub-step-container.tsx
  </files>
  <action>
    Create a new hook `src/hooks/use-dev-output.ts` that:
    1. Exports `useDevOutput()` returning `{ isDevMode: boolean, devOutputEnabled: boolean, toggleDevOutput: () => void }`
    2. `isDevMode` is `true` when `typeof window !== 'undefined' && window.location.hostname === 'localhost'` (also check for `127.0.0.1`)
    3. `devOutputEnabled` reads from `localStorage.getItem('dev-output-enabled') === 'true'` — defaults to `false`
    4. `toggleDevOutput` flips the localStorage value and triggers a re-render via useState
    5. Use `useState` + `useEffect` to hydrate from localStorage on mount (avoids SSR mismatch — initialize both `isDevMode` and `devOutputEnabled` as `false`, then set real values in useEffect)
    6. When `isDevMode` is false, `devOutputEnabled` must ALWAYS be `false` regardless of localStorage (production override)

    Then gate the output panel in three files:

    **right-panel.tsx:**
    - Import `useDevOutput` from `@/hooks/use-dev-output`
    - Add `const { devOutputEnabled } = useDevOutput();` inside the component
    - Modify line 41: change `const showOutput = artifact !== null || isExtracting || extractionError !== null;` to `const showOutput = devOutputEnabled && (artifact !== null || isExtracting || extractionError !== null);`
    - This ensures the OutputAccordion and the resizable 50/50 split are never shown unless dev mode is active

    **step-container.tsx:**
    - Import `useDevOutput` from `@/hooks/use-dev-output`
    - Add `const { devOutputEnabled } = useDevOutput();` inside StepContainer
    - Gate the "Extract Output" button (around line 265): wrap the condition with `devOutputEnabled &&` so it becomes `{devOutputEnabled && !isCanvasStep && hasEnoughMessages && !artifact && !isExtracting && (...)}`
    - This prevents users from triggering extraction when output panel is disabled

    **ideation-sub-step-container.tsx:**
    - Import `useDevOutput` from `@/hooks/use-dev-output`
    - Add `const { devOutputEnabled } = useDevOutput();` inside IdeationSubStepContainer
    - Gate the `renderOutputPanel` function's content: when `!devOutputEnabled`, return an empty `<div className="h-full" />` instead of the IdeaSelection + ArtifactConfirmation UI
    - Gate the "Extract Output" button inside `renderChatPanel` (around line 223): wrap with `devOutputEnabled &&` check
    - Note: The IdeaSelection component in the idea-selection sub-step tab is also part of the output panel system and should be hidden when dev output is off. However, keep the panel layout intact (the resizable split still shows, just with empty right panel) to avoid layout shifts.
  </action>
  <verify>
    1. `npx tsc --noEmit` passes with no type errors
    2. `npm run build` succeeds (no SSR hydration issues from window access)
    3. Open the app on localhost — output panel should NOT appear by default even when artifacts exist
    4. The "Extract Output" button should NOT appear in the chat panel footer
  </verify>
  <done>
    Output panel is hidden by default everywhere. No output accordion, no Extract Output button, no idea-selection output visible unless devOutputEnabled is true. Hook properly handles SSR (no hydration mismatch).
  </done>
</task>

<task type="auto">
  <name>Task 2: Add dev toggle button to step navigation footer</name>
  <files>
    src/components/workshop/step-navigation.tsx
  </files>
  <action>
    Modify `step-navigation.tsx` to add a dev-mode toggle button:

    1. Import `useDevOutput` from `@/hooks/use-dev-output`
    2. Import `Bug` icon from `lucide-react` (a subtle dev-tool icon)
    3. Inside the StepNavigation component, add `const { isDevMode, devOutputEnabled, toggleDevOutput } = useDevOutput();`
    4. In the JSX, add the toggle button in the LEFT section of the footer bar (alongside Back and Reset buttons), but ONLY render it when `isDevMode` is true:
       ```tsx
       {isDevMode && (
         <Button
           onClick={toggleDevOutput}
           variant="ghost"
           size="sm"
           className={cn(
             "text-muted-foreground",
             devOutputEnabled && "text-amber-600 bg-amber-50 hover:bg-amber-100 dark:text-amber-400 dark:bg-amber-950 dark:hover:bg-amber-900"
           )}
           title={devOutputEnabled ? "Hide output panel" : "Show output panel"}
         >
           <Bug className="h-4 w-4" />
         </Button>
       )}
       ```
    5. Import `cn` from `@/lib/utils` (if not already imported — check existing imports)
    6. The button should be the FIRST element in the left-side `<div className="flex items-center gap-2">`, before the Back button, so it's always visible in the footer corner
    7. Visual states:
       - OFF (default): Ghost button with muted text (blends into footer)
       - ON: Amber highlight (bg-amber-50, text-amber-600) to indicate output panel is active
    8. The button persists across steps because StepNavigation is rendered on every step page, and the hook reads from localStorage
  </action>
  <verify>
    1. `npx tsc --noEmit` passes with no type errors
    2. Open app on localhost — Bug icon button visible in bottom-left of footer
    3. Click the Bug button — output panel becomes visible (amber highlight on button)
    4. Navigate to another step — Bug button stays amber, output panel stays visible
    5. Click Bug button again — output panel hides, button returns to muted ghost style
    6. Refresh page — toggle state persists (reads from localStorage)
    7. Deploy to production (or simulate by checking non-localhost) — Bug button does NOT appear
  </verify>
  <done>
    Localhost developers see a Bug icon toggle in the footer. Clicking it toggles output panel visibility. State persists in localStorage across navigation and page refreshes. Button is invisible in production.
  </done>
</task>

</tasks>

<verification>
1. Production behavior: Output panel hidden, no Extract Output button, no dev toggle visible
2. Localhost default: Output panel hidden, Bug toggle visible in footer (muted/ghost state)
3. Localhost toggled ON: Output panel visible, Bug toggle amber, Extract Output button appears
4. Persistence: Toggle state survives step navigation and full page refresh
5. SSR safety: No hydration mismatch (hook initializes as false, hydrates in useEffect)
6. Build: `npm run build` passes with no errors
</verification>

<success_criteria>
- Output panel is invisible to production users (PANEL-01)
- Localhost developers can toggle output panel via footer button (PANEL-02)
- Toggle state persists across page navigation in dev mode
- No TypeScript errors, no build failures, no SSR hydration issues
</success_criteria>

<output>
After completion, create `.planning/phases/31-output-panel-retirement/31-01-SUMMARY.md`
</output>
