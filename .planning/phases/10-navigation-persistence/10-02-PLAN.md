---
phase: 10-navigation-persistence
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/lib/navigation/cascade-invalidation.ts
  - src/actions/workshop-actions.ts
  - src/components/layout/workshop-sidebar.tsx
  - src/components/workshop/step-container.tsx
  - src/components/workshop/step-navigation.tsx
  - src/app/workshop/[sessionId]/step/[stepId]/page.tsx
  - src/app/workshop/[sessionId]/layout.tsx
autonomous: true

must_haves:
  truths:
    - "User can navigate back to any completed step and view its extracted output"
    - "User can revise an earlier step and downstream steps are marked needs_regeneration"
    - "Sidebar shows needs_regeneration status with a visual warning indicator"
    - "User can resume a workshop from where they left off after closing browser"
    - "Sequential enforcement still prevents skipping ahead to not_started steps"
  artifacts:
    - path: "src/lib/navigation/cascade-invalidation.ts"
      provides: "Cascade invalidation logic for downstream steps"
      contains: "invalidateDownstreamSteps"
    - path: "src/components/layout/workshop-sidebar.tsx"
      provides: "Sidebar with needs_regeneration visual indicator"
      contains: "needs_regeneration"
    - path: "src/components/workshop/step-navigation.tsx"
      provides: "Navigation with Revise button for completed steps"
      contains: "handleRevise"
    - path: "src/app/workshop/[sessionId]/step/[stepId]/page.tsx"
      provides: "Step page that loads existing artifact for completed steps"
      contains: "stepArtifacts"
  key_links:
    - from: "src/components/workshop/step-navigation.tsx"
      to: "src/lib/navigation/cascade-invalidation.ts"
      via: "server action import"
      pattern: "invalidateDownstreamSteps"
    - from: "src/components/layout/workshop-sidebar.tsx"
      to: "needs_regeneration status"
      via: "status lookup rendering"
      pattern: "needs_regeneration"
    - from: "src/app/workshop/[sessionId]/step/[stepId]/page.tsx"
      to: "src/db/schema/step-artifacts.ts"
      via: "database query for existing artifact"
      pattern: "stepArtifacts"
    - from: "src/app/workshop/[sessionId]/layout.tsx"
      to: "src/components/layout/workshop-sidebar.tsx"
      via: "passes needs_regeneration status to sidebar"
      pattern: "workshopSteps"
---

<objective>
Enable back-navigation to completed steps with artifact viewing, and implement cascade invalidation when users revise earlier steps. This makes the workshop a living document where users can go back, review outputs, revise steps, and see downstream impacts.

Purpose: Completes NAV-01 (back-nav), NAV-02 (cascade invalidation), and NAV-04 (resume). Users can freely navigate completed steps, explicitly trigger revision which marks downstream steps as needing regeneration, and the sidebar reflects the state accurately.

Output: Cascade invalidation service, updated sidebar with needs_regeneration indicators, Revise button on completed steps, step page loads existing artifacts for viewing.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-navigation-persistence/10-RESEARCH.md
@.planning/phases/10-navigation-persistence/10-01-SUMMARY.md

@src/db/schema/steps.ts
@src/db/schema/step-artifacts.ts
@src/actions/workshop-actions.ts
@src/components/layout/workshop-sidebar.tsx
@src/components/workshop/step-container.tsx
@src/components/workshop/step-navigation.tsx
@src/app/workshop/[sessionId]/step/[stepId]/page.tsx
@src/app/workshop/[sessionId]/layout.tsx
@src/lib/workshop/step-metadata.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create cascade invalidation service and update sidebar</name>
  <files>
    src/lib/navigation/cascade-invalidation.ts
    src/actions/workshop-actions.ts
    src/components/layout/workshop-sidebar.tsx
    src/app/workshop/[sessionId]/layout.tsx
  </files>
  <action>
1. Create `src/lib/navigation/cascade-invalidation.ts`:
   - Export `invalidateDownstreamSteps(workshopId: string, revisedStepId: string): Promise<{ invalidatedCount: number }>`
   - Import STEPS from step-metadata, db from db/client, workshopSteps from schema, eq/and from drizzle-orm
   - Find the order of the revised step using STEPS.find()
   - Filter STEPS to get downstream steps (order > revisedStep.order)
   - For each downstream step ID, update workshopSteps where workshopId AND stepId match:
     - Set status to `'needs_regeneration'`
     - Set completedAt to null
     - Set arcPhase to `'orient'` (reset arc phase so re-entering re-orients)
   - Return count of invalidated steps
   - Skip if no downstream steps (step 10 has nothing downstream)
   - Also reset the REVISED step itself: set status back to `'in_progress'`, set arcPhase to `'orient'`, clear completedAt (this puts the user back into active editing mode for that step)
   - Do NOT delete artifacts or summaries (they serve as starting points for regeneration)

2. Update `src/actions/workshop-actions.ts`:
   - Add new exported server action: `reviseStep(workshopId: string, stepId: string, sessionId: string): Promise<void>`
   - This action calls `invalidateDownstreamSteps(workshopId, stepId)` from the cascade module
   - Then calls `revalidatePath(\`/workshop/\${sessionId}\`)` to refresh the layout/sidebar
   - Wrap in try/catch, log errors, rethrow

3. Update `src/app/workshop/[sessionId]/layout.tsx`:
   - In the workshopSteps serialization, update the status type to include `'needs_regeneration'`:
     - Change `status: s.status as 'not_started' | 'in_progress' | 'complete'` to `status: s.status as 'not_started' | 'in_progress' | 'complete' | 'needs_regeneration'`

4. Update `src/components/layout/workshop-sidebar.tsx`:
   - Update WorkshopSidebarProps type: status union should include `'needs_regeneration'`
   - In the STEPS.map rendering, add handling for `needs_regeneration`:
     - `const needsRegen = status === 'needs_regeneration'`
     - For the step indicator circle: show an orange/amber warning style when needsRegen
       - Use classes: `'border-2 border-amber-500 bg-amber-50 text-amber-600 dark:bg-amber-950 dark:text-amber-400'`
       - Show the step number (not a check mark) inside the circle
     - For the step name text: add `'text-amber-600 dark:text-amber-400'` when needsRegen
     - Accessibility: steps with `needs_regeneration` should be navigable (they are accessible like completed steps -- user can click to view or re-do them)
     - Update `isAccessible` check: `const isAccessible = status !== 'not_started'` (this already covers needs_regeneration since it's not 'not_started')
  </action>
  <verify>
- `npx tsc --noEmit` passes with zero errors
- `src/lib/navigation/cascade-invalidation.ts` exists and exports `invalidateDownstreamSteps`
- `src/actions/workshop-actions.ts` exports `reviseStep`
- Sidebar renders needs_regeneration steps with amber indicator styling
- Layout passes updated status type to sidebar
  </verify>
  <done>
Cascade invalidation marks downstream steps as needs_regeneration. Sidebar displays amber warning on affected steps. reviseStep server action triggers invalidation and refreshes cache.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update step page and navigation for back-nav and revision</name>
  <files>
    src/app/workshop/[sessionId]/step/[stepId]/page.tsx
    src/components/workshop/step-container.tsx
    src/components/workshop/step-navigation.tsx
  </files>
  <action>
1. Update `src/app/workshop/[sessionId]/step/[stepId]/page.tsx`:
   - Currently: redirects if step status is `not_started`. This is correct.
   - Add: Allow navigation to `complete` and `needs_regeneration` steps (already allowed since only not_started is blocked).
   - Add: Query the existing artifact for this step if status is `complete` or `needs_regeneration`:
     - Import `stepArtifacts` from `@/db/schema`
     - After finding `stepRecord`, query: `db.select().from(stepArtifacts).where(eq(stepArtifacts.workshopStepId, stepRecord.id)).limit(1)`
     - Pass the artifact data (or null) as `initialArtifact` prop to StepContainer
   - Pass the step status as a new prop `stepStatus` to StepContainer so it knows whether the user is viewing a completed step or actively working on one

2. Update `src/components/workshop/step-container.tsx`:
   - Add new props: `initialArtifact?: Record<string, unknown> | null`, `stepStatus?: string`
   - If `initialArtifact` is provided and status is `complete`, pre-populate the artifact state: `useState(initialArtifact)`
   - If status is `complete`, also set `artifactConfirmed` to true initially (the artifact was already confirmed when the step was completed)
   - If status is `needs_regeneration`, show the artifact but set `artifactConfirmed` to false (it needs re-confirmation after revision)

3. Update `src/components/workshop/step-navigation.tsx`:
   - Add new prop: `stepStatus?: string`
   - Add new prop: `onRevise?: () => void` (callback for when user clicks Revise)
   - When viewing a COMPLETED step (stepStatus === 'complete'):
     - Hide the "Next" button (don't advance from a completed step being viewed)
     - Show a "Revise This Step" button (amber/warning variant) that calls `onRevise`
     - Keep the "Back" button visible as normal
   - When viewing a NEEDS_REGENERATION step:
     - Show normal Next button behavior (user can re-work and advance)
     - The step is essentially back to in_progress state after revision
   - When step is `in_progress`:
     - Keep existing behavior (Next button advances, Back button navigates)

4. Wire the revision flow in `src/components/workshop/step-container.tsx`:
   - Import `reviseStep` from `@/actions/workshop-actions`
   - Import `useRouter` from `next/navigation`
   - Create handleRevise callback:
     - Call `reviseStep(workshopId, stepId, sessionId)` (the server action that triggers cascade invalidation)
     - After the server action completes, call `router.refresh()` to reload the page with updated status
     - The step will now show as `in_progress`, downstream steps as `needs_regeneration`
   - Pass `handleRevise` as the `onRevise` prop to StepNavigation
   - Pass `stepStatus` to StepNavigation

IMPORTANT considerations:
- Back-navigation to completed steps is VIEW ONLY by default. The chat is still visible with historical messages, and the output panel shows the confirmed artifact.
- Only clicking "Revise This Step" triggers cascade invalidation and puts the step back into editing mode.
- This prevents accidental invalidation when users just want to review earlier work (addressing Pitfall 6 from research).
- The `needs_regeneration` status is navigable -- users can click on those steps in the sidebar to see what needs updating.
  </action>
  <verify>
- `npx tsc --noEmit` passes with zero errors
- `npm run build` succeeds
- Step page queries and passes initialArtifact to StepContainer
- StepContainer pre-populates artifact state for completed steps
- StepNavigation shows "Revise This Step" button for completed steps
- StepNavigation shows normal Next/Back for in_progress steps
  </verify>
  <done>
Users can navigate back to completed steps and view their extracted outputs. Clicking "Revise This Step" triggers cascade invalidation, marking downstream steps as needs_regeneration. Normal in_progress navigation continues working. No accidental invalidation from viewing.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- zero TypeScript errors
2. `npm run build` -- production build succeeds
3. Cascade invalidation: calling reviseStep on step 3 marks steps 4-10 as needs_regeneration
4. Sidebar: completed steps show green check, needs_regeneration show amber indicator
5. Back-nav: clicking completed step in sidebar loads step with artifact visible
6. Revise: clicking "Revise This Step" puts step back to in_progress and cascades
7. Sequential enforcement: not_started steps still blocked from direct navigation
8. Resume: returning to workshop via dashboard reaches last active step (existing behavior preserved)
</verification>

<success_criteria>
- User can click any completed step in sidebar and view its output (NAV-01)
- User can click "Revise This Step" on completed steps, triggering cascade invalidation (NAV-02)
- Downstream steps show amber needs_regeneration indicator in sidebar (NAV-02)
- Workshop resume works -- dashboard links to last active step, messages are loaded from DB (NAV-04)
- No accidental invalidation from simply viewing completed steps
- All existing functionality preserved (forward navigation, extraction, confirmation)
</success_criteria>

<output>
After completion, create `.planning/phases/10-navigation-persistence/10-02-SUMMARY.md`
</output>
