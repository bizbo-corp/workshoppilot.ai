---
phase: 10-navigation-persistence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/db/schema/steps.ts
  - src/hooks/use-auto-save.ts
  - src/actions/auto-save-actions.ts
  - src/components/workshop/chat-panel.tsx
  - package.json
autonomous: true

must_haves:
  truths:
    - "System auto-saves conversation messages every 2 seconds (debounced) with 10s maxWait"
    - "Pending auto-save flushes before step navigation to prevent data loss"
    - "Workshop step status type includes needs_regeneration for cascade invalidation"
    - "User can close browser and return to find their recent messages persisted"
  artifacts:
    - path: "src/db/schema/steps.ts"
      provides: "Extended status enum with needs_regeneration"
      contains: "needs_regeneration"
    - path: "src/hooks/use-auto-save.ts"
      provides: "Debounced auto-save React hook"
      contains: "useDebouncedCallback"
    - path: "src/actions/auto-save-actions.ts"
      provides: "Server action for saving messages"
      contains: "use server"
    - path: "src/components/workshop/chat-panel.tsx"
      provides: "Chat panel with auto-save wired in"
      contains: "useAutoSave"
  key_links:
    - from: "src/hooks/use-auto-save.ts"
      to: "src/actions/auto-save-actions.ts"
      via: "server action call from hook"
      pattern: "autoSaveMessages"
    - from: "src/components/workshop/chat-panel.tsx"
      to: "src/hooks/use-auto-save.ts"
      via: "hook usage in component"
      pattern: "useAutoSave"
    - from: "src/hooks/use-auto-save.ts"
      to: "use-debounce"
      via: "library import"
      pattern: "useDebouncedCallback"
---

<objective>
Add `needs_regeneration` status to workshop steps schema and implement debounced auto-save for chat messages to prevent data loss during workshops.

Purpose: Foundation for Phase 10 navigation features. The schema extension enables cascade invalidation (Plan 02). Auto-save ensures messages persist every 2 seconds without blocking the UI, and flush-on-navigate prevents data loss when users change steps.

Output: Extended schema with migration applied, use-debounce installed, auto-save hook wired into ChatPanel.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-navigation-persistence/10-RESEARCH.md

@src/db/schema/steps.ts
@src/db/schema/index.ts
@src/lib/ai/message-persistence.ts
@src/components/workshop/chat-panel.tsx
@src/components/workshop/step-navigation.tsx
@src/actions/workshop-actions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend schema with needs_regeneration status and install use-debounce</name>
  <files>
    src/db/schema/steps.ts
    src/actions/workshop-actions.ts
    package.json
  </files>
  <action>
1. Install use-debounce: `npm install use-debounce`

2. In `src/db/schema/steps.ts`, update the `workshopSteps.status` column to include `needs_regeneration`:
   - Change the enum array to: `['not_started', 'in_progress', 'complete', 'needs_regeneration']`
   - Update the `.$type<>()` union to include `'needs_regeneration'`

3. In `src/actions/workshop-actions.ts`, update the `updateStepStatus` function signature:
   - Change the status parameter type from `'not_started' | 'in_progress' | 'complete'` to `'not_started' | 'in_progress' | 'complete' | 'needs_regeneration'`
   - Add handling for `needs_regeneration` status in the timestamp logic: same as `not_started` (clear completedAt)

4. Run `npm run db:push:dev` to apply the schema change to the Neon database.

IMPORTANT: Do NOT create a Drizzle migration file. Use `db:push:dev` which pushes schema changes directly (this is the established pattern in this project -- see drizzle.config.ts uses `push` not `migrate` for dev).
  </action>
  <verify>
- `npx tsc --noEmit` passes with zero errors
- `npm run db:push:dev` succeeds (schema applied to Neon)
- `use-debounce` appears in package.json dependencies
- `needs_regeneration` appears in steps.ts status enum
  </verify>
  <done>
Schema includes `needs_regeneration` status value, use-debounce is installed, TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create auto-save hook and wire into ChatPanel</name>
  <files>
    src/hooks/use-auto-save.ts
    src/actions/auto-save-actions.ts
    src/components/workshop/chat-panel.tsx
  </files>
  <action>
1. Create `src/actions/auto-save-actions.ts` (server action):
   - Add `'use server'` directive at top
   - Export `autoSaveMessages(sessionId: string, stepId: string, messages: Array<{ id: string; role: string; parts: Array<{ type: string; text: string }> }>): Promise<void>`
   - Reuse the same deduplication logic from `src/lib/ai/message-persistence.ts` saveMessages function:
     - Fetch existing messageIds for session+step
     - Filter to only new messages
     - Insert new messages with content extracted from parts
   - Wrap in try/catch, log errors but do NOT throw (auto-save failures should be silent to avoid disrupting the user)
   - Note: We duplicate the save logic rather than importing saveMessages because server actions need their own module boundary. The logic is simple (query existing, filter new, insert).

2. Create `src/hooks/use-auto-save.ts`:
   - Import `useDebouncedCallback` from `use-debounce`
   - Import `autoSaveMessages` from `@/actions/auto-save-actions`
   - Export `useAutoSave(sessionId: string, stepId: string, messages: UIMessage[])` hook
   - Create debounced callback with 2000ms delay and `{ maxWait: 10000 }` options
   - In a useEffect, call debounced save whenever messages array changes (and length > 0)
   - In a separate cleanup useEffect, call `debouncedSave.flush()` on unmount to ensure pending saves complete before component teardown
   - Return `{ isPending: boolean, flush: () => void }` for consumer use

3. Wire into `src/components/workshop/chat-panel.tsx`:
   - Import `useAutoSave` from `@/hooks/use-auto-save`
   - Import `getStepByOrder` is already imported
   - Call `useAutoSave(sessionId, step.id, messages)` inside the component (after the existing `useChat` call)
   - The hook will automatically save on message changes and flush on unmount
   - Do NOT add any visible UI for auto-save status (keep it invisible/background)

4. Update `src/components/workshop/step-navigation.tsx`:
   - No changes needed here. The auto-save hook's flush-on-unmount handles the "save before navigate" case because ChatPanel unmounts when the user navigates to a different step page (the step page is a Server Component that re-renders with new params).

IMPORTANT: The `useChat` hook from AI SDK already persists messages via the chat API route on each exchange. The auto-save hook provides an ADDITIONAL safety net that catches any messages that might not have been persisted (e.g., if the user navigates away during streaming, or if the chat API response was interrupted). It uses the same deduplication pattern (check existing messageIds) so double-saves are harmless.
  </action>
  <verify>
- `npx tsc --noEmit` passes with zero errors
- `src/hooks/use-auto-save.ts` exists and exports `useAutoSave`
- `src/actions/auto-save-actions.ts` exists and exports `autoSaveMessages`
- ChatPanel.tsx imports and calls `useAutoSave`
- `npm run build` succeeds (no build errors)
  </verify>
  <done>
Auto-save hook debounces at 2s with 10s maxWait, flushes on unmount, is wired into ChatPanel. Messages auto-persist to database without blocking UI. Server action silently handles save failures.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- zero TypeScript errors
2. `npm run build` -- production build succeeds
3. Schema change applied: `needs_regeneration` in workshopSteps status enum
4. Auto-save hook exists with correct debounce configuration (2s delay, 10s maxWait)
5. ChatPanel uses auto-save hook
6. No UI changes visible (auto-save is background-only)
</verification>

<success_criteria>
- workshopSteps.status accepts 'needs_regeneration' value
- use-debounce is installed and used in auto-save hook
- Auto-save triggers every 2 seconds during active conversation
- Pending saves flush when ChatPanel unmounts (step navigation)
- All existing functionality continues working (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/10-navigation-persistence/10-01-SUMMARY.md`
</output>
