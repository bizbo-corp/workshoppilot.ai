---
phase: 16-split-screen-layout
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/workshop/right-panel.tsx
  - src/components/workshop/output-accordion.tsx
  - src/components/workshop/step-container.tsx
autonomous: true

must_haves:
  truths:
    - "User sees chat panel (320px default) on the left, canvas+output right panel filling the remainder on desktop"
    - "Canvas renders on ALL steps (not just step 8) in the right panel"
    - "Output accordion appears at bottom of right panel only when an artifact has been extracted"
    - "Expanded accordion takes bottom 50% of right panel, canvas compressed to top 50%"
    - "ArtifactConfirmation buttons appear inside the expanded accordion"
    - "Divider is invisible until hover (no visible line, just hover zone)"
    - "Panel sizes persist across steps via autoSaveId"
  artifacts:
    - path: "src/components/workshop/right-panel.tsx"
      provides: "Right panel with canvas + output accordion"
      exports: ["RightPanel"]
    - path: "src/components/workshop/output-accordion.tsx"
      provides: "Collapsible output accordion with artifact confirmation"
      exports: ["OutputAccordion"]
    - path: "src/components/workshop/step-container.tsx"
      provides: "Refactored desktop layout with 320px chat, invisible divider, autoSaveId"
      contains: "RightPanel"
  key_links:
    - from: "src/components/workshop/step-container.tsx"
      to: "src/components/workshop/right-panel.tsx"
      via: "import and render RightPanel in right Panel"
      pattern: "import.*RightPanel.*right-panel"
    - from: "src/components/workshop/right-panel.tsx"
      to: "src/components/workshop/output-accordion.tsx"
      via: "renders OutputAccordion at bottom of right panel"
      pattern: "OutputAccordion"
    - from: "src/components/workshop/right-panel.tsx"
      to: "src/components/canvas/canvas-wrapper.tsx"
      via: "renders CanvasWrapper on ALL steps"
      pattern: "CanvasWrapper"
    - from: "src/components/workshop/output-accordion.tsx"
      to: "src/components/workshop/output-panel.tsx"
      via: "renders OutputPanel inside expanded accordion"
      pattern: "OutputPanel"
    - from: "src/components/workshop/output-accordion.tsx"
      to: "src/components/workshop/artifact-confirmation.tsx"
      via: "renders ArtifactConfirmation inside expanded accordion"
      pattern: "ArtifactConfirmation"
---

<objective>
Restructure the step page into a true split-screen layout where chat is a narrow left panel (320px default) and the right panel contains the canvas (ALL steps) with an output accordion at the bottom.

Purpose: Implements LAYOUT-01 (split-screen on all steps), LAYOUT-02 (resizable divider), and LAYOUT-03 (canvas as primary right panel content, output as accordion). The canvas becomes the primary workspace visible on every step, chat becomes the assistant sidebar, and extracted artifacts appear in a collapsible accordion at the bottom of the right panel.

Output: `right-panel.tsx` (new), `output-accordion.tsx` (new), refactored `step-container.tsx` (desktop path only -- mobile handled in Plan 02)
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-split-screen-layout/16-CONTEXT.md
@.planning/phases/16-split-screen-layout/16-RESEARCH.md
@src/components/workshop/step-container.tsx
@src/components/workshop/output-panel.tsx
@src/components/workshop/artifact-confirmation.tsx
@src/components/canvas/canvas-wrapper.tsx
@src/app/workshop/[sessionId]/step/[stepId]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create OutputAccordion and RightPanel components</name>
  <files>
    src/components/workshop/output-accordion.tsx
    src/components/workshop/right-panel.tsx
  </files>
  <action>
**Create `src/components/workshop/output-accordion.tsx`:**

A collapsible accordion component that wraps the OutputPanel and ArtifactConfirmation. This component only renders when an artifact has been extracted (the parent controls visibility).

Props interface:
```typescript
interface OutputAccordionProps {
  stepOrder: number;
  artifact: Record<string, unknown>;
  isExtracting: boolean;
  extractionError: string | null;
  onRetry?: () => void;
  artifactConfirmed: boolean;
  onConfirm: () => void;
  onEdit: () => void;
}
```

Implementation:
- `'use client'` component
- Internal `isExpanded` state, default `true` (auto-expand when artifact first appears)
- **Collapsed state:** A clickable bar at the bottom showing "Output" label on the left and a `ChevronUp` icon on the right. Styling: `border-t bg-muted/50 px-4 py-2 cursor-pointer hover:bg-muted/70 transition-colors`. The chevron rotates 180deg when expanded (use `transform rotate-180` with transition).
- **Expanded state:** The accordion takes up space via CSS. Use a flex layout where the parent (RightPanel) splits vertically. The expanded accordion content:
  - `overflow-y-auto` for scrollable content
  - Renders `<OutputPanel stepOrder={stepOrder} artifact={artifact} isExtracting={isExtracting} extractionError={extractionError} onRetry={onRetry} />`
  - Below OutputPanel, renders `<ArtifactConfirmation onConfirm={onConfirm} onEdit={onEdit} isConfirming={false} isConfirmed={artifactConfirmed} />` wrapped in `<div className="border-t bg-background p-4">`
- Import OutputPanel from `./output-panel` and ArtifactConfirmation from `./artifact-confirmation`
- Import `ChevronUp` from `lucide-react`
- Use `cn` from `@/lib/utils` for conditional classes

**Create `src/components/workshop/right-panel.tsx`:**

The main right panel component containing canvas (always) and output accordion (conditionally).

Props interface:
```typescript
interface RightPanelProps {
  stepOrder: number;
  sessionId: string;
  workshopId: string;
  artifact: Record<string, unknown> | null;
  isExtracting: boolean;
  extractionError: string | null;
  onRetry?: () => void;
  artifactConfirmed: boolean;
  onConfirm: () => void;
  onEdit: () => void;
}
```

Implementation:
- `'use client'` component
- Layout: `<div className="flex h-full flex-col">` as root
- **Canvas section:** Always rendered. When accordion is collapsed or hidden: `<div className="flex-1 min-h-0">`. When accordion is expanded: `<div className="flex-1 min-h-0">` (canvas gets top portion, accordion gets bottom). The canvas section renders:
  ```tsx
  <CanvasWrapper
    sessionId={sessionId}
    stepId={stepMeta?.id || ''}
    workshopId={workshopId}
  />
  ```
  Where `stepMeta` comes from `getStepByOrder(stepOrder)`.
- **Output accordion section:** Only rendered when `artifact !== null || isExtracting || extractionError !== null`. When rendered, wrap in a container that takes bottom 50% when expanded:
  ```tsx
  {showOutput && (
    <OutputAccordion
      stepOrder={stepOrder}
      artifact={artifact!}
      isExtracting={isExtracting}
      extractionError={extractionError}
      onRetry={onRetry}
      artifactConfirmed={artifactConfirmed}
      onConfirm={onConfirm}
      onEdit={onEdit}
    />
  )}
  ```
  The OutputAccordion manages its own expanded/collapsed state internally.
- For the 50/50 split when accordion is expanded, use a nested `Group` from react-resizable-panels with `orientation="vertical"`:
  - Top Panel (canvas): `defaultSize={50} minSize={30}`
  - Separator (horizontal, thin)
  - Bottom Panel (accordion content): `defaultSize={50} minSize={20}`
  When accordion is collapsed, skip the Group and just show canvas full-height with the collapsed bar at the bottom.
- Import CanvasWrapper from `@/components/canvas/canvas-wrapper`
- Import OutputAccordion from `./output-accordion`
- Import `getStepByOrder` from `@/lib/workshop/step-metadata`
- Import Group, Panel, Separator from `react-resizable-panels` for the vertical split

**IMPORTANT implementation detail for the accordion expand/collapse:**
The OutputAccordion component should expose whether it is expanded via a callback prop (`onExpandedChange?: (expanded: boolean) => void`) so the RightPanel can switch between full-canvas and split layouts. The RightPanel tracks `isAccordionExpanded` state and conditionally renders:
- When collapsed: canvas div `flex-1` + collapsed OutputAccordion bar at bottom
- When expanded: vertical Group with two Panels (canvas top 50%, accordion content bottom 50%)
  </action>
  <verify>
Run `npx tsc --noEmit` -- no TypeScript errors. Verify `right-panel.tsx` exports `RightPanel`. Verify `output-accordion.tsx` exports `OutputAccordion`. Verify `right-panel.tsx` imports CanvasWrapper. Verify `output-accordion.tsx` imports OutputPanel and ArtifactConfirmation.
  </verify>
  <done>
RightPanel component renders CanvasWrapper on ALL steps. OutputAccordion renders conditionally when artifact exists (or extraction in progress). Collapsed accordion shows "Output" label with chevron. Expanded accordion splits right panel 50/50 (canvas top, output bottom). ArtifactConfirmation buttons appear inside the expanded accordion. TypeScript compiles successfully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor step-container.tsx desktop layout</name>
  <files>
    src/components/workshop/step-container.tsx
  </files>
  <action>
Refactor `step-container.tsx` to use the new RightPanel component and implement the CONTEXT.md-specified desktop layout. **This task only modifies the desktop layout path.** Mobile layout is handled in Plan 02.

**Changes to imports:**
1. **Remove** `OutputPanel` import from `./output-panel` (moved to output-accordion.tsx)
2. **Remove** `ArtifactConfirmation` import from `./artifact-confirmation` (moved to output-accordion.tsx)
3. The `CanvasWrapper` import stays for now (will be needed in mobile path until Plan 02, but actually the RightPanel handles it -- check if still needed after changes. If not used directly, remove it.)
4. **Add** `import { RightPanel } from './right-panel';`

**Delete the `renderOutput()` function** (lines 239-277). This entire function is replaced by RightPanel.

**Refactor the desktop layout (currently lines 305-343):**

Replace the current 50/50 panel split with the CONTEXT.md-specified layout:
- Chat panel: `defaultSize={25}` (approximately 320px out of a typical 1280px viewport). Use `minSize={15}` to prevent squishing below usable width.
- Right panel: Fills remainder. `defaultSize={75}` with `minSize={40}`.
- Add `autoSaveId="workshop-panels"` to the Group to persist panel sizes across steps and page reloads (per CONTEXT.md decision: "Panel sizes persist across steps").

The divider must be **invisible until hover** (per CONTEXT.md: "Divider is invisible until hover -- no visible line, just a hover zone that highlights on mouse-over"). Modify the Separator:
```tsx
<Separator className="group relative w-0 hover:w-px data-[resize-handle-state=drag]:w-px">
  {/* Invisible touch-friendly hit area (24px wide) */}
  <div className="absolute inset-y-0 -left-3 -right-3 cursor-col-resize" />
  {/* Visual indicator on hover only */}
  <div className="absolute inset-y-0 left-0 w-px bg-border opacity-0 transition-opacity group-hover:opacity-100 group-data-[resize-handle-state=drag]:opacity-100" />
</Separator>
```
Key difference from current: `w-0` instead of `w-px bg-border`, making the line invisible by default. The hover/drag states reveal it.

Replace `{renderOutput()}` in the right Panel with:
```tsx
<RightPanel
  stepOrder={stepOrder}
  sessionId={sessionId}
  workshopId={workshopId}
  artifact={artifact}
  isExtracting={isExtracting}
  extractionError={extractionError}
  onRetry={extractArtifact}
  artifactConfirmed={artifactConfirmed}
  onConfirm={handleConfirm}
  onEdit={handleEdit}
/>
```

**Keep unchanged:**
- `renderContent()` function (chat panel with extract button)
- Step 8 early return to IdeationSubStepContainer (line 187-208)
- `isMobile` detection and mobile layout (will be changed in Plan 02)
- StepNavigation at the bottom spanning full width
- ResetStepDialog
- All state management (artifact, extraction, confirmation, messages)

**For the mobile layout (lines 280-303):** Keep it AS-IS for now (it still uses `{renderOutput()}` which we deleted). Replace `{renderOutput()}` in the mobile path with `<RightPanel ... />` using the same props as desktop. The full mobile tab redesign happens in Plan 02, but we need it to not break in the meantime.
  </action>
  <verify>
Run `npx tsc --noEmit` -- no TypeScript errors. Run `npm run build` -- build succeeds. Grep `step-container.tsx` for `RightPanel` (should be found). Grep `step-container.tsx` for `renderOutput` (should NOT be found). Grep `step-container.tsx` for `autoSaveId="workshop-panels"` (should be found). Grep `step-container.tsx` for `defaultSize={25}` (chat panel should be ~25% = ~320px). Verify divider has `w-0` class (invisible by default).
  </verify>
  <done>
Desktop layout: chat panel at ~320px (defaultSize={25}) on left, RightPanel filling remainder on right. Divider invisible until hover. Panel sizes persist across steps via autoSaveId. Canvas renders on ALL steps (via RightPanel). Output accordion appears when artifact extracted. Mobile layout temporarily uses RightPanel (full redesign in Plan 02). `renderOutput()` function deleted. `npm run build` succeeds.
  </done>
</task>

</tasks>

<verification>
**LAYOUT-01:** Chat panel left, right panel right on all steps
- Desktop: `Group orientation="horizontal"` with chat Panel (defaultSize=25) and right Panel (defaultSize=75)
- RightPanel renders CanvasWrapper on ALL steps (not just step 8)
- Step 8: IdeationSubStepContainer handles its own layout (unchanged, early return)

**LAYOUT-02:** Resizable divider between panels
- Separator from react-resizable-panels with 24px invisible hit area
- Divider invisible by default (w-0), visible on hover/drag
- autoSaveId="workshop-panels" persists panel sizes

**LAYOUT-03:** Canvas as primary right panel, output as accordion
- CanvasWrapper always rendered in RightPanel
- OutputAccordion appears only when artifact extracted
- Collapsed: "Output" label with chevron at bottom
- Expanded: 50/50 vertical split (canvas top, output+confirmation bottom)
- ArtifactConfirmation inside the expanded accordion
</verification>

<success_criteria>
1. `npm run build` succeeds with zero errors
2. `npx tsc --noEmit` passes
3. `right-panel.tsx` exists and exports RightPanel
4. `output-accordion.tsx` exists and exports OutputAccordion
5. `step-container.tsx` uses RightPanel (not renderOutput)
6. `right-panel.tsx` renders CanvasWrapper on ALL steps
7. `output-accordion.tsx` renders OutputPanel and ArtifactConfirmation
8. Desktop chat panel defaults to ~320px (defaultSize=25)
9. Divider invisible by default (w-0, hover-only reveal)
10. autoSaveId persists panel sizes
11. Step 8 early-returns to IdeationSubStepContainer (unchanged)
</success_criteria>

<output>
After completion, create `.planning/phases/16-split-screen-layout/16-01-SUMMARY.md`
</output>
