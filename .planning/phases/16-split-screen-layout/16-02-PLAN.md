---
phase: 16-split-screen-layout
plan: 02
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - src/components/workshop/step-container.tsx
  - src/components/workshop/mobile-tab-bar.tsx
autonomous: true

must_haves:
  truths:
    - "On mobile (<768px), user sees tabs to switch between Chat and Canvas (one visible at a time)"
    - "Chat tab is the default when landing on a step"
    - "Tab bar sits at the bottom of the screen, above the step navigation"
    - "Tab switching is instant (no loading, both components remain mounted)"
  artifacts:
    - path: "src/components/workshop/mobile-tab-bar.tsx"
      provides: "Bottom tab bar for mobile Chat/Canvas switching"
      exports: ["MobileTabBar"]
    - path: "src/components/workshop/step-container.tsx"
      provides: "Mobile layout with tab-based panel switching"
      contains: "MobileTabBar"
  key_links:
    - from: "src/components/workshop/step-container.tsx"
      to: "src/components/workshop/mobile-tab-bar.tsx"
      via: "import and render MobileTabBar in mobile layout"
      pattern: "import.*MobileTabBar.*mobile-tab-bar"
    - from: "src/components/workshop/step-container.tsx"
      to: "src/components/workshop/right-panel.tsx"
      via: "renders RightPanel in mobile canvas tab (from Plan 01)"
      pattern: "RightPanel"
---

<objective>
Replace the mobile stacked layout with tab-based panel switching (Chat vs Canvas tabs) and add collapsible panel functionality on desktop.

Purpose: Implements LAYOUT-04 (mobile tab switching instead of stacking) and the desktop collapse/expand feature from CONTEXT.md. On mobile, users see one panel at a time with a bottom tab bar. On desktop, both panels can collapse to thin icon strips for focused work.

Output: `mobile-tab-bar.tsx` (new), refactored mobile + desktop sections of `step-container.tsx`
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-split-screen-layout/16-CONTEXT.md
@.planning/phases/16-split-screen-layout/16-01-SUMMARY.md
@src/components/workshop/step-container.tsx
@src/components/workshop/right-panel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MobileTabBar and implement mobile tab-based layout</name>
  <files>
    src/components/workshop/mobile-tab-bar.tsx
    src/components/workshop/step-container.tsx
  </files>
  <action>
**Create `src/components/workshop/mobile-tab-bar.tsx`:**

A bottom tab bar component for mobile viewports that switches between Chat and Canvas views.

Props interface:
```typescript
interface MobileTabBarProps {
  activeTab: 'chat' | 'canvas';
  onTabChange: (tab: 'chat' | 'canvas') => void;
}
```

Implementation:
- `'use client'` component
- Renders a horizontal bar with two tab buttons
- Layout: `flex items-center border-t bg-background` with equal-width buttons
- Each tab button:
  - Icon + label (Chat: `MessageSquare` icon + "Chat", Canvas: `Layout` icon + "Canvas")
  - Active state: `text-foreground font-medium` with a top accent line (e.g., `border-t-2 border-primary`)
  - Inactive state: `text-muted-foreground`
  - `py-2` for comfortable touch targets
- Import `MessageSquare`, `Layout` from `lucide-react`
- Use `cn` from `@/lib/utils` for conditional classes

**Refactor mobile layout in `step-container.tsx`:**

Replace the current mobile stacked layout (the `if (isMobile)` block) with tab-based switching.

Add state for mobile tab:
```typescript
const [mobileTab, setMobileTab] = React.useState<'chat' | 'canvas'>('chat');
```

New mobile layout structure:
```tsx
if (isMobile) {
  return (
    <div className="flex h-full flex-col">
      {/* Content area - show one panel at a time */}
      <div className="min-h-0 flex-1 overflow-hidden">
        {/* Both panels mounted, visibility toggled with CSS for instant switching */}
        <div className={cn('h-full', mobileTab !== 'chat' && 'hidden')}>
          {renderContent()}
        </div>
        <div className={cn('h-full', mobileTab !== 'canvas' && 'hidden')}>
          <RightPanel
            stepOrder={stepOrder}
            sessionId={sessionId}
            workshopId={workshopId}
            artifact={artifact}
            isExtracting={isExtracting}
            extractionError={extractionError}
            onRetry={extractArtifact}
            artifactConfirmed={artifactConfirmed}
            onConfirm={handleConfirm}
            onEdit={handleEdit}
          />
        </div>
      </div>

      {/* Tab bar - above step navigation */}
      <MobileTabBar activeTab={mobileTab} onTabChange={setMobileTab} />

      {/* Step navigation - fixed at bottom, full width */}
      <StepNavigation
        sessionId={sessionId}
        workshopId={workshopId}
        currentStepOrder={stepOrder}
        artifactConfirmed={artifactConfirmed}
        stepStatus={stepStatus}
        onRevise={handleRevise}
        onReset={() => setShowResetDialog(true)}
      />
      <ResetStepDialog
        open={showResetDialog}
        onOpenChange={setShowResetDialog}
        onConfirm={handleReset}
        isResetting={isResetting}
        stepName={getStepByOrder(stepOrder)?.name || `Step ${stepOrder}`}
      />
    </div>
  );
}
```

Key points:
- Both panels remain mounted (hidden with CSS `hidden` class, NOT conditional rendering). This ensures:
  - Canvas state is preserved when switching tabs
  - Chat scroll position is preserved
  - No re-render/re-mount on tab switch
  - Instant switching feel
- Chat tab is default (`useState('chat')`)
- Tab bar sits between content and step navigation
- Step navigation remains at the very bottom, full width
- **Output accordion on mobile:** The RightPanel (rendered in the Canvas tab) includes the output accordion. Per CONTEXT.md: "Output accordion appears on the Canvas tab (same as desktop behavior)." No additional mobile-specific accordion logic is needed -- when the user taps the Canvas tab, they see the canvas AND the output accordion (if an artifact has been extracted), exactly as on desktop.

**Import MobileTabBar:** Add `import { MobileTabBar } from './mobile-tab-bar';` to step-container.tsx.
  </action>
  <verify>
Run `npx tsc --noEmit` -- no TypeScript errors. Verify `mobile-tab-bar.tsx` exists and exports `MobileTabBar`. Grep `step-container.tsx` for `MobileTabBar` (should be found). Grep `step-container.tsx` for `mobileTab` (should be found). Grep `step-container.tsx` for `'chat' | 'canvas'` (tab type union should be found). Verify output accordion on mobile: confirm RightPanel is rendered inside the Canvas tab's `div` -- this ensures the output accordion (part of RightPanel) is visible when the Canvas tab is active, per CONTEXT.md "Output accordion appears on the Canvas tab."
  </verify>
  <done>
Mobile layout uses tab-based switching between Chat and Canvas views. Tab bar at bottom with Chat and Canvas buttons. Chat is default tab. Both panels stay mounted (CSS hidden toggle) for instant switching and state preservation. Step navigation fixed at very bottom below tab bar.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add desktop panel collapse/expand functionality</name>
  <files>
    src/components/workshop/step-container.tsx
  </files>
  <action>
Add collapsible panels on desktop per CONTEXT.md decisions:
- "Chat panel is collapsible on desktop -- collapses to a thin icon strip (~40px) with chat icon and expand button"
- "Canvas/right panel is also collapsible -- user can go full-chat or full-canvas"

**Add state for panel collapse:**
```typescript
const [chatCollapsed, setChatCollapsed] = React.useState(false);
const [canvasCollapsed, setCanvasCollapsed] = React.useState(false);
```

**Implement collapsed chat panel strip:**
When `chatCollapsed` is true, instead of the chat Panel, render a thin vertical strip (~40px wide):
```tsx
<div className="flex w-10 flex-col items-center border-r bg-muted/30 py-4">
  <button
    onClick={() => setChatCollapsed(false)}
    className="rounded-md p-2 text-muted-foreground hover:bg-muted hover:text-foreground transition-colors"
    title="Expand chat"
  >
    <MessageSquare className="h-5 w-5" />
  </button>
</div>
```
Import `MessageSquare`, `PanelLeftClose`, `PanelRightClose` from `lucide-react`.

**Implement collapsed canvas panel strip:**
When `canvasCollapsed` is true, instead of the right Panel, render a thin vertical strip:
```tsx
<div className="flex w-10 flex-col items-center border-l bg-muted/30 py-4">
  <button
    onClick={() => setCanvasCollapsed(false)}
    className="rounded-md p-2 text-muted-foreground hover:bg-muted hover:text-foreground transition-colors"
    title="Expand canvas"
  >
    <LayoutGrid className="h-5 w-5" />
  </button>
</div>
```
Import `LayoutGrid` from `lucide-react`.

**Add collapse buttons to expanded panels:**
- In the chat panel (`renderContent()`), add a collapse button at the top-right corner of the chat section. Add a small button row at the top of the chat content area:
  ```tsx
  {!isMobile && (
    <div className="flex justify-end px-2 pt-2">
      <button
        onClick={() => setChatCollapsed(true)}
        className="rounded-md p-1 text-muted-foreground hover:bg-muted hover:text-foreground transition-colors"
        title="Collapse chat"
      >
        <PanelLeftClose className="h-4 w-4" />
      </button>
    </div>
  )}
  ```
- For the right panel, add a collapse trigger. Pass `onCollapse` prop to RightPanel:
  ```tsx
  <RightPanel
    ...existingProps
    onCollapse={() => setCanvasCollapsed(true)}
  />
  ```
  Update RightPanel to accept optional `onCollapse?: () => void` prop and render a collapse button in the top-right corner of the canvas area:
  ```tsx
  {onCollapse && (
    <div className="absolute top-2 right-2 z-10">
      <button
        onClick={onCollapse}
        className="rounded-md bg-background/80 p-1 text-muted-foreground shadow-sm hover:bg-muted hover:text-foreground transition-colors"
        title="Collapse canvas"
      >
        <PanelRightClose className="h-4 w-4" />
      </button>
    </div>
  )}
  ```

**Desktop layout restructure:**
The desktop return now conditionally renders based on collapse state:
```tsx
<div className="flex h-full flex-col">
  <div className="min-h-0 flex-1 overflow-hidden flex">
    {chatCollapsed ? (
      <CollapsedChatStrip />
    ) : canvasCollapsed ? (
      // Chat takes full width when canvas collapsed
      <div className="flex-1">
        {renderContent()}
        {/* Expand canvas button somewhere */}
      </div>
    ) : (
      // Normal resizable panels
      <Group orientation="horizontal" autoSaveId="workshop-panels" className="h-full">
        <Panel defaultSize={25} minSize={15}>
          {renderContent()}
        </Panel>
        <Separator ...invisibleDivider />
        <Panel defaultSize={75} minSize={40}>
          <RightPanel ...props onCollapse={() => setCanvasCollapsed(true)} />
        </Panel>
      </Group>
    )}
    {/* Collapsed strips on the side */}
    {chatCollapsed && !canvasCollapsed && (
      <div className="flex-1">
        <RightPanel ...props onCollapse={() => setCanvasCollapsed(true)} />
      </div>
    )}
    {canvasCollapsed && !chatCollapsed && (
      <CollapsedCanvasStrip />
    )}
    {chatCollapsed && canvasCollapsed && (
      // Edge case: both collapsed - show both strips
      <div className="flex-1 flex items-center justify-center text-muted-foreground">
        <p className="text-sm">Expand a panel to continue</p>
      </div>
    )}
  </div>
  <StepNavigation ...props />
  <ResetStepDialog ...props />
</div>
```

Simplify this logic: Use a clean approach where the layout is a flex row containing:
1. If chatCollapsed: collapsed strip (40px). Else: Panel with chat content.
2. If neither collapsed: Separator between panels.
3. If canvasCollapsed: collapsed strip (40px). Else: Panel with RightPanel.

When one panel is collapsed, the other should take full width (no Group needed). When both are open, use the Group with resizable panels.

**Important:** Only apply collapse logic on desktop (non-mobile). Mobile uses tabs from Task 1, not collapse.
  </action>
  <verify>
Run `npx tsc --noEmit` -- no TypeScript errors. Run `npm run build` -- build succeeds. Grep `step-container.tsx` for `chatCollapsed` (should be found). Grep `step-container.tsx` for `canvasCollapsed` (should be found). Grep `step-container.tsx` for `PanelLeftClose` or `PanelRightClose` (should be found). Grep `right-panel.tsx` for `onCollapse` (should be found as optional prop).
  </verify>
  <done>
Desktop panels are collapsible: chat collapses to 40px icon strip with expand button, canvas collapses to 40px icon strip with expand button. Collapse buttons appear in each panel's header area. When one panel is collapsed, the other takes full width. Both panels being collapsible allows users to focus on full-chat or full-canvas mode. Mobile layout unchanged (uses tabs from Task 1). Build succeeds.
  </done>
</task>

</tasks>

<verification>
**LAYOUT-04:** Mobile tab-based switching
- Tab bar at bottom with Chat and Canvas tabs
- Chat is default tab
- Both panels mounted but hidden with CSS (instant switching)
- Tab bar sits between content area and step navigation
- No stacking -- one panel visible at a time
- Output accordion visible on Canvas tab when artifact extracted (RightPanel includes it)

> **Note:** CONTEXT.md locks mobile layout as tabs (one panel visible at a time), NOT vertical stacking. The ROADMAP.md LAYOUT-04 success criteria phrase "chat stacks above right panel vertically" is outdated and superseded by the CONTEXT.md decision. This plan implements tabs per CONTEXT.md.

**Desktop collapse/expand:**
- Chat panel collapses to ~40px strip with MessageSquare icon
- Canvas panel collapses to ~40px strip with LayoutGrid icon
- Collapsed panel has expand button
- Expanded panels have collapse buttons
- When one collapsed, other takes full width
</verification>

<success_criteria>
1. `npm run build` succeeds with zero errors
2. `npx tsc --noEmit` passes
3. Mobile (<768px): Tab bar visible with Chat and Canvas tabs
4. Mobile: Chat tab is default, shows chat panel
5. Mobile: Canvas tab shows RightPanel with canvas
6. Mobile: Tab switching is instant (CSS hidden toggle, not unmount/remount)
7. Mobile: Tab bar above step navigation
8. Desktop: Chat panel has collapse button
9. Desktop: Canvas panel has collapse button
10. Desktop: Collapsed panels show thin icon strip
11. Desktop: Clicking expand restores panel
</success_criteria>

<output>
After completion, create `.planning/phases/16-split-screen-layout/16-02-SUMMARY.md`
</output>
