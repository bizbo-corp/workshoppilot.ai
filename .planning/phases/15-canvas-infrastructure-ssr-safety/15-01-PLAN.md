---
phase: 15-canvas-infrastructure-ssr-safety
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/stores/canvas-store.ts
  - src/providers/canvas-store-provider.tsx
  - src/components/canvas/post-it-node.tsx
  - src/components/canvas/canvas-loading-skeleton.tsx
  - src/components/canvas/canvas-wrapper.tsx
autonomous: true

must_haves:
  truths:
    - "Canvas store created via factory pattern (not module-level) with Zustand"
    - "Canvas store provider wraps children with per-request store isolation"
    - "Post-it node renders as classic yellow sticky note with drop shadow"
    - "Canvas wrapper uses next/dynamic with ssr: false to prevent hydration errors"
    - "@xyflow/react is installed and importable"
  artifacts:
    - path: "src/stores/canvas-store.ts"
      provides: "Canvas Zustand store factory with PostIt type and CRUD actions"
      exports: ["createCanvasStore", "PostIt", "CanvasState", "CanvasActions"]
    - path: "src/providers/canvas-store-provider.tsx"
      provides: "React context provider for per-request canvas store isolation"
      exports: ["CanvasStoreProvider", "useCanvasStore"]
    - path: "src/components/canvas/post-it-node.tsx"
      provides: "Custom ReactFlow node rendering classic yellow post-it"
      exports: ["PostItNode", "PostItNodeData"]
    - path: "src/components/canvas/canvas-loading-skeleton.tsx"
      provides: "Loading skeleton shown while canvas dynamically imports"
      exports: ["CanvasLoadingSkeleton"]
    - path: "src/components/canvas/canvas-wrapper.tsx"
      provides: "SSR-safe dynamic import wrapper for ReactFlow canvas"
      exports: ["CanvasWrapper"]
  key_links:
    - from: "src/providers/canvas-store-provider.tsx"
      to: "src/stores/canvas-store.ts"
      via: "imports createCanvasStore factory"
      pattern: "import.*createCanvasStore.*from.*stores/canvas-store"
    - from: "src/components/canvas/canvas-wrapper.tsx"
      to: "src/components/canvas/canvas-loading-skeleton.tsx"
      via: "loading fallback for dynamic import"
      pattern: "dynamic.*ssr.*false"
---

<objective>
Install ReactFlow and create the canvas infrastructure foundation: Zustand store with factory pattern for SSR safety, React context provider for per-request store isolation, custom post-it node component, loading skeleton, and SSR-safe dynamic import wrapper.

Purpose: Establish all foundational pieces that the ReactFlow canvas component (Plan 02) and persistence layer (Plan 03) will build upon. This plan ensures zero SSR hydration errors by using proper patterns from the start.

Output: 6 new files providing canvas store, provider, post-it node, skeleton, and SSR-safe wrapper. @xyflow/react installed.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-canvas-infrastructure-ssr-safety/15-RESEARCH.md
@.planning/phases/15-canvas-infrastructure-ssr-safety/15-CONTEXT.md

# Key existing files to reference:
@src/db/schema/step-artifacts.ts
@src/lib/context/save-artifact.ts
@src/hooks/use-auto-save.ts
@src/app/workshop/[sessionId]/step/[stepId]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @xyflow/react and create Zustand canvas store with provider</name>
  <files>
    package.json
    src/stores/canvas-store.ts
    src/providers/canvas-store-provider.tsx
  </files>
  <action>
    1. Install ReactFlow: `npm install @xyflow/react@latest`
       - Verify installation: `npm list @xyflow/react`

    2. Create `src/stores/canvas-store.ts` — Zustand store using FACTORY PATTERN (not module-level):
       - Import `createStore` from `zustand/vanilla` (not `create` from `zustand` — vanilla for factory pattern)
       - Define `PostIt` type: `{ id: string; text: string; position: { x: number; y: number }; width: number; height: number }`
       - Define `CanvasState`: `{ postIts: PostIt[]; isDirty: boolean }`
       - Define `CanvasActions`: `{ addPostIt, updatePostIt, deletePostIt, setPostIts, markClean }`
       - Export `createCanvasStore` factory function that accepts optional initial state `{ postIts: PostIt[] }`
       - `addPostIt`: takes `Omit<PostIt, 'id'>`, generates ID with `crypto.randomUUID()`, sets isDirty to true
       - `updatePostIt`: takes `id` and `Partial<PostIt>`, updates matching post-it, sets isDirty to true
       - `deletePostIt`: takes `id`, filters out matching post-it, sets isDirty to true
       - `setPostIts`: replaces entire postIts array (for loading from DB), does NOT set isDirty
       - `markClean`: sets isDirty to false (called after successful save)

    3. Create `src/providers/canvas-store-provider.tsx` — React context provider:
       - Add `'use client'` directive
       - Create `CanvasStoreContext` using `createContext<ReturnType<typeof createCanvasStore> | null>(null)`
       - Create `CanvasStoreProvider` component accepting `children` and optional `initialPostIts: PostIt[]`
       - Inside provider: `const [store] = useState(() => createCanvasStore({ postIts: initialPostIts || [] }))` — creates store ONCE per mount (per-request isolation)
       - Create `useCanvasStore<T>(selector: (store: CanvasState & CanvasActions) => T): T` hook
       - Hook uses `useStore(context, selector)` from `zustand` — throws error if used outside provider
       - Export: `CanvasStoreProvider`, `useCanvasStore`
  </action>
  <verify>
    - `npm list @xyflow/react` shows installed version
    - `npx tsc --noEmit` passes without type errors
    - `src/stores/canvas-store.ts` exports `createCanvasStore`, `PostIt` type
    - `src/providers/canvas-store-provider.tsx` exports `CanvasStoreProvider`, `useCanvasStore`
  </verify>
  <done>
    @xyflow/react installed. Canvas store factory creates isolated stores with PostIt CRUD. Provider wraps children with per-request store instance. useCanvasStore hook provides typed access to store state.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create post-it node, loading skeleton, and SSR-safe wrapper</name>
  <files>
    src/components/canvas/post-it-node.tsx
    src/components/canvas/canvas-loading-skeleton.tsx
    src/components/canvas/canvas-wrapper.tsx
  </files>
  <action>
    1. Create `src/components/canvas/post-it-node.tsx` — Custom ReactFlow node:
       - Add `'use client'` directive
       - Import `memo` from React, `Handle`, `Position`, `type NodeProps` from `@xyflow/react`
       - Import `cn` from `@/lib/utils`
       - Define `PostItNodeData` type: `{ text: string; isEditing: boolean; onTextChange?: (id: string, text: string) => void; onEditComplete?: (id: string) => void }`
       - Define `PostItNode` type using `type PostItNode = Node<PostItNodeData, 'postIt'>` from ReactFlow
       - Create `PostItNode` component wrapped in `memo()`:
         - Props: `NodeProps` from ReactFlow (provides `data`, `selected`, `id`)
         - Render a `div` with these locked-decision styles:
           - Classic yellow: `bg-amber-100` (warm yellow, not neon)
           - Drop shadow: `shadow-md` (skeuomorphic feel)
           - No rotation (perfectly aligned by default)
           - Fixed width 120px via inline style `style={{ width: '120px', minHeight: '120px' }}`
           - `min-h-[120px]` — grows taller if text overflows (no truncation)
           - No corner fold — shadow alone conveys depth
           - App font: `font-sans text-sm text-gray-800` (system font, not handwritten)
         - Hover effect (Claude's discretion): subtle lift with `hover:shadow-lg hover:-translate-y-0.5 transition-all duration-150`
         - Selected state: `ring-2 ring-blue-500 ring-offset-1`
         - When `data.isEditing` is true: render a `<textarea>` with:
           - `autoFocus` attribute
           - `className` includes `nodrag nopan` (prevents drag/pan during editing — critical ReactFlow class)
           - `defaultValue={data.text}`
           - `onBlur` calls `data.onEditComplete?.(id)`
           - `onChange` calls `data.onTextChange?.(id, e.target.value)`
           - Styling: transparent background, no border, no outline, resize-none, full width/height
           - `placeholder="Type here..."`
         - When NOT editing: render `<p className="break-words whitespace-pre-wrap">{data.text || ''}</p>`
         - Include hidden Handles for future edge connections:
           - `<Handle type="target" position={Position.Top} className="!opacity-0 !w-0 !h-0" />`
           - `<Handle type="source" position={Position.Bottom} className="!opacity-0 !w-0 !h-0" />`
       - Set `PostItNode.displayName = 'PostItNode'`
       - Export `PostItNode` and `PostItNodeData` type

    2. Create `src/components/canvas/canvas-loading-skeleton.tsx` — Loading state:
       - Add `'use client'` directive
       - Render a full-size container matching canvas dimensions
       - CSS dot grid background using `radial-gradient(circle, #d1d5db 1px, transparent 1px)` with `backgroundSize: '20px 20px'` (matches canvas background)
       - Subtle `animate-pulse` overlay with reduced opacity
       - Centered text: "Loading canvas..." in muted gray

    3. Create `src/components/canvas/canvas-wrapper.tsx` — SSR-safe dynamic import:
       - Add `'use client'` directive
       - Import `dynamic` from `next/dynamic`
       - Import `CanvasLoadingSkeleton` from `./canvas-loading-skeleton`
       - Dynamic import the ReactFlow canvas component (will be created in Plan 02):
         ```
         const ReactFlowCanvas = dynamic(
           () => import('./react-flow-canvas').then((mod) => mod.ReactFlowCanvas),
           { ssr: false, loading: () => <CanvasLoadingSkeleton /> }
         );
         ```
       - Export `CanvasWrapper` component that accepts `sessionId: string` and `stepId: string` props
       - Passes sessionId and stepId through to `ReactFlowCanvas`
       - NOTE: `react-flow-canvas.tsx` will be created in Plan 02. This wrapper must be created first so Plan 02 knows the expected import contract.
  </action>
  <verify>
    - `npx tsc --noEmit` passes (may have expected error for missing react-flow-canvas.tsx — that's OK, it comes in Plan 02)
    - `src/components/canvas/post-it-node.tsx` renders yellow 120x120px sticky note with shadow
    - `src/components/canvas/canvas-wrapper.tsx` uses `next/dynamic` with `ssr: false`
    - No `'use server'` directives in any canvas component file
    - All files have `'use client'` directive
  </verify>
  <done>
    Post-it node renders as classic yellow sticky note (120x120px, drop shadow, no rotation, system font, hover lift effect). Loading skeleton shows dot grid with pulse animation. Canvas wrapper prevents SSR rendering with dynamic import.
  </done>
</task>

</tasks>

<verification>
1. `npm list @xyflow/react` — shows installed version
2. `npx tsc --noEmit` — no type errors (allow react-flow-canvas import to be unresolved)
3. All 6 files exist at specified paths
4. No module-level Zustand store instances (grep for `create(` in stores/ should only show factory function)
5. `canvas-wrapper.tsx` contains `ssr: false` in dynamic import
6. Post-it node uses Tailwind classes for yellow background and shadow (no inline color values except via Tailwind)
</verification>

<success_criteria>
- @xyflow/react installed and importable
- Canvas store factory creates isolated store instances with PostIt CRUD operations
- Provider enables per-request store isolation via React context
- Post-it node renders classic yellow sticky note matching all locked appearance decisions
- SSR-safe wrapper prevents hydration errors with dynamic import
- Loading skeleton shows dot grid background during dynamic import
</success_criteria>

<output>
After completion, create `.planning/phases/15-canvas-infrastructure-ssr-safety/15-01-SUMMARY.md`
</output>
