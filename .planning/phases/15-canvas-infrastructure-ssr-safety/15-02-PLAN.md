---
phase: 15-canvas-infrastructure-ssr-safety
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - src/components/canvas/react-flow-canvas.tsx
  - src/components/canvas/canvas-toolbar.tsx
autonomous: true

must_haves:
  truths:
    - "User can create post-it by double-clicking empty canvas space"
    - "User can create post-it via toolbar '+' button"
    - "User can drag post-its to reposition them"
    - "New post-it immediately enters text editing mode"
    - "Empty canvas shows 'Double-click to add a post-it' hint"
    - "Canvas shows subtle dot grid background"
    - "Post-its snap to grid when positioned"
    - "Toolbar '+' places post-its with dealing-cards offset"
  artifacts:
    - path: "src/components/canvas/react-flow-canvas.tsx"
      provides: "Main ReactFlow canvas with all interactions"
      exports: ["ReactFlowCanvas"]
    - path: "src/components/canvas/canvas-toolbar.tsx"
      provides: "Minimal toolbar with '+' button for post-it creation"
      exports: ["CanvasToolbar"]
  key_links:
    - from: "src/components/canvas/react-flow-canvas.tsx"
      to: "src/stores/canvas-store.ts"
      via: "useCanvasStore hook for state management"
      pattern: "useCanvasStore"
    - from: "src/components/canvas/react-flow-canvas.tsx"
      to: "src/components/canvas/post-it-node.tsx"
      via: "nodeTypes registration"
      pattern: "nodeTypes.*postIt.*PostItNode"
    - from: "src/components/canvas/canvas-wrapper.tsx"
      to: "src/components/canvas/react-flow-canvas.tsx"
      via: "dynamic import"
      pattern: "import.*react-flow-canvas"
---

<objective>
Build the main ReactFlow canvas component with all Phase 15 interactions: double-click creation, toolbar "+" button creation (dealing-cards offset), drag-to-reposition, immediate edit mode on creation, dot grid background, empty state hint, snap-to-grid, and auto-fit zoom on load.

Purpose: This is the core visual canvas experience. After this plan, users can create, type into, and drag post-it notes on an infinite canvas with a dot grid background.

Output: 2 new files — the main ReactFlow canvas component and toolbar component.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-canvas-infrastructure-ssr-safety/15-RESEARCH.md
@.planning/phases/15-canvas-infrastructure-ssr-safety/15-CONTEXT.md
@.planning/phases/15-canvas-infrastructure-ssr-safety/15-01-SUMMARY.md

# Files created in Plan 01 (must exist):
@src/stores/canvas-store.ts
@src/providers/canvas-store-provider.tsx
@src/components/canvas/post-it-node.tsx
@src/components/canvas/canvas-wrapper.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ReactFlow canvas component with all interactions</name>
  <files>
    src/components/canvas/react-flow-canvas.tsx
    src/components/canvas/canvas-toolbar.tsx
  </files>
  <action>
    1. Create `src/components/canvas/canvas-toolbar.tsx`:
       - Add `'use client'` directive
       - Minimal toolbar for Phase 15: just a "+" button (per locked decision — no zoom controls yet)
       - Props: `onAddPostIt: () => void`
       - Render a positioned container (`absolute top-4 left-4 z-10`)
       - Button: `+ Add Post-it` with clean white background, rounded corners, shadow, hover shadow-md
       - Use standard HTML button (or shadcn Button if available) — keep it simple

    2. Create `src/components/canvas/react-flow-canvas.tsx`:
       - Add `'use client'` directive
       - Import `@xyflow/react/dist/style.css` — REQUIRED for ReactFlow default styles
       - Import `ReactFlow`, `ReactFlowProvider`, `useReactFlow`, `Background`, `BackgroundVariant`, `type Node`, `type NodeChange`, `applyNodeChanges` from `@xyflow/react`
       - Import `useCanvasStore` from `@/providers/canvas-store-provider`
       - Import `PostItNode` and `PostItNodeData` from `./post-it-node`
       - Import `CanvasToolbar` from `./canvas-toolbar`

       **Component structure:** Export `ReactFlowCanvas` that wraps inner component in `ReactFlowProvider`:
       ```
       export function ReactFlowCanvas({ sessionId, stepId }: Props) {
         return (
           <ReactFlowProvider>
             <ReactFlowCanvasInner sessionId={sessionId} stepId={stepId} />
           </ReactFlowProvider>
         );
       }
       ```

       **Inner component (`ReactFlowCanvasInner`):**

       a) **Node types** — Define OUTSIDE component (stable reference):
          ```
          const nodeTypes = { postIt: PostItNode };
          ```

       b) **Store access:**
          ```
          const postIts = useCanvasStore(s => s.postIts);
          const addPostIt = useCanvasStore(s => s.addPostIt);
          const updatePostIt = useCanvasStore(s => s.updatePostIt);
          ```

       c) **Editing state:** Track which node is being edited:
          ```
          const [editingNodeId, setEditingNodeId] = useState<string | null>(null);
          ```

       d) **Convert store post-its to ReactFlow nodes** using `useMemo`:
          - Map each `PostIt` to a ReactFlow `Node`:
            ```
            {
              id: postIt.id,
              type: 'postIt',
              position: postIt.position,
              data: {
                text: postIt.text,
                isEditing: editingNodeId === postIt.id,
                onTextChange: handleTextChange,
                onEditComplete: handleEditComplete,
              },
              style: { width: postIt.width, height: 'auto' },
            }
            ```
          - Depend on `[postIts, editingNodeId]`

       e) **Grid snap size:** 20px (matching dot grid background — Claude's discretion)

       f) **Handle double-click on empty canvas** (`onPaneDoubleClick`):
          - Use `screenToFlowPosition` to convert mouse coords to flow coords
          - Snap position to grid: `Math.round(pos / 20) * 20`
          - Call `addPostIt({ text: '', position: snappedPos, width: 120, height: 120 })`
          - Set the newly created post-it as editing (use the store's postIts to find the last one after state update — use a ref or callback pattern)
          - The new post-it's `isEditing` will be true, so textarea auto-focuses

       g) **Handle toolbar "+" creation** (dealing-cards offset per locked decision):
          - Get the last post-it from store
          - If exists: offset by +30px x, +30px y from last post-it position (dealing-cards pattern)
          - If no post-its: place at center of current viewport using `screenToFlowPosition`
          - Snap to grid
          - Call `addPostIt(...)` and set as editing

       h) **Handle node drag** (`onNodesChange`):
          - Use ReactFlow's `onNodesChange` callback with `applyNodeChanges`
          - On `position` change type with `dragging: false` (drag complete): call `updatePostIt(nodeId, { position: newPosition })`
          - Snap positions to grid on drag end

       i) **Handle text change** (`handleTextChange`):
          - Called from PostItNode's textarea onChange
          - Update text in store: `updatePostIt(id, { text })`

       j) **Handle edit complete** (`handleEditComplete`):
          - Called from PostItNode's textarea onBlur
          - Set `editingNodeId` to null
          - If text is empty and this was a newly created post-it, optionally delete it (Claude's discretion — keep empty post-its for now, user might come back to them)

       k) **Handle node click** — Set editing mode on double-click:
          - Use `onNodeDoubleClick` event to set `editingNodeId`
          - Note: Single click selects, double-click enters edit mode

       l) **Auto-fit view on mount** (if nodes exist):
          ```
          useEffect(() => {
            if (postIts.length > 0) {
              setTimeout(() => fitView({ padding: 0.2, duration: 300 }), 100);
            }
          }, []); // Mount only
          ```

       m) **Click on pane to deselect/stop editing:**
          - `onPaneClick` sets `editingNodeId` to null

       n) **ReactFlow configuration:**
          ```
          <ReactFlow
            nodes={nodes}
            edges={[]}
            nodeTypes={nodeTypes}
            onNodesChange={handleNodesChange}
            onPaneDoubleClick={handlePaneDoubleClick}
            onNodeDoubleClick={handleNodeDoubleClick}
            onPaneClick={handlePaneClick}
            snapToGrid={true}
            snapGrid={[20, 20]}
            fitView={postIts.length > 0}
            fitViewOptions={{ padding: 0.2 }}
            minZoom={0.3}
            maxZoom={2}
            defaultViewport={{ x: 0, y: 0, zoom: 1 }}
            deleteKeyCode={null}
            selectionKeyCode={null}
          >
            <Background variant={BackgroundVariant.Dots} gap={20} size={1} color="#d1d5db" />
          </ReactFlow>
          ```
          - `deleteKeyCode={null}` — disable delete key in Phase 15 (comes in Phase 17)
          - `selectionKeyCode={null}` — disable multi-select in Phase 15 (comes in Phase 17)

       o) **Empty state hint** (locked decision):
          - When `postIts.length === 0`, show centered overlay text:
            `"Double-click to add a post-it"`
          - Style: `text-gray-400 text-lg pointer-events-none` so it doesn't block canvas interactions
          - Positioned absolutely centered within the canvas container

       p) **Save status placeholder:**
          - Render a `<div>` in bottom-right corner for save status indicator
          - Accept `saveStatus` as optional prop (will be wired in Plan 03)
          - For now, pass nothing — renders empty div

       q) **Toolbar:**
          - Render `<CanvasToolbar onAddPostIt={handleToolbarAdd} />` inside the ReactFlow container (overlaid)

       r) **Container:**
          - Full height and width: `className="w-full h-full"` on the outer div
          - Position relative for absolute-positioned overlays
  </action>
  <verify>
    - `npx tsc --noEmit` passes without type errors
    - `src/components/canvas/react-flow-canvas.tsx` exists and exports `ReactFlowCanvas`
    - `src/components/canvas/canvas-toolbar.tsx` exists and exports `CanvasToolbar`
    - Component imports `@xyflow/react/dist/style.css`
    - `nodeTypes` defined outside component (not recreated each render)
    - `snapToGrid` and `snapGrid` configured on ReactFlow element
    - `BackgroundVariant.Dots` used for dot grid
    - No `'use server'` directives in any file
  </verify>
  <done>
    ReactFlow canvas renders with dot grid background. Double-click on empty space creates post-it at click position with immediate edit mode. Toolbar "+" button creates post-it with dealing-cards offset. Post-its are draggable with snap-to-grid. Empty state shows "Double-click to add a post-it" hint. Auto-fit zoom applies on load when existing post-its present. All interactions update Zustand store as single source of truth.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — no type errors
2. `react-flow-canvas.tsx` resolves the dynamic import from `canvas-wrapper.tsx` (created in Plan 01)
3. Canvas renders dot grid background (BackgroundVariant.Dots)
4. Double-click creates post-it at click position
5. Toolbar "+" creates post-it with offset
6. New post-its immediately enter edit mode (textarea visible)
7. Dragging a post-it updates its position in the store
8. Empty canvas shows hint text
9. All state changes go through Zustand store (no local state for post-it data)
</verification>

<success_criteria>
- User can see an infinite canvas with subtle dot grid background
- User can create post-its via double-click (at click position) or toolbar "+" (with dealing-cards offset)
- New post-its immediately show textarea for typing
- User can drag post-its to reposition them (snap to 20px grid)
- Empty canvas shows "Double-click to add a post-it" hint that disappears after first post-it
- All post-it state managed in Zustand store (not local component state)
</success_criteria>

<output>
After completion, create `.planning/phases/15-canvas-infrastructure-ssr-safety/15-02-SUMMARY.md`
</output>
