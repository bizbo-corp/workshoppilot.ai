---
phase: 27-ui-kit-advanced-tools
plan: 03
type: execute
wave: 2
depends_on: ["27-01"]
files_modified:
  - src/lib/drawing/speech-bubble-path.ts
  - src/components/ezydraw/tools/speech-bubble-tool.tsx
  - src/components/ezydraw/tools/emoji-picker-tool.tsx
  - src/components/ezydraw/toolbar.tsx
  - src/components/ezydraw/ezydraw-stage.tsx
autonomous: true

must_haves:
  truths:
    - "User can place a speech bubble on the canvas by clicking and dragging with the speech bubble tool"
    - "Speech bubble renders with rounded rectangle body and visible tail pointing downward"
    - "User can adjust the speech bubble tail position by dragging a handle when bubble is selected"
    - "User can open an emoji picker from the toolbar and stamp an emoji onto the canvas"
    - "Emoji picker lazy-loads so it does not bloat the initial bundle"
    - "Speech bubble text is editable via double-click (same pattern as text tool)"
  artifacts:
    - path: "src/lib/drawing/speech-bubble-path.ts"
      provides: "SVG path generation for speech bubble with adjustable tail"
      exports: ["generateSpeechBubblePath"]
    - path: "src/components/ezydraw/tools/speech-bubble-tool.tsx"
      provides: "Speech bubble placement tool with tail handle editing"
      exports: ["useSpeechBubbleTool", "SpeechBubblePreview", "SpeechBubbleTailHandle"]
    - path: "src/components/ezydraw/tools/emoji-picker-tool.tsx"
      provides: "Lazy-loaded emoji picker with canvas placement"
      exports: ["EmojiPickerTool"]
    - path: "src/components/ezydraw/toolbar.tsx"
      provides: "Toolbar with speech bubble and emoji buttons"
      contains: "speechBubble"
  key_links:
    - from: "src/components/ezydraw/ezydraw-stage.tsx"
      to: "src/lib/drawing/speech-bubble-path.ts"
      via: "generates SVG path data for Path element rendering"
      pattern: "generateSpeechBubblePath"
    - from: "src/components/ezydraw/ezydraw-stage.tsx"
      to: "src/components/ezydraw/tools/speech-bubble-tool.tsx"
      via: "uses speech bubble tool handlers for pointer events"
      pattern: "useSpeechBubbleTool"
    - from: "src/components/ezydraw/toolbar.tsx"
      to: "src/components/ezydraw/tools/emoji-picker-tool.tsx"
      via: "renders emoji picker on tool activation"
      pattern: "EmojiPickerTool"
---

<objective>
Implement speech bubble tool (SVG path with adjustable tail, click-drag placement, inline text editing) and emoji picker tool (lazy-loaded emoji-mart, stamp emoji as elements on canvas), and integrate both into the EzyDraw toolbar and stage.

Purpose: Speech bubbles enable annotation and callout wireframing. Emoji stamps add visual flair and rapid iconography. Together they complete the "advanced tools" portion of Phase 27, making EzyDraw a full wireframing/annotation tool.

Output: Speech bubble path generator, speech bubble tool with tail handle, lazy-loaded emoji picker, toolbar integration, stage rendering for both new element types.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-ui-kit-advanced-tools/27-RESEARCH.md
@.planning/phases/27-ui-kit-advanced-tools/27-01-SUMMARY.md

@src/lib/drawing/types.ts
@src/stores/drawing-store.ts
@src/components/ezydraw/toolbar.tsx
@src/components/ezydraw/ezydraw-stage.tsx
@src/components/ezydraw/tools/shapes-tool.tsx
@src/components/ezydraw/tools/pencil-tool.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create speech bubble path generator and placement tool</name>
  <files>
    src/lib/drawing/speech-bubble-path.ts
    src/components/ezydraw/tools/speech-bubble-tool.tsx
  </files>
  <action>
    **Step 1: Create `src/lib/drawing/speech-bubble-path.ts`:**

    Implement `generateSpeechBubblePath()` that produces an SVG path string for a rounded rectangle with a triangular tail.

    Function signature:
    ```typescript
    export function generateSpeechBubblePath(
      x: number,
      y: number,
      width: number,
      height: number,
      tailX: number,      // Absolute tail tip x position
      tailY: number,      // Absolute tail tip y position
      cornerRadius?: number  // Default 8
    ): string
    ```

    The path draws:
    1. Rounded rectangle body using quadratic bezier curves for corners (Q commands)
    2. At the bottom edge, interrupts the line to insert a triangular tail
    3. Tail base is 20px wide, centered on the bottom edge
    4. Tail tip goes to (tailX, tailY) using quadratic bezier curves for smooth transitions
    5. Returns a valid SVG path data string (M, L, Q, Z commands)

    Path construction order (clockwise from top-left):
    - M to top-left corner (past radius)
    - L to top-right corner (before radius)
    - Q for top-right corner
    - L to bottom-right corner (before radius)
    - Q for bottom-right corner
    - L to tail-right base point
    - Q curve to tail tip
    - Q curve back to tail-left base point
    - L to bottom-left corner (before radius)
    - Q for bottom-left corner
    - L to top-left corner (before radius)
    - Q for top-left corner
    - Z to close

    Edge case handling:
    - Clamp tailX and tailY to reasonable ranges (tail shouldn't be inside bubble body)
    - If width < 2 * cornerRadius, reduce cornerRadius proportionally
    - Tail base should be clamped to bubble bottom edge width

    The control points for the tail bezier curves should be:
    - `controlX = (anchorX + tailX) / 2` (midpoint between base and tip)
    - `controlY = (anchorY + tailY) / 2`
    Where anchorX is the center of the tail base, anchorY is the bottom of the bubble.

    **Step 2: Create `src/components/ezydraw/tools/speech-bubble-tool.tsx`:**

    Follow the same pattern as `shapes-tool.tsx` (hook + preview component):

    **`useSpeechBubbleTool` hook:**
    - Returns `{ handleDown, handleMove, handleUp, previewBubble }` (mirrors shapes-tool pattern)
    - On pointer down (when activeTool === 'speechBubble'): record start position, begin preview
    - On pointer move: update preview width/height based on drag distance (min 80w x 50h)
    - On pointer up: commit bubble to store via `addElement()` with type 'speechBubble'
    - Default tail position: `tailX = width/2` (centered), `tailY = height + 40` (40px below bubble)
    - Default text: "Text"
    - Default cornerRadius: 8
    - Uses store's strokeColor for stroke, fillColor for fill (or '#FFFDE7' light yellow if fill is transparent)

    The element created has all SpeechBubbleElement fields from types.ts.

    **`SpeechBubblePreview` component:**
    - Renders a dashed Path element during drag-to-place (opacity 0.6, dash [5,5])
    - Uses `generateSpeechBubblePath()` for the path data
    - listening={false} (preview only)

    **`SpeechBubbleTailHandle` component:**
    - Renders a small Circle (radius 6, fill blue, stroke white) at the tail tip position
    - Draggable circle that, on `onDragMove`, calls `updateElement` with new tailX/tailY
    - Only visible when a speech bubble is selected (activeTool === 'select' and selectedElementId matches a speechBubble element)
    - The handle position is: `x = bubble.x + bubble.tailX`, `y = bubble.y + bubble.tailY`
    - On drag: `newTailX = e.target.x() - bubble.x`, `newTailY = e.target.y() - bubble.y`
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - generateSpeechBubblePath returns valid SVG path string
    - useSpeechBubbleTool returns handler functions matching the tool hook pattern
    - SpeechBubbleTailHandle renders draggable circle at tail position
  </verify>
  <done>
    Speech bubble path generator produces valid SVG paths with rounded rectangle and bezier tail. Speech bubble tool hook handles click-drag placement with preview. Tail handle enables post-placement tail adjustment.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create emoji picker tool and integrate both tools into toolbar and stage</name>
  <files>
    src/components/ezydraw/tools/emoji-picker-tool.tsx
    src/components/ezydraw/toolbar.tsx
    src/components/ezydraw/ezydraw-stage.tsx
  </files>
  <action>
    **Step 1: Create `src/components/ezydraw/tools/emoji-picker-tool.tsx`:**

    Lazy-loaded emoji picker that stamps emoji elements onto the canvas.

    ```typescript
    'use client';
    ```

    Use `next/dynamic` to lazy-load the Picker component (ssr: false) from `@emoji-mart/react`. This is CRITICAL for bundle size - static import would add ~200KB to the main bundle.

    ```typescript
    const Picker = dynamic(
      () => import('@emoji-mart/react').then(mod => ({ default: mod.default })),
      { ssr: false, loading: () => <div className="w-[352px] h-[435px] bg-gray-100 animate-pulse rounded-lg" /> }
    );
    ```

    Lazy-load emoji data when picker opens:
    ```typescript
    const [data, setData] = useState<any>(null);
    useEffect(() => {
      if (isOpen && !data) {
        import('@emoji-mart/data').then(mod => setData(mod.default));
      }
    }, [isOpen, data]);
    ```

    Component: `EmojiPickerTool`
    Props: `{ isOpen: boolean; onEmojiSelect: (emoji: string) => void; onClose: () => void }`
    - Renders absolutely positioned popup (top-14, right-4, z-50, shadow-lg, rounded-lg, overflow-hidden)
    - Passes `data`, `onEmojiSelect`, `theme="light"`, `previewPosition="none"`, `skinTonePosition="search"` to Picker
    - On emoji select: calls `onEmojiSelect(emoji.native)` then `onClose()`
    - Click outside closes picker (use a backdrop div)
    - If `!isOpen`, return null

    **Step 2: Update `src/components/ezydraw/toolbar.tsx`:**

    Add speech bubble and emoji tools to the toolbar:

    1. Import `MessageCircle` and `Smile` from lucide-react for toolbar icons
    2. Add to TOOL_BUTTONS array (after 'text', before 'eraser'):
       ```typescript
       { tool: 'speechBubble', icon: MessageCircle, label: 'Speech Bubble (B)', hotkey: 'b' },
       ```
    3. Add emoji button SEPARATELY from TOOL_BUTTONS (it's not a drawing tool, it opens a picker):
       - Place after the tool buttons group, with a divider
       - Button with Smile icon, toggles emoji picker open/closed
       - No hotkey needed (emoji picker is a popup, not a drawing mode)

    4. Import and render `EmojiPickerTool` component with state management:
       ```typescript
       const [emojiPickerOpen, setEmojiPickerOpen] = useState(false);
       ```
    5. When emoji is selected, add it as an EmojiElement at canvas center:
       ```typescript
       const handleEmojiSelect = (emoji: string) => {
         addElement({
           type: 'emoji',
           x: /* center of viewport, or use a reasonable default like 400 */,
           y: /* center of viewport, or use a reasonable default like 300 */,
           emoji,
           fontSize: 48,
           rotation: 0,
           scaleX: 1,
           scaleY: 1,
           opacity: 1,
         } as Omit<DrawingElement, 'id'>);
       };
       ```
    6. Add `addElement` selector from drawing store for emoji placement

    **Step 3: Update `src/components/ezydraw/ezydraw-stage.tsx`:**

    Add rendering and interaction support for speechBubble and emoji element types:

    1. Import `Path` from react-konva (for speech bubble SVG path rendering)
    2. Import `generateSpeechBubblePath` from `@/lib/drawing/speech-bubble-path`
    3. Import `useSpeechBubbleTool`, `SpeechBubblePreview`, `SpeechBubbleTailHandle` from tools
    4. Initialize speech bubble tool hook: `const speechBubbleHandlers = useSpeechBubbleTool()`

    5. In the element rendering map, add speech bubble rendering:
    ```typescript
    if (element.type === 'speechBubble') {
      const pathData = generateSpeechBubblePath(
        0, 0,  // Path relative to element position
        element.width,
        element.height,
        element.tailX,
        element.tailY,
        element.cornerRadius
      );
      return (
        <React.Fragment key={element.id}>
          <Path
            {...commonProps}
            x={element.x}
            y={element.y}
            data={pathData}
            fill={element.fill}
            stroke={element.stroke}
            strokeWidth={element.strokeWidth}
            rotation={element.rotation}
            scaleX={element.scaleX}
            scaleY={element.scaleY}
            opacity={element.opacity}
            onDblClick={(e) => {
              e.cancelBubble = true;
              const node = e.target;
              const absPos = node.getAbsolutePosition();
              startTextEditing(element.id, absPos.x + 12, absPos.y + 12, element.width - 24, element.fontSize, element.text);
            }}
          />
          <Text
            id={`${element.id}-label`}
            x={element.x + 12}
            y={element.y + 12}
            width={element.width - 24}
            text={element.text}
            fontSize={element.fontSize}
            fill="#000000"
            fontFamily="sans-serif"
            listening={false}
          />
        </React.Fragment>
      );
    }
    ```

    Note: The Path element uses coordinates relative to its own origin (0,0 for the path, positioned via x/y props). The `generateSpeechBubblePath` call uses 0,0 as the base, and Konva's x/y props handle absolute positioning.

    6. Add emoji element rendering:
    ```typescript
    if (element.type === 'emoji') {
      return (
        <Text
          key={element.id}
          {...commonProps}
          x={element.x}
          y={element.y}
          text={element.emoji}
          fontSize={element.fontSize}
          fontFamily="Apple Color Emoji, Segoe UI Emoji, Noto Color Emoji, sans-serif"
          rotation={element.rotation}
          scaleX={element.scaleX}
          scaleY={element.scaleY}
          opacity={element.opacity}
        />
      );
    }
    ```

    7. Add speech bubble tool to pointer event handling:
    - In handlePointerDown: add `else if (tool === 'speechBubble')` case calling `speechBubbleHandlers.handleDown(pos)`
    - In handlePointerMove: add `else if (tool === 'speechBubble')` case
    - In handlePointerUp: add `else if (tool === 'speechBubble')` case
    - Add ref for speech bubble handlers (same pattern as pencil/shape refs)

    8. Add speech bubble preview to the Layer (after ShapesToolPreview):
    ```typescript
    <SpeechBubblePreview previewBubble={speechBubbleHandlers.previewBubble} />
    ```

    9. Add SpeechBubbleTailHandle to the UI layer (after SelectTool):
    - Only render when a speech bubble element is selected
    - Find the selected speech bubble: `const selectedBubble = elements.find(el => el.id === selectedElementId && el.type === 'speechBubble')`
    - Render tail handle if found, passing the bubble element and updateElement callback

    10. Update getCursorStyle to include `case 'speechBubble': return 'crosshair'`

    **Important notes for the speech bubble path generation call:**
    - The path should be generated relative to (0, 0) for the bubble body
    - tailX and tailY in the element are already relative to the bubble's origin
    - The Konva Path is positioned at element.x, element.y via props
    - This means: `generateSpeechBubblePath(0, 0, width, height, tailX, tailY, cornerRadius)`
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run build` succeeds (verifies emoji-mart lazy loaded into separate chunk)
    - Toolbar shows speech bubble and emoji buttons
    - Speech bubble tool in TOOL_BUTTONS array
    - Emoji picker renders as lazy-loaded popup
    - Stage renders speechBubble elements as Path + Text
    - Stage renders emoji elements as Text with emoji fontFamily
    - Speech bubble tail handle appears when bubble is selected
  </verify>
  <done>
    Speech bubble tool places annotated bubbles with adjustable tails via drag handle. Emoji picker lazy-loads and stamps emoji elements on canvas. Both tools are in the toolbar and render correctly on the stage. Double-click on speech bubble opens text editing.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` - no type errors
2. `npm run build` - build succeeds, emoji-mart in separate chunk
3. Select speech bubble tool from toolbar
4. Click and drag on canvas - speech bubble preview appears
5. Release - speech bubble with text and tail renders
6. Select tool, click bubble - tail handle appears (blue circle)
7. Drag tail handle - tail follows cursor
8. Double-click bubble - text editing overlay appears
9. Click emoji button in toolbar - emoji picker popup appears
10. Select emoji - emoji appears on canvas as large text element
11. Emoji picker closes after selection
12. Select and move emoji element - works with select tool
13. Eraser on speech bubble/emoji - deletes them
</verification>

<success_criteria>
- Speech bubble tool creates bubbles via click-drag with visible tail
- Tail is adjustable after placement via draggable handle
- Speech bubble text editable via double-click
- Emoji picker lazy-loads (separate chunk, not in main bundle)
- Selected emoji stamps onto canvas as movable/deletable element
- Both new tools accessible from toolbar with correct icons
- Build passes, no runtime errors
</success_criteria>

<output>
After completion, create `.planning/phases/27-ui-kit-advanced-tools/27-03-SUMMARY.md`
</output>
