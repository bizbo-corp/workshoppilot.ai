---
phase: 27-ui-kit-advanced-tools
plan: 02
type: execute
wave: 2
depends_on: ["27-01"]
files_modified:
  - src/components/ezydraw/ezydraw-modal.tsx
  - src/components/ezydraw/ezydraw-stage.tsx
  - src/stores/drawing-store.ts
  - src/components/ezydraw/palette/droppable-canvas.tsx
autonomous: true

must_haves:
  truths:
    - "User can drag a UI kit component from the palette sidebar and drop it onto the drawing canvas"
    - "Dropped UI kit component appears at the correct position on the Konva stage"
    - "Grouped elements (same groupId) move together when dragged with select tool"
    - "Grouped elements are selected and deleted as a unit"
    - "UI kit palette sidebar is visible in the EzyDraw modal alongside the canvas"
  artifacts:
    - path: "src/components/ezydraw/palette/droppable-canvas.tsx"
      provides: "Droppable wrapper div for Konva stage"
      exports: ["DroppableCanvas"]
    - path: "src/components/ezydraw/ezydraw-modal.tsx"
      provides: "EzyDraw modal with DndContext wrapping palette + canvas"
      contains: "DndContext"
    - path: "src/stores/drawing-store.ts"
      provides: "Group operations: addElements, deleteElementGroup, updateElementGroup"
      contains: "addElements"
    - path: "src/components/ezydraw/ezydraw-stage.tsx"
      provides: "Group-aware rendering with grouped drag, select, delete"
      contains: "groupId"
  key_links:
    - from: "src/components/ezydraw/ezydraw-modal.tsx"
      to: "src/components/ezydraw/palette/ui-kit-palette.tsx"
      via: "renders palette sidebar inside DndContext"
      pattern: "UIKitPalette"
    - from: "src/components/ezydraw/ezydraw-modal.tsx"
      to: "src/components/ezydraw/palette/droppable-canvas.tsx"
      via: "wraps EzyDrawStage in DroppableCanvas"
      pattern: "DroppableCanvas"
    - from: "src/components/ezydraw/ezydraw-modal.tsx"
      to: "src/lib/drawing/ui-kit-components.ts"
      via: "calls factory function on drag end to create elements"
      pattern: "UI_KIT_COMPONENTS.*factory"
    - from: "src/components/ezydraw/ezydraw-stage.tsx"
      to: "src/stores/drawing-store.ts"
      via: "uses group operations for select/drag/delete"
      pattern: "deleteElementGroup|updateElementGroup"
---

<objective>
Wire up drag-and-drop from the UI kit palette to the Konva drawing canvas using dnd-kit, add group-aware operations to the drawing store, and update the stage rendering to handle grouped elements as single units.

Purpose: This is the core UX for the UI kit feature - users drag components from a sidebar palette and drop them onto their drawing canvas. Without this, factories and palette are inert. Group operations ensure compound components (button = rect + text) behave as atomic units.

Output: Working palette-to-canvas drag-drop, group-aware store operations, updated EzyDraw modal layout with sidebar.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-ui-kit-advanced-tools/27-RESEARCH.md
@.planning/phases/27-ui-kit-advanced-tools/27-01-SUMMARY.md

@src/components/ezydraw/ezydraw-modal.tsx
@src/components/ezydraw/ezydraw-stage.tsx
@src/stores/drawing-store.ts
@src/lib/drawing/types.ts
@src/lib/drawing/ui-kit-components.ts
@src/components/ezydraw/palette/ui-kit-palette.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add group operations to drawing store and create DroppableCanvas</name>
  <files>
    src/stores/drawing-store.ts
    src/components/ezydraw/palette/droppable-canvas.tsx
  </files>
  <action>
    **Step 1: Extend `src/stores/drawing-store.ts` with group operations.**

    Add these new actions to `DrawingActions` type and implement them:

    1. `addElements: (elements: DrawingElement[]) => void` - Adds multiple elements atomically (batch add). Pushes to history once after all elements added. Used for dropping UI kit components.

    2. `deleteElementGroup: (groupId: string) => void` - Deletes all elements sharing the same groupId. Pushes single history entry. If selectedElementId belongs to deleted group, clear selection.

    3. `updateElementGroup: (groupId: string, updates: Partial<DrawingElement>) => void` - Updates all elements in a group with the same partial update. Useful for opacity changes, etc. Pushes single history entry.

    4. `moveElementGroup: (groupId: string, deltaX: number, deltaY: number) => void` - Moves all elements in a group by delta offset. Each element's x and y get incremented by deltaX/deltaY respectively. Single history push. This is the key operation for group drag.

    Implementation notes:
    - `addElements` should assign IDs using `createElementId()` to each element (same as addElement does for single elements)
    - All group operations filter elements by `el.groupId === groupId`
    - All group mutations push a single history entry (not one per element)
    - Do NOT change existing `addElement`, `deleteElement`, `updateElement` signatures

    **Step 2: Create `src/components/ezydraw/palette/droppable-canvas.tsx`:**

    ```typescript
    'use client';

    import { useDroppable } from '@dnd-kit/core';

    interface DroppableCanvasProps {
      children: React.ReactNode;
    }

    export function DroppableCanvas({ children }: DroppableCanvasProps) {
      const { setNodeRef, isOver } = useDroppable({
        id: 'ezydraw-canvas',
      });

      return (
        <div
          ref={setNodeRef}
          className={`flex-1 overflow-hidden ${isOver ? 'ring-2 ring-blue-400 ring-inset' : ''}`}
        >
          {children}
        </div>
      );
    }
    ```

    Key detail: The div wrapping Konva Stage receives the droppable ref. Konva canvas cannot be a droppable directly because it's a canvas element, not a DOM element that participates in event delegation. The wrapper div bridges DOM events (dnd-kit) with the canvas.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - drawing-store.ts exports addElements, deleteElementGroup, updateElementGroup, moveElementGroup
    - DroppableCanvas renders a div with useDroppable hook
  </verify>
  <done>
    Drawing store has batch add, group delete, group update, and group move operations. DroppableCanvas wrapper provides dnd-kit drop target for the Konva stage.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire DndContext into EzyDraw modal and add group-aware rendering to stage</name>
  <files>
    src/components/ezydraw/ezydraw-modal.tsx
    src/components/ezydraw/ezydraw-stage.tsx
  </files>
  <action>
    **Step 1: Update `src/components/ezydraw/ezydraw-modal.tsx`:**

    Restructure the EzyDrawContent component to include DndContext, palette sidebar, and DroppableCanvas:

    1. Import `DndContext`, `DragOverlay`, `DragEndEvent` from `@dnd-kit/core`
    2. Import `UIKitPalette` from `./palette/ui-kit-palette`
    3. Import `DroppableCanvas` from `./palette/droppable-canvas`
    4. Import `UI_KIT_COMPONENTS`, `UIKitComponentType` from `@/lib/drawing/ui-kit-components`
    5. Add `addElements` selector from drawing store

    The layout structure of `EzyDrawContent` becomes:
    ```
    DndContext (onDragStart, onDragEnd)
      div.flex.h-full
        UIKitPalette (left sidebar, w-56)
        div.flex-1.flex.flex-col
          EzyDrawToolbar
          DroppableCanvas
            EzyDrawStage (via stageRef)
      DragOverlay (renders ghost of dragged item)
    ```

    The `handleDragEnd` callback:
    1. Check `over?.id === 'ezydraw-canvas'` (dropped on canvas)
    2. Get `componentType` from `active.data.current?.componentType`
    3. Get the stage instance via `stageRef.current?.getStage()`
    4. Get the DroppableCanvas container's bounding rect
    5. Calculate canvas-relative drop position:
       - Use the `activatorEvent` (the original mouse/pointer event) and `over.rect` to calculate where on the canvas the item was dropped
       - Alternative approach: use `event.active.rect.current.translated` coordinates minus the canvas container's bounding rect
       - The key formula: `dropX = (pointerX - containerRect.left)`, `dropY = (pointerY - containerRect.top)` where pointerX/Y come from the over rect center or the event's final position
    6. Call the factory: `const elements = UI_KIT_COMPONENTS[componentType](dropX, dropY)`
    7. Call `addElements(elements)` to batch-add them to the store

    Track `activeId` state for DragOverlay rendering. The overlay shows a simple styled div with the component name during drag.

    **Important:** The DndContext wraps BOTH the palette and the canvas area. The palette items have `useDraggable` (from plan 27-01), the canvas wrapper has `useDroppable`.

    Keep the existing Dialog, DialogContent, DrawingStoreProvider structure. The DndContext goes INSIDE DrawingStoreProvider (needs store access for addElements).

    **Step 2: Update `src/components/ezydraw/ezydraw-stage.tsx` for group-aware rendering:**

    In the element rendering loop (`elements.map(...)`), modify the commonProps to handle groups:

    1. Detect if element has `groupId`: `const isGrouped = !!element.groupId`

    2. For grouped elements, determine if this element is the "group representative" (first element in the group within the elements array). Only the representative is draggable; other group members are NOT draggable (they move via group delta).

    ```typescript
    const isGroupRepresentative = isGrouped &&
      elements.find(el => el.groupId === element.groupId)?.id === element.id;
    ```

    3. Update `isDraggable`:
    ```typescript
    const isDraggable = activeTool === 'select' && (!isGrouped || isGroupRepresentative);
    ```

    4. Update `onClick` for group awareness:
    ```typescript
    onClick: (e) => {
      e.cancelBubble = true;
      if (activeTool === 'select') {
        // For grouped elements, select the representative
        if (element.groupId) {
          const rep = elements.find(el => el.groupId === element.groupId);
          if (rep) selectElement(rep.id);
        } else {
          selectElement(element.id);
        }
      } else if (activeTool === 'eraser') {
        // Delete entire group
        if (element.groupId) {
          deleteElementGroup(element.groupId);
        } else {
          deleteElement(element.id);
        }
      }
    }
    ```

    5. Update `onDragEnd` for group drag:
    ```typescript
    onDragEnd: (e) => {
      if (activeTool === 'select') {
        if (isGroupRepresentative && element.groupId) {
          // Calculate delta from original position
          const deltaX = e.target.x() - element.x;
          const deltaY = e.target.y() - element.y;
          // Move entire group
          moveElementGroup(element.groupId, deltaX, deltaY);
          // Reset Konva node position (store is source of truth)
          e.target.position({ x: element.x + deltaX, y: element.y + deltaY });
        } else if (!isGrouped) {
          updateElement(element.id, { x: e.target.x(), y: e.target.y() });
        }
      }
    }
    ```

    6. Add the new store selectors:
    ```typescript
    const deleteElementGroup = useDrawingStore((s) => s.deleteElementGroup);
    const moveElementGroup = useDrawingStore((s) => s.moveElementGroup);
    ```

    Do NOT change the rendering of individual element types (pencil, rectangle, circle, etc.) - only modify the commonProps logic. The existing rendering handles all element types already. Grouped elements render as individual shapes that move together.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run build` succeeds
    - EzyDraw modal layout includes palette sidebar on left, canvas on right
    - DndContext wraps the entire content area
    - Stage renders grouped elements with representative-only draggability
    - Group drag moves all elements in group by same delta
    - Group eraser deletes all elements in group
  </verify>
  <done>
    DndContext bridges palette drag to canvas drop with correct coordinate mapping. UI kit components appear on canvas at drop position. Grouped elements move, select, and delete as atomic units. EzyDraw modal has sidebar + canvas layout.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` - no type errors
2. `npm run build` - build succeeds
3. Open EzyDraw modal - palette sidebar visible on left
4. Drag a button from palette over canvas - blue ring indicator appears
5. Drop button on canvas - button (rect + text) appears at drop position
6. Switch to select tool - clicking button selects it
7. Dragging button moves both rect and text together
8. Eraser on button deletes both rect and text
9. Drop a card component - 4 elements (bg, divider, header, body) appear and move as one
</verification>

<success_criteria>
- Palette sidebar visible in EzyDraw modal
- Drag-and-drop from palette to canvas places components at correct position
- Grouped elements behave as atomic units for select, drag, and delete
- No z-index or event propagation issues between palette and canvas
- Build passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/27-ui-kit-advanced-tools/27-02-SUMMARY.md`
</output>
