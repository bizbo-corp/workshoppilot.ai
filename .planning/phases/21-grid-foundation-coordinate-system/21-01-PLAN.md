---
phase: 21-grid-foundation-coordinate-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/canvas/grid-layout.ts
  - src/lib/canvas/step-canvas-config.ts
  - src/stores/canvas-store.ts
autonomous: true

must_haves:
  truths:
    - "Step 6 (journey-mapping) canvas config includes gridConfig with 7 fixed rows and default columns"
    - "PostIt type accepts optional cellAssignment with row and col string IDs"
    - "Pure coordinate functions translate between pixel positions and grid cell coordinates"
    - "snapToCell returns padded position inside cell boundary, not flush edge"
  artifacts:
    - path: "src/lib/canvas/grid-layout.ts"
      provides: "Grid types (GridConfig, CellCoordinate, CellBounds) and pure coordinate functions"
      exports: ["GridConfig", "CellCoordinate", "CellBounds", "getCellBounds", "positionToCell", "snapToCell", "getGridDimensions"]
    - path: "src/lib/canvas/step-canvas-config.ts"
      provides: "Extended StepCanvasConfig with hasGrid and gridConfig fields, journey-mapping entry"
      exports: ["GridConfig", "StepCanvasConfig", "STEP_CANVAS_CONFIGS", "getStepCanvasConfig"]
    - path: "src/stores/canvas-store.ts"
      provides: "PostIt type with optional cellAssignment field"
      contains: "cellAssignment"
  key_links:
    - from: "src/lib/canvas/grid-layout.ts"
      to: "src/lib/canvas/step-canvas-config.ts"
      via: "GridConfig type re-exported from step-canvas-config"
      pattern: "GridConfig"
    - from: "src/stores/canvas-store.ts"
      to: "src/lib/canvas/grid-layout.ts"
      via: "cellAssignment uses row/col string IDs matching GridConfig rows/columns"
      pattern: "cellAssignment.*row.*col"
---

<objective>
Create the grid coordinate system foundation: types, pure coordinate transform functions, step-specific grid configuration for Step 6 Journey Map, and extend the PostIt data model with cell assignment metadata.

Purpose: Establish the type-safe foundation that Plan 02 will consume to render the grid overlay, wire snap logic, and detect cell assignments during drag operations.

Output: Three files created/modified providing GridConfig types, coordinate math, step config, and extended PostIt type.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-grid-foundation-coordinate-system/21-RESEARCH.md

# Key source files to reference
@src/lib/canvas/step-canvas-config.ts
@src/lib/canvas/quadrant-detection.ts
@src/stores/canvas-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create grid-layout.ts with types and coordinate transform functions</name>
  <files>src/lib/canvas/grid-layout.ts</files>
  <action>
Create `src/lib/canvas/grid-layout.ts` with the following types and pure functions:

**Types:**
```typescript
export type GridConfig = {
  rows: Array<{ id: string; label: string; height: number }>;
  columns: Array<{ id: string; label: string; width: number }>;
  origin: { x: number; y: number }; // Grid top-left in canvas coordinates
  cellPadding: number; // Padding inside cell for node placement (10px)
};

export type CellCoordinate = { row: number; col: number };

export type CellBounds = { x: number; y: number; width: number; height: number };
```

**Functions:**

1. `getCellBounds(coord: CellCoordinate, config: GridConfig): CellBounds` - Returns pixel bounds for a cell by summing preceding row heights / column widths from origin.

2. `positionToCell(position: { x: number; y: number }, config: GridConfig): CellCoordinate | null` - Detects which cell a canvas position falls in. Returns null if outside grid bounds. Uses relative position from origin and accumulates row heights / column widths to find matching indices.

3. `snapToCell(position: { x: number; y: number }, config: GridConfig): { x: number; y: number }` - Snaps a position to the nearest cell's top-left corner PLUS cellPadding. Calls positionToCell to find the cell, then getCellBounds to get the cell origin, then adds cellPadding offset. Returns original position if outside grid.

4. `getGridDimensions(config: GridConfig): { width: number; height: number }` - Returns total grid width and height by summing all column widths and row heights. Used for overlay rendering.

**Design decisions:**
- Position is always source of truth; cellAssignment is derived metadata (per research).
- cellPadding (10px) prevents nodes from touching cell borders (per research recommendation).
- Functions are pure (no React/Zustand coupling) for testability.
- Return null from positionToCell when outside grid (graceful fallback).

**Do NOT:**
- Import React or Zustand - these are pure utility functions.
- Use ReactFlow's built-in snapGrid (has multi-select bug per issue #1579).
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no TypeScript errors. Verify exports: `grep -c "export function\|export type" src/lib/canvas/grid-layout.ts` should return at least 7 (4 functions + 3 types).
  </verify>
  <done>
grid-layout.ts exists with GridConfig, CellCoordinate, CellBounds types and getCellBounds, positionToCell, snapToCell, getGridDimensions pure functions. All compile without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend step-canvas-config.ts and PostIt type with grid support</name>
  <files>src/lib/canvas/step-canvas-config.ts, src/stores/canvas-store.ts</files>
  <action>
**Step 1: Extend StepCanvasConfig in step-canvas-config.ts**

Import GridConfig from grid-layout.ts. Add two new optional fields to StepCanvasConfig:
```typescript
hasGrid?: boolean;
gridConfig?: GridConfig;
```

Add Step 6 journey-mapping entry to STEP_CANVAS_CONFIGS with:
```typescript
'journey-mapping': {
  hasQuadrants: false,
  hasGrid: true,
  gridConfig: {
    rows: [
      { id: 'actions', label: 'Actions', height: 120 },
      { id: 'goals', label: 'Goals', height: 120 },
      { id: 'barriers', label: 'Barriers', height: 120 },
      { id: 'touchpoints', label: 'Touchpoints', height: 120 },
      { id: 'emotions', label: 'Emotions', height: 100 },
      { id: 'moments', label: 'Moments of Truth', height: 120 },
      { id: 'opportunities', label: 'Opportunities', height: 120 },
    ],
    columns: [
      { id: 'awareness', label: 'Awareness', width: 200 },
      { id: 'consideration', label: 'Consideration', width: 200 },
      { id: 'decision', label: 'Decision', width: 200 },
      { id: 'purchase', label: 'Purchase', width: 200 },
      { id: 'onboarding', label: 'Onboarding', width: 200 },
    ],
    origin: { x: 140, y: 50 },  // 140px for row labels, 50px for column headers
    cellPadding: 10,
  },
},
```

Note: Use 140px x-origin (not 100px) to ensure "Moments of Truth" label fits without truncation. 5 default columns provide a sensible starting grid. Column IDs use semantic UUIDs per project decision (but using readable slugs here since columns are predefined for Step 6).

**Step 2: Extend PostIt type in canvas-store.ts**

Add optional cellAssignment field to PostIt type:
```typescript
cellAssignment?: {
  row: string;  // Row ID from GridConfig (e.g., 'actions', 'goals')
  col: string;  // Column ID from GridConfig (e.g., 'awareness', 'consideration')
};
```

This is backward compatible -- existing post-its without cellAssignment continue to work. No store action changes needed (updatePostIt already accepts Partial<PostIt> which will include cellAssignment).

**Do NOT:**
- Modify existing quadrant configs.
- Change any store actions (addPostIt, updatePostIt already handle partial fields).
- Create separate state for grid structure (grid is config, not state).
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no TypeScript errors. Verify: `grep "hasGrid" src/lib/canvas/step-canvas-config.ts` shows the new field. Verify: `grep "cellAssignment" src/stores/canvas-store.ts` shows the new PostIt field. Verify: `grep "journey-mapping" src/lib/canvas/step-canvas-config.ts` shows the Step 6 config entry.
  </verify>
  <done>
StepCanvasConfig extended with hasGrid and gridConfig fields. Step 6 journey-mapping config defined with 7 rows and 5 default columns. PostIt type extended with optional cellAssignment field. All backward compatible. TypeScript compiles without errors.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. grid-layout.ts exports: GridConfig, CellCoordinate, CellBounds, getCellBounds, positionToCell, snapToCell, getGridDimensions
3. step-canvas-config.ts: journey-mapping entry with hasGrid: true and 7 rows
4. canvas-store.ts: PostIt type includes optional cellAssignment field
5. Existing quadrant configs unchanged (stakeholder-mapping, sense-making)
6. No new npm dependencies
</verification>

<success_criteria>
- Grid coordinate system types and pure functions exist and compile
- Step 6 canvas config defined with 7 swimlane rows and 5 default columns
- PostIt type extended with cellAssignment without breaking existing canvas usage
- All coordinate functions are pure (no React/Zustand imports in grid-layout.ts)
- TypeScript compilation succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/21-grid-foundation-coordinate-system/21-01-SUMMARY.md`
</output>
