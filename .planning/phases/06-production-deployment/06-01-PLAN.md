---
phase: 06-production-deployment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/error.tsx
  - src/app/not-found.tsx
  - src/app/layout.tsx
  - drizzle.config.ts
  - package.json
  - scripts/verify-env.ts
autonomous: true

must_haves:
  truths:
    - "Production build error boundary catches and displays user-friendly error page"
    - "404 page renders branded not-found experience instead of Next.js default"
    - "Build fails fast if required environment variables are missing or wrong key type (test in production)"
    - "Database migrations use unpooled connection to avoid connection pooling issues"
    - "Analytics and Speed Insights components load on every page"
  artifacts:
    - path: "src/app/error.tsx"
      provides: "Production error boundary with retry button"
      contains: "reset"
    - path: "src/app/not-found.tsx"
      provides: "Custom 404 page"
      contains: "not found"
    - path: "scripts/verify-env.ts"
      provides: "Environment variable verification script"
      contains: "NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY"
    - path: "drizzle.config.ts"
      provides: "Drizzle config using unpooled URL for migrations"
      contains: "DATABASE_URL_UNPOOLED"
    - path: "src/app/layout.tsx"
      provides: "Root layout with Analytics and SpeedInsights components"
      contains: "Analytics"
  key_links:
    - from: "package.json"
      to: "scripts/verify-env.ts"
      via: "vercel-build script runs verify-env before build"
      pattern: "verify-env.*&&.*build"
    - from: "src/app/layout.tsx"
      to: "@vercel/analytics"
      via: "Analytics component import"
      pattern: "import.*Analytics.*@vercel/analytics"
---

<objective>
Harden the codebase for production deployment by adding error boundaries, environment variable verification, analytics instrumentation, and fixing the Drizzle migration connection.

Purpose: Production deployments need graceful error handling (not raw stack traces), fast failure on misconfiguration, performance monitoring, and reliable database migrations. These are code changes that must be committed before deployment.

Output: Production-ready codebase with error boundaries, env verification in build pipeline, analytics components, and correct migration connection.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-production-deployment/06-RESEARCH.md
@src/app/layout.tsx
@drizzle.config.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add production error boundaries, env verification, and fix Drizzle migration config</name>
  <files>
    src/app/error.tsx
    src/app/not-found.tsx
    scripts/verify-env.ts
    drizzle.config.ts
    package.json
  </files>
  <action>
    1. Create `src/app/error.tsx` — a 'use client' error boundary component:
       - Accept `error` (Error & { digest?: string }) and `reset` (() => void) props
       - Display user-friendly "Something went wrong" message with WorkshopPilot branding
       - Include a "Try again" button that calls reset()
       - Include a "Go home" link to "/"
       - Log error to console.error in a useEffect (for future Sentry integration)
       - Style with Tailwind: centered layout, muted colors, clear typography

    2. Create `src/app/not-found.tsx` — custom 404 page:
       - Display "Page not found" message with WorkshopPilot branding
       - Include a "Go home" link to "/"
       - Style consistently with error.tsx

    3. Create `scripts/verify-env.ts` — environment variable verification:
       - Check required vars exist: NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY, CLERK_SECRET_KEY, DATABASE_URL, GOOGLE_GENERATIVE_AI_API_KEY
       - In production (VERCEL_ENV === 'production'), verify Clerk keys are NOT test keys (pk_test_, sk_test_)
       - Throw error with clear message if any check fails
       - Log success message if all checks pass
       - Script runs via tsx, same as other scripts in the project

    4. Update `drizzle.config.ts`:
       - Change dbCredentials.url to use `process.env.DATABASE_URL_UNPOOLED || process.env.DATABASE_URL!`
       - This ensures migrations use the unpooled (direct) connection when available, falling back to pooled

    5. Update `package.json` scripts:
       - Change `vercel-build` to: `"tsx scripts/verify-env.ts && npm run db:migrate && npm run build"`
       - Change `db:migrate` to remove dotenv-cli prefix (Vercel provides env vars natively, dotenv-cli is dev-only): `"drizzle-kit migrate"`
       - Actually, keep db:migrate with dotenv-cli for local use but vercel-build should call drizzle-kit directly:
         - Update vercel-build to: `"tsx scripts/verify-env.ts && drizzle-kit migrate && next build"`
         - This avoids dotenv-cli dependency in production (it's a devDependency)
       - IMPORTANT: Vercel installs devDependencies during build by default, so dotenv-cli IS available. However, on Vercel the env vars are already injected, so dotenv-cli is unnecessary overhead. Calling drizzle-kit and next directly is cleaner.
       - Actually, tsx is also a devDependency. On Vercel, devDependencies are installed during build, so tsx is available. Keep the approach: `"tsx scripts/verify-env.ts && drizzle-kit migrate && next build"`
  </action>
  <verify>
    - `npm run build` succeeds locally (verifies error.tsx and not-found.tsx compile)
    - `cat scripts/verify-env.ts` shows required env var checks
    - `cat drizzle.config.ts` shows DATABASE_URL_UNPOOLED fallback
    - `grep vercel-build package.json` shows verify-env in the pipeline
  </verify>
  <done>
    - error.tsx renders user-friendly error page with retry and home link
    - not-found.tsx renders custom 404 page
    - verify-env.ts checks all required env vars and blocks test keys in production
    - drizzle.config.ts uses unpooled URL for migrations
    - vercel-build pipeline: verify-env → migrate → build
  </done>
</task>

<task type="auto">
  <name>Task 2: Install and wire Vercel Analytics and Speed Insights</name>
  <files>
    src/app/layout.tsx
    package.json
  </files>
  <action>
    1. Install packages: `npm install @vercel/analytics @vercel/speed-insights`

    2. Update `src/app/layout.tsx`:
       - Add imports: `import { Analytics } from '@vercel/analytics/next'` and `import { SpeedInsights } from '@vercel/speed-insights/next'`
       - Add `<Analytics />` and `<SpeedInsights />` components inside the `<body>` tag, AFTER `{children}` but inside the ThemeProvider
       - These components are self-contained and work on all Vercel plans (free tier included)
       - They render nothing visible — just inject tracking scripts in production

    3. Verify the layout still renders correctly with `npm run build`
  </action>
  <verify>
    - `npm run build` succeeds
    - `grep -n "Analytics" src/app/layout.tsx` shows Analytics import and component
    - `grep -n "SpeedInsights" src/app/layout.tsx` shows SpeedInsights import and component
    - `grep "@vercel/analytics" package.json` shows dependency installed
  </verify>
  <done>
    - @vercel/analytics and @vercel/speed-insights are installed in package.json dependencies
    - Analytics and SpeedInsights components render in root layout on every page
    - Build succeeds with no errors
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. Error boundary file exists at src/app/error.tsx with 'use client' directive
3. Not-found page exists at src/app/not-found.tsx
4. verify-env.ts checks all 4 required env vars
5. drizzle.config.ts references DATABASE_URL_UNPOOLED
6. vercel-build script includes verify-env step
7. Analytics and SpeedInsights components present in root layout
</verification>

<success_criteria>
- Production build succeeds with all new files
- Error boundary, 404 page, env verification, analytics all in place
- Migration config uses unpooled connection
- Build pipeline validates environment before deploying
</success_criteria>

<output>
After completion, create `.planning/phases/06-production-deployment/06-01-SUMMARY.md`
</output>
