---
phase: 40-production-auth
plan: 02
type: execute
wave: 2
depends_on: [40-01]
files_modified:
  - src/components/auth/sign-in-modal.tsx
  - src/app/layout.tsx
autonomous: false
requirements: [AUTH-03, AUTH-04]

user_setup:
  - service: clerk-google-oauth
    why: "Google OAuth provider for one-click sign-in"
    env_vars: []
    dashboard_config:
      - task: "Enable Google OAuth social connection in Clerk"
        location: "Clerk Dashboard → Configure → Social connections → Google → Enable"
      - task: "Configure Google OAuth credentials (Client ID + Secret from Google Cloud Console)"
        location: "Clerk Dashboard → Configure → Social connections → Google → Use custom credentials (optional but recommended for production)"
      - task: "Set account linking strategy to auto-link by email"
        location: "Clerk Dashboard → Configure → Social connections → Settings → Account linking → Automatic"
  - service: clerk-apple-oauth
    why: "Apple sign-in as second social provider"
    env_vars: []
    dashboard_config:
      - task: "Enable Apple OAuth social connection in Clerk"
        location: "Clerk Dashboard → Configure → Social connections → Apple → Enable"
      - task: "Configure Apple sign-in credentials (Service ID, Team ID, Key ID, Private Key from Apple Developer)"
        location: "Clerk Dashboard → Configure → Social connections → Apple → Configure credentials"

must_haves:
  truths:
    - "Google sign-in button appears first/prominently in the Clerk auth modal"
    - "Apple sign-in button appears alongside Google in the Clerk auth modal"
    - "Social sign-in buttons use olive-styled design matching the app theme"
    - "Clicking Google sign-in completes OAuth flow and lands on /dashboard"
    - "Clicking Apple sign-in completes OAuth flow and lands on /dashboard"
    - "User who signs up with Google and later signs in with email (same address) sees the same account"
    - "Full auth flow works end-to-end on production (workshoppilot.ai)"
  artifacts:
    - path: "src/app/layout.tsx"
      provides: "ClerkProvider with socialButtonsVariant configuration for olive-styled social buttons"
    - path: "src/components/auth/sign-in-modal.tsx"
      provides: "Auth modal rendering Clerk SignIn with social providers visible"
  key_links:
    - from: "Clerk Dashboard"
      to: "src/app/layout.tsx ClerkProvider"
      via: "Social connections enabled in Clerk dashboard appear automatically in SignIn component"
      pattern: "socialButtonsVariant"
    - from: "src/components/auth/sign-in-modal.tsx"
      to: "/dashboard"
      via: "fallbackRedirectUrl after successful OAuth"
      pattern: "fallbackRedirectUrl.*dashboard"
---

<objective>
Add Google OAuth and Apple sign-in as social providers in the Clerk auth modal. Configure Clerk's appearance to style social buttons with the olive design system. Verify the complete auth flow works end-to-end on production.

Purpose: Users expect one-click Google/Apple sign-in. Social auth reduces friction and increases sign-up conversion. Per user decision, Google appears first (primary position), Apple second, and email/password below as secondary.

Output: Working Google + Apple OAuth in the Clerk auth modal, olive-styled, with auto-account-linking.
</objective>

<execution_context>
@/Users/michaelchristie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelchristie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-production-auth/40-CONTEXT.md
@.planning/phases/40-production-auth/40-01-SUMMARY.md
@src/app/layout.tsx
@src/components/auth/sign-in-modal.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure Clerk appearance for olive-styled social buttons and provider ordering</name>
  <files>
    src/app/layout.tsx
    src/components/auth/sign-in-modal.tsx
  </files>
  <action>
    **ClerkProvider appearance update (layout.tsx):**
    - Update the ClerkProvider `appearance` prop (added in Plan 40-01) to style social/OAuth buttons with olive theme. Add elements for social buttons:
      ```tsx
      elements: {
        // ... existing elements from 40-01 ...
        socialButtonsBlockButton: 'border-border text-foreground hover:bg-accent',
        socialButtonsBlockButtonText: 'font-medium',
        socialButtonsProviderIcon: 'w-5 h-5',
        dividerLine: 'bg-border',
        dividerText: 'text-muted-foreground',
        formFieldInput: 'border-border bg-background text-foreground focus:ring-ring',
        formFieldLabel: 'text-foreground',
      }
      ```
    - Clerk automatically renders enabled social providers. The order is controlled in Clerk Dashboard (Google first, Apple second). No code change needed for ordering — Clerk respects dashboard configuration order.
    - Per user decision: "Social buttons use custom olive-styled design with provider icons (not Google/Apple standard branding)". Clerk's `socialButtonsVariant` can be set to `"blockButton"` (full-width buttons) or `"iconButton"` (icon only). Use `"blockButton"` for the prominent full-width style with provider name text. The olive styling is applied via the appearance elements above.
    - Add `socialButtonsVariant: 'blockButton'` to the Clerk SignIn appearance or globally in ClerkProvider layout.

    **Sign-in modal verification (sign-in-modal.tsx):**
    - Verify that the `<SignIn>` component in the modal does NOT override the global appearance — social providers should render with the olive styling from ClerkProvider.
    - If the `<SignIn>` component has a local `appearance` prop, ensure it extends (not replaces) the global theme. If it only sets `routing` and `fallbackRedirectUrl`, it's fine — it will inherit global appearance.
    - Ensure `routing="hash"` is still set so the modal works without page navigation.

    **Note on "not Google/Apple standard branding":** Clerk renders its own styled social buttons that include provider icons but can be themed. The `socialButtonsBlockButton` element class overrides mean the buttons will use olive border/hover colors instead of Google's blue or Apple's black. The provider icons (Google "G", Apple logo) are rendered by Clerk and cannot be removed, but the surrounding button style will match the olive design system, making them feel native to the app.
  </action>
  <verify>
    Run `npx next build` to verify no compile errors. Check that the ClerkProvider appearance includes socialButtonsBlockButton styling. Confirm the SignIn component doesn't override global social button styles.
  </verify>
  <done>
    Clerk appearance configured with olive-styled social buttons. Social buttons use border-border, text-foreground, hover:bg-accent — matching the olive design system. socialButtonsVariant set to blockButton for full-width social buttons with provider names.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify complete auth flow on production</name>
  <files>none — verification only</files>
  <action>
    Human verification checkpoint. What was built:
    - Olive-themed sign-in button in landing page header (secondary style)
    - Clerk modal overlay for sign-in/sign-up (not a separate page)
    - Google OAuth button (first/primary position)
    - Apple sign-in button (second position)
    - Email/password form (below social buttons)
    - Auto-redirect to /dashboard after sign-in
    - User avatar + Dashboard link when signed in
    - Olive theming on all Clerk surfaces

    **Pre-requisite:** Ensure the following Clerk Dashboard configuration is complete:
    1. Google OAuth enabled (Clerk Dashboard → Social connections → Google)
    2. Apple sign-in enabled (Clerk Dashboard → Social connections → Apple)
    3. Account linking set to automatic by email
    4. workshoppilot.ai added as allowed origin
    5. Production Clerk keys (pk_live_*, sk_live_*) set in Vercel environment variables
    6. Email verification enabled

    **Test on workshoppilot.ai:**
    1. Visit https://workshoppilot.ai — verify "Sign in" button is visible in header (subtle/secondary style)
    2. Click "Sign in" — verify Clerk modal appears with olive theming (not default white/blue)
    3. Verify Google sign-in button is first, Apple is second, email form is below
    4. Test Google sign-in — click Google button → complete OAuth → verify redirect to /dashboard
    5. Sign out → test Apple sign-in → complete OAuth → verify redirect to /dashboard
    6. Sign out → test email/password sign-up → verify email verification flow → verify redirect to /dashboard
    7. When signed in: verify header shows Dashboard link and user avatar
    8. Visit /pricing while signed in — verify it's accessible (public route)
    9. Sign out → visit /dashboard directly — verify redirect to landing page (or sign-in modal appears)
    10. Test on mobile: verify hamburger menu has sign-in option
  </action>
  <verify>User confirms all 10 test steps pass on production</verify>
  <done>All auth flows (Google OAuth, Apple sign-in, email/password) work end-to-end on workshoppilot.ai with olive theming and correct redirects</done>
</task>

</tasks>

<verification>
1. `npx next build` completes without errors
2. Google sign-in button renders in olive-styled block button format
3. Apple sign-in button renders alongside Google
4. Social buttons use olive border/hover colors, not default provider branding colors
5. Full OAuth flow (Google → /dashboard) works on production
6. Full OAuth flow (Apple → /dashboard) works on production
7. Email/password sign-up with verification works on production
8. Account auto-linking works (same email across providers = same account)
</verification>

<success_criteria>
- Google and Apple sign-in buttons are visible and styled with olive theme in the auth modal
- OAuth flow for both providers completes successfully and redirects to /dashboard
- Social buttons feel native to the app (olive borders, olive hover states)
- Auto-account-linking works across email and social providers
- Complete auth flow verified on production (workshoppilot.ai)
</success_criteria>

<output>
After completion, create `.planning/phases/40-production-auth/40-02-SUMMARY.md`
</output>
